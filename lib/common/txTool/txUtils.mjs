import{PublicKey as P,ComputeBudgetProgram as V,Transaction as f,TransactionMessage as x,Keypair as b,VersionedTransaction as B}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as F}from"@solana/spl-token";import{get as C,set as v}from"lodash";import S from"dayjs";import E from"dayjs/plugin/utc";S.extend(E);var h=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return S().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let r=e.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(r)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},y={},k={};function A(t){let e=C(y,t);if(!e){let r=C(k,t);e=new h({name:t,logLevel:r}),v(y,t,e)}return e}var d={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};var s=A("Raydium_txUtil"),I=1644;function X(t){let e=[],r=[];return t.microLamports&&(e.push(V.setComputeUnitPrice({microLamports:t.microLamports})),r.push(d.SetComputeUnitPrice)),t.units&&(e.push(V.setComputeUnitLimit({units:t.units})),r.push(d.SetComputeUnitLimit)),{instructions:e,instructionTypes:r}}async function Z(t){var e,r;try{return((r=await((e=t.getLatestBlockhash)==null?void 0:e.call(t)))==null?void 0:r.blockhash)||(await t.getRecentBlockhash()).blockhash}catch{return(await t.getRecentBlockhash()).blockhash}}function R(t,e){t.length<1&&s.logWithError(`no instructions provided: ${t.toString()}`),e.length<1&&s.logWithError(`no signers provided:, ${e.toString()}`);let r=new f;r.recentBlockhash="11111111111111111111111111111111",r.feePayer=e[0],r.add(...t);try{return Buffer.from(r.serialize({verifySignatures:!1})).toString("base64").length<I}catch{return!1}}async function Q(t,e,r,o=!0){let n=new P("RaydiumSimuLateTransaction11111111111111111"),m=[],a=new f;a.feePayer=n;for(let i of e)R([...a.instructions,i],[n])||(m.push(a),a=new f,a.feePayer=n),a.add(i);a.instructions.length>0&&m.push(a);let c=[];try{if(c=await W(t,m,o),c.find(i=>i.err!==null))throw Error("rpc simulateTransaction error")}catch(i){i instanceof Error&&s.logWithError("failed to simulate for instructions","RPC_ERROR",{message:i.message})}let l=[];for(let i of c)if(s.debug("simulate result:",i),i.logs){let u=i.logs.filter(g=>g&&g.includes(r));s.debug("filteredLog:",l),u.length||s.logWithError("simulate log not match keyword","keyword",r),l.push(...u)}return l}function ee(t,e){let r=t.match(/{["\w:,]+}/g);return!r||r.length!==1?s.logWithError(`simulate log fail to match json, keyword: ${e}`):r[0]}function te(t,e){let o=new RegExp(`"${e}":(\\d+)`,"g").exec(t);return!o||o.length!==2?s.logWithError(`simulate log fail to match key", key: ${e}`):o[1]}function re(t,e){let[r,o]=P.findProgramAddressSync(t,e);return{publicKey:r,nonce:o}}async function W(t,e,r){let o=[];if(r){let n=await t.getLatestBlockhash(),m=[];for(let i of e){i.recentBlockhash=n.blockhash,i.lastValidBlockHeight=n.lastValidBlockHeight;let g=i._compile().serialize(),T=i._serialize(g).toString("base64");m.push(T)}let a=m.map(i=>{let u=t._buildArgs([i],void 0,"base64");return{methodName:"simulateTransaction",args:u}}),c=[],l=20;for(let i=0;i<Math.ceil(a.length/l);i++)c.push(a.slice(i*l,(i+1)*l));o=await(await Promise.all(c.map(async i=>(await t._rpcBatchRequest(i)).map(u=>u.result.value)))).flat()}else try{o=await Promise.all(e.map(async n=>await(await t.simulateTransaction(n)).value))}catch(n){n instanceof Error&&s.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:n.message})}return o}function ie({instructions:t,payer:e,signers:r}){return R(t,[e,...r])}function oe({instructions:t,payer:e,lookupTableAddressAccount:r,recentBlockhash:o=b.generate().publicKey.toString()}){let m=new x({payerKey:e,recentBlockhash:o,instructions:t}).compileToV0Message(Object.values(r!=null?r:{}));try{return Buffer.from(new B(m).serialize()).toString("base64").length<I}catch{return!1}}var p={time:0,data:void 0};async function ne(t){if(!p.data||(Date.now()-p.time)/1e3>30){let e=await t.getEpochInfo();return p={time:Date.now(),data:e},e}else return p.data}var M=t=>Buffer.isBuffer(t)?t:t instanceof Uint8Array?Buffer.from(t.buffer,t.byteOffset,t.byteLength):Buffer.from(t);function ae(t){let e=[];return t.forEach(r=>{r instanceof f&&(r.recentBlockhash||(r.recentBlockhash=F.toBase58()),r.feePayer||(r.feePayer=b.generate().publicKey));let o=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof B&&(o=M(o));let n=o.toString("base64");e.push(n)}),console.log("simulate tx string:",e),e}export{I as MAX_BASE64_SIZE,X as addComputeBudget,ie as checkLegacyTxSize,oe as checkV0TxSize,re as findProgramAddress,R as forecastTransactionSize,ne as getEpochInfo,Z as getRecentBlockHash,ee as parseSimulateLogToJson,te as parseSimulateValue,ae as printSimulate,Q as simulateMultipleInstruction,W as simulateTransaction,M as toBuffer};
//# sourceMappingURL=txUtils.mjs.map