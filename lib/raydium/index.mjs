import{merge as ld}from"lodash";import $c from"axios";import{get as Xo,set as Bu}from"lodash";import Yo from"dayjs";import Su from"dayjs/plugin/utc";Yo.extend(Su);var li=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Yo().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},zo={},Ku={};function oe(i){let e=Xo(zo,i);if(!e){let t=Xo(Ku,i);e=new li({name:i,logLevel:t}),Bu(zo,i,e)}return e}import{PublicKey as Ec}from"@solana/web3.js";import Fc from"bn.js";import Mc from"big.js";import xr from"bn.js";import Qe from"bn.js";var sn=9e15,vt=1e9,mi="0123456789abcdef",fr="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",yr="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",di={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-sn,maxE:sn,crypto:!1},Zo,Kt,j=!0,gr="[DecimalError] ",Ft=gr+"Invalid argument: ",$o=gr+"Precision limit exceeded",Jo=gr+"crypto unavailable",es="[object Decimal]",Ve=Math.floor,xe=Math.pow,Cu=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,Ru=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Lu=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,ts=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,mt=1e7,Y=7,Ou=9007199254740991,Nu=fr.length-1,pi=yr.length-1,L={toStringTag:es};L.absoluteValue=L.abs=function(){var i=new this.constructor(this);return i.s<0&&(i.s=1),U(i)};L.ceil=function(){return U(new this.constructor(this),this.e+1,2)};L.clampedTo=L.clamp=function(i,e){var t,n=this,r=n.constructor;if(i=new r(i),e=new r(e),!i.s||!e.s)return new r(NaN);if(i.gt(e))throw Error(Ft+e);return t=n.cmp(i),t<0?i:n.cmp(e)>0?e:new r(n)};L.comparedTo=L.cmp=function(i){var e,t,n,r,o=this,s=o.d,a=(i=new o.constructor(i)).d,u=o.s,c=i.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(o.e!==i.e)return o.e>i.e^u<0?1:-1;for(n=s.length,r=a.length,e=0,t=n<r?n:r;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===r?0:n>r^u<0?1:-1};L.cosine=L.cos=function(){var i,e,t=this,n=t.constructor;return t.d?t.d[0]?(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+Y,n.rounding=1,t=Mu(n,ss(n,t)),n.precision=i,n.rounding=e,U(Kt==2||Kt==3?t.neg():t,i,e,!0)):new n(1):new n(NaN)};L.cubeRoot=L.cbrt=function(){var i,e,t,n,r,o,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(j=!1,o=l.s*xe(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=Le(l.d),i=l.e,(o=(i-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=xe(t,1/3),i=Ve((i+1)/3)-(i%3==(i<0?-1:2)),o==1/0?t="5e"+i:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+i),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(i=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=ye(c.plus(l).times(a),c.plus(u),s+2,1),Le(a.d).slice(0,s)===(t=Le(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!r&&t=="4999"){if(!r&&(U(a,i+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,r=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(U(n,i+1,1),e=!n.times(n).times(n).eq(l));break}return j=!0,U(n,i,m.rounding,e)};L.decimalPlaces=L.dp=function(){var i,e=this.d,t=NaN;if(e){if(i=e.length-1,t=(i-Ve(this.e/Y))*Y,i=e[i],i)for(;i%10==0;i/=10)t--;t<0&&(t=0)}return t};L.dividedBy=L.div=function(i){return ye(this,new this.constructor(i))};L.dividedToIntegerBy=L.divToInt=function(i){var e=this,t=e.constructor;return U(ye(e,new t(i),0,1,1),t.precision,t.rounding)};L.equals=L.eq=function(i){return this.cmp(i)===0};L.floor=function(){return U(new this.constructor(this),this.e+1,3)};L.greaterThan=L.gt=function(i){return this.cmp(i)>0};L.greaterThanOrEqualTo=L.gte=function(i){var e=this.cmp(i);return e==1||e===0};L.hyperbolicCosine=L.cosh=function(){var i,e,t,n,r,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,r=o.d.length,r<32?(i=Math.ceil(r/3),e=(1/Ar(4,i)).toString()):(i=16,e="2.3283064365386962890625e-10"),o=an(s,1,o.times(e),new s(1),!0);for(var u,c=i,l=new s(8);c--;)u=o.times(o),o=a.minus(u.times(l.minus(u.times(l))));return U(o,s.precision=t,s.rounding=n,!0)};L.hyperbolicSine=L.sinh=function(){var i,e,t,n,r=this,o=r.constructor;if(!r.isFinite()||r.isZero())return new o(r);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(r.e,r.sd())+4,o.rounding=1,n=r.d.length,n<3)r=an(o,2,r,r,!0);else{i=1.4*Math.sqrt(n),i=i>16?16:i|0,r=r.times(1/Ar(5,i)),r=an(o,2,r,r,!0);for(var s,a=new o(5),u=new o(16),c=new o(20);i--;)s=r.times(r),r=r.times(a.plus(s.times(u.times(s).plus(c))))}return o.precision=e,o.rounding=t,U(r,e,t,!0)};L.hyperbolicTangent=L.tanh=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+7,n.rounding=1,ye(t.sinh(),t.cosh(),n.precision=i,n.rounding=e)):new n(t.s)};L.inverseCosine=L.acos=function(){var i,e=this,t=e.constructor,n=e.abs().cmp(1),r=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?lt(t,r,o):new t(0):new t(NaN):e.isZero()?lt(t,r+4,o).times(.5):(t.precision=r+6,t.rounding=1,e=e.asin(),i=lt(t,r+4,o).times(.5),t.precision=r,t.rounding=o,i.minus(e))};L.inverseHyperbolicCosine=L.acosh=function(){var i,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(i=n.precision,e=n.rounding,n.precision=i+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,j=!1,t=t.times(t).minus(1).sqrt().plus(t),j=!0,n.precision=i,n.rounding=e,t.ln()):new n(t)};L.inverseHyperbolicSine=L.asinh=function(){var i,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,j=!1,t=t.times(t).plus(1).sqrt().plus(t),j=!0,n.precision=i,n.rounding=e,t.ln())};L.inverseHyperbolicTangent=L.atanh=function(){var i,e,t,n,r=this,o=r.constructor;return r.isFinite()?r.e>=0?new o(r.abs().eq(1)?r.s/0:r.isZero()?r:NaN):(i=o.precision,e=o.rounding,n=r.sd(),Math.max(n,i)<2*-r.e-1?U(new o(r),i,e,!0):(o.precision=t=n-r.e,r=ye(r.plus(1),new o(1).minus(r),t+i,1),o.precision=i+4,o.rounding=1,r=r.ln(),o.precision=i,o.rounding=e,r.times(.5))):new o(NaN)};L.inverseSine=L.asin=function(){var i,e,t,n,r=this,o=r.constructor;return r.isZero()?new o(r):(e=r.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(i=lt(o,t+4,n).times(.5),i.s=r.s,i):new o(NaN):(o.precision=t+6,o.rounding=1,r=r.div(new o(1).minus(r.times(r)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,r.times(2)))};L.inverseTangent=L.atan=function(){var i,e,t,n,r,o,s,a,u,c=this,l=c.constructor,m=l.precision,p=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=pi)return s=lt(l,m+4,p).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=pi)return s=lt(l,m+4,p).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/Y+2|0),i=t;i;--i)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(j=!1,e=Math.ceil(a/Y),n=1,u=c.times(c),s=new l(c),r=c;i!==-1;)if(r=r.times(u),o=s.minus(r.div(n+=2)),r=r.times(u),s=o.plus(r.div(n+=2)),s.d[e]!==void 0)for(i=e;s.d[i]===o.d[i]&&i--;);return t&&(s=s.times(2<<t-1)),j=!0,U(s,l.precision=m,l.rounding=p,!0)};L.isFinite=function(){return!!this.d};L.isInteger=L.isInt=function(){return!!this.d&&Ve(this.e/Y)>this.d.length-2};L.isNaN=function(){return!this.s};L.isNegative=L.isNeg=function(){return this.s<0};L.isPositive=L.isPos=function(){return this.s>0};L.isZero=function(){return!!this.d&&this.d[0]===0};L.lessThan=L.lt=function(i){return this.cmp(i)<0};L.lessThanOrEqualTo=L.lte=function(i){return this.cmp(i)<1};L.logarithm=L.log=function(i){var e,t,n,r,o,s,a,u,c=this,l=c.constructor,m=l.precision,p=l.rounding,d=5;if(i==null)i=new l(10),e=!0;else{if(i=new l(i),t=i.d,i.s<0||!t||!t[0]||i.eq(1))return new l(NaN);e=i.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(r=t[0];r%10===0;)r/=10;o=r!==1}if(j=!1,a=m+d,s=Et(c,a),n=e?br(l,a+10):Et(i,a),u=ye(s,n,a,1),kn(u.d,r=m,p))do if(a+=10,s=Et(c,a),n=e?br(l,a+10):Et(i,a),u=ye(s,n,a,1),!o){+Le(u.d).slice(r+1,r+15)+1==1e14&&(u=U(u,m+1,0));break}while(kn(u.d,r+=10,p));return j=!0,U(u,m,p)};L.minus=L.sub=function(i){var e,t,n,r,o,s,a,u,c,l,m,p,d=this,y=d.constructor;if(i=new y(i),!d.d||!i.d)return!d.s||!i.s?i=new y(NaN):d.d?i.s=-i.s:i=new y(i.d||d.s!==i.s?d:NaN),i;if(d.s!=i.s)return i.s=-i.s,d.plus(i);if(c=d.d,p=i.d,a=y.precision,u=y.rounding,!c[0]||!p[0]){if(p[0])i.s=-i.s;else if(c[0])i=new y(d);else return new y(u===3?-0:0);return j?U(i,a,u):i}if(t=Ve(i.e/Y),l=Ve(d.e/Y),c=c.slice(),o=l-t,o){for(m=o<0,m?(e=c,o=-o,s=p.length):(e=p,t=l,s=c.length),n=Math.max(Math.ceil(a/Y),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=p.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=p[n]){m=c[n]<p[n];break}o=0}for(m&&(e=c,c=p,p=e,i.s=-i.s),s=c.length,n=p.length-s;n>0;--n)c[s++]=0;for(n=p.length;n>o;){if(c[--n]<p[n]){for(r=n;r&&c[--r]===0;)c[r]=mt-1;--c[r],c[n]+=mt}c[n]-=p[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(i.d=c,i.e=wr(c,t),j?U(i,a,u):i):new y(u===3?-0:0)};L.modulo=L.mod=function(i){var e,t=this,n=t.constructor;return i=new n(i),!t.d||!i.s||i.d&&!i.d[0]?new n(NaN):!i.d||t.d&&!t.d[0]?U(new n(t),n.precision,n.rounding):(j=!1,n.modulo==9?(e=ye(t,i.abs(),0,3,1),e.s*=i.s):e=ye(t,i,0,n.modulo,1),e=e.times(i),j=!0,t.minus(e))};L.naturalExponential=L.exp=function(){return fi(this)};L.naturalLogarithm=L.ln=function(){return Et(this)};L.negated=L.neg=function(){var i=new this.constructor(this);return i.s=-i.s,U(i)};L.plus=L.add=function(i){var e,t,n,r,o,s,a,u,c,l,m=this,p=m.constructor;if(i=new p(i),!m.d||!i.d)return!m.s||!i.s?i=new p(NaN):m.d||(i=new p(i.d||m.s===i.s?m:NaN)),i;if(m.s!=i.s)return i.s=-i.s,m.minus(i);if(c=m.d,l=i.d,a=p.precision,u=p.rounding,!c[0]||!l[0])return l[0]||(i=new p(m)),j?U(i,a,u):i;if(o=Ve(m.e/Y),n=Ve(i.e/Y),c=c.slice(),r=o-n,r){for(r<0?(t=c,r=-r,s=l.length):(t=l,n=o,s=c.length),o=Math.ceil(a/Y),s=o>s?o+1:s+1,r>s&&(r=s,t.length=1),t.reverse();r--;)t.push(0);t.reverse()}for(s=c.length,r=l.length,s-r<0&&(r=s,t=l,l=c,c=t),e=0;r;)e=(c[--r]=c[r]+l[r]+e)/mt|0,c[r]%=mt;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return i.d=c,i.e=wr(c,n),j?U(i,a,u):i};L.precision=L.sd=function(i){var e,t=this;if(i!==void 0&&i!==!!i&&i!==1&&i!==0)throw Error(Ft+i);return t.d?(e=ns(t.d),i&&t.e+1>e&&(e=t.e+1)):e=NaN,e};L.round=function(){var i=this,e=i.constructor;return U(new e(i),i.e+1,e.rounding)};L.sine=L.sin=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+Y,n.rounding=1,t=Vu(n,ss(n,t)),n.precision=i,n.rounding=e,U(Kt>2?t.neg():t,i,e,!0)):new n(NaN)};L.squareRoot=L.sqrt=function(){var i,e,t,n,r,o,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(j=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=Le(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=Ve((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(o=n,n=o.plus(ye(s,o,t+2,1)).times(.5),Le(o.d).slice(0,t)===(e=Le(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!r&&e=="4999"){if(!r&&(U(o,u+1,0),o.times(o).eq(s))){n=o;break}t+=4,r=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(U(n,u+1,1),i=!n.times(n).eq(s));break}return j=!0,U(n,u,l.rounding,i)};L.tangent=L.tan=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+10,n.rounding=1,t=t.sin(),t.s=1,t=ye(t,new n(1).minus(t.times(t)).sqrt(),i+10,0),n.precision=i,n.rounding=e,U(Kt==2||Kt==4?t.neg():t,i,e,!0)):new n(NaN)};L.times=L.mul=function(i){var e,t,n,r,o,s,a,u,c,l=this,m=l.constructor,p=l.d,d=(i=new m(i)).d;if(i.s*=l.s,!p||!p[0]||!d||!d[0])return new m(!i.s||p&&!p[0]&&!d||d&&!d[0]&&!p?NaN:!p||!d?i.s/0:i.s*0);for(t=Ve(l.e/Y)+Ve(i.e/Y),u=p.length,c=d.length,u<c&&(o=p,p=d,d=o,s=u,u=c,c=s),o=[],s=u+c,n=s;n--;)o.push(0);for(n=c;--n>=0;){for(e=0,r=u+n;r>n;)a=o[r]+d[n]*p[r-n-1]+e,o[r--]=a%mt|0,e=a/mt|0;o[r]=(o[r]+e)%mt|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),i.d=o,i.e=wr(o,t),j?U(i,m.precision,m.rounding):i};L.toBinary=function(i,e){return bi(this,2,i,e)};L.toDecimalPlaces=L.toDP=function(i,e){var t=this,n=t.constructor;return t=new n(t),i===void 0?t:(ze(i,0,vt),e===void 0?e=n.rounding:ze(e,0,8),U(t,i+t.e+1,e))};L.toExponential=function(i,e){var t,n=this,r=n.constructor;return i===void 0?t=wt(n,!0):(ze(i,0,vt),e===void 0?e=r.rounding:ze(e,0,8),n=U(new r(n),i+1,e),t=wt(n,!0,i+1)),n.isNeg()&&!n.isZero()?"-"+t:t};L.toFixed=function(i,e){var t,n,r=this,o=r.constructor;return i===void 0?t=wt(r):(ze(i,0,vt),e===void 0?e=o.rounding:ze(e,0,8),n=U(new o(r),i+r.e+1,e),t=wt(n,!1,i+n.e+1)),r.isNeg()&&!r.isZero()?"-"+t:t};L.toFraction=function(i){var e,t,n,r,o,s,a,u,c,l,m,p,d=this,y=d.d,f=d.constructor;if(!y)return new f(d);if(c=t=new f(1),n=u=new f(0),e=new f(n),o=e.e=ns(y)-d.e-1,s=o%Y,e.d[0]=xe(10,s<0?Y+s:s),i==null)i=o>0?e:c;else{if(a=new f(i),!a.isInt()||a.lt(c))throw Error(Ft+a);i=a.gt(e)?o>0?e:c:a}for(j=!1,a=new f(Le(y)),l=f.precision,f.precision=o=y.length*Y*2;m=ye(a,e,0,1,1),r=t.plus(m.times(n)),r.cmp(i)!=1;)t=n,n=r,r=c,c=u.plus(m.times(r)),u=r,r=e,e=a.minus(m.times(r)),a=r;return r=ye(i.minus(t),n,0,1,1),u=u.plus(r.times(c)),t=t.plus(r.times(n)),u.s=c.s=d.s,p=ye(c,n,o,1).minus(d).abs().cmp(ye(u,t,o,1).minus(d).abs())<1?[c,n]:[u,t],f.precision=l,j=!0,p};L.toHexadecimal=L.toHex=function(i,e){return bi(this,16,i,e)};L.toNearest=function(i,e){var t=this,n=t.constructor;if(t=new n(t),i==null){if(!t.d)return t;i=new n(1),e=n.rounding}else{if(i=new n(i),e===void 0?e=n.rounding:ze(e,0,8),!t.d)return i.s?t:i;if(!i.d)return i.s&&(i.s=t.s),i}return i.d[0]?(j=!1,t=ye(t,i,0,e,1).times(i),j=!0,U(t)):(i.s=t.s,t=i),t};L.toNumber=function(){return+this};L.toOctal=function(i,e){return bi(this,8,i,e)};L.toPower=L.pow=function(i){var e,t,n,r,o,s,a=this,u=a.constructor,c=+(i=new u(i));if(!a.d||!i.d||!a.d[0]||!i.d[0])return new u(xe(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,o=u.rounding,i.eq(1))return U(a,n,o);if(e=Ve(i.e/Y),e>=i.d.length-1&&(t=c<0?-c:c)<=Ou)return r=rs(u,a,t,n),i.s<0?new u(1).div(r):U(r,n,o);if(s=a.s,s<0){if(e<i.d.length-1)return new u(NaN);if((i.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=xe(+a,c),e=t==0||!isFinite(t)?Ve(c*(Math.log("0."+Le(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(j=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),r=fi(i.times(Et(a,n+t)),n),r.d&&(r=U(r,n+5,1),kn(r.d,n,o)&&(e=n+10,r=U(fi(i.times(Et(a,e+t)),e),e+5,1),+Le(r.d).slice(n+1,n+15)+1==1e14&&(r=U(r,n+1,0)))),r.s=s,j=!0,u.rounding=o,U(r,n,o))};L.toPrecision=function(i,e){var t,n=this,r=n.constructor;return i===void 0?t=wt(n,n.e<=r.toExpNeg||n.e>=r.toExpPos):(ze(i,1,vt),e===void 0?e=r.rounding:ze(e,0,8),n=U(new r(n),i,e),t=wt(n,i<=n.e||n.e<=r.toExpNeg,i)),n.isNeg()&&!n.isZero()?"-"+t:t};L.toSignificantDigits=L.toSD=function(i,e){var t=this,n=t.constructor;return i===void 0?(i=n.precision,e=n.rounding):(ze(i,1,vt),e===void 0?e=n.rounding:ze(e,0,8)),U(new n(t),i,e)};L.toString=function(){var i=this,e=i.constructor,t=wt(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()&&!i.isZero()?"-"+t:t};L.truncated=L.trunc=function(){return U(new this.constructor(this),this.e+1,1)};L.valueOf=L.toJSON=function(){var i=this,e=i.constructor,t=wt(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()?"-"+t:t};function Le(i){var e,t,n,r=i.length-1,o="",s=i[0];if(r>0){for(o+=s,e=1;e<r;e++)n=i[e]+"",t=Y-n.length,t&&(o+=Vt(t)),o+=n;s=i[e],n=s+"",t=Y-n.length,t&&(o+=Vt(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function ze(i,e,t){if(i!==~~i||i<e||i>t)throw Error(Ft+i)}function kn(i,e,t,n){var r,o,s,a;for(o=i[0];o>=10;o/=10)--e;return--e<0?(e+=Y,r=0):(r=Math.ceil((e+1)/Y),e%=Y),o=xe(10,Y-e),a=i[r]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(i[r+1]/o/100|0)==xe(10,e-2)-1||(a==o/2||a==0)&&(i[r+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(i[r+1]/o/1e3|0)==xe(10,e-3)-1,s}function pr(i,e,t){for(var n,r=[0],o,s=0,a=i.length;s<a;){for(o=r.length;o--;)r[o]*=e;for(r[0]+=mi.indexOf(i.charAt(s++)),n=0;n<r.length;n++)r[n]>t-1&&(r[n+1]===void 0&&(r[n+1]=0),r[n+1]+=r[n]/t|0,r[n]%=t)}return r.reverse()}function Mu(i,e){var t,n,r;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),r=(1/Ar(4,t)).toString()):(t=16,r="2.3283064365386962890625e-10"),i.precision+=t,e=an(i,1,e.times(r),new i(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return i.precision-=t,e}var ye=function(){function i(n,r,o){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*r+a,n[u]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,r,o,s){var a,u;if(o!=s)u=o>s?1:-1;else for(a=u=0;a<o;a++)if(n[a]!=r[a]){u=n[a]>r[a]?1:-1;break}return u}function t(n,r,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<r[o]?1:0,n[o]=a*s+n[o]-r[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,r,o,s,a,u){var c,l,m,p,d,y,f,b,g,A,k,h,T,I,S,x,K,N,E,z,v=n.constructor,Z=n.s==r.s?1:-1,J=n.d,re=r.d;if(!J||!J[0]||!re||!re[0])return new v(!n.s||!r.s||(J?re&&J[0]==re[0]:!re)?NaN:J&&J[0]==0||!re?Z*0:Z/0);for(u?(d=1,l=n.e-r.e):(u=mt,d=Y,l=Ve(n.e/d)-Ve(r.e/d)),E=re.length,K=J.length,g=new v(Z),A=g.d=[],m=0;re[m]==(J[m]||0);m++);if(re[m]>(J[m]||0)&&l--,o==null?(I=o=v.precision,s=v.rounding):a?I=o+(n.e-r.e)+1:I=o,I<0)A.push(1),y=!0;else{if(I=I/d+2|0,m=0,E==1){for(p=0,re=re[0],I++;(m<K||p)&&I--;m++)S=p*u+(J[m]||0),A[m]=S/re|0,p=S%re|0;y=p||m<K}else{for(p=u/(re[0]+1)|0,p>1&&(re=i(re,p,u),J=i(J,p,u),E=re.length,K=J.length),x=E,k=J.slice(0,E),h=k.length;h<E;)k[h++]=0;z=re.slice(),z.unshift(0),N=re[0],re[1]>=u/2&&++N;do p=0,c=e(re,k,E,h),c<0?(T=k[0],E!=h&&(T=T*u+(k[1]||0)),p=T/N|0,p>1?(p>=u&&(p=u-1),f=i(re,p,u),b=f.length,h=k.length,c=e(f,k,b,h),c==1&&(p--,t(f,E<b?z:re,b,u))):(p==0&&(c=p=1),f=re.slice()),b=f.length,b<h&&f.unshift(0),t(k,f,h,u),c==-1&&(h=k.length,c=e(re,k,E,h),c<1&&(p++,t(k,E<h?z:re,h,u))),h=k.length):c===0&&(p++,k=[0]),A[m++]=p,c&&k[0]?k[h++]=J[x]||0:(k=[J[x]],h=1);while((x++<K||k[0]!==void 0)&&I--);y=k[0]!==void 0}A[0]||A.shift()}if(d==1)g.e=l,Zo=y;else{for(m=1,p=A[0];p>=10;p/=10)m++;g.e=m+l*d-1,U(g,a?o+g.e+1:o,s,y)}return g}}();function U(i,e,t,n){var r,o,s,a,u,c,l,m,p,d=i.constructor;e:if(e!=null){if(m=i.d,!m)return i;for(r=1,a=m[0];a>=10;a/=10)r++;if(o=e-r,o<0)o+=Y,s=e,l=m[p=0],u=l/xe(10,r-s-1)%10|0;else if(p=Math.ceil((o+1)/Y),a=m.length,p>=a)if(n){for(;a++<=p;)m.push(0);l=u=0,r=1,o%=Y,s=o-Y+1}else break e;else{for(l=a=m[p],r=1;a>=10;a/=10)r++;o%=Y,s=o-Y+r,u=s<0?0:l/xe(10,r-s-1)%10|0}if(n=n||e<0||m[p+1]!==void 0||(s<0?l:l%xe(10,r-s-1)),c=t<4?(u||n)&&(t==0||t==(i.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(o>0?s>0?l/xe(10,r-s):0:m[p-1])%10&1||t==(i.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=i.e+1,m[0]=xe(10,(Y-e%Y)%Y),i.e=-e||0):m[0]=i.e=0,i;if(o==0?(m.length=p,a=1,p--):(m.length=p+1,a=xe(10,Y-o),m[p]=s>0?(l/xe(10,r-s)%xe(10,s)|0)*a:0),c)for(;;)if(p==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(i.e++,m[0]==mt&&(m[0]=1));break}else{if(m[p]+=a,m[p]!=mt)break;m[p--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return j&&(i.e>d.maxE?(i.d=null,i.e=NaN):i.e<d.minE&&(i.e=0,i.d=[0])),i}function wt(i,e,t){if(!i.isFinite())return os(i);var n,r=i.e,o=Le(i.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+Vt(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(i.e<0?"e":"e+")+i.e):r<0?(o="0."+Vt(-r-1)+o,t&&(n=t-s)>0&&(o+=Vt(n))):r>=s?(o+=Vt(r+1-s),t&&(n=t-r-1)>0&&(o=o+"."+Vt(n))):((n=r+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(r+1===s&&(o+="."),o+=Vt(n))),o}function wr(i,e){var t=i[0];for(e*=Y;t>=10;t/=10)e++;return e}function br(i,e,t){if(e>Nu)throw j=!0,t&&(i.precision=t),Error($o);return U(new i(fr),e,1,!0)}function lt(i,e,t){if(e>pi)throw Error($o);return U(new i(yr),e,t,!0)}function ns(i){var e=i.length-1,t=e*Y+1;if(e=i[e],e){for(;e%10==0;e/=10)t--;for(e=i[0];e>=10;e/=10)t++}return t}function Vt(i){for(var e="";i--;)e+="0";return e}function rs(i,e,t,n){var r,o=new i(1),s=Math.ceil(n/Y+4);for(j=!1;;){if(t%2&&(o=o.times(e),Ho(o.d,s)&&(r=!0)),t=Ve(t/2),t===0){t=o.d.length-1,r&&o.d[t]===0&&++o.d[t];break}e=e.times(e),Ho(e.d,s)}return j=!0,o}function Qo(i){return i.d[i.d.length-1]&1}function is(i,e,t){for(var n,r=new i(e[0]),o=0;++o<e.length;)if(n=new i(e[o]),n.s)r[t](n)&&(r=n);else{r=n;break}return r}function fi(i,e){var t,n,r,o,s,a,u,c=0,l=0,m=0,p=i.constructor,d=p.rounding,y=p.precision;if(!i.d||!i.d[0]||i.e>17)return new p(i.d?i.d[0]?i.s<0?0:1/0:1:i.s?i.s<0?0:i:0/0);for(e==null?(j=!1,u=y):u=e,a=new p(.03125);i.e>-2;)i=i.times(a),m+=5;for(n=Math.log(xe(2,m))/Math.LN10*2+5|0,u+=n,t=o=s=new p(1),p.precision=u;;){if(o=U(o.times(i),u,1),t=t.times(++l),a=s.plus(ye(o,t,u,1)),Le(a.d).slice(0,u)===Le(s.d).slice(0,u)){for(r=m;r--;)s=U(s.times(s),u,1);if(e==null)if(c<3&&kn(s.d,u-n,d,c))p.precision=u+=10,t=o=a=new p(1),l=0,c++;else return U(s,p.precision=y,d,j=!0);else return p.precision=y,s}s=a}}function Et(i,e){var t,n,r,o,s,a,u,c,l,m,p,d=1,y=10,f=i,b=f.d,g=f.constructor,A=g.rounding,k=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(j=!1,l=k):l=e,g.precision=l+=y,t=Le(b),n=t.charAt(0),Math.abs(o=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(i),t=Le(f.d),n=t.charAt(0),d++;o=f.e,n>1?(f=new g("0."+t),o++):f=new g(n+"."+t.slice(1))}else return c=br(g,l+2,k).times(o+""),f=Et(new g(n+"."+t.slice(1)),l-y).plus(c),g.precision=k,e==null?U(f,k,A,j=!0):f;for(m=f,u=s=f=ye(f.minus(1),f.plus(1),l,1),p=U(f.times(f),l,1),r=3;;){if(s=U(s.times(p),l,1),c=u.plus(ye(s,new g(r),l,1)),Le(c.d).slice(0,l)===Le(u.d).slice(0,l))if(u=u.times(2),o!==0&&(u=u.plus(br(g,l+2,k).times(o+""))),u=ye(u,new g(d),l,1),e==null)if(kn(u.d,l-y,A,a))g.precision=l+=y,c=s=f=ye(m.minus(1),m.plus(1),l,1),p=U(f.times(f),l,1),r=a=1;else return U(u,g.precision=k,A,j=!0);else return g.precision=k,u;u=c,r+=2}}function os(i){return String(i.s*i.s/0)}function yi(i,e){var t,n,r;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(r=e.length;e.charCodeAt(r-1)===48;--r);if(e=e.slice(n,r),e){if(r-=n,i.e=t=t-n-1,i.d=[],n=(t+1)%Y,t<0&&(n+=Y),n<r){for(n&&i.d.push(+e.slice(0,n)),r-=Y;n<r;)i.d.push(+e.slice(n,n+=Y));e=e.slice(n),n=Y-e.length}else n-=r;for(;n--;)e+="0";i.d.push(+e),j&&(i.e>i.constructor.maxE?(i.d=null,i.e=NaN):i.e<i.constructor.minE&&(i.e=0,i.d=[0]))}else i.e=0,i.d=[0];return i}function _u(i,e){var t,n,r,o,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),ts.test(e))return yi(i,e)}else if(e==="Infinity"||e==="NaN")return+e||(i.s=NaN),i.e=NaN,i.d=null,i;if(Ru.test(e))t=16,e=e.toLowerCase();else if(Cu.test(e))t=2;else if(Lu.test(e))t=8;else throw Error(Ft+e);for(o=e.search(/p/i),o>0?(u=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=i.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,r=rs(n,new n(t),o,o*2)),c=pr(e,t,mt),l=c.length-1,o=l;c[o]===0;--o)c.pop();return o<0?new n(i.s*0):(i.e=wr(c,l),i.d=c,j=!1,s&&(i=ye(i,r,a*4)),u&&(i=i.times(Math.abs(u)<54?xe(2,u):hn.pow(2,u))),j=!0,i)}function Vu(i,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:an(i,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Ar(5,t)),e=an(i,2,e,e);for(var r,o=new i(5),s=new i(16),a=new i(20);t--;)r=e.times(e),e=e.times(o.plus(r.times(s.times(r).minus(a))));return e}function an(i,e,t,n,r){var o,s,a,u,c=1,l=i.precision,m=Math.ceil(l/Y);for(j=!1,u=t.times(t),a=new i(n);;){if(s=ye(a.times(u),new i(e++*e++),l,1),a=r?n.plus(s):n.minus(s),n=ye(s.times(u),new i(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,c++}return j=!0,s.d.length=m+1,s}function Ar(i,e){for(var t=i;--e;)t*=i;return t}function ss(i,e){var t,n=e.s<0,r=lt(i,i.precision,1),o=r.times(.5);if(e=e.abs(),e.lte(o))return Kt=n?4:1,e;if(t=e.divToInt(r),t.isZero())Kt=n?3:2;else{if(e=e.minus(t.times(r)),e.lte(o))return Kt=Qo(t)?n?2:3:n?4:1,e;Kt=Qo(t)?n?1:4:n?3:2}return e.minus(r).abs()}function bi(i,e,t,n){var r,o,s,a,u,c,l,m,p,d=i.constructor,y=t!==void 0;if(y?(ze(t,1,vt),n===void 0?n=d.rounding:ze(n,0,8)):(t=d.precision,n=d.rounding),!i.isFinite())l=os(i);else{for(l=wt(i),s=l.indexOf("."),y?(r=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):r=e,s>=0&&(l=l.replace(".",""),p=new d(1),p.e=l.length-s,p.d=pr(wt(p),10,r),p.e=p.d.length),m=pr(l,10,r),o=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?o--:(i=new d(i),i.d=m,i.e=o,i=ye(i,p,t,n,0,r),m=i.d,o=i.e,c=Zo),s=m[t],a=r/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(i.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(i.s<0?8:7)),m.length=t,c)for(;++m[--t]>r-1;)m[t]=0,t||(++o,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=mi.charAt(m[s]);if(y){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=pr(l,r,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=mi.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>u)for(o-=u;o--;)l+="0";else o<u&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return i.s<0?"-"+l:l}function Ho(i,e){if(i.length>e)return i.length=e,!0}function Eu(i){return new this(i).abs()}function Fu(i){return new this(i).acos()}function vu(i){return new this(i).acosh()}function Wu(i,e){return new this(i).plus(e)}function Du(i){return new this(i).asin()}function qu(i){return new this(i).asinh()}function Uu(i){return new this(i).atan()}function Gu(i){return new this(i).atanh()}function Xu(i,e){i=new this(i),e=new this(e);var t,n=this.precision,r=this.rounding,o=n+4;return!i.s||!e.s?t=new this(NaN):!i.d&&!e.d?(t=lt(this,o,1).times(e.s>0?.25:.75),t.s=i.s):!e.d||i.isZero()?(t=e.s<0?lt(this,n,r):new this(0),t.s=i.s):!i.d||e.isZero()?(t=lt(this,o,1).times(.5),t.s=i.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(ye(i,e,o,1)),e=lt(this,o,1),this.precision=n,this.rounding=r,t=i.s<0?t.minus(e):t.plus(e)):t=this.atan(ye(i,e,o,1)),t}function zu(i){return new this(i).cbrt()}function Yu(i){return U(i=new this(i),i.e+1,2)}function Qu(i,e,t){return new this(i).clamp(e,t)}function Hu(i){if(!i||typeof i!="object")throw Error(gr+"Object expected");var e,t,n,r=i.defaults===!0,o=["precision",1,vt,"rounding",0,8,"toExpNeg",-sn,0,"toExpPos",0,sn,"maxE",0,sn,"minE",-sn,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],r&&(this[t]=di[t]),(n=i[t])!==void 0)if(Ve(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(Ft+t+": "+n);if(t="crypto",r&&(this[t]=di[t]),(n=i[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(Jo);else this[t]=!1;else throw Error(Ft+t+": "+n);return this}function ju(i){return new this(i).cos()}function Zu(i){return new this(i).cosh()}function as(i){var e,t,n;function r(o){var s,a,u,c=this;if(!(c instanceof r))return new r(o);if(c.constructor=r,jo(o)){c.s=o.s,j?!o.d||o.e>r.maxE?(c.e=NaN,c.d=null):o.e<r.minE?(c.e=0,c.d=[0]):(c.e=o.e,c.d=o.d.slice()):(c.e=o.e,c.d=o.d?o.d.slice():o.d);return}if(u=typeof o,u==="number"){if(o===0){c.s=1/o<0?-1:1,c.e=0,c.d=[0];return}if(o<0?(o=-o,c.s=-1):c.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;j?s>r.maxE?(c.e=NaN,c.d=null):s<r.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[o]):(c.e=s,c.d=[o]);return}else if(o*0!==0){o||(c.s=NaN),c.e=NaN,c.d=null;return}return yi(c,o.toString())}else if(u!=="string")throw Error(Ft+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),c.s=-1):(a===43&&(o=o.slice(1)),c.s=1),ts.test(o)?yi(c,o):_u(c,o)}if(r.prototype=L,r.ROUND_UP=0,r.ROUND_DOWN=1,r.ROUND_CEIL=2,r.ROUND_FLOOR=3,r.ROUND_HALF_UP=4,r.ROUND_HALF_DOWN=5,r.ROUND_HALF_EVEN=6,r.ROUND_HALF_CEIL=7,r.ROUND_HALF_FLOOR=8,r.EUCLID=9,r.config=r.set=Hu,r.clone=as,r.isDecimal=jo,r.abs=Eu,r.acos=Fu,r.acosh=vu,r.add=Wu,r.asin=Du,r.asinh=qu,r.atan=Uu,r.atanh=Gu,r.atan2=Xu,r.cbrt=zu,r.ceil=Yu,r.clamp=Qu,r.cos=ju,r.cosh=Zu,r.div=$u,r.exp=Ju,r.floor=ec,r.hypot=tc,r.ln=nc,r.log=rc,r.log10=oc,r.log2=ic,r.max=sc,r.min=ac,r.mod=uc,r.mul=cc,r.pow=lc,r.random=mc,r.round=dc,r.sign=pc,r.sin=fc,r.sinh=yc,r.sqrt=bc,r.sub=gc,r.sum=wc,r.tan=Ac,r.tanh=Pc,r.trunc=kc,i===void 0&&(i={}),i&&i.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)i.hasOwnProperty(t=n[e++])||(i[t]=this[t]);return r.config(i),r}function $u(i,e){return new this(i).div(e)}function Ju(i){return new this(i).exp()}function ec(i){return U(i=new this(i),i.e+1,3)}function tc(){var i,e,t=new this(0);for(j=!1,i=0;i<arguments.length;)if(e=new this(arguments[i++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return j=!0,new this(1/0);t=e}return j=!0,t.sqrt()}function jo(i){return i instanceof hn||i&&i.toStringTag===es||!1}function nc(i){return new this(i).ln()}function rc(i,e){return new this(i).log(e)}function ic(i){return new this(i).log(2)}function oc(i){return new this(i).log(10)}function sc(){return is(this,arguments,"lt")}function ac(){return is(this,arguments,"gt")}function uc(i,e){return new this(i).mod(e)}function cc(i,e){return new this(i).mul(e)}function lc(i,e){return new this(i).pow(e)}function mc(i){var e,t,n,r,o=0,s=new this(1),a=[];if(i===void 0?i=this.precision:ze(i,1,vt),n=Math.ceil(i/Y),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)r=e[o],r>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=r%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)r=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),r>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(r%1e7),o+=4);o=n/4}else throw Error(Jo);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],i%=Y,n&&i&&(r=xe(10,Y-i),a[o]=(n/r|0)*r);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=Y)a.shift();for(n=1,r=a[0];r>=10;r/=10)n++;n<Y&&(t-=Y-n)}return s.e=t,s.d=a,s}function dc(i){return U(i=new this(i),i.e+1,this.rounding)}function pc(i){return i=new this(i),i.d?i.d[0]?i.s:0*i.s:i.s||NaN}function fc(i){return new this(i).sin()}function yc(i){return new this(i).sinh()}function bc(i){return new this(i).sqrt()}function gc(i,e){return new this(i).sub(e)}function wc(){var i=0,e=arguments,t=new this(e[i]);for(j=!1;t.s&&++i<e.length;)t=t.plus(e[i]);return j=!0,U(t,this.precision,this.rounding)}function Ac(i){return new this(i).tan()}function Pc(i){return new this(i).tanh()}function kc(i){return U(i=new this(i),i.e+1,1)}L[Symbol.for("nodejs.util.inspect.custom")]=L.toString;L[Symbol.toStringTag]="Decimal";var hn=L.constructor=as(di);fr=new hn(fr);yr=new hn(yr);var V=hn;import{PublicKey as ki}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as hc}from"@solana/spl-token";import{PublicKey as we,SystemProgram as us,SYSVAR_RENT_PUBKEY as Tc}from"@solana/web3.js";function P({pubkey:i,isSigner:e=!1,isWritable:t=!0}){return{pubkey:i,isWritable:t,isSigner:e}}var gi=[P({pubkey:hc,isWritable:!1}),P({pubkey:us.programId,isWritable:!1}),P({pubkey:Tc,isWritable:!1})];function wi({publicKey:i,transformSol:e}){let t=Ai(i.toString());if(t instanceof we)return e&&t.equals(Be)?$:t;if(e&&t.toString()===Be.toBase58())return $;if(typeof t=="string"){if(t===we.default.toBase58())return we.default;try{return new we(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Ai(i){try{return new we(i)}catch{return i}}var un=new we("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),cs=new we("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Ye=new we("SysvarRent111111111111111111111111111111111"),Pi=new we("SysvarC1ock11111111111111111111111111111111"),cn=new we("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Pr=new we("Sysvar1nstructions1111111111111111111111111"),ls=us.programId,Td=new we("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Id=new we("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),xd=new we("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Bd=new we("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Sd=new we("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Kd=new we("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Cd=new we("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Rd=new we("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Ld=new we("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Od=new we("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Nd=new we("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),$=new we("So11111111111111111111111111111111111111112"),Be=we.default;function ln(i){return wi({publicKey:i,transformSol:!0})}import{PublicKey as Ic}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ms}from"@solana/spl-token";var At={chainId:101,address:Ic.default.toBase58(),programId:ms.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Se={chainId:101,address:"So11111111111111111111111111111111111111112",programId:ms.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var hi=class{constructor({mint:e,decimals:t,symbol:n,name:r,skipMint:o=!1,isToken2022:s=!1}){if(e===Be.toBase58()||e instanceof ki&&Be.equals(e)){this.decimals=Se.decimals,this.symbol=Se.symbol,this.name=Se.name,this.mint=new ki(Se.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=r||e.toString().substring(0,6),this.mint=o?ki.default:wi({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ae=hi;Ae.WSOL=new hi({...Se,mint:Se.address});import hr from"big.js";import Sc from"bn.js";import Kc from"decimal.js-light";import xc from"toformat";var Bc=xc,Tn=Bc;var kr=oe("module/fraction"),Ti=Tn(hr),In=Tn(Kc),Cc={[0]:In.ROUND_DOWN,[1]:In.ROUND_HALF_UP,[2]:In.ROUND_UP},Rc={[0]:hr.roundDown,[1]:hr.roundHalfUp,[2]:hr.roundUp},ue=class{constructor(e,t=new Sc(1)){this.numerator=G(e),this.denominator=G(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new ue(this.denominator,this.numerator)}add(e){let t=e instanceof ue?e:new ue(G(e));return this.denominator.eq(t.denominator)?new ue(this.numerator.add(t.numerator),this.denominator):new ue(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof ue?e:new ue(G(e));return this.denominator.eq(t.denominator)?new ue(this.numerator.sub(t.numerator),this.denominator):new ue(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof ue?e:new ue(G(e));return new ue(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof ue?e:new ue(G(e));return new ue(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||kr.logWithError(`${e} is not an integer.`),e<=0&&kr.logWithError(`${e} is not positive.`),In.set({precision:e+1,rounding:Cc[n]});let r=new In(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||kr.logWithError(`${e} is not an integer.`),e<0&&kr.logWithError(`${e} is negative.`),Ti.DP=e,Ti.RM=Rc[n]||1,new Ti(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Oc=oe("Raydium_price"),rt=class extends ue{constructor(t){let{baseToken:n,quoteToken:r,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=r,this.scalar=new ue(Ii(n.decimals),Ii(r.decimals))}get raw(){return new ue(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new rt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Oc.logWithError("mul token not equals");let n=super.mul(t);return new rt({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,r){return this.adjusted.toSignificant(t,n,r)}toFixed(t=this.quoteToken.decimals,n,r){return this.adjusted.toFixed(t,n,r)}};var xi=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Tr=xi;Tr.SOL=new xi(At);import Nc from"bn.js";var ds=new ue(new Nc(100)),$e=class extends ue{toSignificant(e=5,t,n){return this.mul(ds).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(ds).toFixed(e,t,n)}};var Ue=new Qe(0),fs=new Qe(1),Cp=new Qe(2),Rp=new Qe(3),Lp=new Qe(5),Bi=new Qe(10),Op=new Qe(100),Np=new Qe(1e3),Mp=new Qe(1e4),ps=9007199254740991;function G(i){let e=oe("Raydium_parseBigNumberish");if(i instanceof Qe)return i;if(typeof i=="string"){if(i.match(/^-?[0-9]+$/))return new Qe(i);e.logWithError(`invalid BigNumberish string: ${i}`)}return typeof i=="number"?(i%1&&e.logWithError(`BigNumberish number underflow: ${i}`),(i>=ps||i<=-ps)&&e.logWithError(`BigNumberish number overflow: ${i}`),new Qe(String(i))):typeof i=="bigint"?new Qe(i.toString()):(e.error(`invalid BigNumberish value: ${i}`),new Qe(0))}function Ii(i){return Bi.pow(G(i))}function Ir(i,e){let t=i.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}var _c=oe("Raydium_amount"),bs=Tn(Mc);function Vc(i,e){let t="0",n="0";if(i.includes(".")){let r=i.split(".");r.length===2?([t,n]=r,n=n.padEnd(e,"0")):_c.logWithError(`invalid number string, num: ${i}`)}else t=i;return[t,n.slice(0,e)||n]}var he=class extends ue{constructor(t,n,r=!0,o){let s=new xr(0),a=Bi.pow(new xr(t.decimals));if(r)s=G(n);else{let u=new xr(0),c=new xr(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Vc(n.toString(),t.decimals);u=G(l),c=G(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=oe(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new he(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new he(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.token.decimals,n,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return bs.DP=this.token.decimals,new bs(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};function ys(i){return typeof i=="object"&&i!==null&&![Ae,he,Ec,ue,Fc,rt,$e].some(e=>typeof e=="object"&&i instanceof e)}function me(i){return typeof i=="string"?Ai(i):Array.isArray(i)?i.map(e=>me(e)):ys(i)?Object.fromEntries(Object.entries(i).map(([e,t])=>[e,me(t)])):i}import{PublicKey as Kn,sendAndConfirmTransaction as Ri,Transaction as Cn,TransactionMessage as Rn,VersionedTransaction as Ln}from"@solana/web3.js";import Gc from"axios";var _={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};import{PublicKey as ws,ComputeBudgetProgram as gs,Transaction as Br,TransactionMessage as vc,Keypair as As,VersionedTransaction as Ps}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Wc}from"@solana/spl-token";var Ct=oe("Raydium_txUtil"),ks=1644;function Sr(i){let e=[],t=[];return i.microLamports&&(e.push(gs.setComputeUnitPrice({microLamports:i.microLamports})),t.push(_.SetComputeUnitPrice)),i.units&&(e.push(gs.setComputeUnitLimit({units:i.units})),t.push(_.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function mn(i){var e,t;try{return((t=await((e=i.getLatestBlockhash)==null?void 0:e.call(i)))==null?void 0:t.blockhash)||(await i.getRecentBlockhash()).blockhash}catch{return(await i.getRecentBlockhash()).blockhash}}function Kr(i,e){i.length<1&&Ct.logWithError(`no instructions provided: ${i.toString()}`),e.length<1&&Ct.logWithError(`no signers provided:, ${e.toString()}`);let t=new Br;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...i);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<ks}catch{return!1}}async function hs(i,e,t,n=!0){let r=new ws("RaydiumSimuLateTransaction11111111111111111"),o=[],s=new Br;s.feePayer=r;for(let c of e)Kr([...s.instructions,c],[r])||(o.push(s),s=new Br,s.feePayer=r),s.add(c);s.instructions.length>0&&o.push(s);let a=[];try{if(a=await Dc(i,o,n),a.find(c=>c.err!==null))throw Error("rpc simulateTransaction error")}catch(c){c instanceof Error&&Ct.logWithError("failed to simulate for instructions","RPC_ERROR",{message:c.message})}let u=[];for(let c of a)if(Ct.debug("simulate result:",c),c.logs){let l=c.logs.filter(m=>m&&m.includes(t));Ct.debug("filteredLog:",u),l.length||Ct.logWithError("simulate log not match keyword","keyword",t),u.push(...l)}return u}function Ts(i,e){let t=i.match(/{["\w:,]+}/g);return!t||t.length!==1?Ct.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function Rt(i,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(i);return!n||n.length!==2?Ct.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ne(i,e){let[t,n]=ws.findProgramAddressSync(i,e);return{publicKey:t,nonce:n}}async function Dc(i,e,t){let n=[];if(t){let r=await i.getLatestBlockhash(),o=[];for(let c of e){c.recentBlockhash=r.blockhash,c.lastValidBlockHeight=r.lastValidBlockHeight;let m=c._compile().serialize(),d=c._serialize(m).toString("base64");o.push(d)}let s=o.map(c=>{let l=i._buildArgs([c],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],u=20;for(let c=0;c<Math.ceil(s.length/u);c++)a.push(s.slice(c*u,(c+1)*u));n=await(await Promise.all(a.map(async c=>(await i._rpcBatchRequest(c)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async r=>await(await i.simulateTransaction(r)).value))}catch(r){r instanceof Error&&Ct.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:r.message})}return n}function xn({instructions:i,payer:e,signers:t}){return Kr(i,[e,...t])}function Bn({instructions:i,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=As.generate().publicKey.toString()}){let o=new vc({payerKey:e,recentBlockhash:n,instructions:i}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Ps(o).serialize()).toString("base64").length<ks}catch{return!1}}var qc=i=>Buffer.isBuffer(i)?i:i instanceof Uint8Array?Buffer.from(i.buffer,i.byteOffset,i.byteLength):Buffer.from(i);function Yt(i){let e=[];return i.forEach(t=>{t instanceof Br&&(t.recentBlockhash||(t.recentBlockhash=Wc.toBase58()),t.feePayer||(t.feePayer=As.generate().publicKey));let n=t.serialize({requireAllSignatures:!1,verifySignatures:!1});t instanceof Ps&&(n=qc(n));let r=n.toString("base64");e.push(r)}),console.log("simulate tx string:",e),e}import{PublicKey as Is,AddressLookupTableAccount as Cr}from"@solana/web3.js";import{PublicKey as Uc}from"@solana/web3.js";import{getTransferFeeConfig as hf,unpackMint as Tf}from"@solana/spl-token";var Si=oe("Raydium_accountInfo_util");async function Pt(i,e,t){let{batchRequest:n,commitment:r="confirmed"}={batchRequest:!1,...t},o=Ki(e,100),s=new Array(o.length).fill([]);if(n){let a=o.map(l=>{let m=i._buildArgs([l.map(p=>p.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=Ki(a,10);s=(await(await Promise.all(u.map(async l=>await i._rpcBatchRequest(l)))).flat()).map(l=>(l.error&&Si.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${l.error.message}`),l.result.value.map(m=>{if(m){let{data:p,executable:d,lamports:y,owner:f,rentEpoch:b}=m;return p.length!==2&&p[1]!=="base64"&&Si.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:d,lamports:y,owner:new Uc(f),rentEpoch:b}}return null})))}else try{s=await Promise.all(o.map(a=>i.getMultipleAccountsInfo(a,r)))}catch(a){a instanceof Error&&Si.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return s.flat()}async function Sn(i,e,t){let n=await Pt(i,e.map(r=>r.pubkey),t);return e.map((r,o)=>({...r,accountInfo:n[o]}))}async function Ci({connection:i,address:e}){let t=await Pt(i,[...new Set(e.map(r=>r.toString()))].map(r=>new Is(r))),n={};for(let r=0;r<e.length;r++){let o=t[r],s=e[r];if(!o)continue;let a=new Cr({key:s,state:Cr.deserialize(o.data)});n[s.toString()]=a,Rr[s.toString()]=a}return n}var Rr={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new Cr({key:new Is("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:Cr.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};var Lr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Gc.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=Sr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:r=[],endInstructionTypes:o=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...r),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...s.filter(a=>a!==Kn.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0({...t||{}}):this.build(t)}build(e){let t=new Cn;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async n=>{var a;let{recentBlockHash:r,skipPreflight:o=!0}=n||{},s=r!=null?r:await mn(this.connection);if(t.recentBlockhash=s,this.signers.length&&t.sign(...this.signers),Yt([t]),(a=this.owner)!=null&&a.isKeyPair)return{txId:await Ri(this.connection,t,this.signers.find(u=>u.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:o}),signedTx:t};if(this.signAllTransactions){let u=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(u[0].serialize(),{skipPreflight:o}),signedTx:u[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:r}=this.build(n),o=t.filter(c=>c.transaction.instructions.length>0),s=[r,...o.map(c=>c.transaction)],a=[this.signers,...o.map(c=>c.signers)],u=[...this.instructionTypes,...o.map(c=>c.instructionTypes).flat()];return{builder:this,transactions:s,signers:a,instructionTypes:u,execute:async c=>{var f;let{sequentially:l,onTxUpdate:m,recentBlockHash:p,skipPreflight:d=!0}=c||{},y=p!=null?p:await mn(this.connection);if((f=this.owner)!=null&&f.isKeyPair)return{txIds:await await Promise.all(s.map(async(b,g)=>(b.recentBlockhash=y,await Ri(this.connection,b,a[g].find(A=>A.publicKey.equals(this.owner.publicKey))?a[g]:[...a[g],this.owner.signer],{skipPreflight:d})))),signedTxs:s};if(this.signAllTransactions){let b=s.map((A,k)=>(A.recentBlockhash=y,a[k].length&&A.sign(...a[k]),A));Yt(b);let g=await this.signAllTransactions(b);if(l){let A=0,k=[],h=async()=>{if(!g[A])return;let T=await this.connection.sendRawTransaction(g[A].serialize(),{skipPreflight:d});k.push({txId:T,status:"sent",signedTx:g[A]}),m==null||m([...k]),A++,this.connection.onSignature(T,I=>{let S=k.findIndex(x=>x.txId===T);S>-1&&(k[S].status=I.err?"error":"success"),m==null||m([...k]),I.err||h()},"processed"),this.connection.getSignatureStatus(T)};return await h(),{txIds:k.map(T=>T.txId),signedTxs:g}}else{let A=[];for(let k=0;k<g.length;k+=1){let h=await this.connection.sendRawTransaction(g[k].serialize(),{skipPreflight:d});A.push(h)}return{txIds:A,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){let{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:r,...o}=e||{},s={...this.cluster==="devnet"?{}:Rr,...t},a=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let p of a)s[p]===void 0&&u.push(new Kn(p));let c=await Ci({connection:this.connection,address:u});for(let[p,d]of Object.entries(c))s[p]=d;let l=new Rn({payerKey:this.feePayer,recentBlockhash:r?Kn.default.toBase58():await mn(this.connection),instructions:[...this.allInstructions]}).compileToV0Message(Object.values(s)),m=new Ln(l);return m.sign(this.signers),{builder:this,transaction:m,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async p=>{var f;let{recentBlockHash:d,skipPreflight:y=!0}=p||{};if(d&&(m.message.recentBlockhash=d),Yt([m]),(f=this.owner)!=null&&f.isKeyPair){this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))||m.sign([this.owner.signer]);let b=await this.connection.sendTransaction(m,{skipPreflight:y}),{lastValidBlockHeight:g,blockhash:A}=await this.connection.getLatestBlockhash();return await this.connection.confirmTransaction({blockhash:A,lastValidBlockHeight:g,signature:b},"confirmed"),{txId:b,signedTx:m}}if(this.signAllTransactions){let b=await this.signAllTransactions([m]);return{txId:await this.connection.sendTransaction(b[0],{skipPreflight:y}),signedTx:b[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:r}=await this.buildV0(n),o=t.filter(c=>c.builder.instructions.length>0),s=[r,...o.map(c=>c.transaction)],a=[this.signers,...o.map(c=>c.signers)],u=[...this.instructionTypes,...o.map(c=>c.instructionTypes).flat()];return s.forEach(async(c,l)=>{c.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:u,buildProps:n,execute:async c=>{var y;let{sequentially:l,onTxUpdate:m,recentBlockHash:p,skipPreflight:d=!0}=c||{};if(p&&s.forEach(f=>f.message.recentBlockhash=p),Yt(s),(y=this.owner)!=null&&y.isKeyPair){let{lastValidBlockHeight:f,blockhash:b}=await this.connection.getLatestBlockhash();return s.forEach((g,A)=>{a[A].find(k=>k.publicKey.equals(this.owner.publicKey))||g.sign([this.owner.signer])}),{txIds:await Promise.all(s.map(async g=>{let A=await this.connection.sendTransaction(g,{skipPreflight:d});return await this.connection.confirmTransaction({blockhash:b,lastValidBlockHeight:f,signature:A},"confirmed"),A})),signedTxs:s}}if(this.signAllTransactions){let f=await this.signAllTransactions(s);if(l){let b=0,g=[],A=async()=>{if(!f[b])return;let k=await this.connection.sendTransaction(f[b],{skipPreflight:d});g.push({txId:k,status:"sent",signedTx:f[b]}),m==null||m([...g]),b++,this.connection.onSignature(k,h=>{let T=g.findIndex(I=>I.txId===k);T>-1&&(g[T].status=h.err?"error":"success"),m==null||m([...g]),h.err||A()},"processed"),this.connection.getSignatureStatus(k)};return A(),{txIds:[],signedTxs:f}}else{let b=[];for(let g=0;g<f.length;g+=1){let A=await this.connection.sendTransaction(f[g],{skipPreflight:d});b.push(A)}return{txIds:b,signedTxs:f}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{computeBudgetConfig:t,...n}=e||{},r=t?Sr(t):{instructions:[],instructionTypes:[]},o=this.signers.reduce((c,l)=>({...c,[l.publicKey.toBase58()]:l}),{}),s=[],a=[],u=[];if(this.allInstructions.forEach(c=>{let l=[...u,c],m=t?[...r.instructions,...l]:l,d=[...new Set(l.map(y=>y.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat()).values()].map(y=>new Kn(y));if(u.length<12&&xn({instructions:m,payer:this.feePayer,signers:d})||xn({instructions:l,payer:this.feePayer,signers:d}))u.push(c);else{if(u.length===0)throw Error("item ins too big");xn({instructions:t?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:d})?s.push(new Cn().add(...r.instructions,...u)):s.push(new Cn().add(...u)),a.push(Array.from(new Set(u.map(y=>y.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat())).map(y=>o[y]).filter(y=>y!==void 0)),u=[c]}}),u.length>0){let l=[...new Set(u.map(m=>m.keys.filter(p=>p.isSigner).map(p=>p.pubkey.toString())).flat()).values()].map(m=>o[m]).filter(m=>m!==void 0);xn({instructions:t?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:l.map(m=>m.publicKey)})?s.push(new Cn().add(...r.instructions,...u)):s.push(new Cn().add(...u)),a.push(l)}return s.forEach(c=>c.feePayer=this.feePayer),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async c=>{var f;let{sequentially:l,onTxUpdate:m,recentBlockHash:p,skipPreflight:d=!0}=c||{},y=p!=null?p:await mn(this.connection);if(s.forEach(async(b,g)=>{b.recentBlockhash=y,a[g].length&&b.sign(...a[g])}),Yt(s),(f=this.owner)!=null&&f.isKeyPair)return{txIds:await Promise.all(s.map(async(b,g)=>await Ri(this.connection,b,a[g].find(A=>A.publicKey.equals(this.owner.publicKey))?a[g]:[...a[g],this.owner.signer],{skipPreflight:d}))),signedTxs:s};if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(l){let g=0,A=[],k=async()=>{if(!b[g])return;let h=await this.connection.sendRawTransaction(b[g].serialize(),{skipPreflight:d});A.push({txId:h,status:"sent",signedTx:b[g]}),m==null||m([...A]),g++,this.connection.onSignature(h,T=>{let I=A.findIndex(S=>S.txId===h);I>-1&&(A[I].status=T.err?"error":"success"),m==null||m([...A]),T.err||k()},"processed"),this.connection.getSignatureStatus(h)};return await k(),{txIds:A.map(h=>h.txId),signedTxs:b}}else{let g=[];for(let A=0;A<b.length;A+=1){let k=await this.connection.sendRawTransaction(b[A].serialize(),{skipPreflight:d});g.push(k)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:r=[],...o}=e||{},s={...this.cluster==="devnet"?{}:Rr,...n},a=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let b of a)s[b]===void 0&&u.push(new Kn(b));let c=await Ci({connection:this.connection,address:u});for(let[b,g]of Object.entries(c))s[b]=g;let l=t?Sr(t):{instructions:[],instructionTypes:[]},m=await mn(this.connection),p=this.signers.reduce((b,g)=>({...b,[g.publicKey.toBase58()]:g}),{}),d=[],y=[],f=[];if(this.allInstructions.forEach(b=>{let g=[...f,b],A=t?[...l.instructions,...g]:g;if(f.length<12&&Bn({instructions:A,payer:this.feePayer,lookupTableAddressAccount:s})||Bn({instructions:g,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(b);else{if(f.length===0)throw Error("item ins too big");let k={};for(let h of[...new Set(a)])s[h]!==void 0&&(k[h]=s[h]);if(t&&Bn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let h=new Rn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));d.push(new Ln(h))}else{let h=new Rn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));d.push(new Ln(h))}y.push(Array.from(new Set(f.map(h=>h.keys.filter(T=>T.isSigner).map(T=>T.pubkey.toString())).flat())).map(h=>p[h]).filter(h=>h!==void 0)),f=[b]}}),f.length>0){let g=[...new Set(f.map(A=>A.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat()).values()].map(A=>p[A]).filter(A=>A!==void 0);if(t&&Bn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let A=new Rn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));d.push(new Ln(A))}else{let A=new Rn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));d.push(new Ln(A))}y.push(g)}return{builder:this,transactions:d,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async b=>{var T;let{sequentially:g,onTxUpdate:A,recentBlockHash:k,skipPreflight:h=!0}=b||{};if(d.map(async(I,S)=>{y[S].length&&I.sign(y[S]),k&&(I.message.recentBlockhash=k)}),Yt(d),(T=this.owner)!=null&&T.isKeyPair){let{lastValidBlockHeight:I,blockhash:S}=await this.connection.getLatestBlockhash();return d.forEach((x,K)=>{y[K].find(N=>N.publicKey.equals(this.owner.publicKey))||x.sign([this.owner.signer])}),{txIds:await Promise.all(d.map(async x=>{let K=await this.connection.sendTransaction(x,{skipPreflight:h});return await this.connection.confirmTransaction({blockhash:S,lastValidBlockHeight:I,signature:K},"confirmed"),K})),signedTxs:d}}if(this.signAllTransactions){let I=await this.signAllTransactions(d);if(g){let S=0,x=[],K=async()=>{if(!I[S])return;let N=await this.connection.sendTransaction(I[S],{skipPreflight:h});x.push({txId:N,status:"sent",signedTx:I[S]}),A==null||A([...x]),S++,this.connection.onSignature(N,E=>{let z=x.findIndex(v=>v.txId===N);z>-1&&(x[z].status=E.err?"error":"success"),A==null||A([...x]),E.err||K()},"processed"),this.connection.getSignatureStatus(N)};return K(),{txIds:[],signedTxs:I}}else{let S=[];for(let x=0;x<I.length;x+=1){let K=await this.connection.sendTransaction(I[x],{skipPreflight:h});S.push(K)}return{txIds:S,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}};var dt=class{constructor(e){this._owner=e}get publicKey(){return dt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return dt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return dt.isKeyPair(this._owner)}get isPublicKey(){return dt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!dt.isKeyPair(e)}};function Ki(i,e=1,t=[]){let n=[...i];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var xs=i=>typeof i=="number";function Bs(i,e,t){let n=xs(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(i).getTime()<=+n}function Ss(i,e,t){let n=xs(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(i).getTime()>+n}import{PublicKey as Ie}from"@solana/web3.js";var Ks=new Ie("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Cs=new Ie("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),On=new Ie("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Xf=new Ie("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),zf=new Ie("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Oi=new Ie("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Rs=new Ie("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Yf=new Ie("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),Qf=new Ie("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Hf=new Ie("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Xc=new Ie("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),zc=new Ie("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Yc=new Ie("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Qc=new Ie("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),jf=new Ie("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Zf=new Ie("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),$f=new Ie("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Jf=new Ie("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),ey=new Ie("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),ty=new Ie("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Nn={IDO_PROGRAM_ID_V1:Xc,IDO_PROGRAM_ID_V2:zc,IDO_PROGRAM_ID_V3:Yc,IDO_PROGRAM_ID_V4:Qc};import{PublicKey as Hc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as jc}from"@solana/spl-token";function de(i,e,t){return ne([i.toBuffer(),(t!=null?t:jc).toBuffer(),e.toBuffer()],new Hc("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import pt from"bn.js";var Mn=1e4;function be(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let r={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},o=t.epoch<r.newerTransferFee.epoch?r.olderTransferFee:r.newerTransferFee,s=new pt(o.maximumFee.toString()),a=t.epoch<r.newerTransferFee.epoch?(Number(r.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===Mn){let u=new pt(o.maximumFee.toString());return{amount:i.add(u),fee:u,expirationTime:a}}else{let u=_n(i.mul(new pt(Mn)),new pt(Mn-o.transferFeeBasisPoints)),c=new pt(o.maximumFee.toString()),l=u.sub(i).gt(c)?i.add(c):u,m=_n(l.mul(new pt(o.transferFeeBasisPoints)),new pt(Mn)),p=m.gt(s)?s:m;return{amount:l,fee:p,expirationTime:a}}else{let u=_n(i.mul(new pt(o.transferFeeBasisPoints)),new pt(Mn)),c=u.gt(s)?s:u;return{amount:i,fee:c,expirationTime:a}}}function Qt(i,e){return i===void 0?e:e===void 0?i:Math.min(i,e)}function _n(i,e){let{div:t,mod:n}=i.divmod(e);return n.gt(new pt(0))?t.add(new pt(1)):t}var Oe={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://token.jup.ag/{type}",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee"},Sy={...Oe};var Ls="ray_tab_hash",Ni="ray_req_hash",Zc=()=>{if(typeof window===void 0)return"";let i=sessionStorage.getItem(Ls);return i||(i=`ray-${Date.now()}`,sessionStorage.setItem(Ls,i)),i},Or=async({logCount:i=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(r=>r());let n=JSON.parse(localStorage.getItem(Ni)||"[]").slice(0,i-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:Zc()});try{localStorage.setItem(Ni,JSON.stringify(n))}catch{if(e){let r=!1,o=JSON.stringify(t.data).substring(0,100);for(n[0].data=o+(o.length>100?"...":"");!r;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(Ni,JSON.stringify(n)),r=!0}catch{r=!1}}return new Promise(s=>s())}return Or({...t,logCount:i,removeLastLog:!0})}};var Nr=oe("Raydium_Api"),Mi=new Map;var Mr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:r,urlConfigs:o}){this.cluster=e,this.urlConfigs=o||{},this.logCount=r||1e3,this.api=$c.create({baseURL:this.urlConfigs.BASE_HOST||Oe.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:u,url:c}=s;return Nr.debug(`${a==null?void 0:a.toUpperCase()} ${u}${c}`),s},s=>(Nr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:u,status:c}=s,{method:l,baseURL:m,url:p}=a;return n&&Or({status:c,url:`${m}${p}`,params:a.params,data:u,logCount:this.logCount}),Nr.debug(`${l==null?void 0:l.toUpperCase()} ${m}${p}  ${c}`),u},s=>{let{config:a,response:u={}}=s,{status:c}=u,{method:l,baseURL:m,url:p}=a;return n&&Or({status:c,url:`${m}${p}`,params:a.params,data:s.message,logCount:this.logCount}),Nr.error(`${l.toUpperCase()} ${m}${p} ${c||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Oe.CLMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Oe.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await this.api.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(r=>r.numSlots);return n.reduce((r,o)=>r+o,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Oe.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Oe.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Oe.TOKEN_LIST)).data}async getJupTokenList(e){return this.api.get("/",{baseURL:(this.urlConfigs.JUP_TOKEN_LIST||Oe.JUP_TOKEN_LIST).replace("{type}",e||"all")})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Oe.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:r="desc",page:o=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Oe.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${r}&page=${o}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Oe.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],r=t.filter(s=>Mi.has(s)?(n.push(Mi.get(s)),!1):!0),o=[];return r.length&&(o=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Oe.POOL_KEY_BY_ID)+`?ids=${r.join(",")}`)).data.filter(Boolean),o.forEach(a=>{Mi.set(a.id,a)})),n.concat(o)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:r="all",sort:o="default",order:s="desc",page:a=1}=e,[u,c]=[t&&ln(t).toBase58(),n&&n!=="undefined"?ln(n).toBase58():""],[l,m]=c&&u>c?[c,u]:[u,c];return console.log(123123555,`?mint1=${l}&mint2=${m}&poolType=${r}&poolSortField=${o}&sortType=${s}&pageSize=100&page=${a}`),(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Oe.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${r}&poolSortField=${o}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Oe.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Oe.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Oe.CHECK_AVAILABILITY)).data}};var _r="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",Ns="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{createAssociatedTokenAccountInstruction as Xi,TOKEN_PROGRAM_ID as Ot,AccountLayout as Ut,TOKEN_2022_PROGRAM_ID as Sl}from"@solana/spl-token";import{PublicKey as Ur,SystemProgram as Kl}from"@solana/web3.js";var _i=(...i)=>i.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Pe=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=oe(t)}createTxBuilder(e){return this.scope.checkOwner(),new Lr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(_i(e))}logInfo(...e){this.logger.info(_i(e))}logAndCreateError(...e){let t=_i(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{createInitializeAccountInstruction as kl,createCloseAccountInstruction as hl,createTransferInstruction as Tl,TOKEN_PROGRAM_ID as dn}from"@solana/spl-token";import{PublicKey as Il,SystemProgram as xl}from"@solana/web3.js";import Bl from"bn.js";import{PublicKey as Ys,Keypair as gl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as wl}from"@solana/spl-token";import Al from"bn.js";import{PublicKey as ll}from"@solana/web3.js";import Fs,{isBN as vs}from"bn.js";import{bits as Jc,BitStructure as ab,blob as el,Blob as ub,cstr as cb,f32 as lb,f32be as mb,f64 as db,f64be as pb,greedy as fb,Layout as tl,ns64 as yb,ns64be as bb,nu64 as nl,nu64be as gb,offset as wb,s16 as Ab,s16be as Pb,s24 as kb,s24be as hb,s32 as rl,s32be as Tb,s40 as Ib,s40be as xb,s48 as Bb,s48be as Sb,s8 as Kb,seq as il,struct as Cb,Structure as ol,u16 as sl,u16be as Rb,u24 as Lb,u24be as Ob,u32 as al,u32be as Nb,u40 as Mb,u40be as _b,u48 as Vb,u48be as Eb,u8 as ul,UInt as cl,union as Fb,Union as vb,unionLayoutDiscriminator as Wb,utf8 as Db}from"@solana/buffer-layout";var Vr=tl,Ms=ol;var Vi=cl;var _s=ul,kt=sl;var Ei=al;var Vs=nl;var Ne=rl;var Es=il;var le=el;var Fi=Jc;var Ht=class extends Vr{constructor(t,n,r){super(t,r);this.blob=le(t),this.signed=n}decode(t,n=0){let r=new Fs(this.blob.decode(t,n),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,n,r=0){return typeof t=="number"&&(t=new Fs(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,r)}},Er=class extends Vr{constructor(t){super(8,t);this._lower=Fi(Ei(),!1),this._upper=Fi(Ei(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let r=this._lower.decode(t,n),o=this._upper.decode(t,n+this._lower.span);return{...r,...o}}encode(t,n,r=0){return this._lower.encode(t,n,r)+this._upper.encode(t,n,r+this._lower.span)}};function M(i){return new Vi(1,i)}function Ee(i){return new Vi(4,i)}function w(i){return new Ht(8,!1,i)}function X(i){return new Ht(16,!1,i)}function Ws(i){return new Ht(1,!0,i)}function vr(i){return new Ht(8,!0,i)}function Ds(i){return new Ht(16,!0,i)}var Fr=class extends Vr{constructor(t,n,r,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=r}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,r){return this.layout.encode(this.encoder(t),n,r)}getSpan(t,n){return this.layout.getSpan(t,n)}};function B(i){return new Fr(le(32),e=>new ll(e),e=>e.toBuffer(),i)}function Me(i){return new Fr(_s(),ml,dl,i)}function ml(i){if(i===0)return!1;if(i===1)return!0;throw new Error("Invalid bool: "+i)}function dl(i){return i?1:0}var vi=class extends Ms{decode(e,t){return super.decode(e,t)}};function O(i,e,t){return new vi(i,e,t)}function W(i,e,t){let n,r=typeof e=="number"?e:vs(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=vs(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return Es(i,r,t)}var Wt=O([B("mint"),B("owner"),w("amount"),Ee("delegateOption"),B("delegate"),M("state"),Ee("isNativeOption"),w("isNative"),w("delegatedAmount"),Ee("closeAuthorityOption"),B("closeAuthority")]);function pl(i){return i instanceof Uint8Array||i!=null&&typeof i=="object"&&i.constructor.name==="Uint8Array"}function Wi(i,...e){if(!pl(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${i.length}`)}function Di(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function qs(i,e){Wi(i);let t=e.outputLen;if(i.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Dr=i=>new DataView(i.buffer,i.byteOffset,i.byteLength),ft=(i,e)=>i<<32-e|i>>>e;var ng=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function fl(i){if(typeof i!="string")throw new Error(`utf8ToBytes expected string, got ${typeof i}`);return new Uint8Array(new TextEncoder().encode(i))}function qi(i){return typeof i=="string"&&(i=fl(i)),Wi(i),i}var Wr=class{clone(){return this._cloneInto()}},rg={}.toString;function Us(i){let e=n=>i().update(qi(n)).digest(),t=i();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>i(),e}function yl(i,e,t,n){if(typeof i.setBigUint64=="function")return i.setBigUint64(e,t,n);let r=BigInt(32),o=BigInt(4294967295),s=Number(t>>r&o),a=Number(t&o),u=n?4:0,c=n?0:4;i.setUint32(e+u,s,n),i.setUint32(e+c,a,n)}var Gs=(i,e,t)=>i&e^~i&t,Xs=(i,e,t)=>i&e^i&t^e&t,qr=class extends Wr{constructor(e,t,n,r){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Dr(this.buffer)}update(e){Di(this);let{view:t,buffer:n,blockLen:r}=this;e=qi(e);let o=e.length;for(let s=0;s<o;){let a=Math.min(r-this.pos,o-s);if(a===r){let u=Dr(e);for(;r<=o-s;s+=r)this.process(u,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Di(this),qs(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:r,isLE:o}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>r-s&&(this.process(n,0),s=0);for(let m=s;m<r;m++)t[m]=0;yl(n,r-8,BigInt(this.length*8),o),this.process(n,0);let a=Dr(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let c=u/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<c;m++)a.setUint32(4*m,l[m],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:r,finished:o,destroyed:s,pos:a}=this;return e.length=r,e.pos=a,e.finished=o,e.destroyed=s,r%t&&e.buffer.set(n),e}};var bl=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Dt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),qt=new Uint32Array(64),Ui=class extends qr{constructor(){super(64,32,8,!1),this.A=Dt[0]|0,this.B=Dt[1]|0,this.C=Dt[2]|0,this.D=Dt[3]|0,this.E=Dt[4]|0,this.F=Dt[5]|0,this.G=Dt[6]|0,this.H=Dt[7]|0}get(){let{A:e,B:t,C:n,D:r,E:o,F:s,G:a,H:u}=this;return[e,t,n,r,o,s,a,u]}set(e,t,n,r,o,s,a,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=r|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=u|0}process(e,t){for(let m=0;m<16;m++,t+=4)qt[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let p=qt[m-15],d=qt[m-2],y=ft(p,7)^ft(p,18)^p>>>3,f=ft(d,17)^ft(d,19)^d>>>10;qt[m]=f+qt[m-7]+y+qt[m-16]|0}let{A:n,B:r,C:o,D:s,E:a,F:u,G:c,H:l}=this;for(let m=0;m<64;m++){let p=ft(a,6)^ft(a,11)^ft(a,25),d=l+p+Gs(a,u,c)+bl[m]+qt[m]|0,f=(ft(n,2)^ft(n,13)^ft(n,22))+Xs(n,r,o)|0;l=c,c=u,u=a,a=s+d|0,s=o,o=r,r=n,n=d+f|0}n=n+this.A|0,r=r+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,u=u+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,r,o,s,a,u,c,l)}roundClean(){qt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var zs=Us(()=>new Ui);var Pg=oe("Raydium_Util");function Qs({owner:i,solAccountResp:e,tokenAccountResp:t}){let n=[],r=[];for(let{pubkey:o,account:s}of t.value){let a=Wt.decode(s.data),{mint:u,amount:c}=a;n.push({publicKey:o,mint:u,amount:c,isAssociated:de(i,u,s.owner).publicKey.equals(o),isNative:!1,programId:s.owner}),r.push({pubkey:o,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Ys.default,amount:new Al(e.lamports),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:r}}function Fe({fromPublicKey:i,programId:e=wl}){let t=gl.generate().publicKey.toBase58().slice(0,32);return{publicKey:Pl(i,t,e),seed:t}}function Pl(i,e,t){let n=Buffer.concat([i.toBuffer(),Buffer.from(e),t.toBuffer()]),r=zs(n);return new Ys(r)}function Gi(i){let{mint:e,tokenAccount:t,owner:n,programId:r=dn}=i;return kl(t,e,n,r)}function Lt(i){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:r,programId:o=dn}=i;return hl(e,t,r,n,o)}async function ht(i){let{connection:e,amount:t,commitment:n,payer:r,owner:o,skipCloseAccount:s}=i,a=await e.getMinimumBalanceForRentExemption(Wt.span,n),u=G(t).add(new Bl(a)),c=Fe({fromPublicKey:r,programId:dn});return{addresses:{newAccount:c.publicKey},signers:[],instructions:[xl.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:c.seed,newAccountPubkey:c.publicKey,lamports:u.toNumber(),space:Wt.span,programId:dn}),Gi({mint:new Il(Se.address),tokenAccount:c.publicKey,owner:o,programId:dn})],instructionTypes:[_.CreateAccount,_.InitAccount],endInstructionTypes:s?[]:[_.CloseAccount],endInstructions:s?[]:[Lt({tokenAccount:c.publicKey,payer:r,owner:o})]}}function Vn({source:i,destination:e,owner:t,amount:n,multiSigners:r=[],tokenProgram:o=dn}){return Tl(i,e,t,BigInt(String(n)),r,o)}var En=class extends Pe{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:n,tokenAccountRawInfos:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=r||[],this._clientOwnedToken=!!(n||r)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return de(this.scope.ownerPubKey,t,n).publicKey}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let r={...{},...t},[o,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,r.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Ot},r.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Sl},r.commitment)]),{tokenAccounts:u,tokenAccountRawInfos:c}=Qs({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=u,this._tokenAccountRawInfos=c,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:u,tokenAccountRawInfos:c}}async getCreatedTokenAccount({mint:t,programId:n=Ot,associatedOnly:r=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of o){let{publicKey:u}=a;if(u&&(!r||r&&s.equals(u)))return u}}async getOrCreateTokenAccount(t){var y,f,b;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:r,associatedOnly:o,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:u=!1,checkCreateATAOwner:c=!1}=t,l=new Ur(t.tokenProgram||Ot),m=this.getAssociatedTokenAccount(n,new Ur(l)),p=(a?[]:this.tokenAccountRawInfos).filter(g=>g.accountInfo.mint.equals(n)&&(!o||g.pubkey.equals(m))).sort((g,A)=>g.accountInfo.amount.lt(A.accountInfo.amount)?1:-1);if(r===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let d={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let g=Xi(s,m,s,n,l);if(c){let A=await this.scope.connection.getAccountInfo(m);if(A===null)(y=d.instructions)==null||y.push(g),d.instructionTypes.push(_.CreateATA);else if(!(A.owner.equals(l)&&Ut.decode(A.data).mint.equals(n)&&Ut.decode(A.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else d.instructions.push(g),d.instructionTypes.push(_.CreateATA);if(n.equals($)&&r.amount){let A=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r.payer||this.scope.ownerPubKey,amount:(f=r.amount)!=null?f:0,skipCloseAccount:u});d.instructions.push(...A.instructions||[]),d.endInstructions.push(...A.endInstructions||[]),d.instructionTypes.push(...A.instructionTypes||[]),d.endInstructionTypes.push(...A.endInstructionTypes||[]),r.amount&&(d.instructions.push(Vn({source:A.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:r.amount,tokenProgram:Ot})),d.instructionTypes.push(_.TransferAmount))}return u||(d.endInstructions.push(Lt({owner:s,payer:r.payer||s,tokenAccount:m,programId:l})),d.endInstructionTypes.push(_.CloseAccount)),{account:m,instructionParams:d}}else if(n.equals($)){let g=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r.payer||this.scope.ownerPubKey,amount:(b=r.amount)!=null?b:0,skipCloseAccount:u});return d.instructions.push(...g.instructions||[]),d.endInstructions.push(...g.endInstructions||[]),d.signers.push(...g.signers||[]),d.instructionTypes.push(...g.instructionTypes||[]),d.endInstructionTypes.push(...g.endInstructionTypes||[]),{account:g.addresses.newAccount,instructionParams:d}}else{let g=Fe({fromPublicKey:s,programId:l}),A=await this.scope.connection.getMinimumBalanceForRentExemption(Ut.span),k=Kl.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:g.seed,newAccountPubkey:g.publicKey,lamports:A,space:Ut.span,programId:l});return d.instructions.push(k,Gi({mint:n,tokenAccount:g.publicKey,owner:this.scope.ownerPubKey,programId:l})),d.instructionTypes.push(_.CreateAccount),d.instructionTypes.push(_.InitAccount),u||(d.endInstructions.push(Lt({owner:s,payer:r.payer||s,tokenAccount:g.publicKey,programId:l})),d.endInstructionTypes.push(_.CloseAccount)),{account:g.publicKey,instructionParams:d}}}async checkOrCreateAta({mint:t,programId:n=Ot,autoUnwrapWSOLToSOL:r}){var u;await this.fetchWalletTokenAccounts();let o=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,s=this.scope.ownerPubKey,a={};if(!o){let c=this.getAssociatedTokenAccount(t,n),l=await Xi(s,c,s,t,n);a.instructions=[l],a.instructionTypes=[_.CreateATA],o=c}return r&&$.toBase58()===t.toBase58()&&(a.endInstructions=[Lt({owner:s,payer:s,tokenAccount:o,programId:n})],a.endInstructionTypes=[_.CloseAccount]),{pubKey:o,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:r,mint:o,programId:s=Ot,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:l,checkCreateATAOwner:m}=t,p=this.getAssociatedTokenAccount(o,s);if(new Ur($).equals(o)){let d=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:r,skipCloseAccount:l});return{tokenAccount:d.addresses.newAccount,...d}}else if(!a||n==="out"&&!p.equals(a)&&!c){let d=[],y=Xi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,o,s);if(m){let f=await this.scope.connection.getAccountInfo(p);if(f===null)d.push(y);else if(!(f.owner.equals(Ot)&&Ut.decode(f.data).mint.equals(o)&&Ut.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${p.toString()}
          ataInfo.owner: ${f.owner.toString()}, TOKEN_PROGRAM_ID: ${Ot.toString()},
          ataInfo.data.mint: ${Ut.decode(f.data).mint.toString()}, mint: ${o.toString()},
          ataInfo.data.owner: ${Ut.decode(f.data).owner.toString()}, owner: ${this.scope.ownerPubKey.toString()}`)}else d.push(y);return{tokenAccount:p,instructions:d,instructionTypes:[_.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:r=Ot,amount:o,useSOLBalance:s,handleTokenAccount:a}=t,u,c=this.createTxBuilder();if(n.equals(new Ur($))&&s){let{tokenAccount:l,...m}=await this.handleTokenAccount({side:"in",amount:o||0,mint:n,bypassAssociatedCheck:!0,programId:r});u=l,c.addInstruction(m)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:r}),!u&&a){let{tokenAccount:l,...m}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:r});u=l,c.addInstruction(m)}return{tokenAccount:u,...c.AllTxData}}};import{createAssociatedTokenAccountInstruction as Hl}from"@solana/spl-token";import{PublicKey as ge,SystemProgram as jl}from"@solana/web3.js";import{PublicKey as ta}from"@solana/web3.js";var zi=O([M("instruction")]),Yi=O([M("instruction")]),Cl=O([w("rewardState"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardLastUpdateTime"),w("totalReward"),w("totalRewardEmissioned"),w("rewardClaimed"),w("rewardPerSecond"),X("accRewardPerShare"),B("rewardVault"),B("rewardMint"),B("rewardSender"),w("rewardType"),W(w(),15,"padding")]),Rl=O([w("state"),w("nonce"),B("lpVault"),B("rewardVault"),B(),B(),w(),w(),w("totalReward"),X("perShareReward"),w("lastSlot"),w("perSlotReward")]),Ll=O([w("state"),w("nonce"),B("lpVault"),B("rewardVaultA"),w("totalRewardA"),X("perShareRewardA"),w("perSlotRewardA"),M("option"),B("rewardVaultB"),le(7),w("totalRewardB"),X("perShareRewardB"),w("perSlotRewardB"),w("lastSlot"),B()]),Ol=O([w(),w("state"),w("nonce"),w("validRewardTokenNum"),X("rewardMultiplier"),w("rewardPeriodMax"),w("rewardPeriodMin"),w("rewardPeriodExtend"),B("lpMint"),B("lpVault"),W(Cl,5,"rewardInfos"),B("creator"),B(),W(w(),32,"padding")]),Hs=new Proxy(Rl,{get(i,e,t){return e==="decode"?(...n)=>{let r=i.decode(...n);return{...r,version:3,rewardInfos:[{rewardVault:r.rewardVault,totalReward:r.totalReward,perSlotReward:r.perSlotReward,perShareReward:r.perShareReward}]}}:Reflect.get(i,e,t)}}),js=new Proxy(Ll,{get(i,e,t){return e==="decode"?(...n)=>{let r=i.decode(...n);return{...r,version:5,rewardInfos:[{rewardVault:r.rewardVaultA,totalReward:r.totalRewardA,perSlotReward:r.perSlotRewardA,perShareReward:r.perShareRewardA},{rewardVault:r.rewardVaultB,totalReward:r.totalRewardB,perSlotReward:r.perSlotRewardB,perShareReward:r.perShareRewardB}]}}:Reflect.get(i,e,t)}}),Fn=new Proxy(Ol,{get(i,e,t){return e==="decode"?(...n)=>{let r=i.decode(...n);return{...r,version:6,rewardInfos:r.rewardInfos.map(o=>{var s;return{...o,rewardType:((s=Object.entries(Gt).find(a=>String(a[1])===o.rewardType.toString()))!=null?s:["Standard SPL"])[0]}})}}:Reflect.get(i,e,t)}}),Nl=O([w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),Qi=O([M("instruction"),w("nonce"),W(Nl,5,"rewardTimeInfo")]),Hi=O([M("instruction"),w("rewardReopenTime"),w("rewardEndTime"),w("rewardPerSecond")]),ji=O([M("instruction"),w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),$g=O([w("state"),B("id"),B("owner"),w("deposited"),W(w(),1,"rewardDebts")]),vn=O([w("state"),B("id"),B("owner"),w("deposited"),W(X(),1,"rewardDebts"),w(""),w("voteLockedBalance"),W(w(),15)]),Jg=O([w("state"),B("id"),B("owner"),w("deposited"),W(w(),2,"rewardDebts")]),Zs=O([w("state"),B("id"),B("owner"),w("deposited"),W(X(),2,"rewardDebts"),W(w(),17)]),$s=O([w(),w("state"),B("id"),B("owner"),w("deposited"),W(X(),5,"rewardDebts"),W(w(),16)]),Ge=O([M("instruction"),w("amount")]),Ml=O([B("mint"),B("grantAuthority"),w("baselineVoteWeightScaledFactor"),w("maxExtraLockupVoteWeightScaledFactor"),w("lockupSaturationSecs"),Ws("digitShift"),W(M(),7,"reserved1"),W(w(),7,"reserved2")]),Js=O([le(8),B("governanceProgramId"),B("realm"),B("realmGoverningTokenMint"),B("realmAuthority"),W(M(),32,"reserved1"),W(Ml,4,"votingMints"),vr("timeOffset"),M("bump"),W(M(),7,"reserved2"),W(w(),11,"reserved3")]),_l=O([vr("startTime"),vr("endTime"),M("kind"),W(M(),15,"reserved")]),Vl=O([W(_l,1,"lockup"),w("amountDeposited_native"),w("amountInitiallyLockedNative"),Me("isUsed"),Me("allowClawback"),M("votingMintConfigIdx"),W(M(),29,"reserved")]),ea=O([le(8),B("voterAuthority"),B("registrar"),W(Vl,32,"deposits"),M("voterBump"),M("voterWweightRecordBump"),W(M(),94,"reserved")]);var aw=oe("Raydium_farm_config"),na=new ta("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),ra=new ta("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),ia={3:Hs,5:js,6:Fn},oa={3:vn,5:Zs,6:$s},Zi=i=>[3,5,6].indexOf(i)!==-1,$i=i=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=i,r=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,o={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${r}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${r}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${r}`}};return(s=o[e])==null?void 0:s.call(o)},Gt={"Standard SPL":0,"Option tokens":1},yt={[Ks.toString()]:3,[Cs.toString()]:5,[On.toString()]:6};import{PublicKey as te,SystemProgram as jt,SYSVAR_RENT_PUBKEY as vl,SYSVAR_CLOCK_PUBKEY as qn,TransactionInstruction as Ce}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Wl,TOKEN_PROGRAM_ID as Je,ASSOCIATED_TOKEN_PROGRAM_ID as Dl}from"@solana/spl-token";import Xr from"bn.js";function Ji(i,e,t){return ne([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],i)}function eo(i,e){return ne([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],i)}function to(i,e){return ne([e.toBuffer()],i)}function no(i,e,t){return ne([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],i)}function ro(i,e,t){return ne([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],i)}function io(i,e,t,n){return ne([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}import He from"bn.js";var Wn=oe("Raydium.farm.util");function Dn({programId:i,poolId:e,mint:t,type:n}){let{publicKey:r}=ne([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],i);return r}function je({programId:i,poolId:e,owner:t,version:n}){let{publicKey:r}=ne([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],i);return r}var sa=({programId:i,poolId:e})=>ne([e.toBuffer()],i);function aa(i){return{isSet:new He(1),rewardPerSecond:G(i.perSecond),rewardOpenTime:G(i.openTime),rewardEndTime:G(i.endTime),rewardType:G(Gt[i.rewardType])}}function oo(i){return G(i.endTime).sub(G(i.openTime)).mul(G(i.perSecond))}function Gr(i){let e=oa[i];return e||Wn.logWithError("invalid version",i),e}function El(i){let e=ia[i];return e||Wn.logWithError("invalid version",i),e}function Fl(i,e,t,n){if(i.version===3||i.version===5){if(i.lastSlot.gte(new He(t)))return i;let r=new He(t).sub(i.lastSlot);i.lastSlot=new He(t);for(let o of i.rewardInfos){if(e.amount.eq(new He(0)))continue;let s=o.perSlotReward.mul(r);o.perShareReward=o.perShareReward.add(s.mul(new He(10).pow(new He(i.version===3?9:15))).div(e.amount)),o.totalReward=o.totalReward.add(s)}}else if(i.version===6)for(let r of i.rewardInfos){if(r.rewardState.eq(new He(0)))continue;let o=He.min(new He(n),r.rewardEndTime);if(r.rewardOpenTime.gte(o))continue;let a=o.sub(r.rewardLastUpdateTime).mul(r.rewardPerSecond),u=r.totalReward.sub(r.totalRewardEmissioned);u.lt(a)?(a=u,r.rewardLastUpdateTime=r.rewardLastUpdateTime.add(u.div(r.rewardPerSecond))):r.rewardLastUpdateTime=o,!e.amount.eq(new He(0))&&(r.accRewardPerShare=r.accRewardPerShare.add(a.mul(i.rewardMultiplier).div(e.amount)),r.totalRewardEmissioned=r.totalRewardEmissioned.add(a))}return i}async function Iw({connection:i,farmPools:e,owner:t,config:n,chainTime:r}){let o=!1,s=!1,a=new He(10),u=[];for(let p of e){let d=me(p);d.version===6?s=!0:o=!0,u.push({pubkey:d.id,version:d.version,key:"state",poolId:d.id},{pubkey:d.lpVault,version:d.version,key:"lpVault",poolId:d.id}),t&&u.push({pubkey:je({programId:d.programId,poolId:d.id,owner:t,version:p.version}),version:d.version,key:"ledger",poolId:d.id})}let c={},l=await Sn(i,u,n);for(let{pubkey:p,version:d,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(c[g]={...c[g]},y==="state"){let A=El(d);(!b||!b.data||b.data.length!==A.span)&&Wn.logWithError(`invalid farm state account info, pools.id, ${p}`),c[g].state=A.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==Wt.span)&&Wn.logWithError(`invalid farm lp vault account info, pools.lpVault, ${p}`),c[g].lpVault=Wt.decode(b.data);else if(y==="ledger"){let A=Gr(d);b&&b.data&&(b.data.length!==A.span&&Wn.logWithError(`invalid farm ledger account info, ledger, ${p}`),c[g].ledger=A.decode(b.data))}}let m=s||o?await i.getSlot():0;for(let p of Object.keys(c))c[p]!==void 0&&(c[p].state=Fl(c[p].state,c[p].lpVault,m,r));for(let[p,{state:d,ledger:y}]of Object.entries(c))if(y){let f=d.version===6?d.rewardMultiplier:d.rewardInfos.length===1?a.pow(new He(9)):a.pow(new He(15)),b=d.rewardInfos.map((g,A)=>{let k=y.rewardDebts[A];return y.deposited.mul(d.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});c[p].wrapped={...c[p].wrapped,pendingRewards:b}}return c}function xw(i,e=Date.now()){if(i.version===6){let t=i.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>Bs(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>Ss(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=i.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function so(i,e,t,n){let r=await i.getAccountInfo(e);if(r===null)throw Error("registrar info check error");let s=Js.decode(r.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await i.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let c=ea.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return c===-1?{index:s,isInit:!1}:{index:c,isInit:!0}}var ql=oe("Raydium_farm_instruction"),Un={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ua(i){let{version:e,id:t,ledger:n,programId:r,owner:o}=i,s={3:9,5:10}[e];s||ql.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(zi.span);zi.encode({instruction:s},a);let u=[P({pubkey:t}),P({pubkey:n}),P({pubkey:o,isWritable:!1}),P({pubkey:jt.programId,isWritable:!1}),P({pubkey:vl,isWritable:!1})];return{instruction:new Ce({programId:r,keys:u,data:a}),instructionType:_.FarmV3CreateLedger}}function ca(i){var n;let e=Buffer.alloc(Qi.span);Qi.encode({instruction:0,nonce:new Xr(i.nonce),rewardTimeInfo:i.rewardInfoConfig},e);let t=[...gi,P({pubkey:i.farmId}),P({pubkey:i.farmAuthority,isWritable:!1}),P({pubkey:i.lpVault}),P({pubkey:i.lpMint,isWritable:!1}),P({pubkey:i.lockVault}),P({pubkey:i.lockMint,isWritable:!1}),P({pubkey:(n=i.lockUserAccount)!=null?n:Be}),P({pubkey:i.owner,isWritable:!1,isSigner:!0})];for(let r of i.rewardInfo)t.push(P({pubkey:r.rewardMint,isWritable:!1}),P({pubkey:r.rewardVault}),P({pubkey:r.userRewardToken}));return{instruction:new Ce({programId:i.programId,keys:t,data:e}),instructionType:_.FarmV6Create}}function la(i){let e=Buffer.alloc(Yi.span);Yi.encode({instruction:5},e);let t=[P({pubkey:Je,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.lpVault,isWritable:!1}),P({pubkey:i.rewardVault}),P({pubkey:i.userRewardToken}),P({pubkey:i.owner,isWritable:!1,isSigner:!0})];return{instruction:new Ce({programId:i.programId,keys:t,data:e}),instructionType:_.FarmV6CreatorWithdraw}}function Ul(i,e,t,n,r,o,s,a,u,c,l,m,p){let d=O([M("depositEntryIndex"),w("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:Je,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Pr,isSigner:!1,isWritable:!1}],f=Buffer.alloc(d.span);d.encode({depositEntryIndex:m,amount:p},f);let b=Buffer.from([...Un.voterStakeRegistryDeposit,...f]);return new Ce({keys:y,programId:i,data:b})}function Gl(i,e,t,n){let r=O([]),o=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:jt.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(r.span);r.encode({},s);let a=Buffer.from([...Un.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new Ce({keys:o,programId:i,data:a})}function Xl(i,e,t,n,r,o,s,a,u,c,l,m,p,d,y){let f=O([M("depositEntryIndex"),w("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:Je,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Pr,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:d,amount:y},g);let A=Buffer.from([...Un.voterStakeRegistryWithdraw,...g]);return new Ce({keys:b,programId:i,data:A})}function zl(i,e,t,n,r,o){let s=O([M("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:jt.programId,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);return s.encode({ins:23},u),new Ce({keys:a,programId:i,data:u})}function Yl(i,e,t,n,r,o,s,a){let u=O([M("voterBump"),M("voterWeightRecordBump")]),c=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1},{pubkey:Pr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...Un.voterStakeRegistryCreateVoter,...l]);return new Ce({keys:c,programId:i,data:m})}function Ql(i,e,t,n,r,o,s,a,u,c,l,m){let p=O([M("depositEntryIndex"),M("kind"),M("option"),w("startTs"),Ee("periods"),Me("allowClawback")]),d=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:jt.programId,isSigner:!1,isWritable:!1},{pubkey:Je,isSigner:!1,isWritable:!1},{pubkey:Dl,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1}],y=Buffer.alloc(p.span);p.encode({depositEntryIndex:a,kind:u,option:c===void 0?0:1,startTs:c,periods:l,allowClawback:m},y);let f=Buffer.from([...Un.voterStakeRegistryCreateDepositEntry,...y]);return new Ce({keys:d,programId:i,data:f})}async function qw({connection:i,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:r,communityTokenMint:o,owner:s,poolId:a,tokenProgram:u}){let c=Ji(n,r,o).publicKey,l=je({programId:e,poolId:a,owner:s,version:3}),m=await i.getAccountInfo(l);if(m===null)throw Error("user is not staker");let p=vn.decode(m.data),d=p.deposited.sub(p.voteLockedBalance);if(console.log("amount",d.toString()),d.eq(new Xr(0)))throw Error("user do not has new stake amount");let y=eo(e,a).publicKey,f=to(e,a).publicKey,{publicKey:b,nonce:g}=no(n,c,s),A=de(b,y,u).publicKey,{publicKey:k,nonce:h}=ro(n,c,s),T=io(t,r,o,s).publicKey,I=[],S=de(s,y,u).publicKey;if(await i.getAccountInfo(S)===null&&I.push(Wl(s,S,s,y)),await i.getAccountInfo(b)===null){let z=zl(t,r,s,o,s,T);I.push(z,Yl(n,c,b,k,s,s,g,h))}let{index:N,isInit:E}=await so(i,c,b,y);return E||I.push(Ql(n,c,b,A,s,s,y,N,0,void 0,0,!1)),I.push(Ul(n,c,b,A,S,s,l,a,y,f,e,N,d),Gl(n,c,b,k)),I}async function Uw({connection:i,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:r,communityTokenMint:o,owner:s,poolId:a,tokenProgram:u}){let c=Ji(n,r,o).publicKey,l=je({programId:e,poolId:a,owner:s,version:3}),m=await i.getAccountInfo(l);if(m===null)throw Error("user is not staker");let p=vn.decode(m.data);if(p.voteLockedBalance.eq(new Xr(0)))throw Error("user has vote locked balance = 0");let d=eo(e,a).publicKey,y=to(e,a).publicKey,{publicKey:f}=no(n,c,s),b=de(f,d,u).publicKey,{publicKey:g}=ro(n,c,s),A=io(t,r,o,s).publicKey,k=[],{index:h,isInit:T}=await so(i,c,f,d);if(!T)throw Error("deposit entry index check error");return k.push(Xl(n,c,f,s,A,g,b,de(s,d,u).publicKey,l,a,d,y,e,h,p.voteLockedBalance)),k}function ao({payer:i,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:r}){let o=Buffer.alloc(Hi.span);Hi.encode({instruction:3,rewardReopenTime:G(r.openTime),rewardEndTime:G(r.endTime),rewardPerSecond:G(r.perSecond)},o);let s=[P({pubkey:Je,isWritable:!1}),P({pubkey:n.id}),P({pubkey:n.lpVault,isWritable:!1}),P({pubkey:e}),P({pubkey:t}),P({pubkey:i,isWritable:!1,isSigner:!0})];return new Ce({programId:n.programId,keys:s,data:o})}function uo({payer:i,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:r}){let o=Buffer.alloc(ji.span);ji.encode({instruction:4,isSet:new Xr(1),rewardPerSecond:G(r.perSecond),rewardOpenTime:G(r.openTime),rewardEndTime:G(r.endTime),rewardType:G(Gt[r.rewardType])},o);let s=[...gi,P({pubkey:t.id}),P({pubkey:t.authority,isWritable:!1}),P({pubkey:r.mint,isWritable:!1}),P({pubkey:n}),P({pubkey:e}),P({pubkey:i,isWritable:!1,isSigner:!0})];return new Ce({programId:t.programId,keys:s,data:o})}function Gw(i){let{farmInfo:e,farmKeys:t,version:n,lpAccount:r,rewardAccounts:o,owner:s,instruction:a,amount:u,deposit:c}=i,[l,m]=[new te(e.programId),new te(e.id)],p=je({programId:l,poolId:m,owner:s,version:n}),d=Buffer.alloc(Ge.span);Ge.encode({instruction:a,amount:u},d);let y=n===6?[P({pubkey:Je,isWritable:!1}),...c?[P({pubkey:jt.programId,isWritable:!1})]:[],P({pubkey:m}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:new te(t.lpVault)}),P({pubkey:p}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:r})]:[P({pubkey:m}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:p}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:r}),P({pubkey:new te(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new te(t.rewardInfos[0].vault)}),P({pubkey:qn,isWritable:!1}),P({pubkey:Je,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(P({pubkey:o[f]})),y.push(P({pubkey:new te(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(P({pubkey:new te(t.rewardInfos[f].vault)})),y.push(P({pubkey:o[f]}));return new Ce({programId:l,keys:y,data:d})}function Gn(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s}=i,[a,u]=[new te(e.programId),new te(e.id)],c=je({programId:a,poolId:u,owner:o,version:6}),l=Buffer.alloc(Ge.span);Ge.encode({instruction:2,amount:G(s)},l);let m=[P({pubkey:Je,isWritable:!1}),P({pubkey:u}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:new te(t.lpVault)}),P({pubkey:c}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let p=0;p<t.rewardInfos.length;p++)m.push(P({pubkey:new te(t.rewardInfos[p].vault)})),m.push(P({pubkey:r[p]}));return new Ce({programId:a,keys:m,data:l})}function Xn(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new te(e.programId),new te(e.id)],l=je({programId:u,poolId:c,owner:o,version:5}),m=Buffer.alloc(Ge.span);Ge.encode({instruction:12,amount:G(s)},m);let p=[P({pubkey:c}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new te(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new te(t.rewardInfos[0].vault)}),P({pubkey:qn,isWritable:!1}),P({pubkey:Je,isWritable:!1})];for(let d=1;d<t.rewardInfos.length;d++)p.push(P({pubkey:r[d]})),p.push(P({pubkey:new te(t.rewardInfos[d].vault)}));if(a)for(let d of a)p.push(P({pubkey:d}));return new Ce({programId:u,keys:p,data:m})}function zn(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new te(e.programId),new te(e.id)],l=je({programId:u,poolId:c,owner:o,version:3}),m=Buffer.alloc(Ge.span);Ge.encode({instruction:11,amount:G(s)},m);let p=[P({pubkey:c}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new te(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new te(t.rewardInfos[0].vault)}),P({pubkey:qn,isWritable:!1}),P({pubkey:Je,isWritable:!1})];if(a)for(let d of a)p.push(P({pubkey:d}));return new Ce({programId:u,keys:p,data:m})}function ma(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new te(e.programId),new te(e.id)],l=je({programId:u,poolId:c,owner:o,version:3}),m=Buffer.alloc(Ge.span);Ge.encode({instruction:10,amount:G(s)},m);let p=[P({pubkey:c}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new te(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new te(t.rewardInfos[0].vault)}),P({pubkey:qn,isWritable:!1}),P({pubkey:Je,isWritable:!1})];if(a)for(let d of a)p.push(P({pubkey:d}));return new Ce({programId:u,keys:p,data:m})}function da(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new te(e.programId),new te(e.id)],l=je({programId:u,poolId:c,owner:o,version:5}),m=Buffer.alloc(Ge.span);Ge.encode({instruction:11,amount:G(s)},m);let p=[P({pubkey:c}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new te(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new te(t.rewardInfos[0].vault)}),P({pubkey:qn,isWritable:!1}),P({pubkey:Je,isWritable:!1})];for(let d=1;d<t.rewardInfos.length;d++)p.push(P({pubkey:r[d]})),p.push(P({pubkey:new te(t.rewardInfos[d].vault)}));if(a)for(let d of a)p.push(P({pubkey:d}));return new Ce({programId:u,keys:p,data:m})}function pa(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s}=i,[a,u]=[new te(e.programId),new te(e.id)],c=je({programId:a,poolId:u,owner:o,version:6}),l=Buffer.alloc(Ge.span);Ge.encode({instruction:1,amount:G(s)},l);let m=[P({pubkey:Je,isWritable:!1}),P({pubkey:jt.programId,isWritable:!1}),P({pubkey:u}),P({pubkey:new te(t.authority),isWritable:!1}),P({pubkey:new te(t.lpVault)}),P({pubkey:c}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let p=0;p<t.rewardInfos.length;p++)m.push(P({pubkey:new te(t.rewardInfos[p].vault)})),m.push(P({pubkey:r[p]}));return new Ce({programId:a,keys:m,data:l})}var Yn=class extends Pe{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(Be)){let n=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:oo({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:r=On,txVersion:o}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new ge(e.lpMint.address),lockInfo:{lockMint:na,lockVault:ra},version:6,rewardInfos:t,programId:r},u=this.createTxBuilder(),c=n!=null?n:this.scope.ownerPubKey,l=Fe({fromPublicKey:c,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(Fn.span);u.addInstruction({instructions:[jl.createAccountWithSeed({fromPubkey:c,basePubkey:c,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:Fn.span,programId:a.programId})]});let{publicKey:p,nonce:d}=sa({programId:new ge(a.programId),poolId:l.publicKey}),y=Dn({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),f=[],b=[];for(let h of a.rewardInfos){h.openTime>=h.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",h.openTime.toString()),isNaN(Gt[h.rewardType])&&this.logAndCreateError("rewardType error",h.rewardType),Number(h.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",h.perSecond),f.push(aa(h));let{rewardPubKey:T,newInstruction:I}=await this._getUserRewardInfo({rewardInfo:h,payer:c});I&&u.addInstruction(I),T||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let S=h.mint.equals(Be)?new ge(Se.address):h.mint;b.push({rewardMint:S,rewardVault:Dn({programId:a.programId,poolId:l.publicKey,mint:S,type:"rewardVault"}),userRewardToken:T})}let g=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});g||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:A,instructionType:k}=ca({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:y,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:g,programId:a.programId,rewardInfo:b,rewardInfoConfig:f,nonce:d});return u.addInstruction({instructions:[A],instructionTypes:[k]}).versionBuild({txVersion:o,extInfo:{farmId:l.publicKey,farmAuthority:p,lpVault:y,lockUserAccount:g,nonce:d}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:r}){var b;let o=yt[e.programId];o!==6&&this.logAndCreateError("invalid farm version ",o);let s=me((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,c=n.mint.equals(Be)?new ge(Se.address):n.mint,l=a.rewardInfos.findIndex(g=>new ge(g.mint.address).equals(c)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",c);let p=(b=m.vault)!=null?b:Be,d=this.createTxBuilder(),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return f&&d.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),d.addInstruction({instructions:[ao({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:y,farmKeys:a,rewardInfo:n})],instructionTypes:[_.FarmV6Restart]}).versionBuild({txVersion:r})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:r}){var l;let o=yt[e.programId];o!==6&&this.logAndCreateError("invalid farm version ",o);let s=me((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,c=this.createTxBuilder();for(let m of n){let p=m.mint.equals(Be)?new ge(Se.address):m.mint,d=a.rewardInfos.findIndex(k=>new ge(k.mint.address).equals(p)),y=s.rewardInfos[d];y||this.logAndCreateError("configuration does not exist","rewardMint",p);let f=(l=y.vault)!=null?l:Be,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:u});g&&c.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let A=ao({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});c.addInstruction({instructions:[A],instructionTypes:[_.FarmV6Restart]})}return c.versionBuild({txVersion:r})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:r,payer:o}=e,s=yt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=me((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,c=this.createTxBuilder(),l=r.mint.equals(Be)?new ge(Se.address):r.mint,m=Dn({programId:new ge(n.programId),poolId:new ge(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:p,newInstruction:d}=await this._getUserRewardInfo({rewardInfo:r,payer:u});return d&&c.addInstruction(d),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),r.mint=l,c.addInstruction({instructions:[uo({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:m,rewardInfo:r})],instructionTypes:[_.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:r,payer:o}=e,s=yt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=me((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,c=this.createTxBuilder();for(let l of r){let m=l.mint.equals(Be)?new ge(Se.address):l.mint,p=Dn({programId:new ge(n.programId),poolId:new ge(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:d,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:l,payer:u});y&&c.addInstruction(y),d||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let f=uo({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:p,rewardInfo:{...l,mint:m}});c.addInstruction({instructions:[f],instructionTypes:[_.FarmV6CreatorAddReward]})}return c.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:r,feePayer:o,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:c,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:p}=n,d=yt[p];Zi(d)||this.logAndCreateError("invalid farm program:",n.programId);let[y,f]=[new ge(n.programId),new ge(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],g=je({programId:y,poolId:f,owner:this.scope.ownerPubKey,version:d}),A=this.createTxBuilder();A.addCustomComputeBudget(l);let k={};for(let v of this.scope.account.tokenAccounts)if(a){let Z=de(this.scope.ownerPubKey,v.mint,v.programId).publicKey;v.publicKey&&Z.equals(v.publicKey)&&(k[v.mint.toString()]=v.publicKey)}else k[v.mint.toString()]=v.publicKey;let h=b.lpMint,T=k[h.address];T||this.logAndCreateError("you don't have any lp","lp zero",k);let I=[];for(let v of m){let Z=s&&v.mint.address===$.toString(),J=k[v.mint.address];if(!J){let{account:re,instructionParams:ct}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new ge(v.mint.address),notUseTokenAccount:Z,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!Z,associatedOnly:Z?!1:a,checkCreateATAOwner:u});J=re,ct&&A.addInstruction(ct)}k[v.mint.address]=J,I.push(J)}let S,x=await this.scope.connection.getAccountInfo(g);if(x&&(S=Gr(d).decode(x.data)),n.programId!==On.toString()&&!S){let{instruction:v,instructionType:Z}=ua({id:f,programId:y,version:d,ledger:g,owner:this.scope.ownerPubKey});A.addInstruction({instructions:[v],instructionTypes:[Z]})}let K=$i({version:d,rewardInfos:m,rewardTokenAccountsPublicKeys:I});K&&this.logAndCreateError(K);let N={amount:G(r),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:T,rewardAccounts:I,userAuxiliaryLedgers:c==null?void 0:c.map(v=>new ge(v))},E=d===6?pa(N):d===5?da(N):ma(N),z={3:_.FarmV3Deposit,5:_.FarmV5Deposit,6:_.FarmV6Deposit};return A.addInstruction({instructions:[E],instructionTypes:[z[d]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:r,deposited:o,useSOLBalance:s,feePayer:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let d=yt[n.programId];Zi(d)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],f=this.createTxBuilder();f.addCustomComputeBudget(m);let b={};for(let K of this.scope.account.tokenAccounts)if(u){let N=de(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&N.equals(K.publicKey)&&(b[K.mint.toString()]=K.publicKey)}else b[K.mint.toString()]=K.publicKey;if(o)o.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else{let K=je({programId:new ge(n.programId),poolId:new ge(n.id),owner:this.scope.ownerPubKey,version:d}),N=await this.scope.connection.getAccountInfo(K);N||this.logAndCreateError("no lp data",{farmId:n.id,version:d,ledgerData:N}),Gr(d).decode(N.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id})}let g=y.lpMint.address,A=s&&g===$.toString(),k=b[g.toString()];if(!k){let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new ge(g),notUseTokenAccount:A,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:A?!1:u,checkCreateATAOwner:c});k=K,N&&f.addInstruction(N)}b[g.toString()]=k;let h=[];for(let K of p){let N=s&&K.mint.address===$.toString(),E=b[K.mint.address];if(!E){let{account:z,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new ge(K.mint.address),notUseTokenAccount:N,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!N,associatedOnly:N?!1:u,checkCreateATAOwner:c});E=z,v&&f.addInstruction(v)}b[K.mint.address]=E,h.push(E)}let T=$i({version:d,rewardInfos:p,rewardTokenAccountsPublicKeys:h});T&&this.logAndCreateError(T);let I={amount:G(r),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:k,rewardAccounts:h,userAuxiliaryLedgers:l==null?void 0:l.map(K=>new ge(K))},S=d===6?Gn(I):d===5?Xn(I):zn(I),x={3:_.FarmV3Withdraw,5:_.FarmV5Withdraw,6:_.FarmV6Withdraw};return f.addInstruction({instructions:[S],instructionTypes:[x[d]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var d;this.scope.checkOwner();let r=me((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),o=yt[e.programId];o!==6&&this.logAndCreateError("invalid farm version",o);let s=e.rewardInfos.findIndex(y=>y.mint.address===Be.toString()?new ge(Se.address):t),a=r.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let u=(d=a==null?void 0:a.vault)!=null?d:Be,c=this.createTxBuilder(),l;if(t.equals(Be)){let y=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:oo({...a,openTime:a.openTime,endTime:a.endTime,perSecond:new V(a.perSecond).mul(10**a.mint.decimals).toString()})});l=y.addresses.newAccount,c.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(l=await this.scope.account.getAssociatedTokenAccount(t),c.addInstruction({instructions:[Hl(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[_.CreateATA]})):l=y}let{instruction:m,instructionType:p}=la({programId:r.programId,id:r.id,authority:r.authority,lpVault:r.lpVault,rewardVault:u,userRewardToken:l,owner:this.scope.ownerPubKey});return c.addInstruction({instructions:[m],instructionTypes:[p]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:r,associatedOnly:o=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:u,computeBudgetConfig:c}=e,l=this.createTxBuilder(),m={};for(let y of this.scope.account.tokenAccounts)if(o){let f=de(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let d=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>({...y,[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:A}=y,k=yt[f],h=b.address,T=n&&h===$.toString(),I=m[h];if(!I){let{account:z,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new ge(h),notUseTokenAccount:T,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:T?!1:o,checkCreateATAOwner:s});I=z,v&&l.addInstruction(v)}m[h.toString()]=I;let S=[];for(let z of g){let v=n&&z.mint.address===$.toString(),Z=m[z.mint.address];if(!Z){let{account:J,instructionParams:re}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:z.mint.programId,mint:new ge(z.mint.address),notUseTokenAccount:v,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!v,associatedOnly:v?!1:o,checkCreateATAOwner:s});Z=J,re&&l.addInstruction(re)}m[z.mint.address]=Z,S.push(Z)}let x=d[A],K={amount:Ue,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:x,lpAccount:I,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(z=>new ge(z))},N=k===6?Gn(K):k===5?Xn(K):zn(K),E={3:_.FarmV3Withdraw,5:_.FarmV5Withdraw,6:_.FarmV6Withdraw};l.addInstruction({instructions:[N],instructionTypes:[E[k]]})}return u===1?l.sizeCheckBuild({computeBudgetConfig:c}):l.sizeCheckBuildV0({computeBudgetConfig:c})}};import{PublicKey as Ze}from"@solana/web3.js";import{NATIVE_MINT as Ha,TOKEN_PROGRAM_ID as Jr}from"@solana/spl-token";var pA=O([Ee("mintAuthorityOption"),B("mintAuthority"),w("supply"),M("decimals"),M("isInitialized"),Ee("freezeAuthorityOption"),B("freezeAuthority")]);import{PublicKey as Zl}from"@solana/web3.js";import{MintLayout as fa,TOKEN_PROGRAM_ID as $l}from"@solana/spl-token";var kA=async({connection:i,mint:e})=>{let t=await i.getAccountInfo(new Zl(e));return!t||t.data.length!==fa.span?void 0:fa.decode(t.data)},hA=({mint:i,decimals:e,programId:t=$l,logoURI:n="",priority:r=3})=>{let o=i.toBase58().substring(0,6);return{address:i.toBase58(),decimals:e,symbol:o,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:o,tags:[],priority:r}},ya=i=>new Ae({mint:i.address,decimals:i.decimals,symbol:i.symbol,name:i.name}),TA=({amount:i,isRaw:e,name:t,...n})=>new he(new Ae({mint:n.address,decimals:n.decimals,symbol:n.symbol,name:t}),i,e,t);function IA(i){return i.address===At.address?Se:i}function xA(i){return i.address===Se.address?At:i}import{TOKEN_PROGRAM_ID as Qn,ASSOCIATED_TOKEN_PROGRAM_ID as pm}from"@solana/spl-token";import{PublicKey as pe,TransactionInstruction as Nt,SystemProgram as bo,SYSVAR_RENT_PUBKEY as fm}from"@solana/web3.js";var co=O([M("instruction"),w("amountIn"),w("minAmountOut")]),lo=O([M("instruction"),w("maxAmountIn"),w("amountOut")]),EA=O([M("instruction"),M("nonce")]),mo=O([M("instruction"),M("nonce"),w("startTime")]),Jl=O([w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalValue"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),X("swapBaseInAmount"),X("swapQuoteOutAmount"),w("swapBase2QuoteFee"),X("swapQuoteInAmount"),X("swapBaseOutAmount"),w("swapQuote2BaseFee"),B("baseVault"),B("quoteVault"),B("baseMint"),B("quoteMint"),B("lpMint"),B("openOrders"),B("marketId"),B("marketProgramId"),B("targetOrders"),B("withdrawQueue"),B("lpVault"),B("owner"),w("lpReserve"),W(w(),3,"padding")]),em=O([w("accountType"),w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalsValue"),w("abortTradeFactor"),w("priceTickMultiplier"),w("priceTick"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),X("swapBaseInAmount"),X("swapQuoteOutAmount"),X("swapQuoteInAmount"),X("swapBaseOutAmount"),w("swapQuote2BaseFee"),w("swapBase2QuoteFee"),B("baseVault"),B("quoteVault"),B("baseMint"),B("quoteMint"),B("lpMint"),B("modelDataAccount"),B("openOrders"),B("marketId"),B("marketProgramId"),B("targetOrders"),B("owner"),W(w(),64,"padding")]),po=O([M("instruction"),w("baseAmountIn"),w("quoteAmountIn"),w("fixedSide")]),fo=O([M("instruction"),w("amountIn")]),FA={4:Jl,5:em},ba=O([w("fee")]);import{PublicKey as tm}from"@solana/web3.js";var fn=new tm("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),$t=5e4,nm=O([w("x"),w("y"),w("price")]),rm=O([w("accountType"),w("status"),w("multiplier"),w("validDataCount"),W(nm,$t,"DataElement")]);function im(i,e){return[0,$t-2]}function om(i){return[0,$t-2]}function sm(i){return[0,$t-2]}function am(i,e,t){let[n,r]=im(e,t),o=n,s=r,a=0,u=e*i.multiplier/t;for(;o<=s;){if(a=Math.floor((s+o)/2),a===0||a>=$t-2)return[a,a,!1];let c=i.DataElement[a].x*i.multiplier/i.DataElement[a].y,l=i.DataElement[a-1].x*i.multiplier/i.DataElement[a-1].y,m=i.DataElement[a+1].x*i.multiplier/i.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===l)return[a-1,a-1,!0];if(u===m)return[a+1,a+1,!0];if(u<l)s=a-1;else{if(u>l&&u<c)return[a-1,a,!0];if(u>c&&u<m)return[a,a+1,!0];o=a+1}}return[a,a,!1]}function yo(i,e,t){let[n,r,o]=am(i,e,t);if(!o)return 0;if(n===r){let s=i.DataElement[n].x;return e*i.multiplier/s}else{let s=i.DataElement[n].x,a=i.DataElement[n].y,u=i.DataElement[r].x,c=i.DataElement[r].y,l=t*(u*a-s*c),m=s*l,p=(u-s)*(e*a-s*t)*c,d=m+p;return e*i.multiplier*l/d}}function Zt(i,e,t){return e*i.multiplier/t}function ga(i,e,t){return e*t/i.multiplier}function um(i,e){let[t,n]=om(e),r=t,o=n,s=0,a=e;for(;r<o;){if(s=Math.floor((o+r)/2),s<=0||s>$t-2)return[s,s,!1];let u=i.DataElement[s].x,c=i.DataElement[s-1].x,l=i.DataElement[s+1].x;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<c)o=s-1;else{if(a>c&&a<u)return[s-1,s,!0];if(a>u&&a<l)return[s,s+1,!0];r=s+1}}return[s,s,!1]}function cm(i,e){let[t,n]=sm(e),r=t,o=n,s=0,a=e;for(;r<=o;){if(s=Math.floor((o+r)/2),s<=0||s>=$t-2)return[s,s,!1];let u=i.DataElement[s].y,c=i.DataElement[s-1].y,l=i.DataElement[s+1].y;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)r=s+1;else{if(a<c&&a>u)return[s-1,s,!0];if(a<u&&a>l)return[s,s+1,!0];o=s-1}}return[s,s,!1]}function wa(i,e,t,n){let r=n?e+t:e-t,[o,s,a]=um(i,r);if(!a)return[0,0,!1,a];if(o===s)return[i.DataElement[s].price,i.DataElement[s].y,!1,a];{let u=i.DataElement[o].x,c=i.DataElement[s].x,l=i.DataElement[o].price,m=i.DataElement[s].price,p=i.DataElement[o].y,d=i.DataElement[s].y;if(e>=u&&e<=c)return n?[m,d,!0,a]:[l,p,!0,a];{let y,f;return n?(y=l+(m-l)*(e-u)/(c-u),f=p-(r-u)*i.multiplier/m):(y=l+(m-l)*(e-u)/(c-u),f=d+(c-r)*i.multiplier/l),[y,f,!1,a]}}}function lm(i,e,t,n){let r=n?e-t:e+t,[o,s,a]=cm(i,r);if(!a)return[0,0,!1,a];if(o===s)return[i.DataElement[s].price,i.DataElement[s].x,!1,a];{let u=i.DataElement[o].x,c=i.DataElement[s].x,l=i.DataElement[o].price,m=i.DataElement[s].price,p=i.DataElement[o].y,d=i.DataElement[s].y;if(e>=d&&e<=p)return n?[m,c,!0,a]:[l,u,!0,a];{let y,f;return n?(y=l+(m-l)*(p-e)/(p-d),f=u+m*(p-r)/i.multiplier):(y=l+(m-l)*(p-e)/(p-d),f=c-l*(r-d)/i.multiplier),[y,f,!1,a]}}}function mm(i,e){let t=wa(i,e,0,!1);return t[3]?t[0]:0}function Aa(i,e,t,n){let r=yo(i,e,t),o=Zt(i,e,r),s=Zt(i,t,r),a=Zt(i,n,r),u=!0,[c,l,m,p]=wa(i,o,a,u);if(!p)return 0;if(m)return n*i.multiplier/c;{let d=s-l;return ga(i,d,r)}}function Pa(i,e,t,n){let r=yo(i,e,t),o=Zt(i,e,r),s=Zt(i,t,r),a=Zt(i,n,r),u=!1,[c,l,m,p]=lm(i,s,a,u);if(!p)return 0;if(m)return n*c/i.multiplier;{let d=o-l;return ga(i,d,r)}}function dm(i){let e=rm.decode(i);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function ka(i,e,t,n){let r=mm(i,Zt(i,e,yo(i,e,t)))/i.multiplier;return n?r:1/r}var pn=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(fn);e&&(this._layoutData=dm(e==null?void 0:e.data))}}};var ha=oe("Raydium_liquidity_instruction");function Ta(i){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:r,quoteAmountIn:o,fixedSide:s}=i,a=Buffer.alloc(po.span);po.encode({instruction:3,baseAmountIn:G(r),quoteAmountIn:G(o),fixedSide:s==="base"?Ue:fs},a);let u=[P({pubkey:Qn,isWritable:!1}),P({pubkey:new pe(e.id)}),P({pubkey:new pe(t.authority),isWritable:!1}),P({pubkey:new pe(t.openOrders),isWritable:!1}),P({pubkey:new pe(t.targetOrders)}),P({pubkey:new pe(e.lpMint.address)}),P({pubkey:new pe(t.vault.A)}),P({pubkey:new pe(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(P({pubkey:fn})),u.push(P({pubkey:new pe(e.marketId),isWritable:!1}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:new pe(t.marketEventQueue),isWritable:!1})),new Nt({programId:new pe(e.programId),keys:u,data:a})}function go(i){let{poolInfo:e,poolKeys:t,userKeys:n,amountIn:r}=i,o=me(t),s=4;if(e.pooltype.includes("StablePool")&&(s=5),s===4||s===5){let a=Buffer.alloc(fo.span);fo.encode({instruction:4,amountIn:G(r)},a);let u=[P({pubkey:Qn,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders}),P({pubkey:o.targetOrders}),P({pubkey:o.mintLp.address}),P({pubkey:o.vault.A}),P({pubkey:o.vault.B})];return s===5?u.push(P({pubkey:fn})):(u.push(P({pubkey:o.id})),u.push(P({pubkey:o.id}))),u.push(P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId}),P({pubkey:o.marketBaseVault}),P({pubkey:o.marketQuoteVault}),P({pubkey:o.marketAuthority,isWritable:!1}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:o.marketEventQueue}),P({pubkey:o.marketBids}),P({pubkey:o.marketAsks})),new Nt({programId:o.programId,keys:u,data:a})}return new Nt({programId:o.programId,keys:[]})}function Ia({programId:i,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:r,coinMint:o,pcMint:s,coinVault:a,pcVault:u,withdrawQueue:c,ammTargetOrders:l,poolTempLp:m,marketProgramId:p,marketId:d,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:A,openTime:k,coinAmount:h,pcAmount:T,ammConfigId:I,feeDestinationId:S}){let x=O([M("instruction"),M("nonce"),w("openTime"),w("pcAmount"),w("coinAmount")]),K=[{pubkey:Qn,isSigner:!1,isWritable:!1},{pubkey:pm,isSigner:!1,isWritable:!1},{pubkey:bo.programId,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:I,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],N=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:A,openTime:k,coinAmount:h,pcAmount:T},N),{instruction:new Nt({keys:K,programId:i,data:N}),instructionType:_.AmmV4CreatePool}}function eP(i){let e=O([M("instruction"),M("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new pe(i.id),isWritable:!1}),P({pubkey:new pe(i.authority),isWritable:!1}),P({pubkey:new pe(i.openOrders),isWritable:!1}),P({pubkey:new pe(i.vault.A),isWritable:!1}),P({pubkey:new pe(i.vault.B),isWritable:!1}),P({pubkey:new pe(i.mintLp.address),isWritable:!1}),P({pubkey:new pe(i.marketId),isWritable:!1}),P({pubkey:new pe(i.marketEventQueue),isWritable:!1})];return new Nt({programId:new pe(i.programId),keys:n,data:t})}function ym({poolKeys:i,userKeys:e,amountIn:t,minAmountOut:n},r){let o=me(i),s=Buffer.alloc(co.span);co.encode({instruction:9,amountIn:G(t),minAmountOut:G(n)},s);let a=[P({pubkey:Qn,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders})];return r===4&&a.push(P({pubkey:o.targetOrders})),a.push(P({pubkey:o.vault.A}),P({pubkey:o.vault.B})),r===5&&a.push(P({pubkey:fn})),a.push(P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId}),P({pubkey:o.marketBids}),P({pubkey:o.marketAsks}),P({pubkey:o.marketEventQueue}),P({pubkey:o.marketBaseVault}),P({pubkey:o.marketQuoteVault}),P({pubkey:o.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1})),new Nt({programId:o.programId,keys:a,data:s})}function bm({poolKeys:i,userKeys:e,maxAmountIn:t,amountOut:n},r){let o=me(i),s=Buffer.alloc(lo.span);lo.encode({instruction:11,maxAmountIn:G(t),amountOut:G(n)},s);let a=[P({pubkey:bo.programId,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders}),P({pubkey:o.targetOrders}),P({pubkey:o.vault.A}),P({pubkey:o.vault.B})];return r===5&&a.push(P({pubkey:fn})),a.push(P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId}),P({pubkey:o.marketBids}),P({pubkey:o.marketAsks}),P({pubkey:o.marketEventQueue}),P({pubkey:o.marketBaseVault}),P({pubkey:o.marketQuoteVault}),P({pubkey:o.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Nt({programId:o.programId,keys:a,data:s})}function zr(i){let{poolKeys:e,version:t,userKeys:n,amountIn:r,amountOut:o,fixedSide:s}=i;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return ym({...a,amountIn:r,minAmountOut:o},t);if(s==="out")return bm({...a,maxAmountIn:r,amountOut:o},t);ha.logWithError("invalid params","params",i)}throw ha.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function tP({poolKeys:i,userKeys:e,startTime:t}){let n=Buffer.alloc(mo.span);mo.encode({instruction:0,nonce:5,startTime:G(t)},n);let r=me(i),o=[P({pubkey:Qn,isWritable:!1}),P({pubkey:bo.programId,isWritable:!1}),P({pubkey:fm,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.authority,isWritable:!1}),P({pubkey:r.openOrders}),P({pubkey:r.mintLp.address}),P({pubkey:r.mintA.address,isWritable:!1}),P({pubkey:r.mintB.address,isWritable:!1}),P({pubkey:r.vault.A,isWritable:!1}),P({pubkey:r.vault.B,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.targetOrders}),P({pubkey:e.lpTokenAccount}),P({pubkey:r.id,isWritable:!1}),P({pubkey:r.marketProgramId,isWritable:!1}),P({pubkey:r.marketId,isWritable:!1}),P({pubkey:e.payer,isSigner:!0})];return new Nt({programId:r.programId,keys:o,data:n})}function xa({poolKeys:i}){let e=O([M("instruction"),M("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new pe(i.id),isWritable:!1}),P({pubkey:new pe(i.authority),isWritable:!1}),P({pubkey:new pe(i.openOrders),isWritable:!1}),P({pubkey:new pe(i.vault.A),isWritable:!1}),P({pubkey:new pe(i.vault.B),isWritable:!1}),P({pubkey:new pe(i.mintLp.address),isWritable:!1}),P({pubkey:new pe(i.marketId),isWritable:!1}),P({pubkey:new pe(i.marketEventQueue),isWritable:!1})];return{instruction:new Nt({programId:new pe(i.programId),keys:n,data:t})}}import{TOKEN_PROGRAM_ID as _e,TOKEN_2022_PROGRAM_ID as zt,ASSOCIATED_TOKEN_PROGRAM_ID as Da}from"@solana/spl-token";import{PublicKey as F,TransactionInstruction as bt,SystemProgram as yn,Keypair as xo}from"@solana/web3.js";import qa from"bn.js";import Sm from"bn.js";function Ba(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function rP(i){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,i,!1),new Uint8Array(e)}function iP(i){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,i,!1),new Uint8Array(e)}function Yr(i){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,i,!1),new Uint8Array(e)}function wo(i,e){let t=0;for(let n=i-1;n>=0&&!e.testn(n);n--)t++;return t}function Ao(i,e){let t=0;for(let n=0;n<i&&!e.testn(n);n++)t++;return t}function Hn(i,e){for(let t=0;t<i;t++)if(e.testn(t))return!1;return!0}function Sa(i,e){return Hn(i,e)?null:wo(i,e)}function Ka(i,e){return Hn(i,e)?null:Ao(i,e)}var gm=Buffer.from("amm_config","utf8"),wm=Buffer.from("pool","utf8"),Am=Buffer.from("pool_vault","utf8"),Pm=Buffer.from("pool_reward_vault","utf8"),Ca=Buffer.from("position","utf8"),km=Buffer.from("tick_array","utf8"),hm=Buffer.from("operation","utf8"),Tm=Buffer.from("pool_tick_array_bitmap_extension","utf8");function uP(i,e){return ne([gm,Ba(e)],i)}function Ra(i,e,t,n){return ne([wm,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Po(i,e,t){return ne([Am,e.toBuffer(),t.toBuffer()],i)}function La(i,e,t){return ne([Pm,e.toBuffer(),t.toBuffer()],i)}function fe(i,e,t){return ne([km,e.toBuffer(),Yr(t)],i)}function Jt(i,e,t,n){return ne([Ca,e.toBuffer(),Yr(t),Yr(n)],i)}function it(i,e){return ne([Ca,e.toBuffer()],i)}function Qr(i){return ne([Buffer.from("metadata","utf8"),cn.toBuffer(),i.toBuffer()],cn)}function jn(i){return ne([hm],i)}function ot(i,e){return ne([Tm,e.toBuffer()],i)}import Tt from"bn.js";var ce=new Tt(0),et=new Tt(1),Mt=new Tt(-1),tt=new Tt(1).shln(64),Hr=new Tt(1).shln(128),ko=tt.sub(et),Zn=64,Oa=Hr.subn(1),ve=-443636,Xe=-ve,It=new Tt("4295048016"),xt=new Tt("79226673521066979257578248091"),Na=16,Ma="59543866431248",_a="184467440737095516",Va="15793534762490258745",jr=new Tt(10).pow(new Tt(6)),Im=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Im||{}),mP={[500]:10,[3e3]:60,[1e4]:200},dP={version:6,liquidity:ce,tickCurrent:0,observationIndex:0,observationUpdateDuration:0,feeGrowthGlobalX64A:ce,feeGrowthGlobalX64B:ce,protocolFeesTokenA:ce,protocolFeesTokenB:ce,swapInAmountTokenA:ce,swapOutAmountTokenB:ce,swapInAmountTokenB:ce,swapOutAmountTokenA:ce,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Ea={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},pP=new Tt("18446744073700000000");var xm=15,ae=class{static async getTickArrays(e,t,n,r,o,s,a){let u=[],c=q.getTickArrayStartIndexByTick(r,o),l=q.getInitializedTickArrayInRange(s,a,o,c,Math.floor(xm/2));for(let d=0;d<l.length;d++){let{publicKey:y}=fe(t,n,l[d]);u.push(y)}let m=(await Pt(e,u)).map(d=>d!==null?$n.decode(d.data):null),p={};for(let d=0;d<u.length;d++){let y=m[d];y!==null&&(p[y.startTickIndex]={...y,address:u[d]})}return p}static nextInitializedTick(e,t,n,r,o,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,r,o,s);for(;a==null||a.liquidityGross.lten(0);){if(c=q.getNextTickArrayStartIndex(c,o,s),this.checkIsValidStartIndex(c,o))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:p,tickArrayStartTickIndex:d}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,p,d]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,r,o){let s=Math.floor(e/ae.tickCount(t)),a=n?q.searchLowBitFromStart(r,o,s-1,1,t):q.searchHightBitFromStart(r,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,r){let o;if(r){let a=Ke-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a-1}}else{let a=0;for(;a<Ke;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a+1}}let{publicKey:s}=fe(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,r,o,s){let a=q.getTickArrayStartIndexByTick(r,o),u=Math.floor((r-a)/o),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let p=c.ticks[u];if(p.liquidityGross.gtn(0)){l=p;break}u=u-1}else for(u=u+1;u<Ke;){let p=c.ticks[u];if(p.liquidityGross.gtn(0)){l=p;break}u=u+1}let{publicKey:m}=fe(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(q.checkIsOutOfBoundary(e)){if(e>Xe)return!1;let n=q.getTickArrayStartIndexByTick(ve,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Ke*e}};import ee from"bn.js";import{PublicKey as Xt}from"@solana/web3.js";import Te from"bn.js";var ho=14,_t=class{static maxTickInTickarrayBitmap(e){return e*Ke*en}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(r+=1);let o=n*r;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,r){if(!ae.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=r?t-ae.tickCount(n):t+ae.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*Ke,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(r){let l=e.shln(1024-c-1),m=Sa(1024,l);if(m!==null){let p=(c-m-512)*a;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(c),m=Ka(1024,l);if(m!==null){let p=(c+m-512)*a;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:o-ae.tickCount(n)}}}},Jn=class{static getBitmapOffset(e,t){if(!ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=_t.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&r--,r}static getBitmap(e,t,n){let r=this.getBitmapOffset(e,t);return e<0?{offset:r,tickarrayBitmap:n.negativeTickArrayBitmap[r]}:{offset:r,tickarrayBitmap:n.positiveTickArrayBitmap[r]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:r}=this.extensionTickBoundary(t);if(e>=r&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=_t.maxTickInTickarrayBitmap(e),n=-t;if(Xe<=t)throw Error(`extensionTickBoundary check error: ${Xe}, ${t}`);if(n<=ve)throw Error(`extensionTickBoundary check error: ${n}, ${ve}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:r}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:q.mergeTickArrayBitmap(r).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,r){let o=ae.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,r);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,r){let{minValue:o,maxValue:s}=_t.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(r){let u=q.mergeTickArrayBitmap(e).shln(en-1-a),c=Hn(512,u)?null:wo(512,u);if(c!==null){let l=t-c*ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let u=q.mergeTickArrayBitmap(e).shrn(a),c=Hn(512,u)?null:Ao(512,u);if(c!==null){let l=t+c*ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ae.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%_t.maxTickInTickarrayBitmap(t),r=Math.floor(n/ae.tickCount(t));return e<0&&n!=0&&(r=en-r),r}};import Bt from"bn.js";var er=class{static getfeeGrowthInside(e,t,n){let r=new Bt(0),o=new Bt(0);e.tickCurrent>=t.tick?(r=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Bt(0),a=new Bt(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=H.wrappingSubU128(H.wrappingSubU128(e.feeGrowthGlobalX64A,r),s),c=H.wrappingSubU128(H.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,r){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=H.mulDivFloor(H.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,tt),u=t.tokenFeesOwedA.add(a),c=H.mulDivFloor(H.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,tt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,r){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=H.mulDivFloor(H.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,tt),u=t.tokenFeesOwedA.add(a),c=H.mulDivFloor(H.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,tt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,r){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=H.wrappingSubU128(u,c.growthInsideLastX64),m=H.mulDivFloor(l,t.liquidity,tt),p=c.rewardAmountOwed.add(m);o.push(p)}return o}static GetPositionRewards(e,t,n,r){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=H.wrappingSubU128(u,c.growthInsideLastX64),m=H.mulDivFloor(l,t.liquidity,tt),p=c.rewardAmountOwed.add(m);o.push(p)}return o}static getRewardGrowthInside(e,t,n,r){let o=[];for(let s=0;s<r.length;s++){let a=new Bt(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Bt(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(H.wrappingSubU128(H.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),u))}return o}static getRewardGrowthInsideV2(e,t,n,r){let o=[];for(let s=0;s<r.length;s++){let a=new Bt(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Bt(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(H.wrappingSubU128(H.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),u))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:r,add:o,epochInfo:s}){var b,g,A,k;let a=Q.priceToSqrtPriceX64(new V(e.price),e.mintA.decimals,e.mintB.decimals),u=Q.getSqrtPriceX64FromTick(t.tickLower),c=Q.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+r:1-r,m=se.getAmountsFromLiquidity(a,u,c,n,o),[p,d]=[be(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),be(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[y,f]=[be(new Bt(new V(m.amountA.toString()).mul(l).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,s,!0),be(new Bt(new V(m.amountB.toString()).mul(l).toFixed(0)),(k=e.mintB.extensions)==null?void 0:k.feeConfig,s,!0)];return{liquidity:n,amountA:p,amountB:d,amountSlippageA:y,amountSlippageB:f,expirationTime:Qt(p.expirationTime,d.expirationTime)}}};import{TOKEN_2022_PROGRAM_ID as Fa}from"@solana/spl-token";var We=class{static getOutputAmountAndRemainAccounts(e,t,n,r,o){let s=n.toBase58()===e.mintA.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");a.push(l);let{amountCalculated:m,accounts:p,sqrtPriceX64:d,feeAmount:y}=tn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r,c,o);return a.push(...p),{expectedAmountOut:m.mul(Mt),remainingAccounts:a,executionPrice:d,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,r,o){let s=n.toBase58()===e.mintB.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=fe(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:p,sqrtPriceX64:d,feeAmount:y}=tn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r.mul(Mt),c,o);return a.push(...p),{expectedAmountIn:m,remainingAccounts:a,executionPrice:d,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:r}=We.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Jn.checkTickArrayIsInit(ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):q.checkTickArrayIsInitialized(q.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=fe(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=fe(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ae.tickCount(e.tickSpacing)),r=t?q.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):q.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:r,tickIndex:o}=_t.nextInitializedTickArrayStartIndex(q.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(r)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=Jn.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<ve||t>Xe)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:r,rewardInfos:o}){var a,u,c;let s=[];for(let l=0;l<o.length;l++){let m=o[l],p=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(p===void 0)throw Error("get new reward mint info error");let d={...m,perSecond:H.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Xt(p)};if(d.tokenMint.equals(Xt.default))continue;if(n<=d.openTime.toNumber()||r.eq(ce)){s.push(d);continue}let y=new Te(Math.min(d.endTime.toNumber(),n)),f=y.sub(d.lastUpdateTime),b=H.mulDivFloor(f,d.emissionsPerSecondX64,r),g=d.rewardGrowthGlobalX64.add(b),A=H.mulDivFloor(f,d.emissionsPerSecondX64,tt),k=d.rewardTotalEmissioned.add(A);s.push({...d,rewardGrowthGlobalX64:g,rewardTotalEmissioned:k,lastUpdateTime:y})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:r}=this.tickRange(e);for(let o of t){let s=q.getTickArrayStartIndexByTick(o,e);if(s>=n||s<r)return!0}return!1}static tickRange(e){let t=_t.maxTickInTickarrayBitmap(e),n=-t;return t>Xe&&(t=ae.getArrayStartIndex(Xe,e)+ae.tickCount(e)),n<ve&&(n=ae.getArrayStartIndex(ve,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ae.tickCount(t)*en}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let r=await Sn(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of r)s.accountInfo!==null&&(o[s.pubkey.toString()]=va.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let r={},o=[];for(let u of t){let c=q.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=q.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:p}=fe(u.programId,u.id,m);o.push({pubkey:p}),r[p.toString()]=u.id}}let s=await Sn(e,o,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=r[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=$n.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]={...l,address:u.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:r=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(p=>p.accountInfo.mint),c=[];for(let p of u)for(let d of s)c.push(it(d,p).publicKey);let l=await Pt(t,c,{batchRequest:r}),m={};for(let p of l){if(p===null)continue;let d=$r.decode(p.data),y=d.poolId.toString(),f=e.find(x=>x.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=q._getTickPriceLegacy({poolInfo:b,tick:d.tickLower,baseIn:!0}),A=q._getTickPriceLegacy({poolInfo:b,tick:d.tickUpper,baseIn:!0}),{amountA:k,amountB:h}=se.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,d.liquidity,!1),T=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:g.price,priceUpper:A.price,amountA:k,amountB:h,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(x=>({...x,pendingReward:new Te(0)})),leverage:T,tokenFeeAmountA:new Te(0),tokenFeeAmountB:new Te(0)}];let I=await q.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickLower,f.state.tickSpacing),S=await q.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=I,m[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=S}if(o){let p=Object.values(m),d=await Pt(t,p,{batchRequest:r}),y={};for(let f=0;f<p.length;f++){let b=d[f];if(b===null)continue;let g=p[f].toString();y[g]=$n.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let A=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,k=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,h=y[m[A].toString()],T=y[m[k].toString()],I=h.ticks[q.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=T.ticks[q.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:K}=await er.GetPositionFees(f,g,I,S),N=await er.GetPositionRewards(f,g,I,S);g.tokenFeeAmountA=x.gte(new Te(0))?x:new Te(0),g.tokenFeeAmountB=K.gte(new Te(0))?K:new Te(0);for(let E=0;E<N.length;E++)g.rewardInfos[E].pendingReward=N[E].gte(new Te(0))?N[E]:new Te(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountIn:o,slippage:s,priceLimit:a=new V(0)}){var N;let u,c=n.toBase58()===e.mintA.address,[l,m]=c?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new V(0))?u=c?It.add(new Te(1)):xt.sub(new Te(1)):u=Q.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=be(o,l,r,!1),{expectedAmountOut:d,remainingAccounts:y,executionPrice:f,feeAmount:b}=We.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((N=p.fee)!=null?N:ce),u),g=be(d,m,r,!1),A=Q.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),k=c?A:new V(1).div(A),h=d.mul(new Te(Math.floor((1-s)*1e10))).div(new Te(1e10)),T=be(h,m,r,!1),I=c?e.currentPrice:new V(1).div(e.currentPrice),S=new V(k).sub(I).abs(),x=I,K=new $e(new V(S).mul(10**15).toFixed(0),new V(x).mul(10**15).toFixed(0));return{realAmountIn:p,amountOut:g,minAmountOut:T,expirationTime:Qt(p.expirationTime,g.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:K,fee:b,remainingAccounts:y}}static async computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:r,slippage:o,epochInfo:s}){let a=r.address===e.mintB.address,[u,c]=a?[e.mintA,e.mintB]:[e.mintB,e.mintA],[l,m]=[new Ae({...u,mint:u.address,isToken2022:u.programId===Fa.toBase58()}),new Ae({...c,mint:c.address,isToken2022:c.programId===Fa.toBase58()})],{realAmountIn:p,amountOut:d,minAmountOut:y,expirationTime:f,currentPrice:b,executionPrice:g,priceImpact:A,fee:k,remainingAccounts:h}=await We.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Xt(u.address),amountIn:n,slippage:o,epochInfo:s}),T={...p,amount:new he(l,p.amount),fee:p.fee===void 0?void 0:new he(l,p.fee)},I={...d,amount:new he(m,d.amount),fee:d.fee===void 0?void 0:new he(m,d.fee)},S={...y,amount:new he(m,y.amount),fee:y.fee===void 0?void 0:new he(m,y.fee)},x=new rt({baseToken:l,denominator:new Te(10).pow(new Te(20+l.decimals)),quoteToken:m,numerator:b.mul(new V(10**(20+m.decimals))).toFixed(0)}),K=new rt({baseToken:l,denominator:new Te(10).pow(new Te(20+l.decimals)),quoteToken:m,numerator:g.mul(new V(10**(20+m.decimals))).toFixed(0)}),N=new he(l,k);return{realAmountIn:T,amountOut:I,minAmountOut:S,expirationTime:f,currentPrice:x,executionPrice:K,priceImpact:A,fee:N,remainingAccounts:h}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:r}){var y,f,b;let o=e[t],s=q.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=q.getTickPrice({poolInfo:e,tick:r,baseIn:!0}).price.toNumber(),u=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-u,m=a-s,p=o.priceMax-o.priceMin,d;return l<=0?d=0:m===l?d=p/l:p===l?d=l/m:d=l/p*(l/m),{feeApr:o.feeApr*d,rewardsApr:[(y=o.rewardApr[0])!=null?y:0*d,(f=o.rewardApr[1])!=null?f:0*d,(b=o.rewardApr[2])!=null?b:0*d],apr:o.apr*d}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:r,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=r[ln(e.mintA.address).toString()],p=r[ln(e.mintB.address).toString()],d=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!p)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=Q.priceToSqrtPriceX64(new V(e.price),e.mintA.decimals,e.mintB.decimals),b=Q.getSqrtPriceX64FromTick(s),g=Q.getSqrtPriceX64FromTick(a),{amountSlippageA:A,amountSlippageB:k}=se.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:T}=se.getAmountsFromLiquidityWithSlippage(f,b,g,o,!1,!1,0),I=new V(A.toString()).div(new V(10).pow(d)).mul(m.value).add(new V(k.toString()).div(new V(10).pow(y)).mul(p.value)),S=new V(h.toString()).div(new V(10).pow(d)).mul(m.value).add(new V(T.toString()).div(new V(10).pow(y)).mul(p.value)),x=S.div(I.add(S)).div(S),N=new V(l.volumeFee).mul(365).div(c).mul(x).mul(100).toNumber(),E=3600*24*365,z=e.rewardDefaultInfos.map(v=>{var re,ct;let Z=v.mint.decimals,J=r[v.mint.address];return u<((re=v.startTime)!=null?re:0)||u>((ct=v.endTime)!=null?ct:0)||!v.perSecond||!J||Z===void 0?0:new V(J.value).mul(new V(v.perSecond).mul(E)).div(new V(10).pow(Z)).mul(x).mul(100).toNumber()});return{feeApr:N,rewardsApr:z,apr:N+z.reduce((v,Z)=>v+Z,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:r,amount:o,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var g,A;let l=Q.priceToSqrtPriceX64(new V(e.price),e.mintA.decimals,e.mintB.decimals),m=Q.getSqrtPriceX64FromTick(n),p=Q.getSqrtPriceX64FromTick(r),d=a?1-s:1+s,y=be(o,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!c),f=new Te(new V(y.amount.sub((A=y.fee)!=null?A:ce).toString()).mul(d).toFixed(0)),b;if(l.lte(m))b=t?se.getLiquidityFromTokenAmountA(m,p,f,!a):new Te(0);else if(l.lte(p)){let k=se.getLiquidityFromTokenAmountA(l,p,f,!a),h=se.getLiquidityFromTokenAmountB(m,l,f);b=t?k:h}else b=t?new Te(0):se.getLiquidityFromTokenAmountB(m,p,f);return We.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:r,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:r,liquidity:o,slippage:s,add:a}){var b,g,A,k;let u=Q.getSqrtPriceX64FromTick(n),c=Q.getSqrtPriceX64FromTick(r),l=a?1+s:1-s,m=se.getAmountsFromLiquidity(Q.priceToSqrtPriceX64(new V(t.price),t.mintA.decimals,t.mintB.decimals),u,c,o,a),[p,d]=[be(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),be(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[be(m.amountA.muln(l),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),be(m.amountB.muln(l),(k=t.mintB.extensions)==null?void 0:k.feeConfig,e,!0)];return{liquidity:o,amountA:p,amountB:d,amountSlippageA:y,amountSlippageB:f,expirationTime:Qt(p.expirationTime,d.expirationTime)}}static async fetchComputeClmmInfo({owner:e,connection:t,poolInfo:n}){let r=await t.getAccountInfo(new Xt(n.id));if(!r)throw new Error(`pool not found ${n.id}`);let o=Zr.decode(r.data),s=ot(e,new Xt(n.id)).publicKey,a=await We.fetchExBitmaps({connection:t,exBitmapAddress:[s],batchRequest:!1});return{...o,id:new Xt(n.id),programId:new Xt(n.programId),mintA:n.mintA,mintB:n.mintB,ammConfig:{...n.config,id:new Xt(n.config.id),fundOwner:""},currentPrice:new V(n.price),exBitmapInfo:a[s.toBase58()],startTime:o.startTime.toNumber()}}};function $P({poolInfo:i,tickLower:e,tickUpper:t,amountA:n,amountB:r,slippage:o,add:s,epochInfo:a,amountHasFee:u}){var k,h,T,I;let[c,l,m,p]=e<t?[e,t,n,r]:[t,e,r,n],d=Q.priceToSqrtPriceX64(new V(i.price),i.mintA.decimals,i.mintB.decimals),y=Q.getSqrtPriceX64FromTick(c),f=Q.getSqrtPriceX64FromTick(l),[b,g]=[be(m,(k=i.mintA.extensions)==null?void 0:k.feeConfig,a,!u),be(p,(h=i.mintB.extensions)==null?void 0:h.feeConfig,a,!u)],A=se.getLiquidityFromTokenAmounts(d,y,f,b.amount.sub((T=b.fee)!=null?T:ce),g.amount.sub((I=g.fee)!=null?I:ce));return se.getAmountsOutFromLiquidity({poolInfo:i,tickLower:e,tickUpper:t,liquidity:A,slippage:o,add:s,epochInfo:a,amountAddFee:!u})}var H=class{static mulDivRoundingUp(e,t,n){let r=e.mul(t),o=r.div(n);return r.mod(n).eq(ce)||(o=o.add(et)),o}static mulDivFloor(e,t,n){if(n.eq(ce))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(ce))throw new Error("division by 0");return e.mul(t).add(n.sub(et)).div(n)}static x64ToDecimal(e,t){return new V(e.toString()).div(V.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new ee(e.mul(V.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Hr).sub(t).mod(Hr)}};function Re(i,e){return To(i.mul(e),64,256)}function Bm(i,e,t){let n=i.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function To(i,e,t){let n=i.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var Q=class{static sqrtPriceX64ToPrice(e,t,n){return H.x64ToDecimal(e).pow(2).mul(V.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return H.decimalToX64(e.mul(V.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,r){if(!e.gt(ce))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ce))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,r){if(!e.gt(ce))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ce))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,r){if(n.eq(ce))return e;let o=t.shln(Zn);if(r){let s=o,a=o.add(n.mul(e));return a.gte(s)?H.mulDivCeil(s,e,a):H.mulDivRoundingUp(s,et,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return H.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,r){let o=n.shln(Zn);if(r)return e.add(o.div(t));{let s=H.mulDivRoundingUp(o,et,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<ve||e>Xe)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new ee("18445821805675395072"):new ee("18446744073709551616");return(t&2)!=0&&(n=Re(n,new ee("18444899583751176192"))),(t&4)!=0&&(n=Re(n,new ee("18443055278223355904"))),(t&8)!=0&&(n=Re(n,new ee("18439367220385607680"))),(t&16)!=0&&(n=Re(n,new ee("18431993317065453568"))),(t&32)!=0&&(n=Re(n,new ee("18417254355718170624"))),(t&64)!=0&&(n=Re(n,new ee("18387811781193609216"))),(t&128)!=0&&(n=Re(n,new ee("18329067761203558400"))),(t&256)!=0&&(n=Re(n,new ee("18212142134806163456"))),(t&512)!=0&&(n=Re(n,new ee("17980523815641700352"))),(t&1024)!=0&&(n=Re(n,new ee("17526086738831433728"))),(t&2048)!=0&&(n=Re(n,new ee("16651378430235570176"))),(t&4096)!=0&&(n=Re(n,new ee("15030750278694412288"))),(t&8192)!=0&&(n=Re(n,new ee("12247334978884435968"))),(t&16384)!=0&&(n=Re(n,new ee("8131365268886854656"))),(t&32768)!=0&&(n=Re(n,new ee("3584323654725218816"))),(t&65536)!=0&&(n=Re(n,new ee("696457651848324352"))),(t&131072)!=0&&(n=Re(n,new ee("26294789957507116"))),(t&262144)!=0&&(n=Re(n,new ee("37481735321082"))),e>0&&(n=Oa.div(n)),n}static getTickFromPrice(e,t,n){return Q.getTickFromSqrtPriceX64(Q.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(xt)||e.lt(It))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new ee(t-64),r=Bm(n,32,128),o=new ee("8000000000000000","hex"),s=0,a=new ee(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new ee(0))&&s<Na;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),a=a.add(o.mul(y)),o=o.shrn(1),s+=1}let c=a.shrn(32),m=r.add(c).mul(new ee(Ma)),p=To(m.sub(new ee(_a)),64,128).toNumber(),d=To(m.add(new ee(Va)),64,128).toNumber();return p==d?p:Q.getSqrtPriceX64FromTick(d).lte(e)?d:p}},nn=class{static getTickWithPriceAndTickspacing(e,t,n,r){let s=Q.getTickFromSqrtPriceX64(Q.priceToSqrtPriceX64(e,n,r))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,r){let o=nn.getTickWithPriceAndTickspacing(e,t,n,r),s=Q.getSqrtPriceX64FromTick(o);return Q.sqrtPriceX64ToPrice(s,n,r)}},se=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ce))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(Zn),s=t.sub(e);return r?H.mulDivRoundingUp(H.mulDivCeil(o,s,t),et,e):H.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ce))throw new Error("sqrtPriceX64A must greater than 0");return r?H.mulDivCeil(n,t.sub(e),tt):H.mulDivFloor(n,t.sub(e),tt)}static getLiquidityFromTokenAmountA(e,t,n,r){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return r?H.mulDivRoundingUp(a,et,ko):a.shrn(Zn)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),H.mulDivFloor(n,ko,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,r,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return se.getLiquidityFromTokenAmountA(t,n,r,!1);if(e.lt(n)){let s=se.getLiquidityFromTokenAmountA(e,n,r,!1),a=se.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return se.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,r,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:se.getTokenAmountAFromLiquidity(t,n,r,o),amountB:new ee(0)};if(e.lt(n)){let s=se.getTokenAmountAFromLiquidity(e,n,r,o),a=se.getTokenAmountBFromLiquidity(t,e,r,o);return{amountA:s,amountB:a}}else return{amountA:new ee(0),amountB:se.getTokenAmountBFromLiquidity(t,n,r,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,r,o,s,a){let{amountA:u,amountB:c}=se.getAmountsFromLiquidity(e,t,n,r,s),l=o?1+a:1-a,m=new ee(new V(u.toString()).mul(l).toFixed(0)),p=new ee(new V(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:p}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:r,slippage:o,add:s,epochInfo:a,amountAddFee:u}){var A,k,h,T;let c=Q.priceToSqrtPriceX64(new V(e.price),e.mintA.decimals,e.mintB.decimals),l=Q.getSqrtPriceX64FromTick(t),m=Q.getSqrtPriceX64FromTick(n),p=s?1+o:1-o,d=se.getAmountsFromLiquidity(c,l,m,r,s),[y,f]=[be(d.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,a,u),be(d.amountB,(k=e.mintB.extensions)==null?void 0:k.feeConfig,a,u)],[b,g]=[be(new ee(new V(d.amountA.toString()).mul(p).toFixed(0)),(h=e.mintA.extensions)==null?void 0:h.feeConfig,a,u),be(new ee(new V(d.amountB.toString()).mul(p).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,a,u)];return{liquidity:r,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Qt(y.expirationTime,f.expirationTime)}}},tn=class{static swapCompute(e,t,n,r,o,s,a,u,c,l,m,p,d,y){if(p.eq(ce))throw new Error("amountSpecified must not be 0");if(y||(y=s?It.add(et):xt.sub(et)),s){if(y.lt(It))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(xt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let f=p.gt(ce),b={amountSpecifiedRemaining:p,amountCalculated:ce,sqrtPriceX64:m,tick:c>d?Math.min(d+ae.tickCount(l)-1,c):d,accounts:[],liquidity:u,feeAmount:new ee(0)},g=d,A=n[d],k=0,h=!s&&A.startTickIndex===b.tick;for(;!b.amountSpecifiedRemaining.eq(ce)&&!b.sqrtPriceX64.eq(y);){if(k>10)throw Error("liquidity limit");let T={};T.sqrtPriceStartX64=b.sqrtPriceX64;let I=q.nextInitTick(A,b.tick,l,s,h),S=I||null,x=null;if(!(S!=null&&S.liquidityGross.gtn(0))){let N=We.nextInitializedTickArrayStartIndex({tickCurrent:b.tick,tickSpacing:l,tickArrayBitmap:r,exBitmapInfo:o},g,s);if(!N.isExist)throw Error("swapCompute LiquidityInsufficient");g=N.nextStartIndex;let{publicKey:E}=fe(e,t,g);x=E,A=n[g],S=q.firstInitializedTick(A,s)}T.tickNext=S.tick,T.initialized=S.liquidityGross.gtn(0),d!==g&&x&&(b.accounts.push(x),d=g),T.tickNext<ve?T.tickNext=ve:T.tickNext>Xe&&(T.tickNext=Xe),T.sqrtPriceNextX64=Q.getSqrtPriceX64FromTick(T.tickNext);let K;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?K=y:K=T.sqrtPriceNextX64,[b.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=tn.swapStepCompute(b.sqrtPriceX64,K,b.liquidity,b.amountSpecifiedRemaining,a),b.feeAmount=b.feeAmount.add(T.feeAmount),f?(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),b.amountCalculated=b.amountCalculated.sub(T.amountOut)):(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.add(T.amountOut),b.amountCalculated=b.amountCalculated.add(T.amountIn.add(T.feeAmount))),b.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let N=S.liquidityNet;s&&(N=N.mul(Mt)),b.liquidity=se.addDelta(b.liquidity,N)}h=T.tickNext!=b.tick&&!s&&A.startTickIndex===T.tickNext,b.tick=s?T.tickNext-1:T.tickNext}else if(b.sqrtPriceX64!=T.sqrtPriceStartX64){let N=Q.getTickFromSqrtPriceX64(b.sqrtPriceX64);h=N!=b.tick&&!s&&A.startTickIndex===N,b.tick=N}++k}try{let{nextStartIndex:T,isExist:I}=ae.nextInitializedTickArray(b.tick,l,s,r,o);I&&d!==T&&(b.accounts.push(fe(e,t,T).publicKey),d=T)}catch{}return{amountCalculated:b.amountCalculated,feeAmount:b.feeAmount,sqrtPriceX64:b.sqrtPriceX64,liquidity:b.liquidity,tickCurrent:b.tick,accounts:b.accounts}}static swapStepCompute(e,t,n,r,o){let s={sqrtPriceX64Next:new ee(0),amountIn:new ee(0),amountOut:new ee(0),feeAmount:new ee(0)},a=e.gte(t),u=r.gte(ce);if(u){let l=H.mulDivFloor(r,jr.sub(new ee(o.toString())),jr);s.amountIn=a?se.getTokenAmountAFromLiquidity(t,e,n,!0):se.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=Q.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?se.getTokenAmountBFromLiquidity(t,e,n,!1):se.getTokenAmountAFromLiquidity(e,t,n,!1),r.mul(Mt).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=Q.getNextSqrtPriceX64FromOutput(e,n,r.mul(Mt),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=se.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=se.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:se.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:se.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(r.mul(Mt))&&(s.amountOut=r.mul(Mt)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=r.sub(s.amountIn):s.feeAmount=H.mulDivCeil(s.amountIn,new ee(o),jr.sub(new ee(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var Ke=60,en=512,q=class{static getTickArrayAddressByTick(e,t,n,r){let o=q.getTickArrayStartIndexByTick(n,r),{publicKey:s}=fe(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=q.getTickArrayStartIndexByTick(e,t),r=Math.floor((e-n)/t);if(r<0||r>=Ke)throw new Error("tick offset in array overflow");return r}static getTickArrayBitIndex(e,t){let n=ae.tickCount(t),r=e/n;return e<0&&e%n!=0?r=Math.ceil(r)-1:r=Math.floor(r),r}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ae.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Ke,r=Math.floor(e/n)+512;return Math.abs(r)}static checkTickArrayIsInitialized(e,t,n){let r=n*Ke,o=Math.floor(t/r)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*r}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Ke:e+t*Ke}static mergeTickArrayBitmap(e){let t=new Sm(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,r,o){let s=Math.floor(r/(n*Ke));return[...q.searchLowBitFromStart(e,t,s-1,o,n),...q.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return q.searchHightBitFromStart(e,t,0,en,n)}static getAllInitializedTickArrayInfo(e,t,n,r,o){let s=[],a=q.getAllInitializedTickArrayStartIndex(n,r,o);for(let u of a){let{publicKey:c}=fe(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,r,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>q.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===r)break}let u=ae.tickCount(o);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,r,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>q.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===r)break}let u=ae.tickCount(o);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<ve||e>Xe}static nextInitTick(e,t,n,r,o){if(ae.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(r)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<Ke;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Ke-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Ke;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let r=Q.getSqrtPriceX64FromTick(t),o=Q.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:r}:{tick:t,price:new V(1).div(o),tickSqrtPriceX64:r}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let r=n?t:new V(1).div(t),o=nn.getTickWithPriceAndTickspacing(r,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=Q.getSqrtPriceX64FromTick(o),a=Q.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new V(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let r=Q.getSqrtPriceX64FromTick(t),o=Q.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:r}:{tick:t,price:new V(1).div(o),tickSqrtPriceX64:r}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let r=n?t:new V(1).div(t),o=nn.getTickWithPriceAndTickspacing(r,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=Q.getSqrtPriceX64FromTick(o),a=Q.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new V(1).div(a)}}};var hk=O([le(8),M("bump"),kt("index"),B(""),Ee("protocolFeeRate"),Ee("tradeFeeRate"),kt("tickSpacing"),W(w(),8,"")]),Km=O([Ee("blockTimestamp"),X("sqrtPriceX64"),X("cumulativeTimePriceX64"),W(X(),1,"")]),Io=O([le(8),Me("initialized"),B("poolId"),W(Km,1e3,"observations"),W(X(),5,"")]),Cm=O([M("rewardState"),w("openTime"),w("endTime"),w("lastUpdateTime"),X("emissionsPerSecondX64"),w("rewardTotalEmissioned"),w("rewardClaimed"),B("tokenMint"),B("tokenVault"),B("creator"),X("rewardGrowthGlobalX64")]),Zr=O([le(8),M("bump"),B("ammConfig"),B("creator"),B("mintA"),B("mintB"),B("vaultA"),B("vaultB"),B("observationId"),M("mintDecimalsA"),M("mintDecimalsB"),kt("tickSpacing"),X("liquidity"),X("sqrtPriceX64"),Ne("tickCurrent"),kt("observationIndex"),kt("observationUpdateDuration"),X("feeGrowthGlobalX64A"),X("feeGrowthGlobalX64B"),w("protocolFeesTokenA"),w("protocolFeesTokenB"),X("swapInAmountTokenA"),X("swapOutAmountTokenB"),X("swapInAmountTokenB"),X("swapOutAmountTokenA"),M("status"),W(M(),7,""),W(Cm,3,"rewardInfos"),W(w(),16,"tickArrayBitmap"),w("totalFeesTokenA"),w("totalFeesClaimedTokenA"),w("totalFeesTokenB"),w("totalFeesClaimedTokenB"),w("fundFeesTokenA"),w("fundFeesTokenB"),w("startTime"),W(w(),15*4-3,"padding")]),Rm=O([X("growthInsideLastX64"),w("rewardAmountOwed")]),$r=O([le(8),M("bump"),B("nftMint"),B("poolId"),Ne("tickLower"),Ne("tickUpper"),X("liquidity"),X("feeGrowthInsideLastX64A"),X("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),W(Rm,3,"rewardInfos"),W(w(),8,"")]),Tk=O([le(8),M("bump"),B("poolId"),Ne("tickLowerIndex"),Ne("tickUpperIndex"),X("liquidity"),X("feeGrowthInsideLastX64A"),X("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),W(X(),3,"rewardGrowthInside"),W(w(),8,"")]),Lm=O([Ne("tick"),Ds("liquidityNet"),X("liquidityGross"),X("feeGrowthOutsideX64A"),X("feeGrowthOutsideX64B"),W(X(),3,"rewardGrowthsOutsideX64"),W(Ee(),13,"")]),$n=O([le(8),B("poolId"),Ne("startTickIndex"),W(Lm,Ke,"ticks"),M("initializedTickCount"),W(M(),115,"")]),Wa=O([le(329),W(B(),100,"whitelistMints")]),va=O([le(8),B("poolId"),W(W(w(),8),ho,"positiveTickArrayBitmap"),W(W(w(),8),ho,"negativeTickArrayBitmap")]);var Ua=oe("Raydium_Clmm"),gt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},ke=class{static createPoolInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y){let f=O([X("sqrtPriceX64"),w("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:yn.programId,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:d,startTime:y},g);let A=Buffer.from([...gt.createPool,...g]);return new bt({keys:b,programId:e,data:A})}static async createPoolInstructions(e){let{connection:t,programId:n,owner:r,mintA:o,mintB:s,ammConfigId:a,initialPriceX64:u,startTime:c,forerunCreate:l}=e,m=Fe({fromPublicKey:r,programId:n}),[p,d]=[new F(o.address),new F(s.address)],y=[yn.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:m.seed,newAccountPubkey:m.publicKey,lamports:l?0:await t.getMinimumBalanceForRentExemption(Io.span),space:Io.span,programId:n})],{publicKey:f}=Ra(n,a,p,d),{publicKey:b}=Po(n,f,p),{publicKey:g}=Po(n,f,d);return y.push(this.createPoolInstruction(n,f,r,a,m.publicKey,p,b,new F(o.programId||_e),d,g,new F(s.programId||_e),ot(n,f).publicKey,u,c)),{signers:[],instructions:y,instructionTypes:[_.CreateAccount,_.ClmmCreatePool],address:{poolId:f,observationId:m.publicKey,mintAVault:b,mintBVault:g},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g,A,k,h,T,I,S,x,K,N){let E=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),X("liquidity"),w("amountMaxA"),w("amountMaxB"),Me("withMetadata"),M("optionBaseFlag"),Me("baseFlag")]),z=[...N?[{pubkey:N,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ye,isSigner:!1,isWritable:!1},{pubkey:yn.programId,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:Da,isSigner:!1,isWritable:!1},{pubkey:cn,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...z],Z=Buffer.alloc(E.span);E.encode({tickLowerIndex:A,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:T,liquidity:I,amountMaxA:S,amountMaxB:x,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},Z);let J=Buffer.from([...gt.openPosition,...Z]);return new bt({keys:v,programId:e,data:J})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[p,d]=[new F(e.programId),new F(e.id)],y;if(l)y=new F((await l(1))[0]);else{let x=xo.generate();m.push(x),y=x.publicKey}let f=q.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:g}=fe(p,d,f),{publicKey:A}=fe(p,d,b),{publicKey:k}=de(n.wallet,y,_e),{publicKey:h}=Qr(y),{publicKey:T}=it(p,y),{publicKey:I}=Jt(p,d,r,o),S=this.openPositionFromLiquidityInstruction(p,n.feePayer,d,n.wallet,y,k,h,I,g,A,T,n.tokenAccountA,n.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),r,o,f,b,s,a,u,c);return{signers:m,instructions:[S],instructionTypes:[_.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:k,metadataAccount:h,personalPosition:T,protocolPosition:I}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[p,d]=[new F(e.programId),new F(e.id)],y;if(l)y=new F((await l(1))[0]);else{let x=xo.generate();m.push(x),y=x.publicKey}let f=q.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:g}=fe(p,d,f),{publicKey:A}=fe(p,d,b),{publicKey:k}=de(n.wallet,y,_e),{publicKey:h}=Qr(y),{publicKey:T}=it(p,y),{publicKey:I}=Jt(p,d,r,o),S=this.openPositionFromBaseInstruction(p,n.feePayer,d,n.wallet,y,k,h,I,g,A,T,n.tokenAccountA,n.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),r,o,f,b,c,s,a,u,We.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?ot(p,d).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:k,metadataAccount:h,personalPosition:T,protocolPosition:I},instructions:[S],signers:m,instructionTypes:[_.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g,A,k,h,T,I,S,x,K,N){let E=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),X("liquidity"),w("amountMaxA"),w("amountMaxB"),Me("withMetadata"),M("optionBaseFlag"),Me("baseFlag")]),z=[...N?[{pubkey:N,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ye,isSigner:!1,isWritable:!1},{pubkey:yn.programId,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:Da,isSigner:!1,isWritable:!1},{pubkey:cn,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...z],Z=Buffer.alloc(E.span);E.encode({tickLowerIndex:A,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:T,liquidity:new qa(0),amountMaxA:S==="MintA"?x:K,amountMaxB:S==="MintA"?K:x,withMetadata:I==="create",baseFlag:S==="MintA",optionBaseFlag:1},Z);let J=Buffer.from([...gt.openPosition,...Z]);return new bt({keys:v,programId:e,data:J})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m,p=[];if(l)m=new F((await l(1))[0]);else{let x=xo.generate();p.push(x),m=x.publicKey}let[d,y]=[new F(e.programId),new F(e.id)],f=q.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:g}=fe(d,y,f),{publicKey:A}=fe(d,y,b),{publicKey:k}=de(n.wallet,m,_e),{publicKey:h}=Qr(m),{publicKey:T}=it(d,m),{publicKey:I}=Jt(d,y,r,o),S=this.openPositionFromLiquidityInstruction(d,n.wallet,y,n.wallet,m,k,h,I,g,A,T,n.tokenAccountA,n.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(t.mintA.address),new F(t.mintB.address),r,o,f,b,s,a,u,c,We.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?ot(d,y).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:k,metadataAccount:h,personalPosition:T,protocolPosition:I},instructions:[S],signers:p,instructionTypes:[_.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,r,o){let s=O([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:yn.programId,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let c=Buffer.from([...gt.closePosition,...u]);return new bt({keys:a,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:r}){let o=new F(e.programId),{publicKey:s}=de(n.wallet,r.nftMint,_e),{publicKey:a}=it(o,r.nftMint),u=[];return u.push(this.closePositionInstruction(o,n.wallet,r.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:u,instructionTypes:[_.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g,A){let k=O([X("liquidity"),w("amountMaxA"),w("amountMaxB"),M("optionBaseFlag"),Me("baseFlag")]),h=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],I=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},I);let S=Buffer.from([...gt.increaseLiquidity,...I]);return new bt({keys:T,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:o,amountMaxA:s,amountMaxB:a}){let[u,c]=[new F(e.programId),new F(e.id)],l=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=fe(u,c,l),{publicKey:d}=fe(u,c,m),{publicKey:y}=de(r.wallet,n.nftMint,_e),{publicKey:f}=it(u,n.nftMint),{publicKey:b}=Jt(u,c,n.tickLower,n.tickUpper),g=this.increasePositionFromLiquidityInstruction(u,r.wallet,y,f,c,b,p,d,r.tokenAccountA,r.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),o,s,a,We.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?ot(u,c).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:d,positionNftAccount:y,personalPosition:f,protocolPosition:b},signers:[],instructions:[g],instructionTypes:[_.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,base:o,baseAmount:s,otherAmountMax:a}){let[u,c]=[new F(e.programId),new F(e.id)],l=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=fe(u,c,l),{publicKey:d}=fe(u,c,m),{publicKey:y}=de(r.wallet,n.nftMint,_e),{publicKey:f}=it(u,n.nftMint),{publicKey:b}=Jt(u,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:d,positionNftAccount:y,personalPosition:f,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(u,r.wallet,y,f,c,b,p,d,r.tokenAccountA,r.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),o,s,a,We.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?ot(u,c).publicKey:void 0)],signers:[],instructionTypes:[_.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g,A){let k=O([X("liquidity"),w("amountMaxA"),w("amountMaxB"),M("optionBaseFlag"),Me("baseFlag")]),h=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],I=Buffer.alloc(k.span);k.encode({liquidity:new qa(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},I);let S=Buffer.from([...gt.increaseLiquidity,...I]);return new bt({keys:T,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g,A,k){let h=O([X("liquidity"),w("amountMinA"),w("amountMinB")]),T=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],S=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:A},S);let x=Buffer.from([...gt.decreaseLiquidity,...S]);return new bt({keys:I,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:o,amountMinA:s,amountMinB:a,programId:u}){let[c,l]=[new F(e.programId),new F(e.id)],m=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=fe(c,l,m),{publicKey:y}=fe(c,l,p),{publicKey:f}=de(r.wallet,n.nftMint,u),{publicKey:b}=it(c,n.nftMint),{publicKey:g}=Jt(c,l,n.tickLower,n.tickUpper),A=[];for(let h=0;h<e.rewardDefaultInfos.length;h++)A.push({poolRewardVault:new F(t.rewardInfos[h].vault),ownerRewardVault:r.rewardAccounts[h],rewardMint:new F(e.rewardDefaultInfos[h].mint.address)});let k=[];return k.push(this.decreaseLiquidityInstruction(c,r.wallet,f,b,l,g,d,y,r.tokenAccountA,r.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),A,o,s,a,We.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?ot(c,l).publicKey:void 0)),{address:{tickArrayLower:d,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:k,instructionTypes:[_.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g){let A=O([w("amount"),w("otherAmountThreshold"),X("sqrtPriceLimitX64"),Me("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],T=Buffer.alloc(A.span);A.encode({amount:d,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},T);let I=Buffer.from([...gt.swap,...T]);return new bt({keys:h,programId:e,data:I})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,inputMint:r,amountIn:o,amountOutMin:s,sqrtPriceLimitX64:a,remainingAccounts:u}){let[c,l]=[new F(e.programId),new F(e.id)],[m,p]=[new F(t.vault.A),new F(t.vault.B)],[d,y]=[new F(e.mintA.address),new F(e.mintB.address)],f=e.mintA.address===r.toString(),b=[this.swapInstruction(c,n.wallet,l,new F(e.config.id),f?n.tokenAccountA:n.tokenAccountB,f?n.tokenAccountB:n.tokenAccountA,f?m:p,f?p:m,f?d:y,f?y:d,u,m,o,s,a,!0,ot(c,l).publicKey)];return{signers:[],instructions:b,instructionTypes:[_.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,r,o,s,a,u,c,l,m,p){let d=O([w("openTime"),w("endTime"),X("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:yn.programId,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1}],f=Buffer.alloc(d.span);d.encode({openTime:G(l),endTime:G(m),emissionsPerSecondX64:p},f);let b=Buffer.from([...gt.initReward,...f]);return new bt({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[o,s]=[new F(e.programId),new F(e.id)],a=La(o,s,r.mint).publicKey,u=jn(o).publicKey,c=[this.initRewardInstruction(o,n.wallet,s,u,new F(e.config.id),n.tokenAccount,r.programId,r.mint,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:u},signers:[],instructions:c,instructionTypes:[_.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,r,o,s,a,u,c,l,m,p){let d=O([M("rewardIndex"),X("emissionsPerSecondX64"),w("openTime"),w("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],f=Buffer.alloc(d.span);d.encode({rewardIndex:c,emissionsPerSecondX64:p,openTime:G(l),endTime:G(m)},f);let b=Buffer.from([...gt.setRewardEmissions,...f]);return new bt({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[o,s]=[new F(e.programId),new F(e.id)],a,u,c;for(let p=0;p<e.rewardDefaultInfos.length;p++)e.rewardDefaultInfos[p].mint.address===r.mint.toString()&&(a=p,u=new F(t.rewardInfos[p].vault),c=new F(t.rewardInfos[p].mint.address));(a===void 0||u===void 0)&&Ua.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=jn(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,s,l,new F(e.config.id),n.tokenAccount,u,c,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:l},signers:[],instructions:m,instructionTypes:[_.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,r,o,s,a){let u=O([M("rewardIndex")]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({rewardIndex:a},l);let m=Buffer.from([...gt.collectReward,...l]);return new bt({keys:c,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:r}){let[o,s]=[new F(e.programId),new F(e.id)],a,u;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===r.toString()&&(a=l,u=new F(t.rewardInfos[l].vault));(a===void 0||u===void 0)&&Ua.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=[this.collectRewardInstruction(o,n.wallet,s,n.tokenAccount,u,r,a)];return{address:{rewardVault:u},signers:[],instructions:c,instructionTypes:[_.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapBaseOutInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,outputMint:r,amountOut:o,amountInMax:s,sqrtPriceLimitX64:a,remainingAccounts:u}){let[c,l]=[new F(e.programId),new F(e.id)],[m,p]=[new F(t.vault.A),new F(t.vault.B)],[d,y]=[new F(e.mintA.address),new F(e.mintB.address)],f=e.mintA.address===r.toString(),b=[this.swapInstruction(c,n.wallet,l,new F(e.config.id),f?n.tokenAccountB:n.tokenAccountA,f?n.tokenAccountA:n.tokenAccountB,f?p:m,f?m:p,f?d:y,f?y:d,u,m,o,s,a,!1)];return{signers:[],instructions:b,instructionTypes:[_.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}};import{PublicKey as _m}from"@solana/web3.js";import{PublicKey as Nm}from"@solana/web3.js";import Ga from"bn.js";var Xa=new Ga(25),za=new Ga(1e4),Om={4:3,5:3};var Mm=oe("Raydium_liquidity_serum");function Ya({programId:i,marketId:e}){let t=[e.toBuffer()],n=0,r;for(;n<100;){try{let o=t.concat(Buffer.from([n]),Buffer.alloc(7));r=Nm.createProgramAddressSync(o,i)}catch(o){if(o instanceof TypeError)throw o;n++;continue}return{publicKey:r,nonce:n}}throw Mm.logWithError("unable to find a viable program address nonce","params",{programId:i,marketId:e}),new Error("unable to find a viable program address nonce")}import tr from"bn.js";function So({programId:i}){let{publicKey:e}=ne([Buffer.from("amm_config_account_seed","utf-8")],i);return e}function rn({name:i,programId:e,marketId:t}){let{publicKey:n}=ne([e.toBuffer(),t.toBuffer(),Buffer.from(i,"utf-8")],e);return n}function Vm({programId:i,marketId:e}){let{publicKey:t}=ne([i.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],i);return t}function Em({programId:i}){return ne([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],i)}function Qa({version:i,marketVersion:e,marketId:t,baseMint:n,quoteMint:r,baseDecimals:o,quoteDecimals:s,programId:a,marketProgramId:u}){let c=rn({name:"amm_associated_seed",programId:a,marketId:t}),l=rn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:p}=Em({programId:a}),d=rn({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=rn({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=rn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Vm({programId:a,marketId:t}),g=rn({name:"target_associated_seed",programId:a,marketId:t}),A=rn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=Ya({programId:u,marketId:t});return{id:c,baseMint:n,quoteMint:r,lpMint:l,baseDecimals:o,quoteDecimals:s,lpDecimals:o,version:i,programId:a,authority:m,nonce:p,baseVault:d,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:A,marketVersion:e,marketProgramId:u,marketId:t,marketAuthority:k,lookupTableAccount:_m.default,configId:So({programId:a})}}var Bo;async function Jk({connection:i,poolKeysList:e,config:t}){Bo||(Bo=new pn({connection:i}),await Bo.initStableModelLayout());let n=e.map(s=>xa({poolKeys:s}));return(await hs(i,n.map(s=>s.instruction),"GetPoolData")).map(s=>{let a=Ts(s,"GetPoolData"),u=new tr(Rt(a,"status")),c=Number(Rt(a,"coin_decimals")),l=Number(Rt(a,"pc_decimals")),m=Number(Rt(a,"lp_decimals")),p=new tr(Rt(a,"pool_coin_amount")),d=new tr(Rt(a,"pool_pc_amount")),y=new tr(Rt(a,"pool_lp_supply")),f="0";try{f=Rt(a,"pool_open_time")}catch{}return{status:u,baseDecimals:c,quoteDecimals:l,lpDecimals:m,baseReserve:p,quoteReserve:d,lpSupply:y,startTime:new tr(f)}})}import nt from"bn.js";var nr=class extends Pe{constructor(t){super(t);this.stableLayout=new pn({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:r,baseIn:o}){let s=new nt(new V(n).mul(10**t[o?"mintA":"mintB"].decimals).toFixed(0)),a=ya(t[o?"mintB":"mintA"]),[u,c]=[new nt(new V(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new nt(new V(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new nt(new V(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,V.ROUND_DOWN));this.logDebug("baseReserve:",u.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",o?t.mintB.symbol:t.mintA.symbol,"slippage:",`${r.toSignificant()}%`,"baseReserve",u.toString(),"quoteReserve",c.toString());let m=o?"base":"quote";this.logDebug("input side:",m);let p=Ue;s.isZero()||(p=m==="base"?Ir(s.mul(c),u):Ir(s.mul(u),c)),this.logDebug("amountRaw:",p.toString(),"lpAmount:",l.toString());let d=Ir(s.mul(l),m==="base"?u:c);this.logDebug("liquidity:",d.toString());let f=new $e(new nt(1)).add(r).mul(p).quotient,b=new he(a,p),g=new he(a,f);return this.logDebug("anotherAmount:",b.toFixed(),"maxAnotherAmount:",g.toFixed()),{anotherAmount:b,maxAnotherAmount:g,liquidity:d}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,amountInA:r,amountInB:o,fixedSide:s,config:a,txVersion:u,computeBudgetConfig:c}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",o),(r.isZero()||o.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:o.toFixed()});let{account:l}=this.scope,{bypassAssociatedCheck:m,checkCreateATAOwner:p}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},[d,y]=[r.token,o.token],f=await l.getCreatedTokenAccount({mint:d.mint,associatedOnly:!1}),b=await l.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1});!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",l.tokenAccounts);let g=await l.getCreatedTokenAccount({mint:new Ze(n.lpMint.address)}),A=[d,y],k=[f,b],h=[r.raw,o.raw],T=r.token.mint.toBase58()===n.mintA.address?"base":"quote",I="base";["quote","base"].includes(T)||this.logAndCreateError("invalid fixedSide","fixedSide",s),T==="quote"?(A.reverse(),k.reverse(),h.reverse(),I=s==="a"?"quote":"base"):T==="base"&&(I=s==="a"?"base":"quote");let[S,x]=A,[K,N]=k,[E,z]=h,v=await this.getAmmPoolKeys(n.id),Z=this.createTxBuilder(),{tokenAccount:J,...re}=await l.handleTokenAccount({side:"in",amount:E,mint:S.mint,tokenAccount:K,bypassAssociatedCheck:m,checkCreateATAOwner:p});Z.addInstruction(re);let{tokenAccount:ct,...An}=await l.handleTokenAccount({side:"in",amount:z,mint:x.mint,tokenAccount:N,bypassAssociatedCheck:m,checkCreateATAOwner:p});Z.addInstruction(An);let{tokenAccount:ui,...ci}=await l.handleTokenAccount({side:"out",amount:0,mint:new Ze(n.lpMint.address),tokenAccount:g,bypassAssociatedCheck:m,checkCreateATAOwner:p});return Z.addInstruction(ci),Z.addInstruction({instructions:[Ta({poolInfo:n,poolKeys:v,userKeys:{baseTokenAccount:J,quoteTokenAccount:ct,lpTokenAccount:ui,owner:this.scope.ownerPubKey},baseAmountIn:E,quoteAmountIn:z,fixedSide:I})],instructionTypes:[n.pooltype.includes("StablePool")?_.AmmV5AddLiquidity:_.AmmV4AddLiquidity],lookupTableAddress:v.lookupTableAccount?[v.lookupTableAccount]:[]}),Z.addCustomComputeBudget(c),u===0&&await Z.buildV0(),Z.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,amountIn:r,config:o,txVersion:s,computeBudgetConfig:a}=t,u=await this.getAmmPoolKeys(n.id),[c,l,m]=[new Ze(n.mintA.address),new Ze(n.mintB.address),new Ze(n.lpMint.address)];this.logDebug("amountIn:",r),r.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",r.toString());let{account:p}=this.scope,d=await p.getCreatedTokenAccount({mint:m,associatedOnly:!1});d||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",p.tokenAccounts);let y=await p.getCreatedTokenAccount({mint:c}),f=await p.getCreatedTokenAccount({mint:l}),b=this.createTxBuilder(),{bypassAssociatedCheck:g,checkCreateATAOwner:A}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...o},{tokenAccount:k,...h}=await p.handleTokenAccount({side:"out",amount:0,mint:c,tokenAccount:y,bypassAssociatedCheck:g,checkCreateATAOwner:A});b.addInstruction(h);let{tokenAccount:T,...I}=await p.handleTokenAccount({side:"out",amount:0,mint:l,tokenAccount:f,bypassAssociatedCheck:g,checkCreateATAOwner:A});return b.addInstruction(I),b.addInstruction({instructions:[go({poolInfo:n,poolKeys:u,userKeys:{lpTokenAccount:d,baseTokenAccount:k,quoteTokenAccount:T,owner:this.scope.ownerPubKey},amountIn:r})],lookupTableAddress:u.lookupTableAccount?[u.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?_.AmmV5RemoveLiquidity:_.AmmV4RemoveLiquidity]}),b.addCustomComputeBudget(a),s===0?await b.buildV0():b.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:r,createPositionInfo:o,farmInfo:s,userFarmLpAmount:a,base:u,computeBudgetConfig:c,payer:l,tokenProgram:m=Jr,checkCreateATAOwner:p=!0,getEphemeralSigners:d,txVersion:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let f=this.createTxBuilder();f.addCustomComputeBudget(c);let b={};for(let J of this.scope.account.tokenAccountRawInfos)(b[J.accountInfo.mint.toString()]===void 0||de(this.scope.ownerPubKey,J.accountInfo.mint,Jr).publicKey.equals(J.pubkey))&&(b[J.accountInfo.mint.toString()]=J.pubkey);let g=b[t.lpMint.address];if(g===void 0)throw Error("find lp account error in trade accounts");let A=r.add(a!=null?a:new nt(0)),k=t.mintA.address===Ae.WSOL.mint.toString(),h=t.mintB.address===Ae.WSOL.mint.toString(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Jr,mint:new Ze(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:p});if(f.addInstruction(I||{}),T===void 0)throw new Error("base token account not found");let{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Jr,mint:new Ze(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:p});if(f.addInstruction(x||{}),S===void 0)throw new Error("quote token account not found");if(b[t.mintA.address]=T,b[t.mintB.address]=S,s!==void 0&&!(a!=null&&a.isZero())){let J=[];for(let Pn of s.rewardInfos){let xu=Pn.mint.address===Ae.WSOL.mint.toString();if(b[Pn.mint.address])J.push(b[Pn.mint.address]);else{let{account:Uo,instructionParams:Go}=await this.scope.account.getOrCreateTokenAccount({mint:new Ze(Pn.mint.address),tokenProgram:m,owner:this.scope.ownerPubKey,skipCloseAccount:!xu,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});Uo||this.logAndCreateError("farm reward account not found:",Pn.mint.address),Go&&f.addInstruction(Go),J.push(Uo)}}let re=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],ct={amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:re,lpAccount:g,rewardAccounts:J},An=yt[s.programId],ui=An===6?Gn(ct):An===5?Xn(ct):zn(ct),ci={3:_.FarmV3Withdraw,5:_.FarmV5Withdraw,6:_.FarmV6Withdraw};f.addInstruction({instructions:[ui],instructionTypes:[ci[An]]})}let K=await this.getAmmPoolKeys(t.id),N=go({poolInfo:t,poolKeys:K,userKeys:{lpTokenAccount:g,baseTokenAccount:T,quoteTokenAccount:S,owner:this.scope.ownerPubKey},amountIn:A});f.addInstruction({instructions:[N],instructionTypes:[t.pooltype.includes("StablePool")?_.AmmV5RemoveLiquidity:_.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[E,z]=t.mintA.address===n.mintA.address?[T,S]:[S,T],v=await this.scope.clmm.getClmmPoolKeys(t.id),Z=await ke.openPositionFromBaseInstructions({poolInfo:n,poolKeys:v,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:E,tokenAccountB:z},withMetadata:"create",...o,base:u,getEphemeralSigners:d});return f.addInstruction({instructions:[...Z.instructions],signers:Z.signers,instructionTypes:[...Z.instructionTypes],lookupTableAddress:v.lookupTableAccount?[v.lookupTableAccount]:[]}),y===0?f.sizeCheckBuildV0():f.sizeCheckBuild()}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:r,quoteMintInfo:o,baseAmount:s,quoteAmount:a,startTime:u,ownerInfo:c,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:p,txVersion:d,feeDestinationId:y,computeBudgetConfig:f}){var z;let b=c.feePayer||((z=this.scope.owner)==null?void 0:z.publicKey),g=c.useSOLBalance&&r.mint.equals(Ha),A=c.useSOLBalance&&o.mint.equals(Ha),k=this.createTxBuilder(),{account:h,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:g?{payer:b,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:l,checkCreateATAOwner:m});k.addInstruction(T||{});let{account:I,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:A?{payer:b,amount:a}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:l,checkCreateATAOwner:m});if(k.addInstruction(S||{}),h===void 0||I===void 0)throw Error("you don't has some token account");let x=Qa({version:4,marketVersion:3,marketId:n.marketId,baseMint:r.mint,quoteMint:o.mint,baseDecimals:r.decimals,quoteDecimals:o.decimals,programId:t,marketProgramId:n.programId}),K={programId:t,ammId:x.id,ammAuthority:x.authority,ammOpenOrders:x.openOrders,lpMint:x.lpMint,coinMint:x.baseMint,pcMint:x.quoteMint,coinVault:x.baseVault,pcVault:x.quoteVault,withdrawQueue:x.withdrawQueue,ammTargetOrders:x.targetOrders,poolTempLp:x.lpVault,marketProgramId:x.marketProgramId,marketId:x.marketId,ammConfigId:x.configId,feeDestinationId:y},{instruction:N,instructionType:E}=Ia({...K,userWallet:this.scope.ownerPubKey,userCoinVault:h,userPcVault:I,userLpVault:de(this.scope.ownerPubKey,x.lpMint,p).publicKey,nonce:x.nonce,openTime:u,coinAmount:s,pcAmount:a});return k.addInstruction({instructions:[N],instructionTypes:[E]}),k.addCustomComputeBudget(f),k.versionBuild({txVersion:d,extInfo:{address:K}})}async getCreatePoolFee({programId:t}){let n=So({programId:t}),r=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(r===null)throw Error("get config account error");return ba.decode(r.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:r,mintOut:o,slippage:s}){if(r!==t.mintA.address&&r!==t.mintA.address)throw new Error("toke not match");if(o!==t.mintB.address&&o!==t.mintB.address)throw new Error("toke not match");let{baseReserve:a,quoteReserve:u}=t,c=[a,u],l=r==t.mintA.address?"base":"quote";l==="quote"&&c.reverse();let[m,p]=c,d=t.programId===Rs.toBase58(),y;if(d)y=new V(p.toString()).div(m.toString());else{let x=ka(this.stableLayout.stableModelData,a.toNumber(),u.toNumber(),!1);l==="quote"?y=new V(1e6).div(x*1e6):y=new V(x*1e6).div(1e6)}let f=n,b=new nt(0),g=new nt(0);if(!f.isZero())if(d){g=_n(f.mul(Xa),za);let x=f.sub(g),K=m.add(x);b=p.mul(x).div(K)}else{g=f.mul(new nt(2)).div(new nt(1e4));let x=f.sub(g);l==="quote"?b=new nt(Aa(this.stableLayout.stableModelData,u.toNumber(),a.toNumber(),x.toNumber())):b=new nt(Pa(this.stableLayout.stableModelData,u.toNumber(),a.toNumber(),x.toNumber()))}let A=new nt(new V(b.toString()).mul(1-s).toFixed(0)),k=b,h=A,T=new V(b.toString()).div(new V(f.sub(g).toString()).toFixed(0));!f.isZero()&&!b.isZero()&&(T=new V(b.toString()).div(f.sub(g).toString()));let I=y.sub(T).div(y).mul(100);return{amountOut:k,minAmountOut:h,currentPrice:y,executionPrice:T,priceImpact:I,fee:g}}async swap({poolInfo:t,amountIn:n,amountOut:r,inputMint:o,fixedSide:s,txVersion:a,computeBudgetConfig:u}){let c=this.createTxBuilder(),[l,m]=o===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],p=await this.scope.account.getCreatedTokenAccount({mint:new Ze(l.address),programId:new Ze(l.programId),associatedOnly:!1}),d=await this.scope.account.getCreatedTokenAccount({mint:new Ze(m.address),programId:new Ze(m.programId),associatedOnly:!1}),{tokenAccount:y,...f}=await this.scope.account.handleTokenAccount({side:"in",amount:n,mint:new Ze(l.address),tokenAccount:p,bypassAssociatedCheck:!1,checkCreateATAOwner:!1});c.addInstruction(f);let{tokenAccount:b,...g}=await this.scope.account.handleTokenAccount({side:"out",amount:0,mint:new Ze(m.address),tokenAccount:d,bypassAssociatedCheck:!1,checkCreateATAOwner:!1});c.addInstruction(g);let A=await this.getAmmPoolKeys(t.id),k=4;return t.pooltype.includes("StablePool")&&(k=5),c.addInstruction({instructions:[zr({version:k,poolKeys:A,userKeys:{tokenAccountIn:y,tokenAccountOut:b,owner:this.scope.ownerPubKey},amountIn:n,amountOut:r,fixedSide:s})],instructionTypes:[k===4?_.AmmV4SwapBaseIn:_.AmmV5SwapBaseIn]}),c.addCustomComputeBudget(u),c.versionBuild({txVersion:a})}};import{PublicKey as ie}from"@solana/web3.js";import st from"bn.js";var rr=class extends Pe{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var A;let{programId:t,owner:n=((A=this.scope.owner)==null?void 0:A.publicKey)||ie.default,mint1:r,mint2:o,ammConfig:s,initialPrice:a,startTime:u,computeBudgetConfig:c,forerunCreate:l,txVersion:m}=e,p=this.createTxBuilder(),[d,y,f]=new st(new ie(r.address).toBuffer()).gt(new st(new ie(o.address).toBuffer()))?[o,r,new V(1).div(a)]:[r,o,a],b=Q.priceToSqrtPriceX64(f,d.decimals,y.decimals),g=await ke.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:d,mintB:y,ammConfigId:s.id,initialPriceX64:b,startTime:u,forerunCreate:l});return p.addInstruction(g),p.addCustomComputeBudget(c),p.versionBuild({txVersion:m,extInfo:{address:{...g.address,programId:t.toString(),id:g.address.poolId.toString(),mintA:d,mintB:y,openTime:u.toString(),vault:{A:g.address.mintAVault.toString(),B:g.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:g.address.poolId.toString(),mintA:d,mintB:y,feeRate:s.tradeFeeRate,openTime:u.toString(),programId:t.toString(),price:f.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},...Ea},forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:p,computeBudgetConfig:d,txVersion:y}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),b=null,g=null,A=n.useSOLBalance&&e.mintA.address===$.toString(),k=n.useSOLBalance&&e.mintB.address===$.toString(),[h,T]=s==="MintA"?[a,u]:[u,a],{account:I,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||h.isZero()?{payer:this.scope.ownerPubKey,amount:h}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});I&&(b=I),f.addInstruction(S||{});let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||T.isZero()?{payer:this.scope.ownerPubKey,amount:T}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:c,checkCreateATAOwner:l});x&&(g=x),f.addInstruction(K||{}),(!b||!g)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let N=t||await this.getClmmPoolKeys(e.id),E=await ke.openPositionFromBaseInstructions({poolInfo:e,poolKeys:N,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,withMetadata:m,getEphemeralSigners:p});return f.addInstruction(E),f.addCustomComputeBudget(d),f.versionBuild({txVersion:y,extInfo:E.address})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:r,amountMaxB:o,tickLower:s,tickUpper:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:p,getEphemeralSigners:d}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let y=this.createTxBuilder(),f=null,b=null,g=n.useSOLBalance&&e.mintA.address===$.toBase58(),A=n.useSOLBalance&&e.mintB.address===$.toBase58(),{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:g?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:g?!1:c,checkCreateATAOwner:l});k&&(f=k),y.addInstruction(h||{});let{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});T&&(b=T),y.addInstruction(I||{}),(f===void 0||b===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=t||await this.getClmmPoolKeys(e.id),x=await ke.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:S,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},tickLower:s,tickUpper:a,liquidity:u,amountMaxA:r,amountMaxB:o,withMetadata:m,getEphemeralSigners:d});return y.addInstruction(x),y.versionBuild({txVersion:p,extInfo:{address:x.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,ownerPosition:n,amountMaxA:r,amountMaxB:o,liquidity:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,p=this.createTxBuilder(),d,y,f=a.useSOLBalance&&t.mintA.address===$.toString(),b=a.useSOLBalance&&t.mintB.address===$.toString(),{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});g&&(d=g),p.addInstruction(A||{});let{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b?{payer:this.scope.ownerPubKey,amount:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});k&&(y=k),p.addInstruction(h||{}),!d&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=await this.getClmmPoolKeys(t.id),I=ke.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:d,tokenAccountB:y},liquidity:s,amountMaxA:r,amountMaxB:o});return p.addInstruction(I),p.addCustomComputeBudget(l),p.versionBuild({txVersion:m,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:r,baseAmount:o,otherAmountMax:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,p=this.createTxBuilder(),d,y,f=a.useSOLBalance&&t.mintA.address===$.toString(),b=a.useSOLBalance&&t.mintB.address===$.toString(),{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:r==="MintA"?o:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});g&&(d=g),p.addInstruction(A||{});let{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b?{payer:this.scope.ownerPubKey,amount:r==="MintA"?s:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});k&&(y=k),p.addInstruction(h||{}),!d&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=await this.getClmmPoolKeys(t.id),I=ke.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:T,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:d,tokenAccountB:y},base:r,baseAmount:o,otherAmountMax:s});return p.addInstruction(I),p.addCustomComputeBudget(l),p.versionBuild({txVersion:m,extInfo:{address:I.address}})}async decreaseLiquidity(e){let{poolInfo:t,ownerPosition:n,ownerInfo:r,amountMinA:o,amountMinB:s,liquidity:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),d=r.useSOLBalance&&t.mintA.address===$.toString(),y=r.useSOLBalance&&t.mintB.address===$.toString(),f,b,{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,associatedOnly:d?!1:u,checkCreateATAOwner:c});f=g,A&&p.addInstruction(A);let{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:c});b=k,h&&p.addInstruction(h);let T=[];for(let K of t.rewardDefaultInfos){let N=r.useSOLBalance&&K.mint.address===$.toString(),E;if(K.mint.address===t.mintA.address)E=f;else if(K.mint.address===t.mintB.address)E=b;else{let{account:z,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(K.mint.programId),mint:new ie(K.mint.address),notUseTokenAccount:N,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!N,associatedOnly:N?!1:u,checkCreateATAOwner:c});E=z,v&&p.addInstruction(v)}T.push(E)}!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=await this.getClmmPoolKeys(t.id),S=await ke.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:T},liquidity:a,amountMinA:o,amountMinB:s});p.addInstruction({instructions:S.instructions,instructionTypes:[_.ClmmDecreasePosition]});let x={...S.address};if(r.closePosition){let K=await ke.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});p.addInstruction({endInstructions:K.instructions,endInstructionTypes:K.instructionTypes}),x={...x,...K.address}}return p.addCustomComputeBudget(l),p.versionBuild({txVersion:m,extInfo:{address:x}})}async closePosition({poolInfo:e,ownerPosition:t,txVersion:n}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let r=this.createTxBuilder(),o=await this.getClmmPoolKeys(e.id),s=ke.closePositionInstructions({poolInfo:e,poolKeys:o,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:t});return r.addInstruction(s).versionBuild({txVersion:n,extInfo:{address:s.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.address.toString()===$.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(n.mint.address),mint:new ie(n.mint.address),notUseTokenAccount:!!c,skipCloseAccount:!c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new st(new V(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:c?!1:r,checkCreateATAOwner:o});p&&u.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),y=ke.initRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new ie(n.mint.programId),mint:new ie(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:H.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,ownerInfo:t,rewardInfos:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){for(let l of n)l.endTime<=l.openTime&&this.logAndCreateError("reward time error","rewardInfo",l);let u=this.createTxBuilder(),c={};for(let l of n){let m=t.useSOLBalance&&l.mint.address===$.toString(),p=l.perSecond.mul(l.endTime-l.openTime),{account:d,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(l.mint.programId),mint:new ie(l.mint.address),notUseTokenAccount:!!m,skipCloseAccount:!m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new st(new V(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:m?!1:r,checkCreateATAOwner:o});y&&u.addInstruction(y),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=ke.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new ie(l.mint.programId),mint:new ie(l.mint.address),openTime:l.openTime,endTime:l.endTime,emissionsPerSecondX64:H.decimalToX64(l.perSecond)}});c={...c,...b.address},u.addInstruction(b)}return u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:c}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.equals($),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new st(new V(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:c?!1:r,checkCreateATAOwner:o});m&&u.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),d=ke.setRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:H.decimalToX64(n.perSecond)}});return u.addInstruction(d),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:d.address}})}async setRewards({poolInfo:e,ownerInfo:t,rewardInfos:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){let u=this.createTxBuilder(),c={};for(let l of n){l.endTime<=l.openTime&&this.logAndCreateError("reward time error","rewardInfo",l);let m=t.useSOLBalance&&l.mint.address===$.toString(),{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(l.mint.programId),mint:new ie(l.mint.address),notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new st(new V(l.perSecond.sub(l.endTime-l.openTime).toFixed(0)).gte(l.perSecond.sub(l.endTime-l.openTime))?l.perSecond.sub(l.endTime-l.openTime).toFixed(0):l.perSecond.sub(l.endTime-l.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:r,checkCreateATAOwner:o});d&&u.addInstruction(d),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=ke.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new ie(l.mint.address),openTime:l.openTime,endTime:l.endTime,emissionsPerSecondX64:H.decimalToX64(l.perSecond)}});u.addInstruction(f),c={...c,...f.address}}return u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:c}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1}){let s=e.rewardDefaultInfos.find(d=>d.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),u=t.useSOLBalance&&n.equals($),{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(s.mint.programId),mint:n,notUseTokenAccount:u,owner:this.scope.ownerPubKey,skipCloseAccount:!u,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:u?!1:r,checkCreateATAOwner:o});l&&a.addInstruction(l),c||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),p=ke.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:c},rewardMint:n});return a.addInstruction(p),a.build({address:p.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1}){let s=this.createTxBuilder(),a={};for(let u of n){let c=e.rewardDefaultInfos.find(f=>f.mint.address===u.toString());if(!c){this.logAndCreateError("reward mint error","not found reward mint",u);continue}let l=t.useSOLBalance&&u.equals($),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(c.mint.programId),mint:u,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:r,checkCreateATAOwner:o});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),p&&s.addInstruction(p);let d=await this.getClmmPoolKeys(e.id),y=ke.collectRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:u});s.addInstruction(y),a={...a,...y.address}}return s.build({address:a})}async swap({poolInfo:e,inputMint:t,amountIn:n,amountOutMin:r,priceLimit:o,ownerInfo:s,remainingAccounts:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,txVersion:l}){let m=this.createTxBuilder(),p=s.useSOLBalance&&e.mintA.address===$.toBase58(),d=s.useSOLBalance&&e.mintB.address===$.toBase58(),y;!o||o.equals(new V(0))?y=t.toString()===e.mintA.address?It.add(new st(1)):xt.sub(new st(1)):y=Q.priceToSqrtPriceX64(o,e.mintA.decimals,e.mintB.decimals);let f;if(!f){let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:s.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:u,checkCreateATAOwner:c});f=A,k&&m.addInstruction(k)}let b;if(!b){let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:s.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:u,checkCreateATAOwner:c});b=A,k&&m.addInstruction(k)}(!f||!b)&&this.logAndCreateError("user do not have token account",this.scope.account.tokenAccountRawInfos);let g=await this.getClmmPoolKeys(e.id);return m.addInstruction(ke.makeSwapBaseInInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},inputMint:new ie(t),amountIn:n,amountOutMin:r,sqrtPriceLimitX64:y,remainingAccounts:a})),m.versionBuild({txVersion:l})}async harvestAllRewards({allPoolInfo:e,allPositions:t,ownerInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,programId:s,txVersion:a,computeBudgetConfig:u}){let c={};for(let m of this.scope.account.tokenAccountRawInfos)r?de(this.scope.ownerPubKey,m.accountInfo.mint,s).publicKey.equals(m.pubkey)&&(c[m.accountInfo.mint.toString()]=m.pubkey):c[m.accountInfo.mint.toString()]=m.pubkey;let l=this.createTxBuilder();for(let m of Object.values(e)){if(t[m.id]===void 0||!t[m.id].find(k=>!k.liquidity.isZero()||k.rewardInfos.find(h=>!h.rewardAmountOwed.isZero())))continue;let p=m,d=n.useSOLBalance&&p.mintA.address===$.toString(),y=n.useSOLBalance&&p.mintB.address===$.toString(),f=c[p.mintA.address];if(!f){let{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintA.programId,mint:new ie(p.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:r,checkCreateATAOwner:o});f=k,h&&l.addInstruction(h)}let b=c[p.mintB.address];if(!b){let{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintB.programId,mint:new ie(p.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:r,checkCreateATAOwner:o});b=k,h&&l.addInstruction(h)}c[p.mintA.address]=f,c[p.mintB.address]=b;let g=[];for(let k of p.rewardDefaultInfos){let h=n.useSOLBalance&&k.mint.address===$.toString(),T=c[k.mint.address];if(!T){let{account:I,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(k.mint.programId),mint:new ie(k.mint.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,skipCloseAccount:!h,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:h?!1:r});T=I,S&&l.addInstruction(S)}c[k.mint.address]=T,g.push(T)}let A=await this.getClmmPoolKeys(p.id);for(let k of t[m.id]){let h=ke.decreaseLiquidityInstructions({poolInfo:p,poolKeys:A,ownerPosition:k,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:g},liquidity:new st(0),amountMinA:new st(0),amountMinB:new st(0)});l.addInstruction(h)}}return a===0?l.sizeCheckBuildV0({computeBudgetConfig:u}):l.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(jn(e).publicKey);return t?Wa.decode(t.data).whitelistMints.filter(r=>!r.equals(ie.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new st(1))).map(s=>it(new ie(e),s.accountInfo.mint).publicKey),r=await this.scope.connection.getMultipleAccountsInfo(n),o=[];return r.forEach(s=>{if(!s)return;let a=$r.decode(s.data);o.push(a)}),o}async getRpcClmmPoolInfo({poolId:e}){let t=await this.scope.connection.getAccountInfo(new ie(e)),n=Zr.decode(t.data),r=Q.sqrtPriceX64ToPrice(n.sqrtPriceX64,n.mintDecimalsA,n.mintDecimalsB).toNumber();return{...n,currentPrice:r}}};import{PublicKey as D}from"@solana/web3.js";import{NATIVE_MINT as ti,TOKEN_PROGRAM_ID as St,AccountLayout as su}from"@solana/spl-token";var Fm=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),vm=Buffer.from("amm_config","utf8"),Wm=Buffer.from("pool","utf8"),Dm=Buffer.from("pool_lp_mint","utf8"),qm=Buffer.from("pool_vault","utf8"),Um=Buffer.from("observation","utf8");function Gm(i){return ne([Fm],i)}function Xm(i,e){return ne([vm,Qm(e)],i)}function zm(i,e,t,n){return ne([Wm,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Ym(i,e){return ne([Dm,e.toBuffer()],i)}function ja(i,e,t){return ne([qm,e.toBuffer(),t.toBuffer()],i)}function ei(i,e){return ne([Um,e.toBuffer()],i)}function Qm(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function Za({programId:i,mintA:e,mintB:t}){let n=Xm(i,0).publicKey,r=Gm(i).publicKey,o=zm(i,n,e,t).publicKey,s=Ym(i,o).publicKey,a=ja(i,o,e).publicKey,u=ja(i,o,t).publicKey,c=ei(i,o).publicKey;return{poolId:o,configId:n,authority:r,lpMint:s,vaultA:a,vaultB:u,observationId:c}}import{TransactionInstruction as ir}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ko,TOKEN_2022_PROGRAM_ID as $a,ASSOCIATED_TOKEN_PROGRAM_ID as Hm}from"@solana/spl-token";var jm=oe("Raydium_cpmm"),or={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173]};function Ja(i,e,t,n,r,o,s,a,u,c,l,m,p,d,y,f,b,g,A,k){let h=O([w("amountMaxA"),w("amountMaxB"),w("openTime")]),T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Ko,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:Hm,isSigner:!1,isWritable:!1},{pubkey:ls,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1}],I=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:A,openTime:k},I),new ir({keys:T,programId:i,data:Buffer.from([...or.initialize,...I])})}function eu(i,e,t,n,r,o,s,a,u,c,l,m,p,d,y){let f=O([w("lpAmount"),w("amountMaxA"),w("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:Ko,isSigner:!1,isWritable:!1},{pubkey:$a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return jm.debug("cpmm deposit data",{lpAmount:p.toString(),amountMaxA:d.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:p,amountMaxA:d,amountMaxB:y},g),new ir({keys:b,programId:i,data:Buffer.from([...or.deposit,...g])})}function tu(i,e,t,n,r,o,s,a,u,c,l,m,p,d,y){let f=O([w("lpAmount"),w("amountMinA"),w("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:Ko,isSigner:!1,isWritable:!1},{pubkey:$a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:cs,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:p,amountMinA:d,amountMinB:y},g),new ir({keys:b,programId:i,data:Buffer.from([...or.withdraw,...g])})}function nu(i,e,t,n,r,o,s,a,u,c,l,m,p,d,y,f){let b=O([w("amountIn"),w("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},A),new ir({keys:g,programId:i,data:Buffer.from([...or.swapBaseInput,...A])})}function ru(i,e,t,n,r,o,s,a,u,c,l,m,p,d,y,f){let b=O([w("amountInMax"),w("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},A),new ir({keys:g,programId:i,data:Buffer.from([...or.swapBaseOutput,...A])})}import De from"bn.js";var iu=O([le(8),M("bump"),Me("disableCreatePool"),kt("index"),w("tradeFeeRate"),w("protocolFeeRate"),w("fundFeeRate"),w("createPoolFee"),B("protocolOwner"),B("fundOwner"),W(w(),16)]),ou=O([le(8),B("configId"),B("poolCreator"),B("vaultA"),B("vaultB"),B("mintLp"),B("mintA"),B("mintB"),B("mintProgramA"),B("mintProgramB"),B("observationId"),M("bump"),M("status"),M("lpDecimals"),M("mintDecimalA"),M("mintDecimalB"),w("lpAmount"),w("protocolFeesMintA"),w("protocolFeesMintB"),w("fundFeesMintA"),w("fundFeesMintB"),w("openTime"),W(w(),32)]);var sr=class extends Pe{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){let n=await this.scope.connection.getAccountInfo(new D(e));if(!n)throw new Error(`pool not found: ${e}`);let r=ou.decode(n.data),[o,s]=await this.scope.connection.getMultipleAccountsInfo([r.vaultA,r.vaultB]);if(!o)throw new Error(`pool vaultA info not found: ${r.vaultA.toBase58()}`);if(!s)throw new Error(`pool vaultB info not found: ${r.vaultB.toBase58()}`);let a;if(t){let u=await this.scope.connection.getAccountInfo(r.configId);u&&(a=iu.decode(u.data))}return{...r,baseReserve:new De(su.decode(o.data).amount.toString()).sub(r.protocolFeesMintA).sub(r.fundFeesMintA),quoteReserve:new De(su.decode(s.data).amount.toString()).sub(r.protocolFeesMintB).sub(r.fundFeesMintB),configInfo:a}}async createPool({programId:e,poolFeeAccount:t,startTime:n,ownerInfo:r,associatedOnly:o=!1,checkCreateATAOwner:s=!1,txVersion:a,computeBudgetConfig:u,...c}){var N,E,z;let l=r.feePayer||((N=this.scope.owner)==null?void 0:N.publicKey),m=new De(new D(c.mintA.address).toBuffer()).lte(new De(new D(c.mintB.address).toBuffer())),[p,d]=m?[c.mintA,c.mintB]:[c.mintB,c.mintA],[y,f]=m?[c.mintAAmount,c.mintBAmount]:[c.mintBAmount,c.mintAAmount],b=r.useSOLBalance&&p.address===ti.toBase58(),g=r.useSOLBalance&&d.address===ti.toBase58(),[A,k]=[new D(p.address),new D(d.address)],h=this.createTxBuilder(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:A,tokenProgram:p.programId,owner:this.scope.ownerPubKey,createInfo:b?{payer:l,amount:y}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:o,checkCreateATAOwner:s});h.addInstruction(I||{});let{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:new D(d.address),tokenProgram:d.programId,owner:this.scope.ownerPubKey,createInfo:g?{payer:l,amount:f}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:o,checkCreateATAOwner:s});if(h.addInstruction(x||{}),T===void 0||S===void 0)throw Error("you don't has some token account");let K=Za({programId:e,mintA:A,mintB:k});return h.addInstruction({instructions:[Ja(e,this.scope.ownerPubKey,K.configId,K.authority,K.poolId,A,k,K.lpMint,T,S,de(this.scope.ownerPubKey,K.lpMint).publicKey,K.vaultA,K.vaultB,t,new D((E=p.programId)!=null?E:St),new D((z=d.programId)!=null?z:St),K.observationId,y,f,n)],instructionTypes:[_.CpmmCreatePool]}),h.addCustomComputeBudget(u),h.versionBuild({txVersion:a,extInfo:{address:{...K,mintA:p,mintB:d,programId:e,poolFeeAccount:t}}})}async addLiquidity(e){let{poolInfo:t,inputAmount:n,baseIn:r,slippage:o,computeResult:s,computeBudgetConfig:a,config:u,txVersion:c}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),n.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:n.toString()});let{account:l}=this.scope,{bypassAssociatedCheck:m,checkCreateATAOwner:p}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...u},d=await this.getRpcPoolInfo(t.id),{liquidity:y,inputAmountFee:f,anotherAmount:b}=s||this.computePairAmount({poolInfo:{...t,mintAmountA:new V(d.baseReserve.toString()).div(10**t.mintA.decimals).toNumber(),mintAmountB:new V(d.quoteReserve.toString()).div(10**t.mintB.decimals).toNumber(),lpAmount:new V(d.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},slippage:o,baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new V(n.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),g=b.amount,A=t.mintA.address===ti.toString(),k=t.mintB.address===ti.toString(),h=this.createTxBuilder(),[T,I]=[new D(t.mintA.address),new D(t.mintB.address)],{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new D(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||(r?n:g).isZero()?{payer:this.scope.ownerPubKey,amount:r?n:g}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:!1,checkCreateATAOwner:p});h.addInstruction(x||{});let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new D(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||(r?g:n).isZero()?{payer:this.scope.ownerPubKey,amount:r?g:n}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!1,checkCreateATAOwner:p});h.addInstruction(N||{}),!S&&!K&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",l.tokenAccounts);let E=await l.getCreatedTokenAccount({mint:new D(t.lpMint.address)}),{tokenAccount:z,...v}=await l.handleTokenAccount({side:"out",amount:0,mint:new D(t.lpMint.address),tokenAccount:E,bypassAssociatedCheck:m,checkCreateATAOwner:p});h.addInstruction(v);let Z=await this.getCpmmPoolKeys(t.id);return h.addInstruction({instructions:[eu(new D(t.programId),this.scope.ownerPubKey,new D(Z.authority),new D(t.id),z,S,K,new D(Z.vault.A),new D(Z.vault.B),T,I,new D(t.lpMint.address),y,r?f.amount:g,r?g:f.amount)],instructionTypes:[_.CpmmAddLiquidity],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),h.addCustomComputeBudget(a),h.versionBuild({txVersion:c})}async withdrawLiquidity(e){var z,v;let{poolInfo:t,lpAmount:n,slippage:r,computeBudgetConfig:o,txVersion:s}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let a=new $e(new De(1)).sub(r),u=await this.getRpcPoolInfo(t.id),[c,l]=[a.mul(n.mul(u.baseReserve).div(u.lpAmount)).quotient,a.mul(n.mul(u.quoteReserve).div(u.lpAmount)).quotient],m=await this.scope.fetchEpochInfo(),[p,d]=[be(c,t.mintA.extensions.feeConfig,m,!0),be(l,t.mintB.extensions.feeConfig,m,!0)],{account:y}=this.scope,f=this.createTxBuilder(),[b,g]=[new D(t.mintA.address),new D(t.mintB.address)],A=b.equals($),k=g.equals($),h,T,{account:I,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new D(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:!A,checkCreateATAOwner:!1});h=I,S&&f.addInstruction(S);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new D(t.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:!k,checkCreateATAOwner:!1});T=x,K&&f.addInstruction(K),(!h||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let N=await y.getCreatedTokenAccount({mint:new D(t.lpMint.address)});N||this.logAndCreateError("cannot found lp token account","tokenAccounts",y.tokenAccounts);let E=await this.getCpmmPoolKeys(t.id);return f.addInstruction({instructions:[tu(new D(t.programId),this.scope.ownerPubKey,new D(E.authority),new D(t.id),N,h,T,new D(E.vault.A),new D(E.vault.B),b,g,new D(t.lpMint.address),n,c.sub((z=p.fee)!=null?z:new De(0)),l.sub((v=d.fee)!=null?v:new De(0)))],instructionTypes:[_.CpmmWithdrawLiquidity],lookupTableAddress:E.lookupTableAccount?[E.lookupTableAccount]:[]}),f.addCustomComputeBudget(o),f.versionBuild({txVersion:s})}async swap(e){let{poolInfo:t,baseIn:n,swapResult:r,config:o,computeBudgetConfig:s,txVersion:a,isSell:u=!1}=e,{bypassAssociatedCheck:c,checkCreateATAOwner:l}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...o},m=this.createTxBuilder(),[p,d]=u?[new D(t.mintB.address),new D(t.mintA.address)]:[new D(t.mintA.address),new D(t.mintB.address)],[y,f]=u?[t.mintB.programId,t.mintA.programId]:[t.mintA.programId,t.mintB.programId],b=await this.scope.account.getCreatedTokenAccount({programId:new D(y!=null?y:St),mint:p,associatedOnly:!1}),g=await this.scope.account.getCreatedTokenAccount({programId:new D(f!=null?f:St),mint:d,associatedOnly:!1}),{tokenAccount:A,...k}=await this.scope.account.handleTokenAccount({side:n?"in":"out",amount:n?r.sourceAmountSwapped:r.destinationAmountSwapped,mint:p,tokenAccount:b,bypassAssociatedCheck:c,checkCreateATAOwner:l,programId:new D(y!=null?y:St)});m.addInstruction(k);let{tokenAccount:h,...T}=await this.scope.account.handleTokenAccount({side:n?"out":"in",amount:n?r.destinationAmountSwapped:r.sourceAmountSwapped,mint:d,tokenAccount:g,bypassAssociatedCheck:c,checkCreateATAOwner:l,programId:new D(f!=null?f:St)});m.addInstruction(T),!A&&!h&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getCpmmPoolKeys(t.id),[S,x]=u?[I.vault.B,I.vault.A]:[I.vault.A,I.vault.B];return m.addInstruction({instructions:[n?nu(new D(t.programId),this.scope.ownerPubKey,new D(I.authority),new D(I.config.id),new D(t.id),A,h,new D(S),new D(x),new D(y!=null?y:St),new D(f!=null?f:St),p,d,ei(new D(t.programId),new D(t.id)).publicKey,r.sourceAmountSwapped,r.destinationAmountSwapped):ru(new D(t.programId),this.scope.ownerPubKey,new D(I.authority),new D(I.config.id),new D(t.id),h,A,new D(x),new D(S),new D(f!=null?f:St),new D(y!=null?y:St),d,p,ei(new D(t.programId),new D(t.id)).publicKey,r.sourceAmountSwapped,r.destinationAmountSwapped)],instructionTypes:[n?_.CpmmSwapBaseIn:_.CpmmSwapBaseOut]}),m.addCustomComputeBudget(s),m.versionBuild({txVersion:a})}computePairAmount({poolInfo:e,amount:t,slippage:n,epochInfo:r,baseIn:o}){var A,k,h,T,I,S,x,K;let s=1-Number(n.toSignificant())/100,a=new De(new V(t).mul(10**e[o?"mintA":"mintB"].decimals).mul(s).toFixed(0)),u=be(a,e[o?"mintA":"mintB"].extensions.feeConfig,r,!1),c=a.sub((A=u.fee)!=null?A:new De(0)),[l,m]=[new De(new V(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new De(new V(e.mintAmountB).mul(10**e.mintB.decimals).toString())],p=new De(new V(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,V.ROUND_DOWN));this.logDebug("baseReserve:",l.toString(),"quoteReserve:",m.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",a.toString(),"amountInFee:",(h=(k=u.fee)==null?void 0:k.toString())!=null?h:0,"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`);let d=o?"base":"quote";this.logDebug("input side:",d);let y=c.mul(p).div(d==="base"?l:m),f={amount:Ue,fee:void 0,expirationTime:void 0};c.isZero()||(f=be(Zm(y,l,m,p)[o?"amountB":"amountA"],e[o?"mintB":"mintA"].extensions.feeConfig,r,!0));let b=new $e(new De(1)).add(n),g=be(b.mul(f.amount.sub((T=f.fee)!=null?T:new De(0))).quotient,e[o?"mintB":"mintA"].extensions.feeConfig,r,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(S=(I=f.fee)==null?void 0:I.toString())!=null?S:0,"maxAnotherAmount:",g.amount.toString(),"maxAnotherAmountFee:",(K=(x=g.fee)==null?void 0:x.toString())!=null?K:0),{inputAmountFee:u,anotherAmount:f,maxAnotherAmount:g,liquidity:y}}};function Zm(i,e,t,n){let r=i.mul(e).div(n);!r.isZero()&&!i.mul(e).mod(n).isZero()&&(r=r.add(new De(1)));let o=i.mul(t).div(n);return!o.isZero()&&!i.mul(t).mod(n).isZero()&&(o=o.add(new De(1))),{amountA:r,amountB:o}}var ar=class extends Pe{constructor(e){super(e)}static getAddLiquidityDefaultPool({addLiquidityPools:e,poolInfosCache:t}){if(e.length===0)return;if(e.length===1||(e.sort((r,o)=>o.version-r.version),e[0].version!==e[1].version))return e[0];let n=e.filter(r=>r.version===e[0].version);return n.sort((r,o)=>this.comparePoolSize(r,o,t)),n[0]}static comparePoolSize(e,t,n){let r=n[e.id],o=n[t.id];return r===void 0?1:o===void 0?-1:e.baseMint===t.baseMint?r.baseReserve.sub(o.baseReserve).gte(Ue)?-1:1:r.baseReserve.sub(o.quoteReserve).gte(Ue)?-1:1}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals($));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n}=e,r=await this.getWSolAccounts(),o=this.createTxBuilder();o.addCustomComputeBudget(e.computeBudgetConfig);let s=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});o.addInstruction(s);let a=G(t);for(let u=0;u<r.length;u++)a.gte(r[u].amount)?(o.addInstruction({instructions:[Lt({tokenAccount:r[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),a.sub(r[u].amount)):(o.addInstruction({instructions:[Lt({tokenAccount:r[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),Vn({destination:s.addresses.newAccount,source:r[u].publicKey,amount:a,owner:this.scope.ownerPubKey,tokenProgram:n}));return o.build()}async wrapWSol(e,t){let n=await this.getWSolAccounts(),r=this.createTxBuilder(),o=await ht({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(o),n.length&&r.addInstruction({instructions:[Vn({destination:n[0].publicKey,source:o.addresses.newAccount,amount:e,owner:this.scope.ownerPubKey,tokenProgram:t})],endInstructions:[Lt({tokenAccount:o.addresses.newAccount,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:t})]}),r.build()}};import{TOKEN_PROGRAM_ID as $m}from"@solana/spl-token";import{PublicKey as Jm,Transaction as Co,TransactionInstruction as ed}from"@solana/web3.js";import au from"bn.js";var qe=class extends Pe{static getPdaPoolId(e,t){return ne([qe.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,r){return ne([qe.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new au(r).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:r,chainTime:o}){if(n.length===0)return[];let s=n.map(l=>qe.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<qe.VERSION_PROJECT.length;l++)a.push(...s.map(m=>qe.getPdaOwnerId(t,m,r,l).publicKey));let u=await Pt(e,[...s,...a]),c=[];for(let l=0;l<u.length;l++){let m=Math.floor(l/n.length),p=l%n.length,d=s[p],y=a[l],f=u[p],b=u[n.length+l];if(!(f&&b)||f.data.length!==qe.POOL_LAYOUT.span||b.data.length!==qe.OWNER_LAYOUT.span)continue;let g=qe.POOL_LAYOUT.decode(f.data),A=qe.OWNER_LAYOUT.decode(b.data),k=g.openTime.toNumber(),h=g.endTime.toNumber(),T=A.tokenInfo.map(x=>x.debtAmount.gt(new au(0))).filter(x=>!x).length!==3,I=o>k&&o<h&&g.status===1,S=T&&I;c.push({programId:t,poolId:d,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:A.lpAmount,project:qe.VERSION_PROJECT[m],openTime:k,endTime:h,canClaim:S,canClaimErrorType:T?I?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,K)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:A.tokenInfo[K].debtAmount.add(A.tokenInfo[K].claimedAmount)}))})}return c}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),r=t.wallet||this.scope.ownerPubKey,o=[];for(let u of e.tokenInfo){let{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Ae.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(Ae.WSOL.mint),associatedOnly:u.mintAddress.equals(Ae.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),o.push(c)}n.addInstruction({instructions:[qe.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:o}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),r=t.wallet||this.scope.ownerPubKey,o={};for(let c of e){let l=[];for(let m of c.tokenInfo){let{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Ae.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!m.mintAddress.equals(Ae.WSOL.mint),associatedOnly:m.mintAddress.equals(Ae.WSOL.mint)?!1:t.associatedOnly});d&&n.addInstruction(d),p&&(o[m.mintAddress.toString()]=p,l.push(p))}n.addInstruction({instructions:[qe.makeClaimInstruction({programId:c.programId,poolInfo:c,ownerInfo:{wallet:r,ownerPda:c.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),u=n.allInstructions;return Kr(u,[r,...a.map(c=>c.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new Co().add(...u.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new Co().add(...u.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new Co().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let r=O([]),o=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(u=>({pubkey:u,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:u})=>({pubkey:u,isSigner:!1,isWritable:!0})),{pubkey:$m,isSigner:!1,isWritable:!1}],s=Buffer.alloc(r.span);r.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new ed({keys:o,programId:e,data:a})}},at=qe;at.CLAIMED_NUM=3,at.POOL_LAYOUT=O([le(8),M("bump"),M("status"),w("openTime"),w("endTime"),B("ammId"),W(O([M("mintDecimals"),B("mintAddress"),B("mintVault"),w("perLpLoss"),w("totalClaimedAmount")]),qe.CLAIMED_NUM,"tokenInfo"),W(w(),10,"padding")]),at.OWNER_LAYOUT=O([le(8),M("bump"),M("version"),B("poolId"),B("owner"),w("lpAmount"),W(O([B("mintAddress"),w("debtAmount"),w("claimedAmount")]),qe.CLAIMED_NUM,"tokenInfo"),W(w(),4,"padding")]),at.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Jm(e)),at.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},at.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as Lo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as du}from"@solana/spl-token";import ur from"bn.js";import{TransactionInstruction as nd,SYSVAR_RENT_PUBKEY as rd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as uu}from"@solana/spl-token";import{createInitializeAccountInstruction as cu}from"@solana/spl-token";import{SystemProgram as on,Transaction as lu}from"@solana/web3.js";function td(i="accountFlags"){let e=new Er(i);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ro=O([le(5),td("accountFlags"),B("ownAddress"),w("vaultSignerNonce"),B("baseMint"),B("quoteMint"),B("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),B("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),B("requestQueue"),B("eventQueue"),B("bids"),B("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),le(7)]);function id({programId:i,marketInfo:e}){let t=O([M("version"),Ee("instruction"),w("baseLotSize"),w("quoteLotSize"),kt("feeRateBps"),w("vaultSignerNonce"),w("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:rd,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),r=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},r),new nd({keys:n,programId:i,data:r})}async function mu({connection:i,wallet:e,marketInfo:t}){let n=new lu,r=await i.getMinimumBalanceForRentExemption(165);n.add(on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:r,space:165,programId:uu}),on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:r,space:165,programId:uu}),cu(t.baseVault.publicKey,t.baseMint,t.vaultOwner),cu(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner));let o=new lu;return o.add(on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await i.getMinimumBalanceForRentExemption(Ro.span),space:Ro.span,programId:t.programId}),on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:await i.getMinimumBalanceForRentExemption(5120+12),space:5120+12,programId:t.programId}),on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:await i.getMinimumBalanceForRentExemption(262144+12),space:262144+12,programId:t.programId}),on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:await i.getMinimumBalanceForRentExemption(65536+12),space:65536+12,programId:t.programId}),on.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:await i.getMinimumBalanceForRentExemption(65536+12),space:65536+12,programId:t.programId}),id({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[_.CreateAccount,_.CreateAccount,_.InitAccount,_.InitAccount]},{transaction:o,signer:[],instructionTypes:[_.CreateAccount,_.CreateAccount,_.CreateAccount,_.CreateAccount,_.CreateAccount,_.InitMarket]}]}var bn=class extends Pe{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:r,dexProgramId:o,txVersion:s,computeBudgetConfig:a}){let u=this.scope.ownerPubKey,c=Fe({fromPublicKey:u,programId:o}),l=Fe({fromPublicKey:u,programId:o}),m=Fe({fromPublicKey:u,programId:o}),p=Fe({fromPublicKey:u,programId:o}),d=Fe({fromPublicKey:u,programId:o}),y=Fe({fromPublicKey:u,programId:du}),f=Fe({fromPublicKey:u,programId:du}),b=0,g=new ur(100);function A(){let N=new ur(0);for(;;)try{return{vaultOwner:Lo.createProgramAddressSync([c.publicKey.toBuffer(),N.toArrayLike(Buffer,"le",8)],o),vaultSignerNonce:N}}catch{if(N.iaddn(1),N.gt(new ur(25555)))throw Error("find vault owner error")}}let{vaultOwner:k,vaultSignerNonce:h}=A(),T=new ur(Math.round(10**e.decimals*n)),I=new ur(Math.round(n*10**t.decimals*r));if(T.eq(Ue))throw Error("lot size is too small");if(I.eq(Ue))throw Error("tick size or lot size is too small");let S=await mu({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:o,id:c,baseMint:e.mint,quoteMint:t.mint,baseVault:y,quoteVault:f,vaultOwner:k,requestQueue:l,eventQueue:m,bids:p,asks:d,feeRateBps:b,quoteDustThreshold:g,vaultSignerNonce:h,baseLotSize:T,quoteLotSize:I}}),x=this.createTxBuilder();x.addCustomComputeBudget(a),x.addInstruction({instructions:S[0].transaction.instructions,signers:S[0].signer});let K=[];for await(let N of S.slice(1,S.length)){let E=this.createTxBuilder();E.addCustomComputeBudget(a),E.addInstruction({instructions:N.transaction.instructions,signers:N.signer,instructionTypes:N.instructionTypes});let z=await E.versionBuild({txVersion:s});K.push(z)}return x.versionMultiBuild({extraPreBuildData:K,extInfo:{address:{marketId:c.publicKey,requestQueue:l.publicKey,eventQueue:m.publicKey,bids:p.publicKey,asks:d.publicKey,baseVault:y.publicKey,quoteVault:f.publicKey,baseMint:new Lo(e.mint),quoteMin:new Lo(t.mint)}},txVersion:s})}};import{PublicKey as lr}from"@solana/web3.js";import{PublicKey as od,TransactionInstruction as No,SYSVAR_CLOCK_PUBKEY as sd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Mo}from"@solana/spl-token";var Oo=O([M("instruction"),Vs("amount")]),cr=O([M("instruction")]);function EI({programId:i,amount:e,instructionKeys:t}){let n=[{pubkey:new od("11111111111111111111111111111111"),isSigner:!1,isWritable:!1},{pubkey:Mo,isSigner:!1,isWritable:!1},{pubkey:Ye,isSigner:!1,isWritable:!1},{pubkey:Pi,isSigner:!1,isWritable:!1},...Object.entries(t).map(([o,s])=>({pubkey:s,isSigner:o==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(o)}))],r=Buffer.alloc(Oo.span);return Oo.encode({instruction:1,amount:Number(e)},r),new No({keys:n,programId:i,data:r})}function ni({programId:i},e){let t=[{pubkey:Mo,isSigner:!1,isWritable:!1},{pubkey:Pi,isSigner:!1,isWritable:!1},...Object.entries(e).map(([r,o])=>({pubkey:o,isSigner:r==="userOwner",isWritable:!["authority","userOwner"].includes(r)}))],n=Buffer.alloc(cr.span);return cr.encode({instruction:2},n),new No({keys:t,programId:i,data:n})}function _o(i){let{poolConfig:e,userKeys:t,side:n}=i,r=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,o=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(cr.span);cr.encode({instruction:2},s);let a=[{pubkey:Mo,isWritable:!1,isSigner:!1},{pubkey:sd,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new No({programId:e.programId,keys:a,data:s})}import pu from"bn.js";var ad={[Nn.IDO_PROGRAM_ID_V1.toString()]:1,[Nn.IDO_PROGRAM_ID_V2.toString()]:2,[Nn.IDO_PROGRAM_ID_V3.toString()]:3,[Nn.IDO_PROGRAM_ID_V4.toString()]:4},gn=class extends Pe{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:r=!1,txVersion:o}){let s=this.createTxBuilder(),a=ad[t.programId];a||this.logAndCreateError("invalid version",a);let u=me(t),[c,l]=[!new pu(e.coin).isZero(),!new pu(e.pc).isZero()],m=u.projectInfo.mint.address.equals($),{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:r});!p&&c&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),c&&d&&s.addInstruction(d);let y=u.buyInfo.mint.address.equals($),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:r});if(!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!p||!f)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...c?[ni({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new lr(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[ni({programId:new lr(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:f,userIdoInfo:new lr(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:o});if(a<3)return!c&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[ni({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:f,userBaseTokenAccount:p,userIdoInfo:new lr(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:o});let g={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:f,ledgerAccount:new lr(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...c?[_o({...g,side:"base"})]:[],...l?[_o({...g,side:"quote"})]:[]]}).versionBuild({txVersion:o})}};import{PublicKey as ud}from"@solana/web3.js";import{MintLayout as cd,TOKEN_2022_PROGRAM_ID as Vo,TOKEN_PROGRAM_ID as Eo}from"@solana/spl-token";var mr=class extends Pe{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:r="strict"}=t||{},{mintList:o,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),u=await this.scope.fetchJupTokenList(r,n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(At.address,At),this._mintGroup.official.add(At.address),s.forEach(c=>{this._blackTokenMap.set(c.address,{...c,priority:-1})}),o.forEach(c=>{var l;this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?Vo.toBase58():Eo.toBase58()}),this._mintGroup.official.add(c.address))}),u.forEach(c=>{var l;this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?Vo.toBase58():Eo.toBase58()}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?Vo.toBase58():Eo.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),r=this._tokenMap.get(n);if(r)return r;if(n.toLocaleUpperCase()==="SOL")return At;let o=(await this.scope.api.getTokenInfo([n]))[0];if(o)return this._mintGroup.extra.add(n),this._tokenMap.set(n,{...o,priority:2}),o;let s=await this.scope.connection.getAccountInfo(new ud(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=cd.decode(s.data),u=n.toString().substring(0,6),c={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:u,name:u,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,c),c}};var ri=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:r,api:o,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:u}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=r?new dt(r):void 0,this._signAllTransactions=e.signAllTransactions,this.api=o,this._apiCacheTime=u||5*60*1e3,this.logger=oe("Raydium"),this.farm=new Yn({scope:this,moduleName:"Raydium_Farm"}),this.account=new En({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new nr({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new mr({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new ar({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new rr({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new sr({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new at({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new bn({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new gn({scope:this,moduleName:"Raydium_ido"}),this.availability={};let c=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:c,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=ld({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4,apiCacheTime:3e5,signAllTransactions:void 0,urlConfigs:{},logRequests:!1,logCount:10,jupTokenType:"strict",disableFeatureCheck:!1,disableLoadToken:!1,tokenAccounts:[],tokenAccountRawInfos:[],defaultChainTimeOffset:void 0,defaultChainTime:void 0},e),{cluster:n,apiRequestTimeout:r,logCount:o,logRequests:s,urlConfigs:a}=t,u=new Mr({cluster:n,timeout:r,urlConfigs:a,logCount:o,logRequests:s}),c=new ri({...t,api:u});return await c.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await c.token.load({type:e.jupTokenType}),c}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(_r);return this._owner.publicKey}setOwner(e){return this._owner=e?new dt(e):void 0,this}get connection(){if(!this._connection)throw new Error(Ns);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(_r),new Error(_r)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}async fetchJupTokenList(e,t){var o;let n=(o=this.apiData.jupTokenList)==null?void 0:o[e];if(n&&!this.isCacheInvalidate(n.fetched)&&!t)return n.data;let r=await this.api.getJupTokenList(e);return this.apiData.jupTokenList={...this.apiData.jupTokenList,[e]:{fetched:Date.now(),data:r}},this.apiData.jupTokenList[e].data}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};import{TOKEN_PROGRAM_ID as Wo,TOKEN_2022_PROGRAM_ID as Fo}from"@solana/spl-token";import{PublicKey as ut,TransactionInstruction as Do,SystemProgram as yu}from"@solana/web3.js";import vo from"bn.js";function qx(i,e,t,n,r,o,s,a,u,c,l,m){let p=O([M("instruction"),w("amountIn"),w("amountOut")]),d=[{pubkey:yu.programId,isSigner:!1,isWritable:!1},{pubkey:Wo,isSigner:!1,isWritable:!1},{pubkey:new ut(t.programId),isSigner:!1,isWritable:!1},{pubkey:new ut(t.id),isSigner:!1,isWritable:!0},{pubkey:new ut(n.id),isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=me(t);d.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(u)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(u)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=me(t);d.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new ut("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=me(t);d.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(p.span);return p.encode({instruction:4,amountIn:c,amountOut:l},y),new Do({keys:d,programId:i,data:y})}function Ux(i,e,t,n,r,o,s,a,u,c){let l=O([M("instruction")]),m=[{pubkey:yu.programId,isSigner:!1,isWritable:!1},{pubkey:Wo,isSigner:!1,isWritable:!1},{pubkey:new ut(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new ut(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new ut(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let d=me(n);m.push({pubkey:d.config.id,isSigner:!1,isWritable:!1},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.mintA.address.equals(u)?d.vault.A:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.mintA.address.equals(u)?d.vault.B:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0},...c.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let d=me(n);m.push({pubkey:d.authority,isSigner:!1,isWritable:!1},{pubkey:d.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:new ut("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:d.openOrders,isSigner:!1,isWritable:!0},{pubkey:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.marketId,isSigner:!1,isWritable:!0},{pubkey:d.marketBids,isSigner:!1,isWritable:!0},{pubkey:d.marketAsks,isSigner:!1,isWritable:!0},{pubkey:d.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0})}else{let d=me(n);m.push({pubkey:d.authority,isSigner:!1,isWritable:!1},{pubkey:d.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:d.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:d.openOrders,isSigner:!1,isWritable:!0},{pubkey:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.marketId,isSigner:!1,isWritable:!0},{pubkey:d.marketBids,isSigner:!1,isWritable:!0},{pubkey:d.marketAsks,isSigner:!1,isWritable:!0},{pubkey:d.marketEventQueue,isSigner:!1,isWritable:!0},...d.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:d.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:d.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0}])}let p=Buffer.alloc(l.span);return l.encode({instruction:5},p),new Do({keys:m,programId:i,data:p})}function fu(i,e,t,n,r,o){if(i.pooltype.includes("StablePool")){let s=me(e);return[{pubkey:s.programId,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.authority,isSigner:!1,isWritable:!1},{pubkey:s.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:new ut("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:s.openOrders,isSigner:!1,isWritable:!0},{pubkey:s.vault.A,isSigner:!1,isWritable:!0},{pubkey:s.vault.B,isSigner:!1,isWritable:!0},{pubkey:s.marketId,isSigner:!1,isWritable:!0},{pubkey:s.marketBids,isSigner:!1,isWritable:!0},{pubkey:s.marketAsks,isSigner:!1,isWritable:!0},{pubkey:s.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0}]}else if(i.type==="Concentrated"){let s=i,a=me(e),u=s.mintA.address===t;return[{pubkey:new ut(String(i.programId)),isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a.config.id,isSigner:!1,isWritable:!1},{pubkey:a.id,isSigner:!1,isWritable:!0},{pubkey:u?a.vault.A:a.vault.B,isSigner:!1,isWritable:!0},{pubkey:u?a.vault.B:a.vault.A,isSigner:!1,isWritable:!0},{pubkey:a.id,isSigner:!1,isWritable:!0},...a.mintA.programId.equals(Fo)||a.mintB.programId.equals(Fo)?[{pubkey:Fo,isSigner:!1,isWritable:!1},{pubkey:un,isSigner:!1,isWritable:!1},{pubkey:u?a.mintA.address:a.mintB.address,isSigner:!1,isWritable:!1},{pubkey:u?a.mintB.address:a.mintA.address,isSigner:!1,isWritable:!1}]:[],...(o!=null?o:[]).map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:ot(new ut(String(i.programId)),new ut(i.id)).publicKey,isSigner:!1,isWritable:!0}]}else{let s=me(e);return[{pubkey:s.programId,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.authority,isSigner:!1,isWritable:!1},{pubkey:s.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:s.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:s.openOrders,isSigner:!1,isWritable:!0},{pubkey:s.vault.A,isSigner:!1,isWritable:!0},{pubkey:s.vault.B,isSigner:!1,isWritable:!0},{pubkey:s.marketId,isSigner:!1,isWritable:!0},{pubkey:s.marketBids,isSigner:!1,isWritable:!0},{pubkey:s.marketAsks,isSigner:!1,isWritable:!0},{pubkey:s.marketEventQueue,isSigner:!1,isWritable:!0},...s.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:s.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:s.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0}]]}}function md(i,e,t,n,r,o,s,a,u,c,l,m,p,d){let y=O([M("instruction"),w("amountIn"),w("amountOut")]),f=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:Wo,isSigner:!1,isWritable:!1}];f.push(...fu(a,c,o,t,n,d[0])),f.push(...fu(u,l,s,n,r,d[1]));let b=Buffer.alloc(y.span);return y.encode({instruction:8,amountIn:m,amountOut:p},b),new Do({keys:f,programId:i,data:b})}async function Gx({routeProgram:i,ownerInfo:e,inputMint:t,swapInfo:n}){var r,o,s,a,u,c;if(n.routeType==="amm")if(n.poolInfo[0].type==="Concentrated"){let l=me(n.poolKey[0]),m=t.equals(l.mintA.address)?It.add(et):xt.sub(et);return await ke.makeSwapBaseInInstructions({poolInfo:l,poolKeys:l,ownerInfo:{wallet:e.wallet,tokenAccountA:l.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:l.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((o=(r=n.minAmountOut.fee)==null?void 0:r.raw)!=null?o:new vo(0)),sqrtPriceLimitX64:m,remainingAccounts:n.remainingAccounts[0]})}else{let l=n.poolKey[0];return{signers:[],instructions:[zr({poolKeys:l,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((a=(s=n.minAmountOut.fee)==null?void 0:s.raw)!=null?a:new vo(0)),fixedSide:"in"})],lookupTableAddress:l.lookupTableAccount?[l.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?_.AmmV5SwapBaseIn:_.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let l=n.poolInfo[0],m=n.poolInfo[1],p=n.poolKey[0],d=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[md(i,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.minMiddleAmountFee.token.mint.toString(),l,m,p,d,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((c=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?c:new vo(0)),n.remainingAccounts)],instructionTypes:[_.RouteSwap],lookupTableAddress:[p.lookupTableAccount,d.lookupTableAccount].filter(y=>y!==void 0),address:{}}}else throw Error("route type error")}import gu from"bn.js";var qo=new gu(1e6);function dd(i,e,t){return i.mul(e).add(t).sub(new gu(1)).div(t)}function bu(i,e,t){return i.mul(e).div(t)}var ii=class{static tradingFee(e,t){return dd(e,t,qo)}static protocolFee(e,t){return bu(e,t,qo)}static fundFee(e,t){return bu(e,t,qo)}};import dr from"bn.js";function oi(i,e){if(e.isZero())throw Error("divisor is zero");return i.mod(e)}function pd(i,e){if(e.isZero())throw Error("rhs is zero");let t=i.div(e);if(t.isZero())throw Error("quotient is zero");let n=oi(i,e);if(n.gt(wn)){t=t.add(new dr(1));let r=i.div(t);n=oi(i,t),n.gt(wn)&&(r=r.add(new dr(1)))}return[t,e]}var wn=new dr(0),si=class{static swapWithoutFees(e,t,n){let r=t.mul(n),o=t.add(e),[s,a]=pd(r,o),u=a.sub(t),c=n.sub(s);if(c.isZero())throw Error("destinationAmountSwapped is zero");return{sourceAmountSwapped:u,destinationAmountSwapped:c}}static lpTokensToTradingTokens(e,t,n,r,o){let s=e.mul(n).div(t),a=e.mul(r).div(t);if(o===0)return{tokenAmount0:s,tokenAmount1:a};if(o===1)return oi(e.mul(n),t).gt(wn)&&s.gt(wn)&&(s=s.add(new dr(1))),oi(e.mul(r),t).gt(wn)&&a.gt(wn)&&(a=a.add(new dr(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var wu=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(wu||{}),Au=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,r){let o=ii.tradingFee(e,r),s=e.sub(o),{sourceAmountSwapped:a,destinationAmountSwapped:u}=si.swapWithoutFees(s,t,n),c=a.add(o);return{newSwapSourceAmount:t.add(c),newSwapDestinationAmount:n.sub(u),sourceAmountSwapped:c,destinationAmountSwapped:u,tradeFee:o}}};var Pu={[Oi.toBase58()]:3},ku={3:Oi};var fd=O([le(5),le(8),B("ownAddress"),w("vaultSignerNonce"),B("baseMint"),B("quoteMint"),B("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),B("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),B("requestQueue"),B("eventQueue"),B("bids"),B("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),le(7)]),hu={3:fd};import{PublicKey as Tu}from"@solana/web3.js";var ai=oe("Serum"),Iu=class{static getProgramId(e){let t=ku[e];return t||ai.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Pu[t];return n||ai.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=hu[e];return t||ai.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],r=0,o;for(;r<100;){try{let s=n.concat(Buffer.from([r]),Buffer.alloc(7));o=Tu.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;r++;continue}return{publicKey:o,nonce:r}}return ai.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Tu.default,nonce:r}}};var FB=i=>i;export{gm as AMM_CONFIG_SEED,hk as AmmConfigLayout,Na as BIT_PRECISION,rr as Clmm,ke as ClmmInstrument,si as ConstantProductCurve,iu as CpmmConfigInfoLayout,ii as CpmmFee,ou as CpmmPoolInfoLayout,Au as CurveCalculator,nm as DataElement,ho as EXTENSION_TICKARRAY_BITMAP_SIZE,na as FARM_LOCK_MINT,ra as FARM_LOCK_VAULT,yt as FARM_PROGRAM_TO_VERSION,oa as FARM_VERSION_TO_LEDGER_LAYOUT,ia as FARM_VERSION_TO_STATE_LAYOUT,jr as FEE_RATE_DENOMINATOR,qo as FEE_RATE_DENOMINATOR_VALUE,xm as FETCH_TICKARRAY_COUNT,Im as Fee,za as LIQUIDITY_FEES_DENOMINATOR,Xa as LIQUIDITY_FEES_NUMERATOR,Om as LIQUIDITY_VERSION_TO_SERUM_VERSION,FA as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Ma as LOG_B_2_X32,_a as LOG_B_P_ERR_MARGIN_LOWER_X64,Va as LOG_B_P_ERR_MARGIN_UPPER_X64,se as LiquidityMath,Ro as MARKET_STATE_LAYOUT_V2,fd as MARKET_STATE_LAYOUT_V3,hu as MARKET_VERSION_TO_STATE_LAYOUT,xt as MAX_SQRT_PRICE_X64,Xe as MAX_TICK,It as MIN_SQRT_PRICE_X64,ve as MIN_TICK,fn as MODEL_DATA_PUBKEY,Iu as Market,H as MathUtil,ko as MaxU64,Oa as MaxUint128,Mt as NEGATIVE_ONE,et as ONE,hm as OPERATION_SEED,Io as ObservationInfoLayout,Km as ObservationLayout,Wa as OperationLayout,Pm as POOL_REWARD_VAULT_SEED,wm as POOL_SEED,Tm as POOL_TICK_ARRAY_BITMAP_SEED,Am as POOL_VAULT_SEED,Ca as POSITION_SEED,Zr as PoolInfoLayout,We as PoolUtils,$r as PositionInfoLayout,Rm as PositionRewardInfoLayout,er as PositionUtils,Tk as ProtocolPositionLayout,Hr as Q128,tt as Q64,ri as Raydium,Cm as RewardInfo,wu as RoundDirection,Pu as SERUM_PROGRAMID_TO_VERSION,ku as SERUM_VERSION_TO_PROGRAMID,At as SOL_INFO,pA as SPL_MINT_LAYOUT,Q as SqrtPriceMath,pn as StableLayout,tn as SwapMath,en as TICK_ARRAY_BITMAP_SIZE,km as TICK_ARRAY_SEED,Ke as TICK_ARRAY_SIZE,mP as TICK_SPACINGS,Se as TOKEN_WSOL,_t as TickArrayBitmap,va as TickArrayBitmapExtensionLayout,Jn as TickArrayBitmapExtensionUtils,$n as TickArrayLayout,Lm as TickLayout,nn as TickMath,ae as TickQuery,q as TickUtils,Zn as U64Resolution,pP as U64_IGNORE_RANGE,ea as Voter,Vl as VoterDepositEntry,_l as VoterLockup,Js as VoterRegistrar,Ml as VoterVotingMintConfig,ce as ZERO,po as addLiquidityLayout,zi as associatedLedgerAccountLayout,oo as calFarmRewardAmount,dd as ceilDiv,cr as claimLayout,Lt as closeAccountInstruction,ua as createAssociatedLedgerAccountInstruction,ba as createPoolFeeLayout,Ia as createPoolV4InstructionV2,EA as createPoolV4Layout,ht as createWSolAccountInstructions,Ge as dwLayout,ji as farmAddRewardLayout,$g as farmLedgerLayoutV3_1,vn as farmLedgerLayoutV3_2,Jg as farmLedgerLayoutV5_1,Zs as farmLedgerLayoutV5_2,$s as farmLedgerLayoutV6_1,aa as farmRewardInfoToConfig,Qi as farmRewardLayout,Hi as farmRewardRestartLayout,Nl as farmRewardTimeInfoLayout,Hs as farmStateV3Layout,js as farmStateV5Layout,Fn as farmStateV6Layout,Iw as fetchMultipleFarmInfoAndUpdate,Jk as fetchMultipleInfo,co as fixedSwapInLayout,lo as fixedSwapOutLayout,bu as floorDiv,dm as formatLayout,Fe as generatePubKey,sa as getAssociatedAuthority,So as getAssociatedConfigId,je as getAssociatedLedgerAccount,Dn as getAssociatedLedgerPoolAccount,Vm as getAssociatedOpenOrders,Qa as getAssociatedPoolKeys,Xm as getCpmmPdaAmmConfigId,zm as getCpmmPdaPoolId,Za as getCreatePoolKeys,so as getDepositEntryIndex,Pa as getDxByDyBaseIn,Aa as getDyByDxBaseIn,Gr as getFarmLedgerLayout,El as getFarmStateLayout,Em as getLiquidityAssociatedAuthority,rn as getLiquidityAssociatedId,$P as getLiquidityFromAmounts,uP as getPdaAmmConfigId,ot as getPdaExBitmapAccount,Ym as getPdaLpMint,Qr as getPdaMetadataKey,ei as getPdaObservationId,jn as getPdaOperationAccount,it as getPdaPersonalPositionAddress,Gm as getPdaPoolAuthority,Ra as getPdaPoolId,La as getPdaPoolRewardVaulId,Po as getPdaPoolVaultId,Jt as getPdaProtocolPositionAddress,fe as getPdaTickArrayAddress,ja as getPdaVault,Ji as getRegistrarAddress,ka as getStablePrice,io as getTokenOwnerRecordAddress,no as getVoterAddress,ro as getVoterWeightRecordAddress,to as getVotingMintAuthority,eo as getVotingTokenMint,zl as governanceCreateTokenOwnerRecord,rP as i16ToBytes,Yr as i32ToBytes,mo as initPoolLayout,Gi as initTokenAccountInstruction,id as initializeMarket,Zi as isValidFarmVersion,Hn as isZero,xw as judgeFarmType,wo as leadingZeros,Ka as leastSignificantBit,Jl as liquidityStateV4Layout,em as liquidityStateV5Layout,zr as makeAMMSwapInstruction,Ta as makeAddLiquidityInstruction,uo as makeAddNewRewardInstruction,ni as makeClaimInstruction,_o as makeClaimInstructionV4,Ja as makeCreateCpmmPoolInInstruction,ca as makeCreateFarmInstruction,mu as makeCreateMarketInstruction,la as makeCreatorWithdrawFarmRewardInstruction,eu as makeDepositCpmmInInstruction,ma as makeDepositInstructionV3,da as makeDepositInstructionV5,pa as makeDepositInstructionV6,qw as makeDepositTokenInstruction,Gw as makeDepositWithdrawInstruction,tP as makeInitPoolInstructionV4,EI as makePurchaseInstruction,ao as makeRestartRewardInstruction,xa as makeSimulatePoolInfoInstruction,nu as makeSwapCpmmBaseInInInstruction,ru as makeSwapCpmmBaseOutInInstruction,ym as makeSwapFixedInInstruction,bm as makeSwapFixedOutInstruction,Gx as makeSwapInstruction,Vn as makeTransferInstruction,tu as makeWithdrawCpmmInInstruction,zn as makeWithdrawInstructionV3,Xn as makeWithdrawInstructionV5,Gn as makeWithdrawInstructionV6,Uw as makeWithdrawTokenInstruction,dP as mockCreatePoolInfo,Ea as mockV3CreatePoolInfo,rm as modelDataInfoLayout,Sa as mostSignificantBit,Qs as parseTokenAccountResp,kA as parseTokenInfo,Gt as poolTypeV6,Oo as purchaseLayout,Rl as realFarmStateV3Layout,Ll as realFarmStateV5Layout,Ol as realFarmV6Layout,go as removeLiquidityInstruction,fo as removeLiquidityLayout,qx as route1Instruction,Ux as route2Instruction,md as routeInstruction,eP as simulatePoolInfoInstruction,IA as solToWSolToken,Wt as splAccountLayout,ya as toToken,TA as toTokenAmount,hA as toTokenInfo,Ao as trailingZeros,Ba as u16ToBytes,iP as u32ToBytes,FB as unionArr,Fl as updateFarmPoolInfo,$i as validateFarmRewards,Ql as voterStakeRegistryCreateDepositEntry,Yl as voterStakeRegistryCreateVoter,Ul as voterStakeRegistryDeposit,Gl as voterStakeRegistryUpdateVoterWeightRecord,Xl as voterStakeRegistryWithdraw,xA as wSolToSolToken,Yi as withdrawRewardLayout};
/*!
 *  decimal.js v10.4.3
 *  An arbitrary-precision Decimal type for JavaScript.
 *  https://github.com/MikeMcl/decimal.js
 *  Copyright (c) 2022 Michael Mclaughlin <M8ch88l@gmail.com>
 *  MIT Licence
 */
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map