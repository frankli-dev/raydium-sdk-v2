import C from"bn.js";var ze=9e15,_e=1e9,Bt="0123456789abcdef",dt="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",ft="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",It={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-ze,maxE:ze,crypto:!1},rn,Ne,P=!0,gt="[DecimalError] ",Me=gt+"Invalid argument: ",on=gt+"Precision limit exceeded",sn=gt+"crypto unavailable",an="[object Decimal]",ie=Math.floor,Q=Math.pow,Yn=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,Zn=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,jn=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,un=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,we=1e7,A=7,Qn=9007199254740991,Jn=dt.length-1,Nt=ft.length-1,p={toStringTag:an};p.absoluteValue=p.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),w(r)};p.ceil=function(){return w(new this.constructor(this),this.e+1,2)};p.clampedTo=p.clamp=function(r,e){var t,n=this,i=n.constructor;if(r=new i(r),e=new i(e),!r.s||!e.s)return new i(NaN);if(r.gt(e))throw Error(Me+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new i(n)};p.comparedTo=p.cmp=function(r){var e,t,n,i,o=this,s=o.d,a=(r=new o.constructor(r)).d,u=o.s,c=r.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(o.e!==r.e)return o.e>r.e^u<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===i?0:n>i^u<0?1:-1};p.cosine=p.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+A,n.rounding=1,t=$n(n,fn(n,t)),n.precision=r,n.rounding=e,w(Ne==2||Ne==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};p.cubeRoot=p.cbrt=function(){var r,e,t,n,i,o,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(P=!1,o=l.s*Q(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=re(l.d),r=l.e,(o=(r-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=Q(t,1/3),r=ie((r+1)/3)-(r%3==(r<0?-1:2)),o==1/0?t="5e"+r:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(r=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=D(c.plus(l).times(a),c.plus(u),s+2,1),re(a.d).slice(0,s)===(t=re(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(w(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(w(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return P=!0,w(n,r,m.rounding,e)};p.decimalPlaces=p.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-ie(this.e/A))*A,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};p.dividedBy=p.div=function(r){return D(this,new this.constructor(r))};p.dividedToIntegerBy=p.divToInt=function(r){var e=this,t=e.constructor;return w(D(e,new t(r),0,1,1),t.precision,t.rounding)};p.equals=p.eq=function(r){return this.cmp(r)===0};p.floor=function(){return w(new this.constructor(this),this.e+1,3)};p.greaterThan=p.gt=function(r){return this.cmp(r)>0};p.greaterThanOrEqualTo=p.gte=function(r){var e=this.cmp(r);return e==1||e===0};p.hyperbolicCosine=p.cosh=function(){var r,e,t,n,i,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,i=o.d.length,i<32?(r=Math.ceil(i/3),e=(1/bt(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),o=He(s,1,o.times(e),new s(1),!0);for(var u,c=r,l=new s(8);c--;)u=o.times(o),o=a.minus(u.times(l.minus(u.times(l))));return w(o,s.precision=t,s.rounding=n,!0)};p.hyperbolicSine=p.sinh=function(){var r,e,t,n,i=this,o=i.constructor;if(!i.isFinite()||i.isZero())return new o(i);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(i.e,i.sd())+4,o.rounding=1,n=i.d.length,n<3)i=He(o,2,i,i,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,i=i.times(1/bt(5,r)),i=He(o,2,i,i,!0);for(var s,a=new o(5),u=new o(16),c=new o(20);r--;)s=i.times(i),i=i.times(a.plus(s.times(u.times(s).plus(c))))}return o.precision=e,o.rounding=t,w(i,e,t,!0)};p.hyperbolicTangent=p.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,D(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};p.inverseCosine=p.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?ye(t,i,o):new t(0):new t(NaN):e.isZero()?ye(t,i+4,o).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),r=ye(t,i+4,o).times(.5),t.precision=i,t.rounding=o,r.minus(e))};p.inverseHyperbolicCosine=p.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,P=!1,t=t.times(t).minus(1).sqrt().plus(t),P=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};p.inverseHyperbolicSine=p.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,P=!1,t=t.times(t).plus(1).sqrt().plus(t),P=!0,n.precision=r,n.rounding=e,t.ln())};p.inverseHyperbolicTangent=p.atanh=function(){var r,e,t,n,i=this,o=i.constructor;return i.isFinite()?i.e>=0?new o(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(r=o.precision,e=o.rounding,n=i.sd(),Math.max(n,r)<2*-i.e-1?w(new o(i),r,e,!0):(o.precision=t=n-i.e,i=D(i.plus(1),new o(1).minus(i),t+r,1),o.precision=r+4,o.rounding=1,i=i.ln(),o.precision=r,o.rounding=e,i.times(.5))):new o(NaN)};p.inverseSine=p.asin=function(){var r,e,t,n,i=this,o=i.constructor;return i.isZero()?new o(i):(e=i.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(r=ye(o,t+4,n).times(.5),r.s=i.s,r):new o(NaN):(o.precision=t+6,o.rounding=1,i=i.div(new o(1).minus(i.times(i)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,i.times(2)))};p.inverseTangent=p.atan=function(){var r,e,t,n,i,o,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=Nt)return s=ye(l,m+4,d).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=Nt)return s=ye(l,m+4,d).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/A+2|0),r=t;r;--r)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(P=!1,e=Math.ceil(a/A),n=1,u=c.times(c),s=new l(c),i=c;r!==-1;)if(i=i.times(u),o=s.minus(i.div(n+=2)),i=i.times(u),s=o.plus(i.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===o.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),P=!0,w(s,l.precision=m,l.rounding=d,!0)};p.isFinite=function(){return!!this.d};p.isInteger=p.isInt=function(){return!!this.d&&ie(this.e/A)>this.d.length-2};p.isNaN=function(){return!this.s};p.isNegative=p.isNeg=function(){return this.s<0};p.isPositive=p.isPos=function(){return this.s>0};p.isZero=function(){return!!this.d&&this.d[0]===0};p.lessThan=p.lt=function(r){return this.cmp(r)<0};p.lessThanOrEqualTo=p.lte=function(r){return this.cmp(r)<1};p.logarithm=p.log=function(r){var e,t,n,i,o,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding,f=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(i=t[0];i%10===0;)i/=10;o=i!==1}if(P=!1,a=m+f,s=Fe(c,a),n=e?pt(l,a+10):Fe(r,a),u=D(s,n,a,1),Qe(u.d,i=m,d))do if(a+=10,s=Fe(c,a),n=e?pt(l,a+10):Fe(r,a),u=D(s,n,a,1),!o){+re(u.d).slice(i+1,i+15)+1==1e14&&(u=w(u,m+1,0));break}while(Qe(u.d,i+=10,d));return P=!0,w(u,m,d)};p.minus=p.sub=function(r){var e,t,n,i,o,s,a,u,c,l,m,d,f=this,b=f.constructor;if(r=new b(r),!f.d||!r.d)return!f.s||!r.s?r=new b(NaN):f.d?r.s=-r.s:r=new b(r.d||f.s!==r.s?f:NaN),r;if(f.s!=r.s)return r.s=-r.s,f.plus(r);if(c=f.d,d=r.d,a=b.precision,u=b.rounding,!c[0]||!d[0]){if(d[0])r.s=-r.s;else if(c[0])r=new b(f);else return new b(u===3?-0:0);return P?w(r,a,u):r}if(t=ie(r.e/A),l=ie(f.e/A),c=c.slice(),o=l-t,o){for(m=o<0,m?(e=c,o=-o,s=d.length):(e=d,t=l,s=c.length),n=Math.max(Math.ceil(a/A),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=d[n]){m=c[n]<d[n];break}o=0}for(m&&(e=c,c=d,d=e,r.s=-r.s),s=c.length,n=d.length-s;n>0;--n)c[s++]=0;for(n=d.length;n>o;){if(c[--n]<d[n]){for(i=n;i&&c[--i]===0;)c[i]=we-1;--c[i],c[n]+=we}c[n]-=d[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(r.d=c,r.e=ht(c,t),P?w(r,a,u):r):new b(u===3?-0:0)};p.modulo=p.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?w(new n(t),n.precision,n.rounding):(P=!1,n.modulo==9?(e=D(t,r.abs(),0,3,1),e.s*=r.s):e=D(t,r,0,n.modulo,1),e=e.times(r),P=!0,t.minus(e))};p.naturalExponential=p.exp=function(){return St(this)};p.naturalLogarithm=p.ln=function(){return Fe(this)};p.negated=p.neg=function(){var r=new this.constructor(this);return r.s=-r.s,w(r)};p.plus=p.add=function(r){var e,t,n,i,o,s,a,u,c,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(c=m.d,l=r.d,a=d.precision,u=d.rounding,!c[0]||!l[0])return l[0]||(r=new d(m)),P?w(r,a,u):r;if(o=ie(m.e/A),n=ie(r.e/A),c=c.slice(),i=o-n,i){for(i<0?(t=c,i=-i,s=l.length):(t=l,n=o,s=c.length),o=Math.ceil(a/A),s=o>s?o+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=c.length,i=l.length,s-i<0&&(i=s,t=l,l=c,c=t),e=0;i;)e=(c[--i]=c[i]+l[i]+e)/we|0,c[i]%=we;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return r.d=c,r.e=ht(c,n),P?w(r,a,u):r};p.precision=p.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(Me+r);return t.d?(e=cn(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};p.round=function(){var r=this,e=r.constructor;return w(new e(r),r.e+1,e.rounding)};p.sine=p.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+A,n.rounding=1,t=tr(n,fn(n,t)),n.precision=r,n.rounding=e,w(Ne>2?t.neg():t,r,e,!0)):new n(NaN)};p.squareRoot=p.sqrt=function(){var r,e,t,n,i,o,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(P=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=re(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=ie((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(o=n,n=o.plus(D(s,o,t+2,1)).times(.5),re(o.d).slice(0,t)===(e=re(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(w(o,u+1,0),o.times(o).eq(s))){n=o;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(w(n,u+1,1),r=!n.times(n).eq(s));break}return P=!0,w(n,u,l.rounding,r)};p.tangent=p.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=D(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,w(Ne==2||Ne==4?t.neg():t,r,e,!0)):new n(NaN)};p.times=p.mul=function(r){var e,t,n,i,o,s,a,u,c,l=this,m=l.constructor,d=l.d,f=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!f||!f[0])return new m(!r.s||d&&!d[0]&&!f||f&&!f[0]&&!d?NaN:!d||!f?r.s/0:r.s*0);for(t=ie(l.e/A)+ie(r.e/A),u=d.length,c=f.length,u<c&&(o=d,d=f,f=o,s=u,u=c,c=s),o=[],s=u+c,n=s;n--;)o.push(0);for(n=c;--n>=0;){for(e=0,i=u+n;i>n;)a=o[i]+f[n]*d[i-n-1]+e,o[i--]=a%we|0,e=a/we|0;o[i]=(o[i]+e)%we|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),r.d=o,r.e=ht(o,t),P?w(r,m.precision,m.rounding):r};p.toBinary=function(r,e){return Lt(this,2,r,e)};p.toDecimalPlaces=p.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(ce(r,0,_e),e===void 0?e=n.rounding:ce(e,0,8),w(t,r+t.e+1,e))};p.toExponential=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=Ae(n,!0):(ce(r,0,_e),e===void 0?e=i.rounding:ce(e,0,8),n=w(new i(n),r+1,e),t=Ae(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};p.toFixed=function(r,e){var t,n,i=this,o=i.constructor;return r===void 0?t=Ae(i):(ce(r,0,_e),e===void 0?e=o.rounding:ce(e,0,8),n=w(new o(i),r+i.e+1,e),t=Ae(n,!1,r+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};p.toFraction=function(r){var e,t,n,i,o,s,a,u,c,l,m,d,f=this,b=f.d,g=f.constructor;if(!b)return new g(f);if(c=t=new g(1),n=u=new g(0),e=new g(n),o=e.e=cn(b)-f.e-1,s=o%A,e.d[0]=Q(10,s<0?A+s:s),r==null)r=o>0?e:c;else{if(a=new g(r),!a.isInt()||a.lt(c))throw Error(Me+a);r=a.gt(e)?o>0?e:c:a}for(P=!1,a=new g(re(b)),l=g.precision,g.precision=o=b.length*A*2;m=D(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(r)!=1;)t=n,n=i,i=c,c=u.plus(m.times(i)),u=i,i=e,e=a.minus(m.times(i)),a=i;return i=D(r.minus(t),n,0,1,1),u=u.plus(i.times(c)),t=t.plus(i.times(n)),u.s=c.s=f.s,d=D(c,n,o,1).minus(f).abs().cmp(D(u,t,o,1).minus(f).abs())<1?[c,n]:[u,t],g.precision=l,P=!0,d};p.toHexadecimal=p.toHex=function(r,e){return Lt(this,16,r,e)};p.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:ce(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(P=!1,t=D(t,r,0,e,1).times(r),P=!0,w(t)):(r.s=t.s,t=r),t};p.toNumber=function(){return+this};p.toOctal=function(r,e){return Lt(this,8,r,e)};p.toPower=p.pow=function(r){var e,t,n,i,o,s,a=this,u=a.constructor,c=+(r=new u(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new u(Q(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,o=u.rounding,r.eq(1))return w(a,n,o);if(e=ie(r.e/A),e>=r.d.length-1&&(t=c<0?-c:c)<=Qn)return i=ln(u,a,t,n),r.s<0?new u(1).div(i):w(i,n,o);if(s=a.s,s<0){if(e<r.d.length-1)return new u(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Q(+a,c),e=t==0||!isFinite(t)?ie(c*(Math.log("0."+re(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(P=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),i=St(r.times(Fe(a,n+t)),n),i.d&&(i=w(i,n+5,1),Qe(i.d,n,o)&&(e=n+10,i=w(St(r.times(Fe(a,e+t)),e),e+5,1),+re(i.d).slice(n+1,n+15)+1==1e14&&(i=w(i,n+1,0)))),i.s=s,P=!0,u.rounding=o,w(i,n,o))};p.toPrecision=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=Ae(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(ce(r,1,_e),e===void 0?e=i.rounding:ce(e,0,8),n=w(new i(n),r,e),t=Ae(n,r<=n.e||n.e<=i.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};p.toSignificantDigits=p.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(ce(r,1,_e),e===void 0?e=n.rounding:ce(e,0,8)),w(new n(t),r,e)};p.toString=function(){var r=this,e=r.constructor,t=Ae(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};p.truncated=p.trunc=function(){return w(new this.constructor(this),this.e+1,1)};p.valueOf=p.toJSON=function(){var r=this,e=r.constructor,t=Ae(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function re(r){var e,t,n,i=r.length-1,o="",s=r[0];if(i>0){for(o+=s,e=1;e<i;e++)n=r[e]+"",t=A-n.length,t&&(o+=Re(t)),o+=n;s=r[e],n=s+"",t=A-n.length,t&&(o+=Re(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function ce(r,e,t){if(r!==~~r||r<e||r>t)throw Error(Me+r)}function Qe(r,e,t,n){var i,o,s,a;for(o=r[0];o>=10;o/=10)--e;return--e<0?(e+=A,i=0):(i=Math.ceil((e+1)/A),e%=A),o=Q(10,A-e),a=r[i]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(r[i+1]/o/100|0)==Q(10,e-2)-1||(a==o/2||a==0)&&(r[i+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(r[i+1]/o/1e3|0)==Q(10,e-3)-1,s}function mt(r,e,t){for(var n,i=[0],o,s=0,a=r.length;s<a;){for(o=i.length;o--;)i[o]*=e;for(i[0]+=Bt.indexOf(r.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function $n(r,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/bt(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),r.precision+=t,e=He(r,1,e.times(i),new r(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var D=function(){function r(n,i,o){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*i+a,n[u]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,i,o,s){var a,u;if(o!=s)u=o>s?1:-1;else for(a=u=0;a<o;a++)if(n[a]!=i[a]){u=n[a]>i[a]?1:-1;break}return u}function t(n,i,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<i[o]?1:0,n[o]=a*s+n[o]-i[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,o,s,a,u){var c,l,m,d,f,b,g,h,y,B,T,R,x,q,V,W,ne,G,z,ve,me=n.constructor,Ee=n.s==i.s?1:-1,j=n.d,O=i.d;if(!j||!j[0]||!O||!O[0])return new me(!n.s||!i.s||(j?O&&j[0]==O[0]:!O)?NaN:j&&j[0]==0||!O?Ee*0:Ee/0);for(u?(f=1,l=n.e-i.e):(u=we,f=A,l=ie(n.e/f)-ie(i.e/f)),z=O.length,ne=j.length,y=new me(Ee),B=y.d=[],m=0;O[m]==(j[m]||0);m++);if(O[m]>(j[m]||0)&&l--,o==null?(q=o=me.precision,s=me.rounding):a?q=o+(n.e-i.e)+1:q=o,q<0)B.push(1),b=!0;else{if(q=q/f+2|0,m=0,z==1){for(d=0,O=O[0],q++;(m<ne||d)&&q--;m++)V=d*u+(j[m]||0),B[m]=V/O|0,d=V%O|0;b=d||m<ne}else{for(d=u/(O[0]+1)|0,d>1&&(O=r(O,d,u),j=r(j,d,u),z=O.length,ne=j.length),W=z,T=j.slice(0,z),R=T.length;R<z;)T[R++]=0;ve=O.slice(),ve.unshift(0),G=O[0],O[1]>=u/2&&++G;do d=0,c=e(O,T,z,R),c<0?(x=T[0],z!=R&&(x=x*u+(T[1]||0)),d=x/G|0,d>1?(d>=u&&(d=u-1),g=r(O,d,u),h=g.length,R=T.length,c=e(g,T,h,R),c==1&&(d--,t(g,z<h?ve:O,h,u))):(d==0&&(c=d=1),g=O.slice()),h=g.length,h<R&&g.unshift(0),t(T,g,R,u),c==-1&&(R=T.length,c=e(O,T,z,R),c<1&&(d++,t(T,z<R?ve:O,R,u))),R=T.length):c===0&&(d++,T=[0]),B[m++]=d,c&&T[0]?T[R++]=j[W]||0:(T=[j[W]],R=1);while((W++<ne||T[0]!==void 0)&&q--);b=T[0]!==void 0}B[0]||B.shift()}if(f==1)y.e=l,rn=b;else{for(m=1,d=B[0];d>=10;d/=10)m++;y.e=m+l*f-1,w(y,a?o+y.e+1:o,s,b)}return y}}();function w(r,e,t,n){var i,o,s,a,u,c,l,m,d,f=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(i=1,a=m[0];a>=10;a/=10)i++;if(o=e-i,o<0)o+=A,s=e,l=m[d=0],u=l/Q(10,i-s-1)%10|0;else if(d=Math.ceil((o+1)/A),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=u=0,i=1,o%=A,s=o-A+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;o%=A,s=o-A+i,u=s<0?0:l/Q(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Q(10,i-s-1)),c=t<4?(u||n)&&(t==0||t==(r.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(o>0?s>0?l/Q(10,i-s):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=r.e+1,m[0]=Q(10,(A-e%A)%A),r.e=-e||0):m[0]=r.e=0,r;if(o==0?(m.length=d,a=1,d--):(m.length=d+1,a=Q(10,A-o),m[d]=s>0?(l/Q(10,i-s)%Q(10,s)|0)*a:0),c)for(;;)if(d==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(r.e++,m[0]==we&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=we)break;m[d--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return P&&(r.e>f.maxE?(r.d=null,r.e=NaN):r.e<f.minE&&(r.e=0,r.d=[0])),r}function Ae(r,e,t){if(!r.isFinite())return dn(r);var n,i=r.e,o=re(r.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+Re(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(r.e<0?"e":"e+")+r.e):i<0?(o="0."+Re(-i-1)+o,t&&(n=t-s)>0&&(o+=Re(n))):i>=s?(o+=Re(i+1-s),t&&(n=t-i-1)>0&&(o=o+"."+Re(n))):((n=i+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(o+="."),o+=Re(n))),o}function ht(r,e){var t=r[0];for(e*=A;t>=10;t/=10)e++;return e}function pt(r,e,t){if(e>Jn)throw P=!0,t&&(r.precision=t),Error(on);return w(new r(dt),e,1,!0)}function ye(r,e,t){if(e>Nt)throw Error(on);return w(new r(ft),e,t,!0)}function cn(r){var e=r.length-1,t=e*A+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function Re(r){for(var e="";r--;)e+="0";return e}function ln(r,e,t,n){var i,o=new r(1),s=Math.ceil(n/A+4);for(P=!1;;){if(t%2&&(o=o.times(e),tn(o.d,s)&&(i=!0)),t=ie(t/2),t===0){t=o.d.length-1,i&&o.d[t]===0&&++o.d[t];break}e=e.times(e),tn(e.d,s)}return P=!0,o}function en(r){return r.d[r.d.length-1]&1}function mn(r,e,t){for(var n,i=new r(e[0]),o=0;++o<e.length;)if(n=new r(e[o]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function St(r,e){var t,n,i,o,s,a,u,c=0,l=0,m=0,d=r.constructor,f=d.rounding,b=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(P=!1,u=b):u=e,a=new d(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(Q(2,m))/Math.LN10*2+5|0,u+=n,t=o=s=new d(1),d.precision=u;;){if(o=w(o.times(r),u,1),t=t.times(++l),a=s.plus(D(o,t,u,1)),re(a.d).slice(0,u)===re(s.d).slice(0,u)){for(i=m;i--;)s=w(s.times(s),u,1);if(e==null)if(c<3&&Qe(s.d,u-n,f,c))d.precision=u+=10,t=o=a=new d(1),l=0,c++;else return w(s,d.precision=b,f,P=!0);else return d.precision=b,s}s=a}}function Fe(r,e){var t,n,i,o,s,a,u,c,l,m,d,f=1,b=10,g=r,h=g.d,y=g.constructor,B=y.rounding,T=y.precision;if(g.s<0||!h||!h[0]||!g.e&&h[0]==1&&h.length==1)return new y(h&&!h[0]?-1/0:g.s!=1?NaN:h?0:g);if(e==null?(P=!1,l=T):l=e,y.precision=l+=b,t=re(h),n=t.charAt(0),Math.abs(o=g.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)g=g.times(r),t=re(g.d),n=t.charAt(0),f++;o=g.e,n>1?(g=new y("0."+t),o++):g=new y(n+"."+t.slice(1))}else return c=pt(y,l+2,T).times(o+""),g=Fe(new y(n+"."+t.slice(1)),l-b).plus(c),y.precision=T,e==null?w(g,T,B,P=!0):g;for(m=g,u=s=g=D(g.minus(1),g.plus(1),l,1),d=w(g.times(g),l,1),i=3;;){if(s=w(s.times(d),l,1),c=u.plus(D(s,new y(i),l,1)),re(c.d).slice(0,l)===re(u.d).slice(0,l))if(u=u.times(2),o!==0&&(u=u.plus(pt(y,l+2,T).times(o+""))),u=D(u,new y(f),l,1),e==null)if(Qe(u.d,l-b,B,a))y.precision=l+=b,c=s=g=D(m.minus(1),m.plus(1),l,1),d=w(g.times(g),l,1),i=a=1;else return w(u,y.precision=T,B,P=!0);else return y.precision=T,u;u=c,i+=2}}function dn(r){return String(r.s*r.s/0)}function Ct(r,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%A,t<0&&(n+=A),n<i){for(n&&r.d.push(+e.slice(0,n)),i-=A;n<i;)r.d.push(+e.slice(n,n+=A));e=e.slice(n),n=A-e.length}else n-=i;for(;n--;)e+="0";r.d.push(+e),P&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function er(r,e){var t,n,i,o,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),un.test(e))return Ct(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(Zn.test(e))t=16,e=e.toLowerCase();else if(Yn.test(e))t=2;else if(jn.test(e))t=8;else throw Error(Me+e);for(o=e.search(/p/i),o>0?(u=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,i=ln(n,new n(t),o,o*2)),c=mt(e,t,we),l=c.length-1,o=l;c[o]===0;--o)c.pop();return o<0?new n(r.s*0):(r.e=ht(c,l),r.d=c,P=!1,s&&(r=D(r,i,a*4)),u&&(r=r.times(Math.abs(u)<54?Q(2,u):Je.pow(2,u))),P=!0,r)}function tr(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:He(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/bt(5,t)),e=He(r,2,e,e);for(var i,o=new r(5),s=new r(16),a=new r(20);t--;)i=e.times(e),e=e.times(o.plus(i.times(s.times(i).minus(a))));return e}function He(r,e,t,n,i){var o,s,a,u,c=1,l=r.precision,m=Math.ceil(l/A);for(P=!1,u=t.times(t),a=new r(n);;){if(s=D(a.times(u),new r(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=D(s.times(u),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,c++}return P=!0,s.d.length=m+1,s}function bt(r,e){for(var t=r;--e;)t*=r;return t}function fn(r,e){var t,n=e.s<0,i=ye(r,r.precision,1),o=i.times(.5);if(e=e.abs(),e.lte(o))return Ne=n?4:1,e;if(t=e.divToInt(i),t.isZero())Ne=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(o))return Ne=en(t)?n?2:3:n?4:1,e;Ne=en(t)?n?1:4:n?3:2}return e.minus(i).abs()}function Lt(r,e,t,n){var i,o,s,a,u,c,l,m,d,f=r.constructor,b=t!==void 0;if(b?(ce(t,1,_e),n===void 0?n=f.rounding:ce(n,0,8)):(t=f.precision,n=f.rounding),!r.isFinite())l=dn(r);else{for(l=Ae(r),s=l.indexOf("."),b?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new f(1),d.e=l.length-s,d.d=mt(Ae(d),10,i),d.e=d.d.length),m=mt(l,10,i),o=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=b?"0p+0":"0";else{if(s<0?o--:(r=new f(r),r.d=m,r.e=o,r=D(r,d,t,n,0,i),m=r.d,o=r.e,c=rn),s=m[t],a=i/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,c)for(;++m[--t]>i-1;)m[t]=0,t||(++o,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=Bt.charAt(m[s]);if(b){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=mt(l,i,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=Bt.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>u)for(o-=u;o--;)l+="0";else o<u&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function tn(r,e){if(r.length>e)return r.length=e,!0}function nr(r){return new this(r).abs()}function rr(r){return new this(r).acos()}function ir(r){return new this(r).acosh()}function or(r,e){return new this(r).plus(e)}function sr(r){return new this(r).asin()}function ar(r){return new this(r).asinh()}function ur(r){return new this(r).atan()}function cr(r){return new this(r).atanh()}function lr(r,e){r=new this(r),e=new this(e);var t,n=this.precision,i=this.rounding,o=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=ye(this,o,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?ye(this,n,i):new this(0),t.s=r.s):!r.d||e.isZero()?(t=ye(this,o,1).times(.5),t.s=r.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(D(r,e,o,1)),e=ye(this,o,1),this.precision=n,this.rounding=i,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(D(r,e,o,1)),t}function mr(r){return new this(r).cbrt()}function dr(r){return w(r=new this(r),r.e+1,2)}function fr(r,e,t){return new this(r).clamp(e,t)}function pr(r){if(!r||typeof r!="object")throw Error(gt+"Object expected");var e,t,n,i=r.defaults===!0,o=["precision",1,_e,"rounding",0,8,"toExpNeg",-ze,0,"toExpPos",0,ze,"maxE",0,ze,"minE",-ze,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],i&&(this[t]=It[t]),(n=r[t])!==void 0)if(ie(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(Me+t+": "+n);if(t="crypto",i&&(this[t]=It[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(sn);else this[t]=!1;else throw Error(Me+t+": "+n);return this}function gr(r){return new this(r).cos()}function hr(r){return new this(r).cosh()}function pn(r){var e,t,n;function i(o){var s,a,u,c=this;if(!(c instanceof i))return new i(o);if(c.constructor=i,nn(o)){c.s=o.s,P?!o.d||o.e>i.maxE?(c.e=NaN,c.d=null):o.e<i.minE?(c.e=0,c.d=[0]):(c.e=o.e,c.d=o.d.slice()):(c.e=o.e,c.d=o.d?o.d.slice():o.d);return}if(u=typeof o,u==="number"){if(o===0){c.s=1/o<0?-1:1,c.e=0,c.d=[0];return}if(o<0?(o=-o,c.s=-1):c.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;P?s>i.maxE?(c.e=NaN,c.d=null):s<i.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[o]):(c.e=s,c.d=[o]);return}else if(o*0!==0){o||(c.s=NaN),c.e=NaN,c.d=null;return}return Ct(c,o.toString())}else if(u!=="string")throw Error(Me+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),c.s=-1):(a===43&&(o=o.slice(1)),c.s=1),un.test(o)?Ct(c,o):er(c,o)}if(i.prototype=p,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=pr,i.clone=pn,i.isDecimal=nn,i.abs=nr,i.acos=rr,i.acosh=ir,i.add=or,i.asin=sr,i.asinh=ar,i.atan=ur,i.atanh=cr,i.atan2=lr,i.cbrt=mr,i.ceil=dr,i.clamp=fr,i.cos=gr,i.cosh=hr,i.div=br,i.exp=yr,i.floor=wr,i.hypot=Tr,i.ln=xr,i.log=Ar,i.log10=Pr,i.log2=kr,i.max=Br,i.min=Ir,i.mod=Nr,i.mul=Sr,i.pow=Cr,i.random=Lr,i.round=Er,i.sign=Rr,i.sin=Fr,i.sinh=Mr,i.sqrt=_r,i.sub=Or,i.sum=Dr,i.tan=vr,i.tanh=Kr,i.trunc=qr,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return i.config(r),i}function br(r,e){return new this(r).div(e)}function yr(r){return new this(r).exp()}function wr(r){return w(r=new this(r),r.e+1,3)}function Tr(){var r,e,t=new this(0);for(P=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return P=!0,new this(1/0);t=e}return P=!0,t.sqrt()}function nn(r){return r instanceof Je||r&&r.toStringTag===an||!1}function xr(r){return new this(r).ln()}function Ar(r,e){return new this(r).log(e)}function kr(r){return new this(r).log(2)}function Pr(r){return new this(r).log(10)}function Br(){return mn(this,arguments,"lt")}function Ir(){return mn(this,arguments,"gt")}function Nr(r,e){return new this(r).mod(e)}function Sr(r,e){return new this(r).mul(e)}function Cr(r,e){return new this(r).pow(e)}function Lr(r){var e,t,n,i,o=0,s=new this(1),a=[];if(r===void 0?r=this.precision:ce(r,1,_e),n=Math.ceil(r/A),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)i=e[o],i>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)i=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(i%1e7),o+=4);o=n/4}else throw Error(sn);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],r%=A,n&&r&&(i=Q(10,A-r),a[o]=(n/i|0)*i);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=A)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<A&&(t-=A-n)}return s.e=t,s.d=a,s}function Er(r){return w(r=new this(r),r.e+1,this.rounding)}function Rr(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function Fr(r){return new this(r).sin()}function Mr(r){return new this(r).sinh()}function _r(r){return new this(r).sqrt()}function Or(r,e){return new this(r).sub(e)}function Dr(){var r=0,e=arguments,t=new this(e[r]);for(P=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return P=!0,w(t,this.precision,this.rounding)}function vr(r){return new this(r).tan()}function Kr(r){return new this(r).tanh()}function qr(r){return w(r=new this(r),r.e+1,1)}p[Symbol.for("nodejs.util.inspect.custom")]=p.toString;p[Symbol.toStringTag]="Decimal";var Je=p.constructor=pn(It);dt=new Je(dt);ft=new Je(ft);var k=Je;import ke from"bn.js";var Y=new ke(0),Pe=new ke(1),Se=new ke(-1),de=new ke(1).shln(64),yt=new ke(1).shln(128),Et=de.sub(Pe),$e=64,gn=yt.subn(1),oe=-443636,ae=-oe,Ye=new ke("4295048016"),Ze=new ke("79226673521066979257578248091"),hn=16,bn="59543866431248",yn="184467440737095516",wn="15793534762490258745",wt=new ke(10).pow(new ke(6));var Mi=new ke("18446744073700000000");import{get as Tn,set as Gr}from"lodash";import An from"dayjs";import Vr from"dayjs/plugin/utc";An.extend(Vr);var Rt=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return An().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},xn={},Ur={};function fe(r){let e=Tn(xn,r);if(!e){let t=Tn(Ur,r);e=new Rt({name:r,logLevel:t}),Gr(xn,r,e)}return e}import{PublicKey as Rs}from"@solana/web3.js";import Ms from"bn.js";import ii from"big.js";import kt from"bn.js";import le from"bn.js";import{PublicKey as Ot}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Wr}from"@solana/spl-token";import{PublicKey as U,SystemProgram as Pn,SYSVAR_RENT_PUBKEY as Xr}from"@solana/web3.js";function Ft({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var Ui=[Ft({pubkey:Wr,isWritable:!1}),Ft({pubkey:Pn.programId,isWritable:!1}),Ft({pubkey:Xr,isWritable:!1})];function Mt({publicKey:r,transformSol:e}){let t=Bn(r.toString());if(t instanceof U)return e&&t.equals(et)?kn:t;if(e&&t.toString()===et.toBase58())return kn;if(typeof t=="string"){if(t===U.default.toBase58())return U.default;try{return new U(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Bn(r){try{return new U(r)}catch{return r}}var Wi=new U("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Xi=new U("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),zi=new U("SysvarRent111111111111111111111111111111111"),Hi=new U("SysvarC1ock11111111111111111111111111111111"),zr=new U("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Yi=new U("Sysvar1nstructions1111111111111111111111111"),Zi=Pn.programId,ji=new U("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Qi=new U("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Ji=new U("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),$i=new U("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),eo=new U("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),to=new U("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),no=new U("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ro=new U("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),io=new U("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),oo=new U("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),so=new U("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),kn=new U("So11111111111111111111111111111111111111112"),et=U.default;function _t(r){return Mt({publicKey:r,transformSol:!0})}import{PublicKey as Hr}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as In}from"@solana/spl-token";var Nn={chainId:101,address:Hr.default.toBase58(),programId:In.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Ke={chainId:101,address:"So11111111111111111111111111111111111111112",programId:In.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var Dt=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:o=!1,isToken2022:s=!1}){if(e===et.toBase58()||e instanceof Ot&&et.equals(e)){this.decimals=Ke.decimals,this.symbol=Ke.symbol,this.name=Ke.name,this.mint=new Ot(Ke.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=o?Ot.default:Mt({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ce=Dt;Ce.WSOL=new Dt({...Ke,mint:Ke.address});import xt from"big.js";import jr from"bn.js";import Qr from"decimal.js-light";import Yr from"toformat";var Zr=Yr,tt=Zr;var Tt=fe("module/fraction"),vt=tt(xt),nt=tt(Qr),Jr={[0]:nt.ROUND_DOWN,[1]:nt.ROUND_HALF_UP,[2]:nt.ROUND_UP},$r={[0]:xt.roundDown,[1]:xt.roundHalfUp,[2]:xt.roundUp},_=class{constructor(e,t=new jr(1)){this.numerator=ge(e),this.denominator=ge(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new _(this.denominator,this.numerator)}add(e){let t=e instanceof _?e:new _(ge(e));return this.denominator.eq(t.denominator)?new _(this.numerator.add(t.numerator),this.denominator):new _(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof _?e:new _(ge(e));return this.denominator.eq(t.denominator)?new _(this.numerator.sub(t.numerator),this.denominator):new _(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof _?e:new _(ge(e));return new _(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof _?e:new _(ge(e));return new _(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Tt.logWithError(`${e} is not an integer.`),e<=0&&Tt.logWithError(`${e} is not positive.`),nt.set({precision:e+1,rounding:Jr[n]});let i=new nt(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Tt.logWithError(`${e} is not an integer.`),e<0&&Tt.logWithError(`${e} is negative.`),vt.DP=e,vt.RM=$r[n]||1,new vt(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var ti=fe("Raydium_price"),Te=class extends _{constructor(t){let{baseToken:n,quoteToken:i,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=i,this.scalar=new _(Kt(n.decimals),Kt(i.decimals))}get raw(){return new _(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Te({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&ti.logWithError("mul token not equals");let n=super.mul(t);return new Te({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};var qt=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},At=qt;At.SOL=new qt(Nn);import ni from"bn.js";var Sn=new _(new ni(100)),qe=class extends _{toSignificant(e=5,t,n){return this.mul(Sn).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Sn).toFixed(e,t,n)}};var ri=new le(0),rs=new le(1),is=new le(2),os=new le(3),ss=new le(5),Gt=new le(10),as=new le(100),us=new le(1e3),cs=new le(1e4),Cn=9007199254740991;function ge(r){let e=fe("Raydium_parseBigNumberish");if(r instanceof le)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new le(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=Cn||r<=-Cn)&&e.logWithError(`BigNumberish number overflow: ${r}`),new le(String(r))):typeof r=="bigint"?new le(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new le(0))}function Kt(r){return Gt.pow(ge(r))}var oi=fe("Raydium_amount"),Ln=tt(ii);function si(r,e){let t="0",n="0";if(r.includes(".")){let i=r.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):oi.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var se=class extends _{constructor(t,n,i=!0,o){let s=new kt(0),a=Gt.pow(new kt(t.decimals));if(i)s=ge(n);else{let u=new kt(0),c=new kt(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=si(n.toString(),t.decimals);u=ge(l),c=ge(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=fe(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new se(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new se(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Ln.DP=this.token.decimals,new Ln(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Ba,sendAndConfirmTransaction as Ia,Transaction as Sa,TransactionMessage as La,VersionedTransaction as Ea}from"@solana/web3.js";import Fa from"axios";import{PublicKey as ai,ComputeBudgetProgram as Vs,Transaction as Ws,TransactionMessage as zs,Keypair as Hs,VersionedTransaction as Zs}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Qs}from"@solana/spl-token";var ea=fe("Raydium_txUtil");function rt(r,e){let[t,n]=ai.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}import{PublicKey as ci,AddressLookupTableAccount as En}from"@solana/web3.js";import{PublicKey as ui}from"@solana/web3.js";import{getTransferFeeConfig as aa,unpackMint as ua}from"@solana/spl-token";var Vt=fe("Raydium_accountInfo_util");async function Ge(r,e,t){let{batchRequest:n,commitment:i="confirmed"}={batchRequest:!1,...t},o=Ut(e,100),s=new Array(o.length).fill([]);if(n){let a=o.map(l=>{let m=r._buildArgs([l.map(d=>d.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=Ut(a,10);s=(await(await Promise.all(u.map(async l=>await r._rpcBatchRequest(l)))).flat()).map(l=>(l.error&&Vt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${l.error.message}`),l.result.value.map(m=>{if(m){let{data:d,executable:f,lamports:b,owner:g,rentEpoch:h}=m;return d.length!==2&&d[1]!=="base64"&&Vt.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(d[0],"base64"),executable:f,lamports:b,owner:new ui(g),rentEpoch:h}}return null})))}else try{s=await Promise.all(o.map(a=>r.getMultipleAccountsInfo(a,i)))}catch(a){a instanceof Error&&Vt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return s.flat()}async function Wt(r,e,t){let n=await Ge(r,e.map(i=>i.pubkey),t);return e.map((i,o)=>({...i,accountInfo:n[o]}))}var li={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new En({key:new ci("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:En.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};function Ut(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as Z}from"@solana/web3.js";var Ua=new Z("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Wa=new Z("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Xa=new Z("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),za=new Z("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Ha=new Z("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Ya=new Z("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Za=new Z("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),ja=new Z("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),Qa=new Z("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Ja=new Z("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),$a=new Z("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),eu=new Z("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),tu=new Z("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),nu=new Z("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),ru=new Z("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),iu=new Z("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),ou=new Z("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),su=new Z("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),au=new Z("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),uu=new Z("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2");import{PublicKey as mu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as pu}from"@solana/spl-token";import xe from"bn.js";var it=1e4;function J(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},o=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new xe(o.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===it){let u=new xe(o.maximumFee.toString());return{amount:r.add(u),fee:u,expirationTime:a}}else{let u=Xt(r.mul(new xe(it)),new xe(it-o.transferFeeBasisPoints)),c=new xe(o.maximumFee.toString()),l=u.sub(r).gt(c)?r.add(c):u,m=Xt(l.mul(new xe(o.transferFeeBasisPoints)),new xe(it)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let u=Xt(r.mul(new xe(o.transferFeeBasisPoints)),new xe(it)),c=u.gt(s)?s:u;return{amount:r,fee:c,expirationTime:a}}}function Ve(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function Xt(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new xe(0))?t.add(new xe(1)):t}function Rn(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function zt(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function Ht(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function ot(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Fn(r,e){return ot(r,e)?null:zt(r,e)}function Mn(r,e){return ot(r,e)?null:Ht(r,e)}var Ku=Buffer.from("amm_config","utf8"),qu=Buffer.from("pool","utf8"),Gu=Buffer.from("pool_vault","utf8"),Vu=Buffer.from("pool_reward_vault","utf8"),mi=Buffer.from("position","utf8"),di=Buffer.from("tick_array","utf8"),Uu=Buffer.from("operation","utf8"),fi=Buffer.from("pool_tick_array_bitmap_extension","utf8");function ue(r,e,t){return rt([di,e.toBuffer(),Rn(t)],r)}function _n(r,e){return rt([mi,e.toBuffer()],r)}function On(r,e){return rt([fi,e.toBuffer()],r)}import{PublicKey as De}from"@solana/web3.js";import H from"bn.js";import Li from"bn.js";import{PublicKey as Ai}from"@solana/web3.js";import qn,{isBN as Gn}from"bn.js";import{bits as zu,BitStructure as Hu,blob as pi,Blob as Yu,cstr as Zu,f32 as ju,f32be as Qu,f64 as Ju,f64be as $u,greedy as ec,Layout as gi,ns64 as tc,ns64be as nc,nu64 as rc,nu64be as ic,offset as oc,s16 as sc,s16be as ac,s24 as uc,s24be as cc,s32 as hi,s32be as lc,s40 as mc,s40be as dc,s48 as fc,s48be as pc,s8 as gc,seq as bi,struct as hc,Structure as yi,u16 as wi,u16be as bc,u24 as yc,u24be as wc,u32 as Tc,u32be as xc,u40 as Ac,u40be as kc,u48 as Pc,u48be as Bc,u8 as Ti,UInt as xi,union as Ic,Union as Nc,unionLayoutDiscriminator as Sc,utf8 as Cc}from"@solana/buffer-layout";var Yt=gi,Dn=yi;var Zt=xi;var vn=Ti,je=wi;var Oe=hi;var Kn=bi;var he=pi;var st=class extends Yt{constructor(t,n,i){super(t,i);this.blob=he(t),this.signed=n}decode(t,n=0){let i=new qn(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new qn(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}};function be(r){return new Zt(1,r)}function at(r){return new Zt(4,r)}function v(r){return new st(8,!1,r)}function K(r){return new st(16,!1,r)}function Vn(r){return new st(16,!0,r)}var Pt=class extends Yt{constructor(t,n,i,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function $(r){return new Pt(he(32),e=>new Ai(e),e=>e.toBuffer(),r)}function Un(r){return new Pt(vn(),ki,Pi,r)}function ki(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function Pi(r){return r?1:0}var jt=class extends Dn{decode(e,t){return super.decode(e,t)}};function pe(r,e,t){return new jt(r,e,t)}function X(r,e,t){let n,i=typeof e=="number"?e:Gn(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=Gn(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return Kn(r,i,t)}var Qt=14,Le=class{static maxTickInTickarrayBitmap(e){return e*ee*Ue}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let o=n*i;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!F.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=i?t-F.tickCount(n):t+F.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*ee,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(i){let l=e.shln(1024-c-1),m=Fn(1024,l);if(m!==null){let d=(c-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(c),m=Mn(1024,l);if(m!==null){let d=(c+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-F.tickCount(n)}}}},ut=class{static getBitmapOffset(e,t){if(!F.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Le.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Le.maxTickInTickarrayBitmap(e),n=-t;if(ae<=t)throw Error(`extensionTickBoundary check error: ${ae}, ${t}`);if(n<=oe)throw Error(`extensionTickBoundary check error: ${n}, ${oe}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:I.mergeTickArrayBitmap(i).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let o=F.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:o,maxValue:s}=Le.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let u=I.mergeTickArrayBitmap(e).shln(Ue-1-a),c=ot(512,u)?null:zt(512,u);if(c!==null){let l=t-c*F.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let u=I.mergeTickArrayBitmap(e).shrn(a),c=ot(512,u)?null:Ht(512,u);if(c!==null){let l=t+c*F.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-F.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Le.maxTickInTickarrayBitmap(t),i=Math.floor(n/F.tickCount(t));return e<0&&n!=0&&(i=Ue-i),i}};var jc=pe([he(8),be("bump"),je("index"),$(""),at("protocolFeeRate"),at("tradeFeeRate"),je("tickSpacing"),X(v(),8,"")]),Bi=pe([at("blockTimestamp"),K("sqrtPriceX64"),K("cumulativeTimePriceX64"),X(K(),1,"")]),Qc=pe([he(8),Un("initialized"),$("poolId"),X(Bi,1e3,"observations"),X(K(),5,"")]),Ii=pe([be("rewardState"),v("openTime"),v("endTime"),v("lastUpdateTime"),K("emissionsPerSecondX64"),v("rewardTotalEmissioned"),v("rewardClaimed"),$("tokenMint"),$("tokenVault"),$("creator"),K("rewardGrowthGlobalX64")]),Wn=pe([he(8),be("bump"),$("ammConfig"),$("creator"),$("mintA"),$("mintB"),$("vaultA"),$("vaultB"),$("observationId"),be("mintDecimalsA"),be("mintDecimalsB"),je("tickSpacing"),K("liquidity"),K("sqrtPriceX64"),Oe("tickCurrent"),je("observationIndex"),je("observationUpdateDuration"),K("feeGrowthGlobalX64A"),K("feeGrowthGlobalX64B"),v("protocolFeesTokenA"),v("protocolFeesTokenB"),K("swapInAmountTokenA"),K("swapOutAmountTokenB"),K("swapInAmountTokenB"),K("swapOutAmountTokenA"),be("status"),X(be(),7,""),X(Ii,3,"rewardInfos"),X(v(),16,"tickArrayBitmap"),v("totalFeesTokenA"),v("totalFeesClaimedTokenA"),v("totalFeesTokenB"),v("totalFeesClaimedTokenB"),v("fundFeesTokenA"),v("fundFeesTokenB"),v("startTime"),X(v(),15*4-3,"padding")]),Ni=pe([K("growthInsideLastX64"),v("rewardAmountOwed")]),Xn=pe([he(8),be("bump"),$("nftMint"),$("poolId"),Oe("tickLower"),Oe("tickUpper"),K("liquidity"),K("feeGrowthInsideLastX64A"),K("feeGrowthInsideLastX64B"),v("tokenFeesOwedA"),v("tokenFeesOwedB"),X(Ni,3,"rewardInfos"),X(v(),8,"")]),Jc=pe([he(8),be("bump"),$("poolId"),Oe("tickLowerIndex"),Oe("tickUpperIndex"),K("liquidity"),K("feeGrowthInsideLastX64A"),K("feeGrowthInsideLastX64B"),v("tokenFeesOwedA"),v("tokenFeesOwedB"),X(K(),3,"rewardGrowthInside"),X(v(),8,"")]),Si=pe([Oe("tick"),Vn("liquidityNet"),K("liquidityGross"),K("feeGrowthOutsideX64A"),K("feeGrowthOutsideX64B"),X(K(),3,"rewardGrowthsOutsideX64"),X(at(),13,"")]),ct=pe([he(8),$("poolId"),Oe("startTickIndex"),X(Si,ee,"ticks"),be("initializedTickCount"),X(be(),115,"")]),$c=pe([he(329),X($(),100,"whitelistMints")]),zn=pe([he(8),$("poolId"),X(X(v(),8),Qt,"positiveTickArrayBitmap"),X(X(v(),8),Qt,"negativeTickArrayBitmap")]);var Ci=15,F=class{static async getTickArrays(e,t,n,i,o,s,a){let u=[],c=I.getTickArrayStartIndexByTick(i,o),l=I.getInitializedTickArrayInRange(s,a,o,c,Math.floor(Ci/2));for(let f=0;f<l.length;f++){let{publicKey:b}=ue(t,n,l[f]);u.push(b)}let m=(await Ge(e,u)).map(f=>f!==null?ct.decode(f.data):null),d={};for(let f=0;f<u.length;f++){let b=m[f];b!==null&&(d[b.startTickIndex]={...b,address:u[f]})}return d}static nextInitializedTick(e,t,n,i,o,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,i,o,s);for(;a==null||a.liquidityGross.lten(0);){if(c=I.getNextTickArrayStartIndex(c,o,s),this.checkIsValidStartIndex(c,o))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:f}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,d,f]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,i,o){let s=Math.floor(e/F.tickCount(t)),a=n?I.searchLowBitFromStart(i,o,s-1,1,t):I.searchHightBitFromStart(i,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let o;if(i){let a=ee-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a-1}}else{let a=0;for(;a<ee;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a+1}}let{publicKey:s}=ue(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,o,s){let a=I.getTickArrayStartIndexByTick(i,o),u=Math.floor((i-a)/o),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u-1}else for(u=u+1;u<ee;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u+1}let{publicKey:m}=ue(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(I.checkIsOutOfBoundary(e)){if(e>ae)return!1;let n=I.getTickArrayStartIndexByTick(oe,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return ee*e}};var ee=60,Ue=512,I=class{static getTickArrayAddressByTick(e,t,n,i){let o=I.getTickArrayStartIndexByTick(n,i),{publicKey:s}=ue(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=I.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=ee)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=F.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*F.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*ee,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*ee,o=Math.floor(t/i)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*ee:e+t*ee}static mergeTickArrayBitmap(e){let t=new Li(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,o){let s=Math.floor(i/(n*ee));return[...I.searchLowBitFromStart(e,t,s-1,o,n),...I.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return I.searchHightBitFromStart(e,t,0,Ue,n)}static getAllInitializedTickArrayInfo(e,t,n,i,o){let s=[],a=I.getAllInitializedTickArrayStartIndex(n,i,o);for(let u of a){let{publicKey:c}=ue(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>I.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===i)break}let u=F.tickCount(o);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>I.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===i)break}let u=F.tickCount(o);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<oe||e>ae}static nextInitTick(e,t,n,i,o){if(F.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<ee;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=ee-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<ee;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=N.getSqrtPriceX64FromTick(t),o=N.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new k(1).div(o),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new k(1).div(t),o=We.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=N.getSqrtPriceX64FromTick(o),a=N.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new k(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=N.getSqrtPriceX64FromTick(t),o=N.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new k(1).div(o),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new k(1).div(t),o=We.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=N.getSqrtPriceX64FromTick(o),a=N.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new k(1).div(a)}}};import Be from"bn.js";var lt=class{static getfeeGrowthInside(e,t,n){let i=new Be(0),o=new Be(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Be(0),a=new Be(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=S.wrappingSubU128(S.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),c=S.wrappingSubU128(S.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=S.mulDivFloor(S.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,de),u=t.tokenFeesOwedA.add(a),c=S.mulDivFloor(S.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,de),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=S.mulDivFloor(S.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,de),u=t.tokenFeesOwedA.add(a),c=S.mulDivFloor(S.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,de),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=S.wrappingSubU128(u,c.growthInsideLastX64),m=S.mulDivFloor(l,t.liquidity,de),d=c.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,i){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=S.wrappingSubU128(u,c.growthInsideLastX64),m=S.mulDivFloor(l,t.liquidity,de),d=c.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new Be(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Be(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(S.wrappingSubU128(S.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return o}static getRewardGrowthInsideV2(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new Be(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Be(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(S.wrappingSubU128(S.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:o,epochInfo:s}){var h,y,B,T;let a=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),u=N.getSqrtPriceX64FromTick(t.tickLower),c=N.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+i:1-i,m=M.getAmountsFromLiquidity(a,u,c,n,o),[d,f]=[J(m.amountA,(h=e.mintA.extensions)==null?void 0:h.feeConfig,s,!0),J(m.amountB,(y=e.mintB.extensions)==null?void 0:y.feeConfig,s,!0)],[b,g]=[J(new Be(new k(m.amountA.toString()).mul(l).toFixed(0)),(B=e.mintA.extensions)==null?void 0:B.feeConfig,s,!0),J(new Be(new k(m.amountB.toString()).mul(l).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Ve(d.expirationTime,f.expirationTime)}}};import{TOKEN_2022_PROGRAM_ID as Hn}from"@solana/spl-token";var Ie=class{static getOutputAmountAndRemainAccounts(e,t,n,i,o){let s=n.toBase58()===e.mintA.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:f,feeAmount:b}=Xe.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,c,o);return a.push(...d),{expectedAmountOut:m.mul(Se),remainingAccounts:a,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,o){let s=n.toBase58()===e.mintB.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let g=this.preInitializedTickArrayStartIndex(e,s);if(g.isExist){let{publicKey:h}=ue(e.programId,e.id,g.nextStartIndex);a.push(h)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:f,feeAmount:b}=Xe.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(Se),c,o);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:f,feeAmount:b}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Ie.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?ut.checkTickArrayIsInit(F.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):I.checkTickArrayIsInitialized(I.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ue(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,F.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=ue(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/F.tickCount(e.tickSpacing)),i=t?I.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):I.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=F.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:o}=Le.nextInitializedTickArrayStartIndex(I.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=ut.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<oe||t>ae)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:o}){var a,u,c;let s=[];for(let l=0;l<o.length;l++){let m=o[l],d=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(d===void 0)throw Error("get new reward mint info error");let f={...m,perSecond:S.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new De(d)};if(f.tokenMint.equals(De.default))continue;if(n<=f.openTime.toNumber()||i.eq(Y)){s.push(f);continue}let b=new H(Math.min(f.endTime.toNumber(),n)),g=b.sub(f.lastUpdateTime),h=S.mulDivFloor(g,f.emissionsPerSecondX64,i),y=f.rewardGrowthGlobalX64.add(h),B=S.mulDivFloor(g,f.emissionsPerSecondX64,de),T=f.rewardTotalEmissioned.add(B);s.push({...f,rewardGrowthGlobalX64:y,rewardTotalEmissioned:T,lastUpdateTime:b})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let o of t){let s=I.getTickArrayStartIndexByTick(o,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=Le.maxTickInTickarrayBitmap(e),n=-t;return t>ae&&(t=F.getArrayStartIndex(ae,e)+F.tickCount(e)),n<oe&&(n=F.getArrayStartIndex(oe,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!F.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/F.tickCount(t)*Ue}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Wt(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of i)s.accountInfo!==null&&(o[s.pubkey.toString()]=zn.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},o=[];for(let u of t){let c=I.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=I.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:d}=ue(u.programId,u.id,m);o.push({pubkey:d}),i[d.toString()]=u.id}}let s=await Wt(e,o,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=i[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=ct.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]={...l,address:u.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of u)for(let f of s)c.push(_n(f,d).publicKey);let l=await Ge(t,c,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let f=Xn.decode(d.data),b=f.poolId.toString(),g=e.find(W=>W.state.id.toBase58()===b);if(g===void 0)continue;let h=g.state,y=I._getTickPriceLegacy({poolInfo:h,tick:f.tickLower,baseIn:!0}),B=I._getTickPriceLegacy({poolInfo:h,tick:f.tickUpper,baseIn:!0}),{amountA:T,amountB:R}=M.getAmountsFromLiquidity(h.sqrtPriceX64,y.tickSqrtPriceX64,B.tickSqrtPriceX64,f.liquidity,!1),x=1/(1-Math.sqrt(Math.sqrt(y.price.div(B.price).toNumber())));g.positionAccount=[...(a=g.positionAccount)!=null?a:[],{poolId:f.poolId,nftMint:f.nftMint,priceLower:y.price,priceUpper:B.price,amountA:T,amountB:R,tickLower:f.tickLower,tickUpper:f.tickUpper,liquidity:f.liquidity,feeGrowthInsideLastX64A:f.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:f.feeGrowthInsideLastX64B,tokenFeesOwedA:f.tokenFeesOwedA,tokenFeesOwedB:f.tokenFeesOwedB,rewardInfos:f.rewardInfos.map(W=>({...W,pendingReward:new H(0)})),leverage:x,tokenFeeAmountA:new H(0),tokenFeeAmountB:new H(0)}];let q=await I.getTickArrayAddressByTick(g.state.programId,f.poolId,f.tickLower,g.state.tickSpacing),V=await I.getTickArrayAddressByTick(g.state.programId,f.poolId,f.tickUpper,g.state.tickSpacing);m[`${g.state.programId.toString()}-${f.poolId.toString()}-${f.tickLower}`]=q,m[`${g.state.programId.toString()}-${f.poolId.toString()}-${f.tickUpper}`]=V}if(o){let d=Object.values(m),f=await Ge(t,d,{batchRequest:i}),b={};for(let g=0;g<d.length;g++){let h=f[g];if(h===null)continue;let y=d[g].toString();b[y]=ct.decode(h.data)}for(let{state:g,positionAccount:h}of e)if(!!h)for(let y of h){let B=`${g.programId.toString()}-${g.id.toString()}-${y.tickLower}`,T=`${g.programId.toString()}-${g.id.toString()}-${y.tickUpper}`,R=b[m[B].toString()],x=b[m[T].toString()],q=R.ticks[I.getTickOffsetInArray(y.tickLower,g.tickSpacing)],V=x.ticks[I.getTickOffsetInArray(y.tickUpper,g.tickSpacing)],{tokenFeeAmountA:W,tokenFeeAmountB:ne}=await lt.GetPositionFees(g,y,q,V),G=await lt.GetPositionRewards(g,y,q,V);y.tokenFeeAmountA=W.gte(new H(0))?W:new H(0),y.tokenFeeAmountB=ne.gte(new H(0))?ne:new H(0);for(let z=0;z<G.length;z++)y.rewardInfos[z].pendingReward=G[z].gte(new H(0))?G[z]:new H(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:o,slippage:s,priceLimit:a=new k(0)}){var G;let u,c=n.toBase58()===e.mintA.address,[l,m]=c?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new k(0))?u=c?Ye.add(new H(1)):Ze.sub(new H(1)):u=N.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let d=J(o,l,i,!1),{expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:h}=Ie.getOutputAmountAndRemainAccounts(e,t,n,d.amount.sub((G=d.fee)!=null?G:Y),u),y=J(f,m,i,!1),B=N.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),T=c?B:new k(1).div(B),R=f.mul(new H(Math.floor((1-s)*1e10))).div(new H(1e10)),x=J(R,m,i,!1),q=c?e.currentPrice:new k(1).div(e.currentPrice),V=new k(T).sub(q).abs(),W=q,ne=new qe(new k(V).mul(10**15).toFixed(0),new k(W).mul(10**15).toFixed(0));return{realAmountIn:d,amountOut:y,minAmountOut:x,expirationTime:Ve(d.expirationTime,y.expirationTime),currentPrice:e.currentPrice,executionPrice:T,priceImpact:ne,fee:h,remainingAccounts:b}}static async computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:o,epochInfo:s}){let a=i.address===e.mintB.address,[u,c]=a?[e.mintA,e.mintB]:[e.mintB,e.mintA],[l,m]=[new Ce({...u,mint:u.address,isToken2022:u.programId===Hn.toBase58()}),new Ce({...c,mint:c.address,isToken2022:c.programId===Hn.toBase58()})],{realAmountIn:d,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:h,executionPrice:y,priceImpact:B,fee:T,remainingAccounts:R}=await Ie.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new De(u.address),amountIn:n,slippage:o,epochInfo:s}),x={...d,amount:new se(l,d.amount),fee:d.fee===void 0?void 0:new se(l,d.fee)},q={...f,amount:new se(m,f.amount),fee:f.fee===void 0?void 0:new se(m,f.fee)},V={...b,amount:new se(m,b.amount),fee:b.fee===void 0?void 0:new se(m,b.fee)},W=new Te({baseToken:l,denominator:new H(10).pow(new H(20+l.decimals)),quoteToken:m,numerator:h.mul(new k(10**(20+m.decimals))).toFixed(0)}),ne=new Te({baseToken:l,denominator:new H(10).pow(new H(20+l.decimals)),quoteToken:m,numerator:y.mul(new k(10**(20+m.decimals))).toFixed(0)}),G=new se(l,T);return{realAmountIn:x,amountOut:q,minAmountOut:V,expirationTime:g,currentPrice:W,executionPrice:ne,priceImpact:B,fee:G,remainingAccounts:R}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var b,g,h;let o=e[t],s=I.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=I.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-u,m=a-s,d=o.priceMax-o.priceMin,f;return l<=0?f=0:m===l?f=d/l:d===l?f=l/m:f=l/d*(l/m),{feeApr:o.feeApr*f,rewardsApr:[(b=o.rewardApr[0])!=null?b:0*f,(g=o.rewardApr[1])!=null?g:0*f,(h=o.rewardApr[2])!=null?h:0*f],apr:o.apr*f}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[_t(e.mintA.address).toString()],d=i[_t(e.mintB.address).toString()],f=e.mintA.decimals,b=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let g=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),h=N.getSqrtPriceX64FromTick(s),y=N.getSqrtPriceX64FromTick(a),{amountSlippageA:B,amountSlippageB:T}=M.getAmountsFromLiquidityWithSlippage(g,h,y,t,!1,!1,0),{amountSlippageA:R,amountSlippageB:x}=M.getAmountsFromLiquidityWithSlippage(g,h,y,o,!1,!1,0),q=new k(B.toString()).div(new k(10).pow(f)).mul(m.value).add(new k(T.toString()).div(new k(10).pow(b)).mul(d.value)),V=new k(R.toString()).div(new k(10).pow(f)).mul(m.value).add(new k(x.toString()).div(new k(10).pow(b)).mul(d.value)),W=V.div(q.add(V)).div(V),G=new k(l.volumeFee).mul(365).div(c).mul(W).mul(100).toNumber(),z=3600*24*365,ve=e.rewardDefaultInfos.map(me=>{var O,$t;let Ee=me.mint.decimals,j=i[me.mint.address];return u<((O=me.startTime)!=null?O:0)||u>(($t=me.endTime)!=null?$t:0)||!me.perSecond||!j||Ee===void 0?0:new k(j.value).mul(new k(me.perSecond).mul(z)).div(new k(10).pow(Ee)).mul(W).mul(100).toNumber()});return{feeApr:G,rewardsApr:ve,apr:G+ve.reduce((me,Ee)=>me+Ee,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:o,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var y,B;let l=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),m=N.getSqrtPriceX64FromTick(n),d=N.getSqrtPriceX64FromTick(i),f=a?1-s:1+s,b=J(o,(y=e[t?"mintA":"mintB"].extensions)==null?void 0:y.feeConfig,u,!c),g=new H(new k(b.amount.sub((B=b.fee)!=null?B:Y).toString()).mul(f).toFixed(0)),h;if(l.lte(m))h=t?M.getLiquidityFromTokenAmountA(m,d,g,!a):new H(0);else if(l.lte(d)){let T=M.getLiquidityFromTokenAmountA(l,d,g,!a),R=M.getLiquidityFromTokenAmountB(m,l,g);h=t?T:R}else h=t?new H(0):M.getLiquidityFromTokenAmountB(m,d,g);return Ie.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:h,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:o,slippage:s,add:a}){var h,y,B,T;let u=N.getSqrtPriceX64FromTick(n),c=N.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=M.getAmountsFromLiquidity(N.priceToSqrtPriceX64(new k(t.price),t.mintA.decimals,t.mintB.decimals),u,c,o,a),[d,f]=[J(m.amountA,(h=t.mintA.extensions)==null?void 0:h.feeConfig,e,!0),J(m.amountB,(y=t.mintB.extensions)==null?void 0:y.feeConfig,e,!0)],[b,g]=[J(m.amountA.muln(l),(B=t.mintA.extensions)==null?void 0:B.feeConfig,e,!0),J(m.amountB.muln(l),(T=t.mintB.extensions)==null?void 0:T.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Ve(d.expirationTime,f.expirationTime)}}static async fetchComputeClmmInfo({owner:e,connection:t,poolInfo:n}){let i=await t.getAccountInfo(new De(n.id));if(!i)throw new Error(`pool not found ${n.id}`);let o=Wn.decode(i.data),s=On(e,new De(n.id)).publicKey,a=await Ie.fetchExBitmaps({connection:t,exBitmapAddress:[s],batchRequest:!1});return{...o,id:new De(n.id),programId:new De(n.programId),mintA:n.mintA,mintB:n.mintB,ammConfig:{...n.config,id:new De(n.config.id),fundOwner:""},currentPrice:new k(n.price),exBitmapInfo:a[s.toBase58()],startTime:o.startTime.toNumber()}}};var S=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),o=i.div(n);return i.mod(n).eq(Y)||(o=o.add(Pe)),o}static mulDivFloor(e,t,n){if(n.eq(Y))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(Y))throw new Error("division by 0");return e.mul(t).add(n.sub(Pe)).div(n)}static x64ToDecimal(e,t){return new k(e.toString()).div(k.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new C(e.mul(k.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(yt).sub(t).mod(yt)}};function te(r,e){return Jt(r.mul(e),64,256)}function Ei(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Jt(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var N=class{static sqrtPriceX64ToPrice(e,t,n){return S.x64ToDecimal(e).pow(2).mul(k.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return S.decimalToX64(e.mul(k.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(Y))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Y))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(Y))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Y))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(Y))return e;let o=t.shln($e);if(i){let s=o,a=o.add(n.mul(e));return a.gte(s)?S.mulDivCeil(s,e,a):S.mulDivRoundingUp(s,Pe,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return S.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let o=n.shln($e);if(i)return e.add(o.div(t));{let s=S.mulDivRoundingUp(o,Pe,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<oe||e>ae)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new C("18445821805675395072"):new C("18446744073709551616");return(t&2)!=0&&(n=te(n,new C("18444899583751176192"))),(t&4)!=0&&(n=te(n,new C("18443055278223355904"))),(t&8)!=0&&(n=te(n,new C("18439367220385607680"))),(t&16)!=0&&(n=te(n,new C("18431993317065453568"))),(t&32)!=0&&(n=te(n,new C("18417254355718170624"))),(t&64)!=0&&(n=te(n,new C("18387811781193609216"))),(t&128)!=0&&(n=te(n,new C("18329067761203558400"))),(t&256)!=0&&(n=te(n,new C("18212142134806163456"))),(t&512)!=0&&(n=te(n,new C("17980523815641700352"))),(t&1024)!=0&&(n=te(n,new C("17526086738831433728"))),(t&2048)!=0&&(n=te(n,new C("16651378430235570176"))),(t&4096)!=0&&(n=te(n,new C("15030750278694412288"))),(t&8192)!=0&&(n=te(n,new C("12247334978884435968"))),(t&16384)!=0&&(n=te(n,new C("8131365268886854656"))),(t&32768)!=0&&(n=te(n,new C("3584323654725218816"))),(t&65536)!=0&&(n=te(n,new C("696457651848324352"))),(t&131072)!=0&&(n=te(n,new C("26294789957507116"))),(t&262144)!=0&&(n=te(n,new C("37481735321082"))),e>0&&(n=gn.div(n)),n}static getTickFromPrice(e,t,n){return N.getTickFromSqrtPriceX64(N.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ze)||e.lt(Ye))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new C(t-64),i=Ei(n,32,128),o=new C("8000000000000000","hex"),s=0,a=new C(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new C(0))&&s<hn;){u=u.mul(u);let b=u.shrn(127);u=u.shrn(63+b.toNumber()),a=a.add(o.mul(b)),o=o.shrn(1),s+=1}let c=a.shrn(32),m=i.add(c).mul(new C(bn)),d=Jt(m.sub(new C(yn)),64,128).toNumber(),f=Jt(m.add(new C(wn)),64,128).toNumber();return d==f?d:N.getSqrtPriceX64FromTick(f).lte(e)?f:d}},We=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=N.getTickFromSqrtPriceX64(N.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let o=We.getTickWithPriceAndTickspacing(e,t,n,i),s=N.getSqrtPriceX64FromTick(o);return N.sqrtPriceX64ToPrice(s,n,i)}},M=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Y))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln($e),s=t.sub(e);return i?S.mulDivRoundingUp(S.mulDivCeil(o,s,t),Pe,e):S.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Y))throw new Error("sqrtPriceX64A must greater than 0");return i?S.mulDivCeil(n,t.sub(e),de):S.mulDivFloor(n,t.sub(e),de)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return i?S.mulDivRoundingUp(a,Pe,Et):a.shrn($e)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),S.mulDivFloor(n,Et,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return M.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=M.getLiquidityFromTokenAmountA(e,n,i,!1),a=M.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return M.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:M.getTokenAmountAFromLiquidity(t,n,i,o),amountB:new C(0)};if(e.lt(n)){let s=M.getTokenAmountAFromLiquidity(e,n,i,o),a=M.getTokenAmountBFromLiquidity(t,e,i,o);return{amountA:s,amountB:a}}else return{amountA:new C(0),amountB:M.getTokenAmountBFromLiquidity(t,n,i,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,o,s,a){let{amountA:u,amountB:c}=M.getAmountsFromLiquidity(e,t,n,i,s),l=o?1+a:1-a,m=new C(new k(u.toString()).mul(l).toFixed(0)),d=new C(new k(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:o,add:s,epochInfo:a,amountAddFee:u}){var B,T,R,x;let c=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),l=N.getSqrtPriceX64FromTick(t),m=N.getSqrtPriceX64FromTick(n),d=s?1+o:1-o,f=M.getAmountsFromLiquidity(c,l,m,i,s),[b,g]=[J(f.amountA,(B=e.mintA.extensions)==null?void 0:B.feeConfig,a,u),J(f.amountB,(T=e.mintB.extensions)==null?void 0:T.feeConfig,a,u)],[h,y]=[J(new C(new k(f.amountA.toString()).mul(d).toFixed(0)),(R=e.mintA.extensions)==null?void 0:R.feeConfig,a,u),J(new C(new k(f.amountB.toString()).mul(d).toFixed(0)),(x=e.mintB.extensions)==null?void 0:x.feeConfig,a,u)];return{liquidity:i,amountA:b,amountB:g,amountSlippageA:h,amountSlippageB:y,expirationTime:Ve(b.expirationTime,g.expirationTime)}}},Xe=class{static swapCompute(e,t,n,i,o,s,a,u,c,l,m,d,f,b){if(d.eq(Y))throw new Error("amountSpecified must not be 0");if(b||(b=s?Ye.add(Pe):Ze.sub(Pe)),s){if(b.lt(Ye))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(b.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(b.gt(Ze))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(b.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let g=d.gt(Y),h={amountSpecifiedRemaining:d,amountCalculated:Y,sqrtPriceX64:m,tick:c>f?Math.min(f+F.tickCount(l)-1,c):f,accounts:[],liquidity:u,feeAmount:new C(0)},y=f,B=n[f],T=0,R=!s&&B.startTickIndex===h.tick;for(;!h.amountSpecifiedRemaining.eq(Y)&&!h.sqrtPriceX64.eq(b);){if(T>10)throw Error("liquidity limit");let x={};x.sqrtPriceStartX64=h.sqrtPriceX64;let q=I.nextInitTick(B,h.tick,l,s,R),V=q||null,W=null;if(!(V!=null&&V.liquidityGross.gtn(0))){let G=Ie.nextInitializedTickArrayStartIndex({tickCurrent:h.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:o},y,s);if(!G.isExist)throw Error("swapCompute LiquidityInsufficient");y=G.nextStartIndex;let{publicKey:z}=ue(e,t,y);W=z,B=n[y],V=I.firstInitializedTick(B,s)}x.tickNext=V.tick,x.initialized=V.liquidityGross.gtn(0),f!==y&&W&&(h.accounts.push(W),f=y),x.tickNext<oe?x.tickNext=oe:x.tickNext>ae&&(x.tickNext=ae),x.sqrtPriceNextX64=N.getSqrtPriceX64FromTick(x.tickNext);let ne;if(s&&x.sqrtPriceNextX64.lt(b)||!s&&x.sqrtPriceNextX64.gt(b)?ne=b:ne=x.sqrtPriceNextX64,[h.sqrtPriceX64,x.amountIn,x.amountOut,x.feeAmount]=Xe.swapStepCompute(h.sqrtPriceX64,ne,h.liquidity,h.amountSpecifiedRemaining,a),h.feeAmount=h.feeAmount.add(x.feeAmount),g?(h.amountSpecifiedRemaining=h.amountSpecifiedRemaining.sub(x.amountIn.add(x.feeAmount)),h.amountCalculated=h.amountCalculated.sub(x.amountOut)):(h.amountSpecifiedRemaining=h.amountSpecifiedRemaining.add(x.amountOut),h.amountCalculated=h.amountCalculated.add(x.amountIn.add(x.feeAmount))),h.sqrtPriceX64.eq(x.sqrtPriceNextX64)){if(x.initialized){let G=V.liquidityNet;s&&(G=G.mul(Se)),h.liquidity=M.addDelta(h.liquidity,G)}R=x.tickNext!=h.tick&&!s&&B.startTickIndex===x.tickNext,h.tick=s?x.tickNext-1:x.tickNext}else if(h.sqrtPriceX64!=x.sqrtPriceStartX64){let G=N.getTickFromSqrtPriceX64(h.sqrtPriceX64);R=G!=h.tick&&!s&&B.startTickIndex===G,h.tick=G}++T}try{let{nextStartIndex:x,isExist:q}=F.nextInitializedTickArray(h.tick,l,s,i,o);q&&f!==x&&(h.accounts.push(ue(e,t,x).publicKey),f=x)}catch{}return{amountCalculated:h.amountCalculated,feeAmount:h.feeAmount,sqrtPriceX64:h.sqrtPriceX64,liquidity:h.liquidity,tickCurrent:h.tick,accounts:h.accounts}}static swapStepCompute(e,t,n,i,o){let s={sqrtPriceX64Next:new C(0),amountIn:new C(0),amountOut:new C(0),feeAmount:new C(0)},a=e.gte(t),u=i.gte(Y);if(u){let l=S.mulDivFloor(i,wt.sub(new C(o.toString())),wt);s.amountIn=a?M.getTokenAmountAFromLiquidity(t,e,n,!0):M.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=N.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?M.getTokenAmountBFromLiquidity(t,e,n,!1):M.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(Se).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=N.getNextSqrtPriceX64FromOutput(e,n,i.mul(Se),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=M.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=M.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:M.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:M.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(i.mul(Se))&&(s.amountOut=i.mul(Se)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=i.sub(s.amountIn):s.feeAmount=S.mulDivCeil(s.amountIn,new C(o),wt.sub(new C(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};export{M as LiquidityMath,S as MathUtil,N as SqrtPriceMath,Xe as SwapMath,We as TickMath};
/*!
 *  decimal.js v10.4.3
 *  An arbitrary-precision Decimal type for JavaScript.
 *  https://github.com/MikeMcl/decimal.js
 *  Copyright (c) 2022 Michael Mclaughlin <M8ch88l@gmail.com>
 *  MIT Licence
 */
//# sourceMappingURL=math.mjs.map