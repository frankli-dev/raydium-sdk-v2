import{merge as em}from"lodash";import Ju from"axios";import{get as so,set as Ba}from"lodash";import uo from"dayjs";import Sa from"dayjs/plugin/utc";uo.extend(Sa);var Ur=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return uo().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ao={},Ka={};function re(i){let e=so(ao,i);if(!e){let t=so(Ka,i);e=new Ur({name:i,logLevel:t}),Ba(ao,i,e)}return e}import{PublicKey as Vu}from"@solana/web3.js";import vu from"bn.js";import _u from"big.js";import cr from"bn.js";import Ge from"bn.js";var Zt=9e15,Ct=1e9,Gr="0123456789abcdef",$n="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Jn="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",Xr={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Zt,maxE:Zt,crypto:!1},po,kt,j=!0,tr="[DecimalError] ",Kt=tr+"Invalid argument: ",fo=tr+"Precision limit exceeded",yo=tr+"crypto unavailable",bo="[object Decimal]",Oe=Math.floor,Te=Math.pow,Ca=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,La=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Ra=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,go=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,nt=1e7,z=7,Oa=9007199254740991,Na=$n.length-1,zr=Jn.length-1,C={toStringTag:bo};C.absoluteValue=C.abs=function(){var i=new this.constructor(this);return i.s<0&&(i.s=1),U(i)};C.ceil=function(){return U(new this.constructor(this),this.e+1,2)};C.clampedTo=C.clamp=function(i,e){var t,n=this,r=n.constructor;if(i=new r(i),e=new r(e),!i.s||!e.s)return new r(NaN);if(i.gt(e))throw Error(Kt+e);return t=n.cmp(i),t<0?i:n.cmp(e)>0?e:new r(n)};C.comparedTo=C.cmp=function(i){var e,t,n,r,o=this,s=o.d,a=(i=new o.constructor(i)).d,u=o.s,c=i.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(o.e!==i.e)return o.e>i.e^u<0?1:-1;for(n=s.length,r=a.length,e=0,t=n<r?n:r;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===r?0:n>r^u<0?1:-1};C.cosine=C.cos=function(){var i,e,t=this,n=t.constructor;return t.d?t.d[0]?(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+z,n.rounding=1,t=Ma(n,ko(n,t)),n.precision=i,n.rounding=e,U(kt==2||kt==3?t.neg():t,i,e,!0)):new n(1):new n(NaN)};C.cubeRoot=C.cbrt=function(){var i,e,t,n,r,o,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(j=!1,o=l.s*Te(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=Se(l.d),i=l.e,(o=(i-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=Te(t,1/3),i=Oe((i+1)/3)-(i%3==(i<0?-1:2)),o==1/0?t="5e"+i:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+i),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(i=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=le(c.plus(l).times(a),c.plus(u),s+2,1),Se(a.d).slice(0,s)===(t=Se(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!r&&t=="4999"){if(!r&&(U(a,i+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,r=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(U(n,i+1,1),e=!n.times(n).times(n).eq(l));break}return j=!0,U(n,i,m.rounding,e)};C.decimalPlaces=C.dp=function(){var i,e=this.d,t=NaN;if(e){if(i=e.length-1,t=(i-Oe(this.e/z))*z,i=e[i],i)for(;i%10==0;i/=10)t--;t<0&&(t=0)}return t};C.dividedBy=C.div=function(i){return le(this,new this.constructor(i))};C.dividedToIntegerBy=C.divToInt=function(i){var e=this,t=e.constructor;return U(le(e,new t(i),0,1,1),t.precision,t.rounding)};C.equals=C.eq=function(i){return this.cmp(i)===0};C.floor=function(){return U(new this.constructor(this),this.e+1,3)};C.greaterThan=C.gt=function(i){return this.cmp(i)>0};C.greaterThanOrEqualTo=C.gte=function(i){var e=this.cmp(i);return e==1||e===0};C.hyperbolicCosine=C.cosh=function(){var i,e,t,n,r,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,r=o.d.length,r<32?(i=Math.ceil(r/3),e=(1/rr(4,i)).toString()):(i=16,e="2.3283064365386962890625e-10"),o=$t(s,1,o.times(e),new s(1),!0);for(var u,c=i,l=new s(8);c--;)u=o.times(o),o=a.minus(u.times(l.minus(u.times(l))));return U(o,s.precision=t,s.rounding=n,!0)};C.hyperbolicSine=C.sinh=function(){var i,e,t,n,r=this,o=r.constructor;if(!r.isFinite()||r.isZero())return new o(r);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(r.e,r.sd())+4,o.rounding=1,n=r.d.length,n<3)r=$t(o,2,r,r,!0);else{i=1.4*Math.sqrt(n),i=i>16?16:i|0,r=r.times(1/rr(5,i)),r=$t(o,2,r,r,!0);for(var s,a=new o(5),u=new o(16),c=new o(20);i--;)s=r.times(r),r=r.times(a.plus(s.times(u.times(s).plus(c))))}return o.precision=e,o.rounding=t,U(r,e,t,!0)};C.hyperbolicTangent=C.tanh=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+7,n.rounding=1,le(t.sinh(),t.cosh(),n.precision=i,n.rounding=e)):new n(t.s)};C.inverseCosine=C.acos=function(){var i,e=this,t=e.constructor,n=e.abs().cmp(1),r=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?tt(t,r,o):new t(0):new t(NaN):e.isZero()?tt(t,r+4,o).times(.5):(t.precision=r+6,t.rounding=1,e=e.asin(),i=tt(t,r+4,o).times(.5),t.precision=r,t.rounding=o,i.minus(e))};C.inverseHyperbolicCosine=C.acosh=function(){var i,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(i=n.precision,e=n.rounding,n.precision=i+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,j=!1,t=t.times(t).minus(1).sqrt().plus(t),j=!0,n.precision=i,n.rounding=e,t.ln()):new n(t)};C.inverseHyperbolicSine=C.asinh=function(){var i,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,j=!1,t=t.times(t).plus(1).sqrt().plus(t),j=!0,n.precision=i,n.rounding=e,t.ln())};C.inverseHyperbolicTangent=C.atanh=function(){var i,e,t,n,r=this,o=r.constructor;return r.isFinite()?r.e>=0?new o(r.abs().eq(1)?r.s/0:r.isZero()?r:NaN):(i=o.precision,e=o.rounding,n=r.sd(),Math.max(n,i)<2*-r.e-1?U(new o(r),i,e,!0):(o.precision=t=n-r.e,r=le(r.plus(1),new o(1).minus(r),t+i,1),o.precision=i+4,o.rounding=1,r=r.ln(),o.precision=i,o.rounding=e,r.times(.5))):new o(NaN)};C.inverseSine=C.asin=function(){var i,e,t,n,r=this,o=r.constructor;return r.isZero()?new o(r):(e=r.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(i=tt(o,t+4,n).times(.5),i.s=r.s,i):new o(NaN):(o.precision=t+6,o.rounding=1,r=r.div(new o(1).minus(r.times(r)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,r.times(2)))};C.inverseTangent=C.atan=function(){var i,e,t,n,r,o,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=zr)return s=tt(l,m+4,d).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=zr)return s=tt(l,m+4,d).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/z+2|0),i=t;i;--i)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(j=!1,e=Math.ceil(a/z),n=1,u=c.times(c),s=new l(c),r=c;i!==-1;)if(r=r.times(u),o=s.minus(r.div(n+=2)),r=r.times(u),s=o.plus(r.div(n+=2)),s.d[e]!==void 0)for(i=e;s.d[i]===o.d[i]&&i--;);return t&&(s=s.times(2<<t-1)),j=!0,U(s,l.precision=m,l.rounding=d,!0)};C.isFinite=function(){return!!this.d};C.isInteger=C.isInt=function(){return!!this.d&&Oe(this.e/z)>this.d.length-2};C.isNaN=function(){return!this.s};C.isNegative=C.isNeg=function(){return this.s<0};C.isPositive=C.isPos=function(){return this.s>0};C.isZero=function(){return!!this.d&&this.d[0]===0};C.lessThan=C.lt=function(i){return this.cmp(i)<0};C.lessThanOrEqualTo=C.lte=function(i){return this.cmp(i)<1};C.logarithm=C.log=function(i){var e,t,n,r,o,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding,p=5;if(i==null)i=new l(10),e=!0;else{if(i=new l(i),t=i.d,i.s<0||!t||!t[0]||i.eq(1))return new l(NaN);e=i.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(r=t[0];r%10===0;)r/=10;o=r!==1}if(j=!1,a=m+p,s=St(c,a),n=e?er(l,a+10):St(i,a),u=le(s,n,a,1),pn(u.d,r=m,d))do if(a+=10,s=St(c,a),n=e?er(l,a+10):St(i,a),u=le(s,n,a,1),!o){+Se(u.d).slice(r+1,r+15)+1==1e14&&(u=U(u,m+1,0));break}while(pn(u.d,r+=10,d));return j=!0,U(u,m,d)};C.minus=C.sub=function(i){var e,t,n,r,o,s,a,u,c,l,m,d,p=this,y=p.constructor;if(i=new y(i),!p.d||!i.d)return!p.s||!i.s?i=new y(NaN):p.d?i.s=-i.s:i=new y(i.d||p.s!==i.s?p:NaN),i;if(p.s!=i.s)return i.s=-i.s,p.plus(i);if(c=p.d,d=i.d,a=y.precision,u=y.rounding,!c[0]||!d[0]){if(d[0])i.s=-i.s;else if(c[0])i=new y(p);else return new y(u===3?-0:0);return j?U(i,a,u):i}if(t=Oe(i.e/z),l=Oe(p.e/z),c=c.slice(),o=l-t,o){for(m=o<0,m?(e=c,o=-o,s=d.length):(e=d,t=l,s=c.length),n=Math.max(Math.ceil(a/z),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=d[n]){m=c[n]<d[n];break}o=0}for(m&&(e=c,c=d,d=e,i.s=-i.s),s=c.length,n=d.length-s;n>0;--n)c[s++]=0;for(n=d.length;n>o;){if(c[--n]<d[n]){for(r=n;r&&c[--r]===0;)c[r]=nt-1;--c[r],c[n]+=nt}c[n]-=d[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(i.d=c,i.e=nr(c,t),j?U(i,a,u):i):new y(u===3?-0:0)};C.modulo=C.mod=function(i){var e,t=this,n=t.constructor;return i=new n(i),!t.d||!i.s||i.d&&!i.d[0]?new n(NaN):!i.d||t.d&&!t.d[0]?U(new n(t),n.precision,n.rounding):(j=!1,n.modulo==9?(e=le(t,i.abs(),0,3,1),e.s*=i.s):e=le(t,i,0,n.modulo,1),e=e.times(i),j=!0,t.minus(e))};C.naturalExponential=C.exp=function(){return Yr(this)};C.naturalLogarithm=C.ln=function(){return St(this)};C.negated=C.neg=function(){var i=new this.constructor(this);return i.s=-i.s,U(i)};C.plus=C.add=function(i){var e,t,n,r,o,s,a,u,c,l,m=this,d=m.constructor;if(i=new d(i),!m.d||!i.d)return!m.s||!i.s?i=new d(NaN):m.d||(i=new d(i.d||m.s===i.s?m:NaN)),i;if(m.s!=i.s)return i.s=-i.s,m.minus(i);if(c=m.d,l=i.d,a=d.precision,u=d.rounding,!c[0]||!l[0])return l[0]||(i=new d(m)),j?U(i,a,u):i;if(o=Oe(m.e/z),n=Oe(i.e/z),c=c.slice(),r=o-n,r){for(r<0?(t=c,r=-r,s=l.length):(t=l,n=o,s=c.length),o=Math.ceil(a/z),s=o>s?o+1:s+1,r>s&&(r=s,t.length=1),t.reverse();r--;)t.push(0);t.reverse()}for(s=c.length,r=l.length,s-r<0&&(r=s,t=l,l=c,c=t),e=0;r;)e=(c[--r]=c[r]+l[r]+e)/nt|0,c[r]%=nt;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return i.d=c,i.e=nr(c,n),j?U(i,a,u):i};C.precision=C.sd=function(i){var e,t=this;if(i!==void 0&&i!==!!i&&i!==1&&i!==0)throw Error(Kt+i);return t.d?(e=wo(t.d),i&&t.e+1>e&&(e=t.e+1)):e=NaN,e};C.round=function(){var i=this,e=i.constructor;return U(new e(i),i.e+1,e.rounding)};C.sine=C.sin=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+z,n.rounding=1,t=Ea(n,ko(n,t)),n.precision=i,n.rounding=e,U(kt>2?t.neg():t,i,e,!0)):new n(NaN)};C.squareRoot=C.sqrt=function(){var i,e,t,n,r,o,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(j=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=Se(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=Oe((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(o=n,n=o.plus(le(s,o,t+2,1)).times(.5),Se(o.d).slice(0,t)===(e=Se(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!r&&e=="4999"){if(!r&&(U(o,u+1,0),o.times(o).eq(s))){n=o;break}t+=4,r=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(U(n,u+1,1),i=!n.times(n).eq(s));break}return j=!0,U(n,u,l.rounding,i)};C.tangent=C.tan=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+10,n.rounding=1,t=t.sin(),t.s=1,t=le(t,new n(1).minus(t.times(t)).sqrt(),i+10,0),n.precision=i,n.rounding=e,U(kt==2||kt==4?t.neg():t,i,e,!0)):new n(NaN)};C.times=C.mul=function(i){var e,t,n,r,o,s,a,u,c,l=this,m=l.constructor,d=l.d,p=(i=new m(i)).d;if(i.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!i.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?i.s/0:i.s*0);for(t=Oe(l.e/z)+Oe(i.e/z),u=d.length,c=p.length,u<c&&(o=d,d=p,p=o,s=u,u=c,c=s),o=[],s=u+c,n=s;n--;)o.push(0);for(n=c;--n>=0;){for(e=0,r=u+n;r>n;)a=o[r]+p[n]*d[r-n-1]+e,o[r--]=a%nt|0,e=a/nt|0;o[r]=(o[r]+e)%nt|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),i.d=o,i.e=nr(o,t),j?U(i,m.precision,m.rounding):i};C.toBinary=function(i,e){return jr(this,2,i,e)};C.toDecimalPlaces=C.toDP=function(i,e){var t=this,n=t.constructor;return t=new n(t),i===void 0?t:(Ue(i,0,Ct),e===void 0?e=n.rounding:Ue(e,0,8),U(t,i+t.e+1,e))};C.toExponential=function(i,e){var t,n=this,r=n.constructor;return i===void 0?t=mt(n,!0):(Ue(i,0,Ct),e===void 0?e=r.rounding:Ue(e,0,8),n=U(new r(n),i+1,e),t=mt(n,!0,i+1)),n.isNeg()&&!n.isZero()?"-"+t:t};C.toFixed=function(i,e){var t,n,r=this,o=r.constructor;return i===void 0?t=mt(r):(Ue(i,0,Ct),e===void 0?e=o.rounding:Ue(e,0,8),n=U(new o(r),i+r.e+1,e),t=mt(n,!1,i+n.e+1)),r.isNeg()&&!r.isZero()?"-"+t:t};C.toFraction=function(i){var e,t,n,r,o,s,a,u,c,l,m,d,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(c=t=new f(1),n=u=new f(0),e=new f(n),o=e.e=wo(y)-p.e-1,s=o%z,e.d[0]=Te(10,s<0?z+s:s),i==null)i=o>0?e:c;else{if(a=new f(i),!a.isInt()||a.lt(c))throw Error(Kt+a);i=a.gt(e)?o>0?e:c:a}for(j=!1,a=new f(Se(y)),l=f.precision,f.precision=o=y.length*z*2;m=le(a,e,0,1,1),r=t.plus(m.times(n)),r.cmp(i)!=1;)t=n,n=r,r=c,c=u.plus(m.times(r)),u=r,r=e,e=a.minus(m.times(r)),a=r;return r=le(i.minus(t),n,0,1,1),u=u.plus(r.times(c)),t=t.plus(r.times(n)),u.s=c.s=p.s,d=le(c,n,o,1).minus(p).abs().cmp(le(u,t,o,1).minus(p).abs())<1?[c,n]:[u,t],f.precision=l,j=!0,d};C.toHexadecimal=C.toHex=function(i,e){return jr(this,16,i,e)};C.toNearest=function(i,e){var t=this,n=t.constructor;if(t=new n(t),i==null){if(!t.d)return t;i=new n(1),e=n.rounding}else{if(i=new n(i),e===void 0?e=n.rounding:Ue(e,0,8),!t.d)return i.s?t:i;if(!i.d)return i.s&&(i.s=t.s),i}return i.d[0]?(j=!1,t=le(t,i,0,e,1).times(i),j=!0,U(t)):(i.s=t.s,t=i),t};C.toNumber=function(){return+this};C.toOctal=function(i,e){return jr(this,8,i,e)};C.toPower=C.pow=function(i){var e,t,n,r,o,s,a=this,u=a.constructor,c=+(i=new u(i));if(!a.d||!i.d||!a.d[0]||!i.d[0])return new u(Te(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,o=u.rounding,i.eq(1))return U(a,n,o);if(e=Oe(i.e/z),e>=i.d.length-1&&(t=c<0?-c:c)<=Oa)return r=Ao(u,a,t,n),i.s<0?new u(1).div(r):U(r,n,o);if(s=a.s,s<0){if(e<i.d.length-1)return new u(NaN);if((i.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Te(+a,c),e=t==0||!isFinite(t)?Oe(c*(Math.log("0."+Se(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(j=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),r=Yr(i.times(St(a,n+t)),n),r.d&&(r=U(r,n+5,1),pn(r.d,n,o)&&(e=n+10,r=U(Yr(i.times(St(a,e+t)),e),e+5,1),+Se(r.d).slice(n+1,n+15)+1==1e14&&(r=U(r,n+1,0)))),r.s=s,j=!0,u.rounding=o,U(r,n,o))};C.toPrecision=function(i,e){var t,n=this,r=n.constructor;return i===void 0?t=mt(n,n.e<=r.toExpNeg||n.e>=r.toExpPos):(Ue(i,1,Ct),e===void 0?e=r.rounding:Ue(e,0,8),n=U(new r(n),i,e),t=mt(n,i<=n.e||n.e<=r.toExpNeg,i)),n.isNeg()&&!n.isZero()?"-"+t:t};C.toSignificantDigits=C.toSD=function(i,e){var t=this,n=t.constructor;return i===void 0?(i=n.precision,e=n.rounding):(Ue(i,1,Ct),e===void 0?e=n.rounding:Ue(e,0,8)),U(new n(t),i,e)};C.toString=function(){var i=this,e=i.constructor,t=mt(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()&&!i.isZero()?"-"+t:t};C.truncated=C.trunc=function(){return U(new this.constructor(this),this.e+1,1)};C.valueOf=C.toJSON=function(){var i=this,e=i.constructor,t=mt(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()?"-"+t:t};function Se(i){var e,t,n,r=i.length-1,o="",s=i[0];if(r>0){for(o+=s,e=1;e<r;e++)n=i[e]+"",t=z-n.length,t&&(o+=Bt(t)),o+=n;s=i[e],n=s+"",t=z-n.length,t&&(o+=Bt(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function Ue(i,e,t){if(i!==~~i||i<e||i>t)throw Error(Kt+i)}function pn(i,e,t,n){var r,o,s,a;for(o=i[0];o>=10;o/=10)--e;return--e<0?(e+=z,r=0):(r=Math.ceil((e+1)/z),e%=z),o=Te(10,z-e),a=i[r]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(i[r+1]/o/100|0)==Te(10,e-2)-1||(a==o/2||a==0)&&(i[r+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(i[r+1]/o/1e3|0)==Te(10,e-3)-1,s}function Zn(i,e,t){for(var n,r=[0],o,s=0,a=i.length;s<a;){for(o=r.length;o--;)r[o]*=e;for(r[0]+=Gr.indexOf(i.charAt(s++)),n=0;n<r.length;n++)r[n]>t-1&&(r[n+1]===void 0&&(r[n+1]=0),r[n+1]+=r[n]/t|0,r[n]%=t)}return r.reverse()}function Ma(i,e){var t,n,r;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),r=(1/rr(4,t)).toString()):(t=16,r="2.3283064365386962890625e-10"),i.precision+=t,e=$t(i,1,e.times(r),new i(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return i.precision-=t,e}var le=function(){function i(n,r,o){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*r+a,n[u]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,r,o,s){var a,u;if(o!=s)u=o>s?1:-1;else for(a=u=0;a<o;a++)if(n[a]!=r[a]){u=n[a]>r[a]?1:-1;break}return u}function t(n,r,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<r[o]?1:0,n[o]=a*s+n[o]-r[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,r,o,s,a,u){var c,l,m,d,p,y,f,b,g,A,h,P,T,I,B,x,K,O,F,Y,v=n.constructor,Z=n.s==r.s?1:-1,J=n.d,te=r.d;if(!J||!J[0]||!te||!te[0])return new v(!n.s||!r.s||(J?te&&J[0]==te[0]:!te)?NaN:J&&J[0]==0||!te?Z*0:Z/0);for(u?(p=1,l=n.e-r.e):(u=nt,p=z,l=Oe(n.e/p)-Oe(r.e/p)),F=te.length,K=J.length,g=new v(Z),A=g.d=[],m=0;te[m]==(J[m]||0);m++);if(te[m]>(J[m]||0)&&l--,o==null?(I=o=v.precision,s=v.rounding):a?I=o+(n.e-r.e)+1:I=o,I<0)A.push(1),y=!0;else{if(I=I/p+2|0,m=0,F==1){for(d=0,te=te[0],I++;(m<K||d)&&I--;m++)B=d*u+(J[m]||0),A[m]=B/te|0,d=B%te|0;y=d||m<K}else{for(d=u/(te[0]+1)|0,d>1&&(te=i(te,d,u),J=i(J,d,u),F=te.length,K=J.length),x=F,h=J.slice(0,F),P=h.length;P<F;)h[P++]=0;Y=te.slice(),Y.unshift(0),O=te[0],te[1]>=u/2&&++O;do d=0,c=e(te,h,F,P),c<0?(T=h[0],F!=P&&(T=T*u+(h[1]||0)),d=T/O|0,d>1?(d>=u&&(d=u-1),f=i(te,d,u),b=f.length,P=h.length,c=e(f,h,b,P),c==1&&(d--,t(f,F<b?Y:te,b,u))):(d==0&&(c=d=1),f=te.slice()),b=f.length,b<P&&f.unshift(0),t(h,f,P,u),c==-1&&(P=h.length,c=e(te,h,F,P),c<1&&(d++,t(h,F<P?Y:te,P,u))),P=h.length):c===0&&(d++,h=[0]),A[m++]=d,c&&h[0]?h[P++]=J[x]||0:(h=[J[x]],P=1);while((x++<K||h[0]!==void 0)&&I--);y=h[0]!==void 0}A[0]||A.shift()}if(p==1)g.e=l,po=y;else{for(m=1,d=A[0];d>=10;d/=10)m++;g.e=m+l*p-1,U(g,a?o+g.e+1:o,s,y)}return g}}();function U(i,e,t,n){var r,o,s,a,u,c,l,m,d,p=i.constructor;e:if(e!=null){if(m=i.d,!m)return i;for(r=1,a=m[0];a>=10;a/=10)r++;if(o=e-r,o<0)o+=z,s=e,l=m[d=0],u=l/Te(10,r-s-1)%10|0;else if(d=Math.ceil((o+1)/z),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=u=0,r=1,o%=z,s=o-z+1}else break e;else{for(l=a=m[d],r=1;a>=10;a/=10)r++;o%=z,s=o-z+r,u=s<0?0:l/Te(10,r-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Te(10,r-s-1)),c=t<4?(u||n)&&(t==0||t==(i.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(o>0?s>0?l/Te(10,r-s):0:m[d-1])%10&1||t==(i.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=i.e+1,m[0]=Te(10,(z-e%z)%z),i.e=-e||0):m[0]=i.e=0,i;if(o==0?(m.length=d,a=1,d--):(m.length=d+1,a=Te(10,z-o),m[d]=s>0?(l/Te(10,r-s)%Te(10,s)|0)*a:0),c)for(;;)if(d==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(i.e++,m[0]==nt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=nt)break;m[d--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return j&&(i.e>p.maxE?(i.d=null,i.e=NaN):i.e<p.minE&&(i.e=0,i.d=[0])),i}function mt(i,e,t){if(!i.isFinite())return Po(i);var n,r=i.e,o=Se(i.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+Bt(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(i.e<0?"e":"e+")+i.e):r<0?(o="0."+Bt(-r-1)+o,t&&(n=t-s)>0&&(o+=Bt(n))):r>=s?(o+=Bt(r+1-s),t&&(n=t-r-1)>0&&(o=o+"."+Bt(n))):((n=r+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(r+1===s&&(o+="."),o+=Bt(n))),o}function nr(i,e){var t=i[0];for(e*=z;t>=10;t/=10)e++;return e}function er(i,e,t){if(e>Na)throw j=!0,t&&(i.precision=t),Error(fo);return U(new i($n),e,1,!0)}function tt(i,e,t){if(e>zr)throw Error(fo);return U(new i(Jn),e,t,!0)}function wo(i){var e=i.length-1,t=e*z+1;if(e=i[e],e){for(;e%10==0;e/=10)t--;for(e=i[0];e>=10;e/=10)t++}return t}function Bt(i){for(var e="";i--;)e+="0";return e}function Ao(i,e,t,n){var r,o=new i(1),s=Math.ceil(n/z+4);for(j=!1;;){if(t%2&&(o=o.times(e),lo(o.d,s)&&(r=!0)),t=Oe(t/2),t===0){t=o.d.length-1,r&&o.d[t]===0&&++o.d[t];break}e=e.times(e),lo(e.d,s)}return j=!0,o}function co(i){return i.d[i.d.length-1]&1}function ho(i,e,t){for(var n,r=new i(e[0]),o=0;++o<e.length;)if(n=new i(e[o]),n.s)r[t](n)&&(r=n);else{r=n;break}return r}function Yr(i,e){var t,n,r,o,s,a,u,c=0,l=0,m=0,d=i.constructor,p=d.rounding,y=d.precision;if(!i.d||!i.d[0]||i.e>17)return new d(i.d?i.d[0]?i.s<0?0:1/0:1:i.s?i.s<0?0:i:0/0);for(e==null?(j=!1,u=y):u=e,a=new d(.03125);i.e>-2;)i=i.times(a),m+=5;for(n=Math.log(Te(2,m))/Math.LN10*2+5|0,u+=n,t=o=s=new d(1),d.precision=u;;){if(o=U(o.times(i),u,1),t=t.times(++l),a=s.plus(le(o,t,u,1)),Se(a.d).slice(0,u)===Se(s.d).slice(0,u)){for(r=m;r--;)s=U(s.times(s),u,1);if(e==null)if(c<3&&pn(s.d,u-n,p,c))d.precision=u+=10,t=o=a=new d(1),l=0,c++;else return U(s,d.precision=y,p,j=!0);else return d.precision=y,s}s=a}}function St(i,e){var t,n,r,o,s,a,u,c,l,m,d,p=1,y=10,f=i,b=f.d,g=f.constructor,A=g.rounding,h=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(j=!1,l=h):l=e,g.precision=l+=y,t=Se(b),n=t.charAt(0),Math.abs(o=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(i),t=Se(f.d),n=t.charAt(0),p++;o=f.e,n>1?(f=new g("0."+t),o++):f=new g(n+"."+t.slice(1))}else return c=er(g,l+2,h).times(o+""),f=St(new g(n+"."+t.slice(1)),l-y).plus(c),g.precision=h,e==null?U(f,h,A,j=!0):f;for(m=f,u=s=f=le(f.minus(1),f.plus(1),l,1),d=U(f.times(f),l,1),r=3;;){if(s=U(s.times(d),l,1),c=u.plus(le(s,new g(r),l,1)),Se(c.d).slice(0,l)===Se(u.d).slice(0,l))if(u=u.times(2),o!==0&&(u=u.plus(er(g,l+2,h).times(o+""))),u=le(u,new g(p),l,1),e==null)if(pn(u.d,l-y,A,a))g.precision=l+=y,c=s=f=le(m.minus(1),m.plus(1),l,1),d=U(f.times(f),l,1),r=a=1;else return U(u,g.precision=h,A,j=!0);else return g.precision=h,u;u=c,r+=2}}function Po(i){return String(i.s*i.s/0)}function Hr(i,e){var t,n,r;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(r=e.length;e.charCodeAt(r-1)===48;--r);if(e=e.slice(n,r),e){if(r-=n,i.e=t=t-n-1,i.d=[],n=(t+1)%z,t<0&&(n+=z),n<r){for(n&&i.d.push(+e.slice(0,n)),r-=z;n<r;)i.d.push(+e.slice(n,n+=z));e=e.slice(n),n=z-e.length}else n-=r;for(;n--;)e+="0";i.d.push(+e),j&&(i.e>i.constructor.maxE?(i.d=null,i.e=NaN):i.e<i.constructor.minE&&(i.e=0,i.d=[0]))}else i.e=0,i.d=[0];return i}function _a(i,e){var t,n,r,o,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),go.test(e))return Hr(i,e)}else if(e==="Infinity"||e==="NaN")return+e||(i.s=NaN),i.e=NaN,i.d=null,i;if(La.test(e))t=16,e=e.toLowerCase();else if(Ca.test(e))t=2;else if(Ra.test(e))t=8;else throw Error(Kt+e);for(o=e.search(/p/i),o>0?(u=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=i.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,r=Ao(n,new n(t),o,o*2)),c=Zn(e,t,nt),l=c.length-1,o=l;c[o]===0;--o)c.pop();return o<0?new n(i.s*0):(i.e=nr(c,l),i.d=c,j=!1,s&&(i=le(i,r,a*4)),u&&(i=i.times(Math.abs(u)<54?Te(2,u):fn.pow(2,u))),j=!0,i)}function Ea(i,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:$t(i,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/rr(5,t)),e=$t(i,2,e,e);for(var r,o=new i(5),s=new i(16),a=new i(20);t--;)r=e.times(e),e=e.times(o.plus(r.times(s.times(r).minus(a))));return e}function $t(i,e,t,n,r){var o,s,a,u,c=1,l=i.precision,m=Math.ceil(l/z);for(j=!1,u=t.times(t),a=new i(n);;){if(s=le(a.times(u),new i(e++*e++),l,1),a=r?n.plus(s):n.minus(s),n=le(s.times(u),new i(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,c++}return j=!0,s.d.length=m+1,s}function rr(i,e){for(var t=i;--e;)t*=i;return t}function ko(i,e){var t,n=e.s<0,r=tt(i,i.precision,1),o=r.times(.5);if(e=e.abs(),e.lte(o))return kt=n?4:1,e;if(t=e.divToInt(r),t.isZero())kt=n?3:2;else{if(e=e.minus(t.times(r)),e.lte(o))return kt=co(t)?n?2:3:n?4:1,e;kt=co(t)?n?1:4:n?3:2}return e.minus(r).abs()}function jr(i,e,t,n){var r,o,s,a,u,c,l,m,d,p=i.constructor,y=t!==void 0;if(y?(Ue(t,1,Ct),n===void 0?n=p.rounding:Ue(n,0,8)):(t=p.precision,n=p.rounding),!i.isFinite())l=Po(i);else{for(l=mt(i),s=l.indexOf("."),y?(r=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):r=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Zn(mt(d),10,r),d.e=d.d.length),m=Zn(l,10,r),o=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?o--:(i=new p(i),i.d=m,i.e=o,i=le(i,d,t,n,0,r),m=i.d,o=i.e,c=po),s=m[t],a=r/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(i.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(i.s<0?8:7)),m.length=t,c)for(;++m[--t]>r-1;)m[t]=0,t||(++o,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=Gr.charAt(m[s]);if(y){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=Zn(l,r,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=Gr.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>u)for(o-=u;o--;)l+="0";else o<u&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return i.s<0?"-"+l:l}function lo(i,e){if(i.length>e)return i.length=e,!0}function Fa(i){return new this(i).abs()}function Va(i){return new this(i).acos()}function va(i){return new this(i).acosh()}function Da(i,e){return new this(i).plus(e)}function Wa(i){return new this(i).asin()}function qa(i){return new this(i).asinh()}function Ua(i){return new this(i).atan()}function Ga(i){return new this(i).atanh()}function Xa(i,e){i=new this(i),e=new this(e);var t,n=this.precision,r=this.rounding,o=n+4;return!i.s||!e.s?t=new this(NaN):!i.d&&!e.d?(t=tt(this,o,1).times(e.s>0?.25:.75),t.s=i.s):!e.d||i.isZero()?(t=e.s<0?tt(this,n,r):new this(0),t.s=i.s):!i.d||e.isZero()?(t=tt(this,o,1).times(.5),t.s=i.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(le(i,e,o,1)),e=tt(this,o,1),this.precision=n,this.rounding=r,t=i.s<0?t.minus(e):t.plus(e)):t=this.atan(le(i,e,o,1)),t}function za(i){return new this(i).cbrt()}function Ya(i){return U(i=new this(i),i.e+1,2)}function Ha(i,e,t){return new this(i).clamp(e,t)}function ja(i){if(!i||typeof i!="object")throw Error(tr+"Object expected");var e,t,n,r=i.defaults===!0,o=["precision",1,Ct,"rounding",0,8,"toExpNeg",-Zt,0,"toExpPos",0,Zt,"maxE",0,Zt,"minE",-Zt,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],r&&(this[t]=Xr[t]),(n=i[t])!==void 0)if(Oe(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(Kt+t+": "+n);if(t="crypto",r&&(this[t]=Xr[t]),(n=i[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(yo);else this[t]=!1;else throw Error(Kt+t+": "+n);return this}function Qa(i){return new this(i).cos()}function Za(i){return new this(i).cosh()}function To(i){var e,t,n;function r(o){var s,a,u,c=this;if(!(c instanceof r))return new r(o);if(c.constructor=r,mo(o)){c.s=o.s,j?!o.d||o.e>r.maxE?(c.e=NaN,c.d=null):o.e<r.minE?(c.e=0,c.d=[0]):(c.e=o.e,c.d=o.d.slice()):(c.e=o.e,c.d=o.d?o.d.slice():o.d);return}if(u=typeof o,u==="number"){if(o===0){c.s=1/o<0?-1:1,c.e=0,c.d=[0];return}if(o<0?(o=-o,c.s=-1):c.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;j?s>r.maxE?(c.e=NaN,c.d=null):s<r.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[o]):(c.e=s,c.d=[o]);return}else if(o*0!==0){o||(c.s=NaN),c.e=NaN,c.d=null;return}return Hr(c,o.toString())}else if(u!=="string")throw Error(Kt+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),c.s=-1):(a===43&&(o=o.slice(1)),c.s=1),go.test(o)?Hr(c,o):_a(c,o)}if(r.prototype=C,r.ROUND_UP=0,r.ROUND_DOWN=1,r.ROUND_CEIL=2,r.ROUND_FLOOR=3,r.ROUND_HALF_UP=4,r.ROUND_HALF_DOWN=5,r.ROUND_HALF_EVEN=6,r.ROUND_HALF_CEIL=7,r.ROUND_HALF_FLOOR=8,r.EUCLID=9,r.config=r.set=ja,r.clone=To,r.isDecimal=mo,r.abs=Fa,r.acos=Va,r.acosh=va,r.add=Da,r.asin=Wa,r.asinh=qa,r.atan=Ua,r.atanh=Ga,r.atan2=Xa,r.cbrt=za,r.ceil=Ya,r.clamp=Ha,r.cos=Qa,r.cosh=Za,r.div=$a,r.exp=Ja,r.floor=eu,r.hypot=tu,r.ln=nu,r.log=ru,r.log10=ou,r.log2=iu,r.max=su,r.min=au,r.mod=uu,r.mul=cu,r.pow=lu,r.random=mu,r.round=du,r.sign=pu,r.sin=fu,r.sinh=yu,r.sqrt=bu,r.sub=gu,r.sum=wu,r.tan=Au,r.tanh=hu,r.trunc=Pu,i===void 0&&(i={}),i&&i.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)i.hasOwnProperty(t=n[e++])||(i[t]=this[t]);return r.config(i),r}function $a(i,e){return new this(i).div(e)}function Ja(i){return new this(i).exp()}function eu(i){return U(i=new this(i),i.e+1,3)}function tu(){var i,e,t=new this(0);for(j=!1,i=0;i<arguments.length;)if(e=new this(arguments[i++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return j=!0,new this(1/0);t=e}return j=!0,t.sqrt()}function mo(i){return i instanceof fn||i&&i.toStringTag===bo||!1}function nu(i){return new this(i).ln()}function ru(i,e){return new this(i).log(e)}function iu(i){return new this(i).log(2)}function ou(i){return new this(i).log(10)}function su(){return ho(this,arguments,"lt")}function au(){return ho(this,arguments,"gt")}function uu(i,e){return new this(i).mod(e)}function cu(i,e){return new this(i).mul(e)}function lu(i,e){return new this(i).pow(e)}function mu(i){var e,t,n,r,o=0,s=new this(1),a=[];if(i===void 0?i=this.precision:Ue(i,1,Ct),n=Math.ceil(i/z),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)r=e[o],r>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=r%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)r=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),r>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(r%1e7),o+=4);o=n/4}else throw Error(yo);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],i%=z,n&&i&&(r=Te(10,z-i),a[o]=(n/r|0)*r);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=z)a.shift();for(n=1,r=a[0];r>=10;r/=10)n++;n<z&&(t-=z-n)}return s.e=t,s.d=a,s}function du(i){return U(i=new this(i),i.e+1,this.rounding)}function pu(i){return i=new this(i),i.d?i.d[0]?i.s:0*i.s:i.s||NaN}function fu(i){return new this(i).sin()}function yu(i){return new this(i).sinh()}function bu(i){return new this(i).sqrt()}function gu(i,e){return new this(i).sub(e)}function wu(){var i=0,e=arguments,t=new this(e[i]);for(j=!1;t.s&&++i<e.length;)t=t.plus(e[i]);return j=!0,U(t,this.precision,this.rounding)}function Au(i){return new this(i).tan()}function hu(i){return new this(i).tanh()}function Pu(i){return U(i=new this(i),i.e+1,1)}C[Symbol.for("nodejs.util.inspect.custom")]=C.toString;C[Symbol.toStringTag]="Decimal";var fn=C.constructor=To(Xr);$n=new fn($n);Jn=new fn(Jn);var _=fn;import{PublicKey as Jr}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ku}from"@solana/spl-token";import{PublicKey as fe,SystemProgram as Io,SYSVAR_RENT_PUBKEY as Tu}from"@solana/web3.js";function k({pubkey:i,isSigner:e=!1,isWritable:t=!0}){return{pubkey:i,isWritable:t,isSigner:e}}var Qr=[k({pubkey:ku,isWritable:!1}),k({pubkey:Io.programId,isWritable:!1}),k({pubkey:Tu,isWritable:!1})];function Zr({publicKey:i,transformSol:e}){let t=$r(i.toString());if(t instanceof fe)return e&&t.equals(Ie)?$:t;if(e&&t.toString()===Ie.toBase58())return $;if(typeof t=="string"){if(t===fe.default.toBase58())return fe.default;try{return new fe(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function $r(i){try{return new fe(i)}catch{return i}}var ir=new fe("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),xo=new fe("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),rt=new fe("SysvarRent111111111111111111111111111111111"),Bo=new fe("SysvarC1ock11111111111111111111111111111111"),Jt=new fe("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Iu=new fe("Sysvar1nstructions1111111111111111111111111"),So=Io.programId,cm=new fe("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),lm=new fe("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),mm=new fe("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),dm=new fe("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),pm=new fe("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),fm=new fe("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ym=new fe("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),bm=new fe("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),gm=new fe("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),wm=new fe("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Am=new fe("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),$=new fe("So11111111111111111111111111111111111111112"),Ie=fe.default;function en(i){return Zr({publicKey:i,transformSol:!0})}import{PublicKey as xu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ko}from"@solana/spl-token";var Lt={chainId:101,address:xu.default.toBase58(),programId:Ko.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Ke={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ko.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var ei=class{constructor({mint:e,decimals:t,symbol:n,name:r,skipMint:o=!1,isToken2022:s=!1}){if(e===Ie.toBase58()||e instanceof Jr&&Ie.equals(e)){this.decimals=Ke.decimals,this.symbol=Ke.symbol,this.name=Ke.name,this.mint=new Jr(Ke.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=r||e.toString().substring(0,6),this.mint=o?Jr.default:Zr({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},be=ei;be.WSOL=new ei({...Ke,mint:Ke.address});import sr from"big.js";import Ku from"bn.js";import Cu from"decimal.js-light";import Bu from"toformat";var Su=Bu,yn=Su;var or=re("module/fraction"),ti=yn(sr),bn=yn(Cu),Lu={[0]:bn.ROUND_DOWN,[1]:bn.ROUND_HALF_UP,[2]:bn.ROUND_UP},Ru={[0]:sr.roundDown,[1]:sr.roundHalfUp,[2]:sr.roundUp},ue=class{constructor(e,t=new Ku(1)){this.numerator=X(e),this.denominator=X(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new ue(this.denominator,this.numerator)}add(e){let t=e instanceof ue?e:new ue(X(e));return this.denominator.eq(t.denominator)?new ue(this.numerator.add(t.numerator),this.denominator):new ue(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof ue?e:new ue(X(e));return this.denominator.eq(t.denominator)?new ue(this.numerator.sub(t.numerator),this.denominator):new ue(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof ue?e:new ue(X(e));return new ue(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof ue?e:new ue(X(e));return new ue(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||or.logWithError(`${e} is not an integer.`),e<=0&&or.logWithError(`${e} is not positive.`),bn.set({precision:e+1,rounding:Lu[n]});let r=new bn(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||or.logWithError(`${e} is not an integer.`),e<0&&or.logWithError(`${e} is negative.`),ti.DP=e,ti.RM=Ru[n]||1,new ti(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Nu=re("Raydium_price"),Qe=class extends ue{constructor(t){let{baseToken:n,quoteToken:r,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=r,this.scalar=new ue(ni(n.decimals),ni(r.decimals))}get raw(){return new ue(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Qe({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Nu.logWithError("mul token not equals");let n=super.mul(t);return new Qe({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,r){return this.adjusted.toSignificant(t,n,r)}toFixed(t=this.quoteToken.decimals,n,r){return this.adjusted.toFixed(t,n,r)}};var ri=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},ar=ri;ar.SOL=new ri(Lt);import Mu from"bn.js";var Co=new ue(new Mu(100)),ze=class extends ue{toSignificant(e=5,t,n){return this.mul(Co).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Co).toFixed(e,t,n)}};var ve=new Ge(0),Ro=new Ge(1),yd=new Ge(2),bd=new Ge(3),gd=new Ge(5),ii=new Ge(10),wd=new Ge(100),Ad=new Ge(1e3),hd=new Ge(1e4),Lo=9007199254740991;function X(i){let e=re("Raydium_parseBigNumberish");if(i instanceof Ge)return i;if(typeof i=="string"){if(i.match(/^-?[0-9]+$/))return new Ge(i);e.logWithError(`invalid BigNumberish string: ${i}`)}return typeof i=="number"?(i%1&&e.logWithError(`BigNumberish number underflow: ${i}`),(i>=Lo||i<=-Lo)&&e.logWithError(`BigNumberish number overflow: ${i}`),new Ge(String(i))):typeof i=="bigint"?new Ge(i.toString()):(e.error(`invalid BigNumberish value: ${i}`),new Ge(0))}function ni(i){return ii.pow(X(i))}function ur(i,e){let t=i.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}var Eu=re("Raydium_amount"),No=yn(_u);function Fu(i,e){let t="0",n="0";if(i.includes(".")){let r=i.split(".");r.length===2?([t,n]=r,n=n.padEnd(e,"0")):Eu.logWithError(`invalid number string, num: ${i}`)}else t=i;return[t,n.slice(0,e)||n]}var we=class extends ue{constructor(t,n,r=!0,o){let s=new cr(0),a=ii.pow(new cr(t.decimals));if(r)s=X(n);else{let u=new cr(0),c=new cr(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Fu(n.toString(),t.decimals);u=X(l),c=X(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=re(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new we(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new we(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,r=0){return super.toSignificant(t,n,r)}toFixed(t=this.token.decimals,n,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,r)}toExact(t={groupSeparator:""}){return No.DP=this.token.decimals,new No(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};function Oo(i){return typeof i=="object"&&i!==null&&![be,we,Vu,ue,vu,Qe,ze].some(e=>typeof e=="object"&&i instanceof e)}function De(i){return typeof i=="string"?$r(i):Array.isArray(i)?i.map(e=>De(e)):Oo(i)?Object.fromEntries(Object.entries(i).map(([e,t])=>[e,De(t)])):i}import{PublicKey as An,sendAndConfirmTransaction as ci,Transaction as hn,TransactionMessage as Pn,VersionedTransaction as kn}from"@solana/web3.js";import Xu from"axios";var M={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};import{PublicKey as Du,ComputeBudgetProgram as Mo,Transaction as Eo,TransactionMessage as Wu,Keypair as Fo,VersionedTransaction as Vo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as qu}from"@solana/spl-token";var _o=re("Raydium_txUtil"),vo=1644;function lr(i){let e=[],t=[];return i.microLamports&&(e.push(Mo.setComputeUnitPrice({microLamports:i.microLamports})),t.push(M.SetComputeUnitPrice)),i.units&&(e.push(Mo.setComputeUnitLimit({units:i.units})),t.push(M.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function tn(i){var e,t;try{return((t=await((e=i.getLatestBlockhash)==null?void 0:e.call(i)))==null?void 0:t.blockhash)||(await i.getRecentBlockhash()).blockhash}catch{return(await i.getRecentBlockhash()).blockhash}}function oi(i,e){i.length<1&&_o.logWithError(`no instructions provided: ${i.toString()}`),e.length<1&&_o.logWithError(`no signers provided:, ${e.toString()}`);let t=new Eo;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...i);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<vo}catch{return!1}}function se(i,e){let[t,n]=Du.findProgramAddressSync(i,e);return{publicKey:t,nonce:n}}function gn({instructions:i,payer:e,signers:t}){return oi(i,[e,...t])}function wn({instructions:i,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Fo.generate().publicKey.toString()}){let o=new Wu({payerKey:e,recentBlockhash:n,instructions:i}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Vo(o).serialize()).toString("base64").length<vo}catch{return!1}}var Uu=i=>Buffer.isBuffer(i)?i:i instanceof Uint8Array?Buffer.from(i.buffer,i.byteOffset,i.byteLength):Buffer.from(i);function Dt(i){let e=[];return i.forEach(t=>{t instanceof Eo&&(t.recentBlockhash||(t.recentBlockhash=qu.toBase58()),t.feePayer||(t.feePayer=Fo.generate().publicKey));let n=t.serialize({requireAllSignatures:!1,verifySignatures:!1});t instanceof Vo&&(n=Uu(n));let r=n.toString("base64");e.push(r)}),console.log("simulate tx string:",e),e}import{PublicKey as Do,AddressLookupTableAccount as dr}from"@solana/web3.js";import{PublicKey as Gu}from"@solana/web3.js";import{getTransferFeeConfig as ap,unpackMint as up}from"@solana/spl-token";var si=re("Raydium_accountInfo_util");async function dt(i,e,t){let{batchRequest:n,commitment:r="confirmed"}={batchRequest:!1,...t},o=ai(e,100),s=new Array(o.length).fill([]);if(n){let a=o.map(l=>{let m=i._buildArgs([l.map(d=>d.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=ai(a,10);s=(await(await Promise.all(u.map(async l=>await i._rpcBatchRequest(l)))).flat()).map(l=>(l.error&&si.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${l.error.message}`),l.result.value.map(m=>{if(m){let{data:d,executable:p,lamports:y,owner:f,rentEpoch:b}=m;return d.length!==2&&d[1]!=="base64"&&si.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(d[0],"base64"),executable:p,lamports:y,owner:new Gu(f),rentEpoch:b}}return null})))}else try{s=await Promise.all(o.map(a=>i.getMultipleAccountsInfo(a,r)))}catch(a){a instanceof Error&&si.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return s.flat()}async function mr(i,e,t){let n=await dt(i,e.map(r=>r.pubkey),t);return e.map((r,o)=>({...r,accountInfo:n[o]}))}async function ui({connection:i,address:e}){let t=await dt(i,[...new Set(e.map(r=>r.toString()))].map(r=>new Do(r))),n={};for(let r=0;r<e.length;r++){let o=t[r],s=e[r];if(!o)continue;let a=new dr({key:s,state:dr.deserialize(o.data)});n[s.toString()]=a,pr[s.toString()]=a}return n}var pr={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new dr({key:new Do("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:dr.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};var fr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Xu.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=lr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:r=[],endInstructionTypes:o=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...r),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...s.filter(a=>a!==An.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0({...t||{}}):this.build(t)}build(e){let t=new hn;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async n=>{var a;let{recentBlockHash:r,skipPreflight:o=!0}=n||{},s=r!=null?r:await tn(this.connection);if(t.recentBlockhash=s,this.signers.length&&t.sign(...this.signers),Dt([t]),(a=this.owner)!=null&&a.isKeyPair)return{txId:await ci(this.connection,t,this.signers.find(u=>u.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:o}),signedTx:t};if(this.signAllTransactions){let u=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(u[0].serialize(),{skipPreflight:o}),signedTx:u[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:r}=this.build(n),o=t.filter(c=>c.transaction.instructions.length>0),s=[r,...o.map(c=>c.transaction)],a=[this.signers,...o.map(c=>c.signers)],u=[...this.instructionTypes,...o.map(c=>c.instructionTypes).flat()];return{builder:this,transactions:s,signers:a,instructionTypes:u,execute:async c=>{var f;let{sequentially:l,onTxUpdate:m,recentBlockHash:d,skipPreflight:p=!0}=c||{},y=d!=null?d:await tn(this.connection);if((f=this.owner)!=null&&f.isKeyPair)return{txIds:await await Promise.all(s.map(async(b,g)=>(b.recentBlockhash=y,await ci(this.connection,b,a[g].find(A=>A.publicKey.equals(this.owner.publicKey))?a[g]:[...a[g],this.owner.signer],{skipPreflight:p})))),signedTxs:s};if(this.signAllTransactions){let b=s.map((A,h)=>(A.recentBlockhash=y,a[h].length&&A.sign(...a[h]),A));Dt(b);let g=await this.signAllTransactions(b);if(l){let A=0,h=[],P=async()=>{if(!g[A])return;let T=await this.connection.sendRawTransaction(g[A].serialize(),{skipPreflight:p});h.push({txId:T,status:"sent",signedTx:g[A]}),m==null||m([...h]),A++,this.connection.onSignature(T,I=>{let B=h.findIndex(x=>x.txId===T);B>-1&&(h[B].status=I.err?"error":"success"),m==null||m([...h]),I.err||P()},"processed"),this.connection.getSignatureStatus(T)};return await P(),{txIds:h.map(T=>T.txId),signedTxs:g}}else{let A=[];for(let h=0;h<g.length;h+=1){let P=await this.connection.sendRawTransaction(g[h].serialize(),{skipPreflight:p});A.push(P)}return{txIds:A,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){let{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:r,...o}=e||{},s={...this.cluster==="devnet"?{}:pr,...t},a=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let d of a)s[d]===void 0&&u.push(new An(d));let c=await ui({connection:this.connection,address:u});for(let[d,p]of Object.entries(c))s[d]=p;let l=new Pn({payerKey:this.feePayer,recentBlockhash:r?An.default.toBase58():await tn(this.connection),instructions:[...this.allInstructions]}).compileToV0Message(Object.values(s)),m=new kn(l);return m.sign(this.signers),{builder:this,transaction:m,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async d=>{var f;let{recentBlockHash:p,skipPreflight:y=!0}=d||{};if(p&&(m.message.recentBlockhash=p),Dt([m]),(f=this.owner)!=null&&f.isKeyPair){this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))||m.sign([this.owner.signer]);let b=await this.connection.sendTransaction(m,{skipPreflight:y}),{lastValidBlockHeight:g,blockhash:A}=await this.connection.getLatestBlockhash();return await this.connection.confirmTransaction({blockhash:A,lastValidBlockHeight:g,signature:b},"confirmed"),{txId:b,signedTx:m}}if(this.signAllTransactions){let b=await this.signAllTransactions([m]);return{txId:await this.connection.sendTransaction(b[0],{skipPreflight:y}),signedTx:b[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:r}=await this.buildV0(n),o=t.filter(c=>c.builder.instructions.length>0),s=[r,...o.map(c=>c.transaction)],a=[this.signers,...o.map(c=>c.signers)],u=[...this.instructionTypes,...o.map(c=>c.instructionTypes).flat()];return s.forEach(async(c,l)=>{c.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:u,buildProps:n,execute:async c=>{var y;let{sequentially:l,onTxUpdate:m,recentBlockHash:d,skipPreflight:p=!0}=c||{};if(d&&s.forEach(f=>f.message.recentBlockhash=d),Dt(s),(y=this.owner)!=null&&y.isKeyPair){let{lastValidBlockHeight:f,blockhash:b}=await this.connection.getLatestBlockhash();return s.forEach((g,A)=>{a[A].find(h=>h.publicKey.equals(this.owner.publicKey))||g.sign([this.owner.signer])}),{txIds:await Promise.all(s.map(async g=>{let A=await this.connection.sendTransaction(g,{skipPreflight:p});return await this.connection.confirmTransaction({blockhash:b,lastValidBlockHeight:f,signature:A},"confirmed"),A})),signedTxs:s}}if(this.signAllTransactions){let f=await this.signAllTransactions(s);if(l){let b=0,g=[],A=async()=>{if(!f[b])return;let h=await this.connection.sendTransaction(f[b],{skipPreflight:p});g.push({txId:h,status:"sent",signedTx:f[b]}),m==null||m([...g]),b++,this.connection.onSignature(h,P=>{let T=g.findIndex(I=>I.txId===h);T>-1&&(g[T].status=P.err?"error":"success"),m==null||m([...g]),P.err||A()},"processed"),this.connection.getSignatureStatus(h)};return A(),{txIds:[],signedTxs:f}}else{let b=[];for(let g=0;g<f.length;g+=1){let A=await this.connection.sendTransaction(f[g],{skipPreflight:p});b.push(A)}return{txIds:b,signedTxs:f}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{computeBudgetConfig:t,...n}=e||{},r=t?lr(t):{instructions:[],instructionTypes:[]},o=this.signers.reduce((c,l)=>({...c,[l.publicKey.toBase58()]:l}),{}),s=[],a=[],u=[];if(this.allInstructions.forEach(c=>{let l=[...u,c],m=t?[...r.instructions,...l]:l,p=[...new Set(l.map(y=>y.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat()).values()].map(y=>new An(y));if(u.length<12&&gn({instructions:m,payer:this.feePayer,signers:p})||gn({instructions:l,payer:this.feePayer,signers:p}))u.push(c);else{if(u.length===0)throw Error("item ins too big");gn({instructions:t?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:p})?s.push(new hn().add(...r.instructions,...u)):s.push(new hn().add(...u)),a.push(Array.from(new Set(u.map(y=>y.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat())).map(y=>o[y]).filter(y=>y!==void 0)),u=[c]}}),u.length>0){let l=[...new Set(u.map(m=>m.keys.filter(d=>d.isSigner).map(d=>d.pubkey.toString())).flat()).values()].map(m=>o[m]).filter(m=>m!==void 0);gn({instructions:t?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:l.map(m=>m.publicKey)})?s.push(new hn().add(...r.instructions,...u)):s.push(new hn().add(...u)),a.push(l)}return s.forEach(c=>c.feePayer=this.feePayer),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async c=>{var f;let{sequentially:l,onTxUpdate:m,recentBlockHash:d,skipPreflight:p=!0}=c||{},y=d!=null?d:await tn(this.connection);if(s.forEach(async(b,g)=>{b.recentBlockhash=y,a[g].length&&b.sign(...a[g])}),Dt(s),(f=this.owner)!=null&&f.isKeyPair)return{txIds:await Promise.all(s.map(async(b,g)=>await ci(this.connection,b,a[g].find(A=>A.publicKey.equals(this.owner.publicKey))?a[g]:[...a[g],this.owner.signer],{skipPreflight:p}))),signedTxs:s};if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(l){let g=0,A=[],h=async()=>{if(!b[g])return;let P=await this.connection.sendRawTransaction(b[g].serialize(),{skipPreflight:p});A.push({txId:P,status:"sent",signedTx:b[g]}),m==null||m([...A]),g++,this.connection.onSignature(P,T=>{let I=A.findIndex(B=>B.txId===P);I>-1&&(A[I].status=T.err?"error":"success"),m==null||m([...A]),T.err||h()},"processed"),this.connection.getSignatureStatus(P)};return await h(),{txIds:A.map(P=>P.txId),signedTxs:b}}else{let g=[];for(let A=0;A<b.length;A+=1){let h=await this.connection.sendRawTransaction(b[A].serialize(),{skipPreflight:p});g.push(h)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:r=[],...o}=e||{},s={...this.cluster==="devnet"?{}:pr,...n},a=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let b of a)s[b]===void 0&&u.push(new An(b));let c=await ui({connection:this.connection,address:u});for(let[b,g]of Object.entries(c))s[b]=g;let l=t?lr(t):{instructions:[],instructionTypes:[]},m=await tn(this.connection),d=this.signers.reduce((b,g)=>({...b,[g.publicKey.toBase58()]:g}),{}),p=[],y=[],f=[];if(this.allInstructions.forEach(b=>{let g=[...f,b],A=t?[...l.instructions,...g]:g;if(f.length<12&&wn({instructions:A,payer:this.feePayer,lookupTableAddressAccount:s})||wn({instructions:g,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(b);else{if(f.length===0)throw Error("item ins too big");let h={};for(let P of[...new Set(a)])s[P]!==void 0&&(h[P]=s[P]);if(t&&wn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let P=new Pn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new kn(P))}else{let P=new Pn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new kn(P))}y.push(Array.from(new Set(f.map(P=>P.keys.filter(T=>T.isSigner).map(T=>T.pubkey.toString())).flat())).map(P=>d[P]).filter(P=>P!==void 0)),f=[b]}}),f.length>0){let g=[...new Set(f.map(A=>A.keys.filter(h=>h.isSigner).map(h=>h.pubkey.toString())).flat()).values()].map(A=>d[A]).filter(A=>A!==void 0);if(t&&wn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let A=new Pn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new kn(A))}else{let A=new Pn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new kn(A))}y.push(g)}return{builder:this,transactions:p,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async b=>{var T;let{sequentially:g,onTxUpdate:A,recentBlockHash:h,skipPreflight:P=!0}=b||{};if(p.map(async(I,B)=>{y[B].length&&I.sign(y[B]),h&&(I.message.recentBlockhash=h)}),Dt(p),(T=this.owner)!=null&&T.isKeyPair){let{lastValidBlockHeight:I,blockhash:B}=await this.connection.getLatestBlockhash();return p.forEach((x,K)=>{y[K].find(O=>O.publicKey.equals(this.owner.publicKey))||x.sign([this.owner.signer])}),{txIds:await Promise.all(p.map(async x=>{let K=await this.connection.sendTransaction(x,{skipPreflight:P});return await this.connection.confirmTransaction({blockhash:B,lastValidBlockHeight:I,signature:K},"confirmed"),K})),signedTxs:p}}if(this.signAllTransactions){let I=await this.signAllTransactions(p);if(g){let B=0,x=[],K=async()=>{if(!I[B])return;let O=await this.connection.sendTransaction(I[B],{skipPreflight:P});x.push({txId:O,status:"sent",signedTx:I[B]}),A==null||A([...x]),B++,this.connection.onSignature(O,F=>{let Y=x.findIndex(v=>v.txId===O);Y>-1&&(x[Y].status=F.err?"error":"success"),A==null||A([...x]),F.err||K()},"processed"),this.connection.getSignatureStatus(O)};return K(),{txIds:[],signedTxs:I}}else{let B=[];for(let x=0;x<I.length;x+=1){let K=await this.connection.sendTransaction(I[x],{skipPreflight:P});B.push(K)}return{txIds:B,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}};var it=class{constructor(e){this._owner=e}get publicKey(){return it.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return it.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return it.isKeyPair(this._owner)}get isPublicKey(){return it.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!it.isKeyPair(e)}};function ai(i,e=1,t=[]){let n=[...i];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as Pe}from"@solana/web3.js";var Wo=new Pe("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),qo=new Pe("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Tn=new Pe("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Lp=new Pe("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Rp=new Pe("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Op=new Pe("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Uo=new Pe("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Np=new Pe("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),Mp=new Pe("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),_p=new Pe("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),zu=new Pe("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Yu=new Pe("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Hu=new Pe("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),ju=new Pe("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Ep=new Pe("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Fp=new Pe("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Vp=new Pe("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),vp=new Pe("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Dp=new Pe("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Wp=new Pe("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),In={IDO_PROGRAM_ID_V1:zu,IDO_PROGRAM_ID_V2:Yu,IDO_PROGRAM_ID_V3:Hu,IDO_PROGRAM_ID_V4:ju};import{PublicKey as Qu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Zu}from"@solana/spl-token";function ye(i,e,t){return se([i.toBuffer(),(t!=null?t:Zu).toBuffer(),e.toBuffer()],new Qu("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import ot from"bn.js";var xn=1e4;function de(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let r={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},o=t.epoch<r.newerTransferFee.epoch?r.olderTransferFee:r.newerTransferFee,s=new ot(o.maximumFee.toString()),a=t.epoch<r.newerTransferFee.epoch?(Number(r.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===xn){let u=new ot(o.maximumFee.toString());return{amount:i.add(u),fee:u,expirationTime:a}}else{let u=Bn(i.mul(new ot(xn)),new ot(xn-o.transferFeeBasisPoints)),c=new ot(o.maximumFee.toString()),l=u.sub(i).gt(c)?i.add(c):u,m=Bn(l.mul(new ot(o.transferFeeBasisPoints)),new ot(xn)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let u=Bn(i.mul(new ot(o.transferFeeBasisPoints)),new ot(xn)),c=u.gt(s)?s:u;return{amount:i,fee:c,expirationTime:a}}}function Wt(i,e){return i===void 0?e:e===void 0?i:Math.min(i,e)}function Bn(i,e){let{div:t,mod:n}=i.divmod(e);return n.gt(new ot(0))?t.add(new ot(1)):t}var Ce={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://token.jup.ag/{type}",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee"},ff={...Ce};var Go="ray_tab_hash",mi="ray_req_hash",$u=()=>{if(typeof window===void 0)return"";let i=sessionStorage.getItem(Go);return i||(i=`ray-${Date.now()}`,sessionStorage.setItem(Go,i)),i},yr=async({logCount:i=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(r=>r());let n=JSON.parse(localStorage.getItem(mi)||"[]").slice(0,i-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:$u()});try{localStorage.setItem(mi,JSON.stringify(n))}catch{if(e){let r=!1,o=JSON.stringify(t.data).substring(0,100);for(n[0].data=o+(o.length>100?"...":"");!r;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(mi,JSON.stringify(n)),r=!0}catch{r=!1}}return new Promise(s=>s())}return yr({...t,logCount:i,removeLastLog:!0})}};var br=re("Raydium_Api"),di=new Map;var gr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:r,urlConfigs:o}){this.cluster=e,this.urlConfigs=o||{},this.logCount=r||1e3,this.api=Ju.create({baseURL:this.urlConfigs.BASE_HOST||Ce.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:u,url:c}=s;return br.debug(`${a==null?void 0:a.toUpperCase()} ${u}${c}`),s},s=>(br.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:u,status:c}=s,{method:l,baseURL:m,url:d}=a;return n&&yr({status:c,url:`${m}${d}`,params:a.params,data:u,logCount:this.logCount}),br.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${c}`),u},s=>{let{config:a,response:u={}}=s,{status:c}=u,{method:l,baseURL:m,url:d}=a;return n&&yr({status:c,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),br.error(`${l.toUpperCase()} ${m}${d} ${c||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Ce.CLMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Ce.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await this.api.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(r=>r.numSlots);return n.reduce((r,o)=>r+o,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Ce.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Ce.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Ce.TOKEN_LIST)).data}async getJupTokenList(e){return this.api.get("/",{baseURL:(this.urlConfigs.JUP_TOKEN_LIST||Ce.JUP_TOKEN_LIST).replace("{type}",e||"all")})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Ce.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:r="desc",page:o=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Ce.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${r}&page=${o}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Ce.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],r=t.filter(s=>di.has(s)?(n.push(di.get(s)),!1):!0),o=[];return r.length&&(o=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Ce.POOL_KEY_BY_ID)+`?ids=${r.join(",")}`)).data.filter(Boolean),o.forEach(a=>{di.set(a.id,a)})),n.concat(o)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:r="all",sort:o="default",order:s="desc",page:a=1}=e,[u,c]=[t&&en(t).toBase58(),n&&n!=="undefined"?en(n).toBase58():""],[l,m]=c&&u>c?[c,u]:[u,c];return console.log(123123555,`?mint1=${l}&mint2=${m}&poolType=${r}&poolSortField=${o}&sortType=${s}&pageSize=100&page=${a}`),(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Ce.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${r}&poolSortField=${o}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Ce.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Ce.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Ce.CHECK_AVAILABILITY)).data}};var wr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",zo="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{createAssociatedTokenAccountInstruction as Ti,TOKEN_PROGRAM_ID as Nt,AccountLayout as on,TOKEN_2022_PROGRAM_ID as Kc}from"@solana/spl-token";import{PublicKey as Br,SystemProgram as Cc}from"@solana/web3.js";var pi=(...i)=>i.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),ge=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=re(t)}createTxBuilder(e){return this.scope.checkOwner(),new fr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(pi(e))}logInfo(...e){this.logger.info(pi(e))}logAndCreateError(...e){let t=pi(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{createInitializeAccountInstruction as kc,createCloseAccountInstruction as Tc,createTransferInstruction as Ic,TOKEN_PROGRAM_ID as rn}from"@solana/spl-token";import{PublicKey as xc,SystemProgram as Bc}from"@solana/web3.js";import Sc from"bn.js";import{PublicKey as ss,Keypair as wc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ac}from"@solana/spl-token";import hc from"bn.js";import{PublicKey as mc}from"@solana/web3.js";import Zo,{isBN as $o}from"bn.js";import{bits as ec,BitStructure as Hf,blob as tc,Blob as jf,cstr as Qf,f32 as Zf,f32be as $f,f64 as Jf,f64be as ey,greedy as ty,Layout as nc,ns64 as ny,ns64be as ry,nu64 as rc,nu64be as iy,offset as oy,s16 as sy,s16be as ay,s24 as uy,s24be as cy,s32 as ic,s32be as ly,s40 as my,s40be as dy,s48 as py,s48be as fy,s8 as yy,seq as oc,struct as by,Structure as sc,u16 as ac,u16be as gy,u24 as wy,u24be as Ay,u32 as uc,u32be as hy,u40 as Py,u40be as ky,u48 as Ty,u48be as Iy,u8 as cc,UInt as lc,union as xy,Union as By,unionLayoutDiscriminator as Sy,utf8 as Ky}from"@solana/buffer-layout";var Ar=nc,Yo=sc;var fi=lc;var Ho=cc,pt=ac;var yi=uc;var jo=rc;var Le=ic;var Qo=oc;var pe=tc;var bi=ec;var qt=class extends Ar{constructor(t,n,r){super(t,r);this.blob=pe(t),this.signed=n}decode(t,n=0){let r=new Zo(this.blob.decode(t,n),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,n,r=0){return typeof t=="number"&&(t=new Zo(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,r)}},hr=class extends Ar{constructor(t){super(8,t);this._lower=bi(yi(),!1),this._upper=bi(yi(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let r=this._lower.decode(t,n),o=this._upper.decode(t,n+this._lower.span);return{...r,...o}}encode(t,n,r=0){return this._lower.encode(t,n,r)+this._upper.encode(t,n,r+this._lower.span)}};function E(i){return new fi(1,i)}function We(i){return new fi(4,i)}function w(i){return new qt(8,!1,i)}function G(i){return new qt(16,!1,i)}function Jo(i){return new qt(1,!0,i)}function kr(i){return new qt(8,!0,i)}function es(i){return new qt(16,!0,i)}var Pr=class extends Ar{constructor(t,n,r,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=r}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,r){return this.layout.encode(this.encoder(t),n,r)}getSpan(t,n){return this.layout.getSpan(t,n)}};function S(i){return new Pr(pe(32),e=>new mc(e),e=>e.toBuffer(),i)}function Ne(i){return new Pr(Ho(),dc,pc,i)}function dc(i){if(i===0)return!1;if(i===1)return!0;throw new Error("Invalid bool: "+i)}function pc(i){return i?1:0}var gi=class extends Yo{decode(e,t){return super.decode(e,t)}};function N(i,e,t){return new gi(i,e,t)}function D(i,e,t){let n,r=typeof e=="number"?e:$o(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=$o(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return Qo(i,r,t)}var nn=N([S("mint"),S("owner"),w("amount"),We("delegateOption"),S("delegate"),E("state"),We("isNativeOption"),w("isNative"),w("delegatedAmount"),We("closeAuthorityOption"),S("closeAuthority")]);function fc(i){return i instanceof Uint8Array||i!=null&&typeof i=="object"&&i.constructor.name==="Uint8Array"}function wi(i,...e){if(!fc(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${i.length}`)}function Ai(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function ts(i,e){wi(i);let t=e.outputLen;if(i.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Ir=i=>new DataView(i.buffer,i.byteOffset,i.byteLength),st=(i,e)=>i<<32-e|i>>>e;var Uy=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function yc(i){if(typeof i!="string")throw new Error(`utf8ToBytes expected string, got ${typeof i}`);return new Uint8Array(new TextEncoder().encode(i))}function hi(i){return typeof i=="string"&&(i=yc(i)),wi(i),i}var Tr=class{clone(){return this._cloneInto()}},Gy={}.toString;function ns(i){let e=n=>i().update(hi(n)).digest(),t=i();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>i(),e}function bc(i,e,t,n){if(typeof i.setBigUint64=="function")return i.setBigUint64(e,t,n);let r=BigInt(32),o=BigInt(4294967295),s=Number(t>>r&o),a=Number(t&o),u=n?4:0,c=n?0:4;i.setUint32(e+u,s,n),i.setUint32(e+c,a,n)}var rs=(i,e,t)=>i&e^~i&t,is=(i,e,t)=>i&e^i&t^e&t,xr=class extends Tr{constructor(e,t,n,r){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Ir(this.buffer)}update(e){Ai(this);let{view:t,buffer:n,blockLen:r}=this;e=hi(e);let o=e.length;for(let s=0;s<o;){let a=Math.min(r-this.pos,o-s);if(a===r){let u=Ir(e);for(;r<=o-s;s+=r)this.process(u,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ai(this),ts(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:r,isLE:o}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>r-s&&(this.process(n,0),s=0);for(let m=s;m<r;m++)t[m]=0;bc(n,r-8,BigInt(this.length*8),o),this.process(n,0);let a=Ir(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let c=u/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<c;m++)a.setUint32(4*m,l[m],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:r,finished:o,destroyed:s,pos:a}=this;return e.length=r,e.pos=a,e.finished=o,e.destroyed=s,r%t&&e.buffer.set(n),e}};var gc=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Rt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Ot=new Uint32Array(64),Pi=class extends xr{constructor(){super(64,32,8,!1),this.A=Rt[0]|0,this.B=Rt[1]|0,this.C=Rt[2]|0,this.D=Rt[3]|0,this.E=Rt[4]|0,this.F=Rt[5]|0,this.G=Rt[6]|0,this.H=Rt[7]|0}get(){let{A:e,B:t,C:n,D:r,E:o,F:s,G:a,H:u}=this;return[e,t,n,r,o,s,a,u]}set(e,t,n,r,o,s,a,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=r|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=u|0}process(e,t){for(let m=0;m<16;m++,t+=4)Ot[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=Ot[m-15],p=Ot[m-2],y=st(d,7)^st(d,18)^d>>>3,f=st(p,17)^st(p,19)^p>>>10;Ot[m]=f+Ot[m-7]+y+Ot[m-16]|0}let{A:n,B:r,C:o,D:s,E:a,F:u,G:c,H:l}=this;for(let m=0;m<64;m++){let d=st(a,6)^st(a,11)^st(a,25),p=l+d+rs(a,u,c)+gc[m]+Ot[m]|0,f=(st(n,2)^st(n,13)^st(n,22))+is(n,r,o)|0;l=c,c=u,u=a,a=s+p|0,s=o,o=r,r=n,n=p+f|0}n=n+this.A|0,r=r+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,u=u+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,r,o,s,a,u,c,l)}roundClean(){Ot.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var os=ns(()=>new Pi);var ab=re("Raydium_Util");function as({owner:i,solAccountResp:e,tokenAccountResp:t}){let n=[],r=[];for(let{pubkey:o,account:s}of t.value){let a=nn.decode(s.data),{mint:u,amount:c}=a;n.push({publicKey:o,mint:u,amount:c,isAssociated:ye(i,u,s.owner).publicKey.equals(o),isNative:!1,programId:s.owner}),r.push({pubkey:o,accountInfo:a,programId:s.owner})}return e&&n.push({mint:ss.default,amount:new hc(e.lamports),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:r}}function Me({fromPublicKey:i,programId:e=Ac}){let t=wc.generate().publicKey.toBase58().slice(0,32);return{publicKey:Pc(i,t,e),seed:t}}function Pc(i,e,t){let n=Buffer.concat([i.toBuffer(),Buffer.from(e),t.toBuffer()]),r=os(n);return new ss(r)}function ki(i){let{mint:e,tokenAccount:t,owner:n,programId:r=rn}=i;return kc(t,e,n,r)}function Tt(i){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:r,programId:o=rn}=i;return Tc(e,t,r,n,o)}async function ft(i){let{connection:e,amount:t,commitment:n,payer:r,owner:o,skipCloseAccount:s}=i,a=await e.getMinimumBalanceForRentExemption(nn.span,n),u=X(t).add(new Sc(a)),c=Me({fromPublicKey:r,programId:rn});return{addresses:{newAccount:c.publicKey},signers:[],instructions:[Bc.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:c.seed,newAccountPubkey:c.publicKey,lamports:u.toNumber(),space:nn.span,programId:rn}),ki({mint:new xc(Ke.address),tokenAccount:c.publicKey,owner:o,programId:rn})],instructionTypes:[M.CreateAccount,M.InitAccount],endInstructionTypes:s?[]:[M.CloseAccount],endInstructions:s?[]:[Tt({tokenAccount:c.publicKey,payer:r,owner:o})]}}function Sn({source:i,destination:e,owner:t,amount:n,multiSigners:r=[],tokenProgram:o=rn}){return Ic(i,e,t,BigInt(String(n)),r,o)}var Kn=class extends ge{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:n,tokenAccountRawInfos:r}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=r||[],this._clientOwnedToken=!!(n||r)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return ye(this.scope.ownerPubKey,t,n).publicKey}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let r={...{},...t},[o,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,r.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Nt},r.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Kc},r.commitment)]),{tokenAccounts:u,tokenAccountRawInfos:c}=as({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=u,this._tokenAccountRawInfos=c,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:u,tokenAccountRawInfos:c}}async getCreatedTokenAccount({mint:t,programId:n=Nt,associatedOnly:r=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of o){let{publicKey:u}=a;if(u&&(!r||r&&s.equals(u)))return u}}async getOrCreateTokenAccount(t){var y,f,b;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:r,associatedOnly:o,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:u=!1,checkCreateATAOwner:c=!1}=t,l=new Br(t.tokenProgram||Nt),m=this.getAssociatedTokenAccount(n,new Br(l)),d=(a?[]:this.tokenAccountRawInfos).filter(g=>g.accountInfo.mint.equals(n)&&(!o||g.pubkey.equals(m))).sort((g,A)=>g.accountInfo.amount.lt(A.accountInfo.amount)?1:-1);if(r===void 0||d.length>0)return d.length>0?{account:d[0].pubkey}:{};let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let g=Ti(s,m,s,n,l);if(c){let A=await this.scope.connection.getAccountInfo(m);if(A===null)(y=p.instructions)==null||y.push(g),p.instructionTypes.push(M.CreateATA);else if(!(A.owner.equals(l)&&on.decode(A.data).mint.equals(n)&&on.decode(A.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else p.instructions.push(g),p.instructionTypes.push(M.CreateATA);if(n.equals($)&&r.amount){let A=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r.payer||this.scope.ownerPubKey,amount:(f=r.amount)!=null?f:0,skipCloseAccount:u});p.instructions.push(...A.instructions||[]),p.endInstructions.push(...A.endInstructions||[]),p.instructionTypes.push(...A.instructionTypes||[]),p.endInstructionTypes.push(...A.endInstructionTypes||[]),r.amount&&(p.instructions.push(Sn({source:A.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:r.amount,tokenProgram:Nt})),p.instructionTypes.push(M.TransferAmount))}return u||(p.endInstructions.push(Tt({owner:s,payer:r.payer||s,tokenAccount:m,programId:l})),p.endInstructionTypes.push(M.CloseAccount)),{account:m,instructionParams:p}}else if(n.equals($)){let g=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r.payer||this.scope.ownerPubKey,amount:(b=r.amount)!=null?b:0,skipCloseAccount:u});return p.instructions.push(...g.instructions||[]),p.endInstructions.push(...g.endInstructions||[]),p.signers.push(...g.signers||[]),p.instructionTypes.push(...g.instructionTypes||[]),p.endInstructionTypes.push(...g.endInstructionTypes||[]),{account:g.addresses.newAccount,instructionParams:p}}else{let g=Me({fromPublicKey:s,programId:l}),A=await this.scope.connection.getMinimumBalanceForRentExemption(on.span),h=Cc.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:g.seed,newAccountPubkey:g.publicKey,lamports:A,space:on.span,programId:l});return p.instructions.push(h,ki({mint:n,tokenAccount:g.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(M.CreateAccount),p.instructionTypes.push(M.InitAccount),u||(p.endInstructions.push(Tt({owner:s,payer:r.payer||s,tokenAccount:g.publicKey,programId:l})),p.endInstructionTypes.push(M.CloseAccount)),{account:g.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:t,programId:n=Nt,autoUnwrapWSOLToSOL:r}){var u;await this.fetchWalletTokenAccounts();let o=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,s=this.scope.ownerPubKey,a={};if(!o){let c=this.getAssociatedTokenAccount(t,n),l=await Ti(s,c,s,t,n);a.instructions=[l],a.instructionTypes=[M.CreateATA],o=c}return r&&$.toBase58()===t.toBase58()&&(a.endInstructions=[Tt({owner:s,payer:s,tokenAccount:o,programId:n})],a.endInstructionTypes=[M.CloseAccount]),{pubKey:o,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:r,mint:o,programId:s=Nt,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(o,s);if(new Br($).equals(o)){let p=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:r,skipCloseAccount:l});return{tokenAccount:p.addresses.newAccount,...p}}else if(!a||n==="out"&&!d.equals(a)&&!c){let p=[],y=Ti(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(y);else if(!(f.owner.equals(Nt)&&on.decode(f.data).mint.equals(o)&&on.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else p.push(y);return{tokenAccount:d,instructions:p,instructionTypes:[M.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:r=Nt,amount:o,useSOLBalance:s,handleTokenAccount:a}=t,u,c=this.createTxBuilder();if(n.equals(new Br($))&&s){let{tokenAccount:l,...m}=await this.handleTokenAccount({side:"in",amount:o||0,mint:n,bypassAssociatedCheck:!0,programId:r});u=l,c.addInstruction(m)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:r}),!u&&a){let{tokenAccount:l,...m}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:r});u=l,c.addInstruction(m)}return{tokenAccount:u,...c.AllTxData}}};import{createAssociatedTokenAccountInstruction as zc}from"@solana/spl-token";import{PublicKey as me,SystemProgram as Yc}from"@solana/web3.js";import{PublicKey as ls}from"@solana/web3.js";var Ii=N([E("instruction")]),xi=N([E("instruction")]),Lc=N([w("rewardState"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardLastUpdateTime"),w("totalReward"),w("totalRewardEmissioned"),w("rewardClaimed"),w("rewardPerSecond"),G("accRewardPerShare"),S("rewardVault"),S("rewardMint"),S("rewardSender"),w("rewardType"),D(w(),15,"padding")]),Rc=N([w("state"),w("nonce"),S("lpVault"),S("rewardVault"),S(),S(),w(),w(),w("totalReward"),G("perShareReward"),w("lastSlot"),w("perSlotReward")]),Oc=N([w("state"),w("nonce"),S("lpVault"),S("rewardVaultA"),w("totalRewardA"),G("perShareRewardA"),w("perSlotRewardA"),E("option"),S("rewardVaultB"),pe(7),w("totalRewardB"),G("perShareRewardB"),w("perSlotRewardB"),w("lastSlot"),S()]),Nc=N([w(),w("state"),w("nonce"),w("validRewardTokenNum"),G("rewardMultiplier"),w("rewardPeriodMax"),w("rewardPeriodMin"),w("rewardPeriodExtend"),S("lpMint"),S("lpVault"),D(Lc,5,"rewardInfos"),S("creator"),S(),D(w(),32,"padding")]),Mc=new Proxy(Rc,{get(i,e,t){return e==="decode"?(...n)=>{let r=i.decode(...n);return{...r,version:3,rewardInfos:[{rewardVault:r.rewardVault,totalReward:r.totalReward,perSlotReward:r.perSlotReward,perShareReward:r.perShareReward}]}}:Reflect.get(i,e,t)}}),_c=new Proxy(Oc,{get(i,e,t){return e==="decode"?(...n)=>{let r=i.decode(...n);return{...r,version:5,rewardInfos:[{rewardVault:r.rewardVaultA,totalReward:r.totalRewardA,perSlotReward:r.perSlotRewardA,perShareReward:r.perShareRewardA},{rewardVault:r.rewardVaultB,totalReward:r.totalRewardB,perSlotReward:r.perSlotRewardB,perShareReward:r.perShareRewardB}]}}:Reflect.get(i,e,t)}}),Sr=new Proxy(Nc,{get(i,e,t){return e==="decode"?(...n)=>{let r=i.decode(...n);return{...r,version:6,rewardInfos:r.rewardInfos.map(o=>{var s;return{...o,rewardType:((s=Object.entries(Mt).find(a=>String(a[1])===o.rewardType.toString()))!=null?s:["Standard SPL"])[0]}})}}:Reflect.get(i,e,t)}}),Ec=N([w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),Bi=N([E("instruction"),w("nonce"),D(Ec,5,"rewardTimeInfo")]),Si=N([E("instruction"),w("rewardReopenTime"),w("rewardEndTime"),w("rewardPerSecond")]),Ki=N([E("instruction"),w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),vb=N([w("state"),S("id"),S("owner"),w("deposited"),D(w(),1,"rewardDebts")]),Ci=N([w("state"),S("id"),S("owner"),w("deposited"),D(G(),1,"rewardDebts"),w(""),w("voteLockedBalance"),D(w(),15)]),Db=N([w("state"),S("id"),S("owner"),w("deposited"),D(w(),2,"rewardDebts")]),us=N([w("state"),S("id"),S("owner"),w("deposited"),D(G(),2,"rewardDebts"),D(w(),17)]),cs=N([w(),w("state"),S("id"),S("owner"),w("deposited"),D(G(),5,"rewardDebts"),D(w(),16)]),Ye=N([E("instruction"),w("amount")]),Fc=N([S("mint"),S("grantAuthority"),w("baselineVoteWeightScaledFactor"),w("maxExtraLockupVoteWeightScaledFactor"),w("lockupSaturationSecs"),Jo("digitShift"),D(E(),7,"reserved1"),D(w(),7,"reserved2")]),Vc=N([pe(8),S("governanceProgramId"),S("realm"),S("realmGoverningTokenMint"),S("realmAuthority"),D(E(),32,"reserved1"),D(Fc,4,"votingMints"),kr("timeOffset"),E("bump"),D(E(),7,"reserved2"),D(w(),11,"reserved3")]),vc=N([kr("startTime"),kr("endTime"),E("kind"),D(E(),15,"reserved")]),Dc=N([D(vc,1,"lockup"),w("amountDeposited_native"),w("amountInitiallyLockedNative"),Ne("isUsed"),Ne("allowClawback"),E("votingMintConfigIdx"),D(E(),29,"reserved")]),Wc=N([pe(8),S("voterAuthority"),S("registrar"),D(Dc,32,"deposits"),E("voterBump"),E("voterWweightRecordBump"),D(E(),94,"reserved")]);var Hb=re("Raydium_farm_config"),ms=new ls("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),ds=new ls("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var ps={3:Ci,5:us,6:cs},Li=i=>[3,5,6].indexOf(i)!==-1,Ri=i=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=i,r=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,o={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${r}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${r}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${r}`}};return(s=o[e])==null?void 0:s.call(o)},Mt={"Standard SPL":0,"Option tokens":1},at={[Wo.toString()]:3,[qo.toString()]:5,[Tn.toString()]:6};import{PublicKey as ae,SystemProgram as bs,SYSVAR_RENT_PUBKEY as Gc,SYSVAR_CLOCK_PUBKEY as Kr,TransactionInstruction as ut}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as xg,TOKEN_PROGRAM_ID as _t,ASSOCIATED_TOKEN_PROGRAM_ID as Bg}from"@solana/spl-token";import gs from"bn.js";import qc from"bn.js";var Uc=re("Raydium.farm.util");function Cn({programId:i,poolId:e,mint:t,type:n}){let{publicKey:r}=se([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],i);return r}function yt({programId:i,poolId:e,owner:t,version:n}){let{publicKey:r}=se([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],i);return r}var fs=({programId:i,poolId:e})=>se([e.toBuffer()],i);function ys(i){return{isSet:new qc(1),rewardPerSecond:X(i.perSecond),rewardOpenTime:X(i.openTime),rewardEndTime:X(i.endTime),rewardType:X(Mt[i.rewardType])}}function Oi(i){return X(i.endTime).sub(X(i.openTime)).mul(X(i.perSecond))}function Ni(i){let e=ps[i];return e||Uc.logWithError("invalid version",i),e}var Xc=re("Raydium_farm_instruction"),vg={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ws(i){let{version:e,id:t,ledger:n,programId:r,owner:o}=i,s={3:9,5:10}[e];s||Xc.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Ii.span);Ii.encode({instruction:s},a);let u=[k({pubkey:t}),k({pubkey:n}),k({pubkey:o,isWritable:!1}),k({pubkey:bs.programId,isWritable:!1}),k({pubkey:Gc,isWritable:!1})];return{instruction:new ut({programId:r,keys:u,data:a}),instructionType:M.FarmV3CreateLedger}}function As(i){var n;let e=Buffer.alloc(Bi.span);Bi.encode({instruction:0,nonce:new gs(i.nonce),rewardTimeInfo:i.rewardInfoConfig},e);let t=[...Qr,k({pubkey:i.farmId}),k({pubkey:i.farmAuthority,isWritable:!1}),k({pubkey:i.lpVault}),k({pubkey:i.lpMint,isWritable:!1}),k({pubkey:i.lockVault}),k({pubkey:i.lockMint,isWritable:!1}),k({pubkey:(n=i.lockUserAccount)!=null?n:Ie}),k({pubkey:i.owner,isWritable:!1,isSigner:!0})];for(let r of i.rewardInfo)t.push(k({pubkey:r.rewardMint,isWritable:!1}),k({pubkey:r.rewardVault}),k({pubkey:r.userRewardToken}));return{instruction:new ut({programId:i.programId,keys:t,data:e}),instructionType:M.FarmV6Create}}function hs(i){let e=Buffer.alloc(xi.span);xi.encode({instruction:5},e);let t=[k({pubkey:_t,isWritable:!1}),k({pubkey:i.id}),k({pubkey:i.authority,isWritable:!1}),k({pubkey:i.lpVault,isWritable:!1}),k({pubkey:i.rewardVault}),k({pubkey:i.userRewardToken}),k({pubkey:i.owner,isWritable:!1,isSigner:!0})];return{instruction:new ut({programId:i.programId,keys:t,data:e}),instructionType:M.FarmV6CreatorWithdraw}}function Mi({payer:i,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:r}){let o=Buffer.alloc(Si.span);Si.encode({instruction:3,rewardReopenTime:X(r.openTime),rewardEndTime:X(r.endTime),rewardPerSecond:X(r.perSecond)},o);let s=[k({pubkey:_t,isWritable:!1}),k({pubkey:n.id}),k({pubkey:n.lpVault,isWritable:!1}),k({pubkey:e}),k({pubkey:t}),k({pubkey:i,isWritable:!1,isSigner:!0})];return new ut({programId:n.programId,keys:s,data:o})}function _i({payer:i,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:r}){let o=Buffer.alloc(Ki.span);Ki.encode({instruction:4,isSet:new gs(1),rewardPerSecond:X(r.perSecond),rewardOpenTime:X(r.openTime),rewardEndTime:X(r.endTime),rewardType:X(Mt[r.rewardType])},o);let s=[...Qr,k({pubkey:t.id}),k({pubkey:t.authority,isWritable:!1}),k({pubkey:r.mint,isWritable:!1}),k({pubkey:n}),k({pubkey:e}),k({pubkey:i,isWritable:!1,isSigner:!0})];return new ut({programId:t.programId,keys:s,data:o})}function Ln(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s}=i,[a,u]=[new ae(e.programId),new ae(e.id)],c=yt({programId:a,poolId:u,owner:o,version:6}),l=Buffer.alloc(Ye.span);Ye.encode({instruction:2,amount:X(s)},l);let m=[k({pubkey:_t,isWritable:!1}),k({pubkey:u}),k({pubkey:new ae(t.authority),isWritable:!1}),k({pubkey:new ae(t.lpVault)}),k({pubkey:c}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(k({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(k({pubkey:r[d]}));return new ut({programId:a,keys:m,data:l})}function Rn(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new ae(e.programId),new ae(e.id)],l=yt({programId:u,poolId:c,owner:o,version:5}),m=Buffer.alloc(Ye.span);Ye.encode({instruction:12,amount:X(s)},m);let d=[k({pubkey:c}),k({pubkey:new ae(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new ae(t.lpVault)}),k({pubkey:r[0]}),k({pubkey:new ae(t.rewardInfos[0].vault)}),k({pubkey:Kr,isWritable:!1}),k({pubkey:_t,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(k({pubkey:r[p]})),d.push(k({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(k({pubkey:p}));return new ut({programId:u,keys:d,data:m})}function On(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new ae(e.programId),new ae(e.id)],l=yt({programId:u,poolId:c,owner:o,version:3}),m=Buffer.alloc(Ye.span);Ye.encode({instruction:11,amount:X(s)},m);let d=[k({pubkey:c}),k({pubkey:new ae(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new ae(t.lpVault)}),k({pubkey:r[0]}),k({pubkey:new ae(t.rewardInfos[0].vault)}),k({pubkey:Kr,isWritable:!1}),k({pubkey:_t,isWritable:!1})];if(a)for(let p of a)d.push(k({pubkey:p}));return new ut({programId:u,keys:d,data:m})}function Ps(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new ae(e.programId),new ae(e.id)],l=yt({programId:u,poolId:c,owner:o,version:3}),m=Buffer.alloc(Ye.span);Ye.encode({instruction:10,amount:X(s)},m);let d=[k({pubkey:c}),k({pubkey:new ae(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new ae(t.lpVault)}),k({pubkey:r[0]}),k({pubkey:new ae(t.rewardInfos[0].vault)}),k({pubkey:Kr,isWritable:!1}),k({pubkey:_t,isWritable:!1})];if(a)for(let p of a)d.push(k({pubkey:p}));return new ut({programId:u,keys:d,data:m})}function ks(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s,userAuxiliaryLedgers:a}=i,[u,c]=[new ae(e.programId),new ae(e.id)],l=yt({programId:u,poolId:c,owner:o,version:5}),m=Buffer.alloc(Ye.span);Ye.encode({instruction:11,amount:X(s)},m);let d=[k({pubkey:c}),k({pubkey:new ae(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new ae(t.lpVault)}),k({pubkey:r[0]}),k({pubkey:new ae(t.rewardInfos[0].vault)}),k({pubkey:Kr,isWritable:!1}),k({pubkey:_t,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(k({pubkey:r[p]})),d.push(k({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(k({pubkey:p}));return new ut({programId:u,keys:d,data:m})}function Ts(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:r,owner:o,amount:s}=i,[a,u]=[new ae(e.programId),new ae(e.id)],c=yt({programId:a,poolId:u,owner:o,version:6}),l=Buffer.alloc(Ye.span);Ye.encode({instruction:1,amount:X(s)},l);let m=[k({pubkey:_t,isWritable:!1}),k({pubkey:bs.programId,isWritable:!1}),k({pubkey:u}),k({pubkey:new ae(t.authority),isWritable:!1}),k({pubkey:new ae(t.lpVault)}),k({pubkey:c}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(k({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(k({pubkey:r[d]}));return new ut({programId:a,keys:m,data:l})}var Nn=class extends ge{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(Ie)){let n=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:Oi({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:r=Tn,txVersion:o}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new me(e.lpMint.address),lockInfo:{lockMint:ms,lockVault:ds},version:6,rewardInfos:t,programId:r},u=this.createTxBuilder(),c=n!=null?n:this.scope.ownerPubKey,l=Me({fromPublicKey:c,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(Sr.span);u.addInstruction({instructions:[Yc.createAccountWithSeed({fromPubkey:c,basePubkey:c,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:Sr.span,programId:a.programId})]});let{publicKey:d,nonce:p}=fs({programId:new me(a.programId),poolId:l.publicKey}),y=Cn({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),f=[],b=[];for(let P of a.rewardInfos){P.openTime>=P.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",P.openTime.toString()),isNaN(Mt[P.rewardType])&&this.logAndCreateError("rewardType error",P.rewardType),Number(P.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",P.perSecond),f.push(ys(P));let{rewardPubKey:T,newInstruction:I}=await this._getUserRewardInfo({rewardInfo:P,payer:c});I&&u.addInstruction(I),T||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let B=P.mint.equals(Ie)?new me(Ke.address):P.mint;b.push({rewardMint:B,rewardVault:Cn({programId:a.programId,poolId:l.publicKey,mint:B,type:"rewardVault"}),userRewardToken:T})}let g=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});g||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:A,instructionType:h}=As({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:d,lpVault:y,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:g,programId:a.programId,rewardInfo:b,rewardInfoConfig:f,nonce:p});return u.addInstruction({instructions:[A],instructionTypes:[h]}).versionBuild({txVersion:o,extInfo:{farmId:l.publicKey,farmAuthority:d,lpVault:y,lockUserAccount:g,nonce:p}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:r}){var b;let o=at[e.programId];o!==6&&this.logAndCreateError("invalid farm version ",o);let s=De((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,c=n.mint.equals(Ie)?new me(Ke.address):n.mint,l=a.rewardInfos.findIndex(g=>new me(g.mint.address).equals(c)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",c);let d=(b=m.vault)!=null?b:Ie,p=this.createTxBuilder(),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return f&&p.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),p.addInstruction({instructions:[Mi({payer:this.scope.ownerPubKey,rewardVault:d,userRewardTokenPub:y,farmKeys:a,rewardInfo:n})],instructionTypes:[M.FarmV6Restart]}).versionBuild({txVersion:r})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:r}){var l;let o=at[e.programId];o!==6&&this.logAndCreateError("invalid farm version ",o);let s=De((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,c=this.createTxBuilder();for(let m of n){let d=m.mint.equals(Ie)?new me(Ke.address):m.mint,p=a.rewardInfos.findIndex(h=>new me(h.mint.address).equals(d)),y=s.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",d);let f=(l=y.vault)!=null?l:Ie,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:u});g&&c.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let A=Mi({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});c.addInstruction({instructions:[A],instructionTypes:[M.FarmV6Restart]})}return c.versionBuild({txVersion:r})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:r,payer:o}=e,s=at[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=De((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,c=this.createTxBuilder(),l=r.mint.equals(Ie)?new me(Ke.address):r.mint,m=Cn({programId:new me(n.programId),poolId:new me(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:d,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:r,payer:u});return p&&c.addInstruction(p),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),r.mint=l,c.addInstruction({instructions:[_i({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:m,rewardInfo:r})],instructionTypes:[M.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:r,payer:o}=e,s=at[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=De((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,c=this.createTxBuilder();for(let l of r){let m=l.mint.equals(Ie)?new me(Ke.address):l.mint,d=Cn({programId:new me(n.programId),poolId:new me(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:l,payer:u});y&&c.addInstruction(y),p||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let f=_i({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:d,rewardInfo:{...l,mint:m}});c.addInstruction({instructions:[f],instructionTypes:[M.FarmV6CreatorAddReward]})}return c.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:r,feePayer:o,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:c,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:d}=n,p=at[d];Li(p)||this.logAndCreateError("invalid farm program:",n.programId);let[y,f]=[new me(n.programId),new me(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],g=yt({programId:y,poolId:f,owner:this.scope.ownerPubKey,version:p}),A=this.createTxBuilder();A.addCustomComputeBudget(l);let h={};for(let v of this.scope.account.tokenAccounts)if(a){let Z=ye(this.scope.ownerPubKey,v.mint,v.programId).publicKey;v.publicKey&&Z.equals(v.publicKey)&&(h[v.mint.toString()]=v.publicKey)}else h[v.mint.toString()]=v.publicKey;let P=b.lpMint,T=h[P.address];T||this.logAndCreateError("you don't have any lp","lp zero",h);let I=[];for(let v of m){let Z=s&&v.mint.address===$.toString(),J=h[v.mint.address];if(!J){let{account:te,instructionParams:et}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new me(v.mint.address),notUseTokenAccount:Z,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!Z,associatedOnly:Z?!1:a,checkCreateATAOwner:u});J=te,et&&A.addInstruction(et)}h[v.mint.address]=J,I.push(J)}let B,x=await this.scope.connection.getAccountInfo(g);if(x&&(B=Ni(p).decode(x.data)),n.programId!==Tn.toString()&&!B){let{instruction:v,instructionType:Z}=ws({id:f,programId:y,version:p,ledger:g,owner:this.scope.ownerPubKey});A.addInstruction({instructions:[v],instructionTypes:[Z]})}let K=Ri({version:p,rewardInfos:m,rewardTokenAccountsPublicKeys:I});K&&this.logAndCreateError(K);let O={amount:X(r),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:T,rewardAccounts:I,userAuxiliaryLedgers:c==null?void 0:c.map(v=>new me(v))},F=p===6?Ts(O):p===5?ks(O):Ps(O),Y={3:M.FarmV3Deposit,5:M.FarmV5Deposit,6:M.FarmV6Deposit};return A.addInstruction({instructions:[F],instructionTypes:[Y[p]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:r,deposited:o,useSOLBalance:s,feePayer:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:d}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let p=at[n.programId];Li(p)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],f=this.createTxBuilder();f.addCustomComputeBudget(m);let b={};for(let K of this.scope.account.tokenAccounts)if(u){let O=ye(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&O.equals(K.publicKey)&&(b[K.mint.toString()]=K.publicKey)}else b[K.mint.toString()]=K.publicKey;if(o)o.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else{let K=yt({programId:new me(n.programId),poolId:new me(n.id),owner:this.scope.ownerPubKey,version:p}),O=await this.scope.connection.getAccountInfo(K);O||this.logAndCreateError("no lp data",{farmId:n.id,version:p,ledgerData:O}),Ni(p).decode(O.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id})}let g=y.lpMint.address,A=s&&g===$.toString(),h=b[g.toString()];if(!h){let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new me(g),notUseTokenAccount:A,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:A?!1:u,checkCreateATAOwner:c});h=K,O&&f.addInstruction(O)}b[g.toString()]=h;let P=[];for(let K of d){let O=s&&K.mint.address===$.toString(),F=b[K.mint.address];if(!F){let{account:Y,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new me(K.mint.address),notUseTokenAccount:O,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!O,associatedOnly:O?!1:u,checkCreateATAOwner:c});F=Y,v&&f.addInstruction(v)}b[K.mint.address]=F,P.push(F)}let T=Ri({version:p,rewardInfos:d,rewardTokenAccountsPublicKeys:P});T&&this.logAndCreateError(T);let I={amount:X(r),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:h,rewardAccounts:P,userAuxiliaryLedgers:l==null?void 0:l.map(K=>new me(K))},B=p===6?Ln(I):p===5?Rn(I):On(I),x={3:M.FarmV3Withdraw,5:M.FarmV5Withdraw,6:M.FarmV6Withdraw};return f.addInstruction({instructions:[B],instructionTypes:[x[p]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var p;this.scope.checkOwner();let r=De((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),o=at[e.programId];o!==6&&this.logAndCreateError("invalid farm version",o);let s=e.rewardInfos.findIndex(y=>y.mint.address===Ie.toString()?new me(Ke.address):t),a=r.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let u=(p=a==null?void 0:a.vault)!=null?p:Ie,c=this.createTxBuilder(),l;if(t.equals(Ie)){let y=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Oi({...a,openTime:a.openTime,endTime:a.endTime,perSecond:new _(a.perSecond).mul(10**a.mint.decimals).toString()})});l=y.addresses.newAccount,c.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(l=await this.scope.account.getAssociatedTokenAccount(t),c.addInstruction({instructions:[zc(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[M.CreateATA]})):l=y}let{instruction:m,instructionType:d}=hs({programId:r.programId,id:r.id,authority:r.authority,lpVault:r.lpVault,rewardVault:u,userRewardToken:l,owner:this.scope.ownerPubKey});return c.addInstruction({instructions:[m],instructionTypes:[d]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:r,associatedOnly:o=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:u,computeBudgetConfig:c}=e,l=this.createTxBuilder(),m={};for(let y of this.scope.account.tokenAccounts)if(o){let f=ye(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>({...y,[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:A}=y,h=at[f],P=b.address,T=n&&P===$.toString(),I=m[P];if(!I){let{account:Y,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new me(P),notUseTokenAccount:T,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:T?!1:o,checkCreateATAOwner:s});I=Y,v&&l.addInstruction(v)}m[P.toString()]=I;let B=[];for(let Y of g){let v=n&&Y.mint.address===$.toString(),Z=m[Y.mint.address];if(!Z){let{account:J,instructionParams:te}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Y.mint.programId,mint:new me(Y.mint.address),notUseTokenAccount:v,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!v,associatedOnly:v?!1:o,checkCreateATAOwner:s});Z=J,te&&l.addInstruction(te)}m[Y.mint.address]=Z,B.push(Z)}let x=p[A],K={amount:ve,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:x,lpAccount:I,rewardAccounts:B,userAuxiliaryLedgers:a==null?void 0:a.map(Y=>new me(Y))},O=h===6?Ln(K):h===5?Rn(K):On(K),F={3:M.FarmV3Withdraw,5:M.FarmV5Withdraw,6:M.FarmV6Withdraw};l.addInstruction({instructions:[O],instructionTypes:[F[h]]})}return u===1?l.sizeCheckBuild({computeBudgetConfig:c}):l.sizeCheckBuildV0({computeBudgetConfig:c})}};import{PublicKey as Xe}from"@solana/web3.js";import{NATIVE_MINT as ia,TOKEN_PROGRAM_ID as Er}from"@solana/spl-token";var uw=N([We("mintAuthorityOption"),S("mintAuthority"),w("supply"),E("decimals"),E("isInitialized"),We("freezeAuthorityOption"),S("freezeAuthority")]);import{PublicKey as dw}from"@solana/web3.js";import{MintLayout as fw,TOKEN_PROGRAM_ID as bw}from"@solana/spl-token";var Is=i=>new be({mint:i.address,decimals:i.decimals,symbol:i.symbol,name:i.name});import{TOKEN_PROGRAM_ID as Cr,ASSOCIATED_TOKEN_PROGRAM_ID as al}from"@solana/spl-token";import{PublicKey as bt,TransactionInstruction as an,SystemProgram as Os,SYSVAR_RENT_PUBKEY as Dw}from"@solana/web3.js";var Ei=N([E("instruction"),w("amountIn"),w("minAmountOut")]),Fi=N([E("instruction"),w("maxAmountIn"),w("amountOut")]),Lw=N([E("instruction"),E("nonce")]),Hc=N([E("instruction"),E("nonce"),w("startTime")]),Rw=N([w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalValue"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),G("swapBaseInAmount"),G("swapQuoteOutAmount"),w("swapBase2QuoteFee"),G("swapQuoteInAmount"),G("swapBaseOutAmount"),w("swapQuote2BaseFee"),S("baseVault"),S("quoteVault"),S("baseMint"),S("quoteMint"),S("lpMint"),S("openOrders"),S("marketId"),S("marketProgramId"),S("targetOrders"),S("withdrawQueue"),S("lpVault"),S("owner"),w("lpReserve"),D(w(),3,"padding")]),Ow=N([w("accountType"),w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalsValue"),w("abortTradeFactor"),w("priceTickMultiplier"),w("priceTick"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),G("swapBaseInAmount"),G("swapQuoteOutAmount"),G("swapQuoteInAmount"),G("swapBaseOutAmount"),w("swapQuote2BaseFee"),w("swapBase2QuoteFee"),S("baseVault"),S("quoteVault"),S("baseMint"),S("quoteMint"),S("lpMint"),S("modelDataAccount"),S("openOrders"),S("marketId"),S("marketProgramId"),S("targetOrders"),S("owner"),D(w(),64,"padding")]),Vi=N([E("instruction"),w("baseAmountIn"),w("quoteAmountIn"),w("fixedSide")]),vi=N([E("instruction"),w("amountIn")]);var xs=N([w("fee")]);import{PublicKey as jc}from"@solana/web3.js";var sn=new jc("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Gt=5e4,Qc=N([w("x"),w("y"),w("price")]),Zc=N([w("accountType"),w("status"),w("multiplier"),w("validDataCount"),D(Qc,Gt,"DataElement")]);function $c(i,e){return[0,Gt-2]}function Jc(i){return[0,Gt-2]}function el(i){return[0,Gt-2]}function tl(i,e,t){let[n,r]=$c(e,t),o=n,s=r,a=0,u=e*i.multiplier/t;for(;o<=s;){if(a=Math.floor((s+o)/2),a===0||a>=Gt-2)return[a,a,!1];let c=i.DataElement[a].x*i.multiplier/i.DataElement[a].y,l=i.DataElement[a-1].x*i.multiplier/i.DataElement[a-1].y,m=i.DataElement[a+1].x*i.multiplier/i.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===l)return[a-1,a-1,!0];if(u===m)return[a+1,a+1,!0];if(u<l)s=a-1;else{if(u>l&&u<c)return[a-1,a,!0];if(u>c&&u<m)return[a,a+1,!0];o=a+1}}return[a,a,!1]}function Di(i,e,t){let[n,r,o]=tl(i,e,t);if(!o)return 0;if(n===r){let s=i.DataElement[n].x;return e*i.multiplier/s}else{let s=i.DataElement[n].x,a=i.DataElement[n].y,u=i.DataElement[r].x,c=i.DataElement[r].y,l=t*(u*a-s*c),m=s*l,d=(u-s)*(e*a-s*t)*c,p=m+d;return e*i.multiplier*l/p}}function Ut(i,e,t){return e*i.multiplier/t}function Bs(i,e,t){return e*t/i.multiplier}function nl(i,e){let[t,n]=Jc(e),r=t,o=n,s=0,a=e;for(;r<o;){if(s=Math.floor((o+r)/2),s<=0||s>Gt-2)return[s,s,!1];let u=i.DataElement[s].x,c=i.DataElement[s-1].x,l=i.DataElement[s+1].x;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<c)o=s-1;else{if(a>c&&a<u)return[s-1,s,!0];if(a>u&&a<l)return[s,s+1,!0];r=s+1}}return[s,s,!1]}function rl(i,e){let[t,n]=el(e),r=t,o=n,s=0,a=e;for(;r<=o;){if(s=Math.floor((o+r)/2),s<=0||s>=Gt-2)return[s,s,!1];let u=i.DataElement[s].y,c=i.DataElement[s-1].y,l=i.DataElement[s+1].y;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)r=s+1;else{if(a<c&&a>u)return[s-1,s,!0];if(a<u&&a>l)return[s,s+1,!0];o=s-1}}return[s,s,!1]}function Ss(i,e,t,n){let r=n?e+t:e-t,[o,s,a]=nl(i,r);if(!a)return[0,0,!1,a];if(o===s)return[i.DataElement[s].price,i.DataElement[s].y,!1,a];{let u=i.DataElement[o].x,c=i.DataElement[s].x,l=i.DataElement[o].price,m=i.DataElement[s].price,d=i.DataElement[o].y,p=i.DataElement[s].y;if(e>=u&&e<=c)return n?[m,p,!0,a]:[l,d,!0,a];{let y,f;return n?(y=l+(m-l)*(e-u)/(c-u),f=d-(r-u)*i.multiplier/m):(y=l+(m-l)*(e-u)/(c-u),f=p+(c-r)*i.multiplier/l),[y,f,!1,a]}}}function il(i,e,t,n){let r=n?e-t:e+t,[o,s,a]=rl(i,r);if(!a)return[0,0,!1,a];if(o===s)return[i.DataElement[s].price,i.DataElement[s].x,!1,a];{let u=i.DataElement[o].x,c=i.DataElement[s].x,l=i.DataElement[o].price,m=i.DataElement[s].price,d=i.DataElement[o].y,p=i.DataElement[s].y;if(e>=p&&e<=d)return n?[m,c,!0,a]:[l,u,!0,a];{let y,f;return n?(y=l+(m-l)*(d-e)/(d-p),f=u+m*(d-r)/i.multiplier):(y=l+(m-l)*(d-e)/(d-p),f=c-l*(r-p)/i.multiplier),[y,f,!1,a]}}}function ol(i,e){let t=Ss(i,e,0,!1);return t[3]?t[0]:0}function Ks(i,e,t,n){let r=Di(i,e,t),o=Ut(i,e,r),s=Ut(i,t,r),a=Ut(i,n,r),u=!0,[c,l,m,d]=Ss(i,o,a,u);if(!d)return 0;if(m)return n*i.multiplier/c;{let p=s-l;return Bs(i,p,r)}}function Cs(i,e,t,n){let r=Di(i,e,t),o=Ut(i,e,r),s=Ut(i,t,r),a=Ut(i,n,r),u=!1,[c,l,m,d]=il(i,s,a,u);if(!d)return 0;if(m)return n*c/i.multiplier;{let p=o-l;return Bs(i,p,r)}}function sl(i){let e=Zc.decode(i);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Ls(i,e,t,n){let r=ol(i,Ut(i,e,Di(i,e,t)))/i.multiplier;return n?r:1/r}var Mn=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(sn);e&&(this._layoutData=sl(e==null?void 0:e.data))}}};var Rs=re("Raydium_liquidity_instruction");function Ns(i){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:r,quoteAmountIn:o,fixedSide:s}=i,a=Buffer.alloc(Vi.span);Vi.encode({instruction:3,baseAmountIn:X(r),quoteAmountIn:X(o),fixedSide:s==="base"?ve:Ro},a);let u=[k({pubkey:Cr,isWritable:!1}),k({pubkey:new bt(e.id)}),k({pubkey:new bt(t.authority),isWritable:!1}),k({pubkey:new bt(t.openOrders),isWritable:!1}),k({pubkey:new bt(t.targetOrders)}),k({pubkey:new bt(e.lpMint.address)}),k({pubkey:new bt(t.vault.A)}),k({pubkey:new bt(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(k({pubkey:sn})),u.push(k({pubkey:new bt(e.marketId),isWritable:!1}),k({pubkey:n.baseTokenAccount}),k({pubkey:n.quoteTokenAccount}),k({pubkey:n.lpTokenAccount}),k({pubkey:n.owner,isWritable:!1,isSigner:!0}),k({pubkey:new bt(t.marketEventQueue),isWritable:!1})),new an({programId:new bt(e.programId),keys:u,data:a})}function Wi(i){let{poolInfo:e,poolKeys:t,userKeys:n,amountIn:r}=i,o=De(t),s=4;if(e.pooltype.includes("StablePool")&&(s=5),s===4||s===5){let a=Buffer.alloc(vi.span);vi.encode({instruction:4,amountIn:X(r)},a);let u=[k({pubkey:Cr,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.openOrders}),k({pubkey:o.targetOrders}),k({pubkey:o.mintLp.address}),k({pubkey:o.vault.A}),k({pubkey:o.vault.B})];return s===5?u.push(k({pubkey:sn})):(u.push(k({pubkey:o.id})),u.push(k({pubkey:o.id}))),u.push(k({pubkey:o.marketProgramId,isWritable:!1}),k({pubkey:o.marketId}),k({pubkey:o.marketBaseVault}),k({pubkey:o.marketQuoteVault}),k({pubkey:o.marketAuthority,isWritable:!1}),k({pubkey:n.lpTokenAccount}),k({pubkey:n.baseTokenAccount}),k({pubkey:n.quoteTokenAccount}),k({pubkey:n.owner,isWritable:!1,isSigner:!0}),k({pubkey:o.marketEventQueue}),k({pubkey:o.marketBids}),k({pubkey:o.marketAsks})),new an({programId:o.programId,keys:u,data:a})}return new an({programId:o.programId,keys:[]})}function Ms({programId:i,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:r,coinMint:o,pcMint:s,coinVault:a,pcVault:u,withdrawQueue:c,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:A,openTime:h,coinAmount:P,pcAmount:T,ammConfigId:I,feeDestinationId:B}){let x=N([E("instruction"),E("nonce"),w("openTime"),w("pcAmount"),w("coinAmount")]),K=[{pubkey:Cr,isSigner:!1,isWritable:!1},{pubkey:al,isSigner:!1,isWritable:!1},{pubkey:Os.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:I,isSigner:!1,isWritable:!1},{pubkey:B,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],O=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:A,openTime:h,coinAmount:P,pcAmount:T},O),{instruction:new an({keys:K,programId:i,data:O}),instructionType:M.AmmV4CreatePool}}function ul({poolKeys:i,userKeys:e,amountIn:t,minAmountOut:n},r){let o=De(i),s=Buffer.alloc(Ei.span);Ei.encode({instruction:9,amountIn:X(t),minAmountOut:X(n)},s);let a=[k({pubkey:Cr,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.openOrders})];return r===4&&a.push(k({pubkey:o.targetOrders})),a.push(k({pubkey:o.vault.A}),k({pubkey:o.vault.B})),r===5&&a.push(k({pubkey:sn})),a.push(k({pubkey:o.marketProgramId,isWritable:!1}),k({pubkey:o.marketId}),k({pubkey:o.marketBids}),k({pubkey:o.marketAsks}),k({pubkey:o.marketEventQueue}),k({pubkey:o.marketBaseVault}),k({pubkey:o.marketQuoteVault}),k({pubkey:o.marketAuthority,isWritable:!1}),k({pubkey:e.tokenAccountIn}),k({pubkey:e.tokenAccountOut}),k({pubkey:e.owner,isWritable:!1})),new an({programId:o.programId,keys:a,data:s})}function cl({poolKeys:i,userKeys:e,maxAmountIn:t,amountOut:n},r){let o=De(i),s=Buffer.alloc(Fi.span);Fi.encode({instruction:11,maxAmountIn:X(t),amountOut:X(n)},s);let a=[k({pubkey:Os.programId,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.openOrders}),k({pubkey:o.targetOrders}),k({pubkey:o.vault.A}),k({pubkey:o.vault.B})];return r===5&&a.push(k({pubkey:sn})),a.push(k({pubkey:o.marketProgramId,isWritable:!1}),k({pubkey:o.marketId}),k({pubkey:o.marketBids}),k({pubkey:o.marketAsks}),k({pubkey:o.marketEventQueue}),k({pubkey:o.marketBaseVault}),k({pubkey:o.marketQuoteVault}),k({pubkey:o.marketAuthority,isWritable:!1}),k({pubkey:e.tokenAccountIn}),k({pubkey:e.tokenAccountOut}),k({pubkey:e.owner,isWritable:!1,isSigner:!0})),new an({programId:o.programId,keys:a,data:s})}function _s(i){let{poolKeys:e,version:t,userKeys:n,amountIn:r,amountOut:o,fixedSide:s}=i;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return ul({...a,amountIn:r,minAmountOut:o},t);if(s==="out")return cl({...a,maxAmountIn:r,amountOut:o},t);Rs.logWithError("invalid params","params",i)}throw Rs.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{TOKEN_PROGRAM_ID as Re,TOKEN_2022_PROGRAM_ID as vt,ASSOCIATED_TOKEN_PROGRAM_ID as Qs}from"@solana/spl-token";import{PublicKey as V,TransactionInstruction as ct,SystemProgram as un,Keypair as ji}from"@solana/web3.js";import Zs from"bn.js";import wl from"bn.js";function Lr(i){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,i,!1),new Uint8Array(e)}function qi(i,e){let t=0;for(let n=i-1;n>=0&&!e.testn(n);n--)t++;return t}function Ui(i,e){let t=0;for(let n=0;n<i&&!e.testn(n);n++)t++;return t}function _n(i,e){for(let t=0;t<i;t++)if(e.testn(t))return!1;return!0}function Es(i,e){return _n(i,e)?null:qi(i,e)}function Fs(i,e){return _n(i,e)?null:Ui(i,e)}var eA=Buffer.from("amm_config","utf8"),ll=Buffer.from("pool","utf8"),ml=Buffer.from("pool_vault","utf8"),dl=Buffer.from("pool_reward_vault","utf8"),Vs=Buffer.from("position","utf8"),pl=Buffer.from("tick_array","utf8"),fl=Buffer.from("operation","utf8"),yl=Buffer.from("pool_tick_array_bitmap_extension","utf8");function vs(i,e,t,n){return se([ll,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Gi(i,e,t){return se([ml,e.toBuffer(),t.toBuffer()],i)}function Ds(i,e,t){return se([dl,e.toBuffer(),t.toBuffer()],i)}function ce(i,e,t){return se([pl,e.toBuffer(),Lr(t)],i)}function Xt(i,e,t,n){return se([Vs,e.toBuffer(),Lr(t),Lr(n)],i)}function Ze(i,e){return se([Vs,e.toBuffer()],i)}function Rr(i){return se([Buffer.from("metadata","utf8"),Jt.toBuffer(),i.toBuffer()],Jt)}function En(i){return se([fl],i)}function gt(i,e){return se([yl,e.toBuffer()],i)}import wt from"bn.js";var ke=new wt(0),At=new wt(1),It=new wt(-1),He=new wt(1).shln(64),Or=new wt(1).shln(128),Xi=He.sub(At),Fn=64,Ws=Or.subn(1),_e=-443636,qe=-_e,Et=new wt("4295048016"),Ft=new wt("79226673521066979257578248091"),qs=16,Us="59543866431248",Gs="184467440737095516",Xs="15793534762490258745",Nr=new wt(10).pow(new wt(6));var zs={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},rA=new wt("18446744073700000000");var bl=15,ie=class{static async getTickArrays(e,t,n,r,o,s,a){let u=[],c=q.getTickArrayStartIndexByTick(r,o),l=q.getInitializedTickArrayInRange(s,a,o,c,Math.floor(bl/2));for(let p=0;p<l.length;p++){let{publicKey:y}=ce(t,n,l[p]);u.push(y)}let m=(await dt(e,u)).map(p=>p!==null?Vn.decode(p.data):null),d={};for(let p=0;p<u.length;p++){let y=m[p];y!==null&&(d[y.startTickIndex]={...y,address:u[p]})}return d}static nextInitializedTick(e,t,n,r,o,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,r,o,s);for(;a==null||a.liquidityGross.lten(0);){if(c=q.getNextTickArrayStartIndex(c,o,s),this.checkIsValidStartIndex(c,o))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,r,o){let s=Math.floor(e/ie.tickCount(t)),a=n?q.searchLowBitFromStart(r,o,s-1,1,t):q.searchHightBitFromStart(r,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,r){let o;if(r){let a=xe-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a-1}}else{let a=0;for(;a<xe;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a+1}}let{publicKey:s}=ce(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,r,o,s){let a=q.getTickArrayStartIndexByTick(r,o),u=Math.floor((r-a)/o),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u-1}else for(u=u+1;u<xe;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u+1}let{publicKey:m}=ce(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(q.checkIsOutOfBoundary(e)){if(e>qe)return!1;let n=q.getTickArrayStartIndexByTick(_e,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return xe*e}};import ee from"bn.js";import{PublicKey as Vt}from"@solana/web3.js";import Ae from"bn.js";var zi=14,xt=class{static maxTickInTickarrayBitmap(e){return e*xe*zt}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(r+=1);let o=n*r;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,r){if(!ie.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=r?t-ie.tickCount(n):t+ie.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*xe,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(r){let l=e.shln(1024-c-1),m=Es(1024,l);if(m!==null){let d=(c-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(c),m=Fs(1024,l);if(m!==null){let d=(c+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-ie.tickCount(n)}}}},vn=class{static getBitmapOffset(e,t){if(!ie.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=xt.maxTickInTickarrayBitmap(t),r=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&r--,r}static getBitmap(e,t,n){let r=this.getBitmapOffset(e,t);return e<0?{offset:r,tickarrayBitmap:n.negativeTickArrayBitmap[r]}:{offset:r,tickarrayBitmap:n.positiveTickArrayBitmap[r]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:r}=this.extensionTickBoundary(t);if(e>=r&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=xt.maxTickInTickarrayBitmap(e),n=-t;if(qe<=t)throw Error(`extensionTickBoundary check error: ${qe}, ${t}`);if(n<=_e)throw Error(`extensionTickBoundary check error: ${n}, ${_e}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:r}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:q.mergeTickArrayBitmap(r).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,r){let o=ie.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,r);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,r){let{minValue:o,maxValue:s}=xt.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(r){let u=q.mergeTickArrayBitmap(e).shln(zt-1-a),c=_n(512,u)?null:qi(512,u);if(c!==null){let l=t-c*ie.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let u=q.mergeTickArrayBitmap(e).shrn(a),c=_n(512,u)?null:Ui(512,u);if(c!==null){let l=t+c*ie.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ie.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%xt.maxTickInTickarrayBitmap(t),r=Math.floor(n/ie.tickCount(t));return e<0&&n!=0&&(r=zt-r),r}};import ht from"bn.js";var Dn=class{static getfeeGrowthInside(e,t,n){let r=new ht(0),o=new ht(0);e.tickCurrent>=t.tick?(r=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(r=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new ht(0),a=new ht(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=H.wrappingSubU128(H.wrappingSubU128(e.feeGrowthGlobalX64A,r),s),c=H.wrappingSubU128(H.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,r){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=H.mulDivFloor(H.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,He),u=t.tokenFeesOwedA.add(a),c=H.mulDivFloor(H.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,He),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,r){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,r),a=H.mulDivFloor(H.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,He),u=t.tokenFeesOwedA.add(a),c=H.mulDivFloor(H.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,He),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,r){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=H.wrappingSubU128(u,c.growthInsideLastX64),m=H.mulDivFloor(l,t.liquidity,He),d=c.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,r){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,r,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=H.wrappingSubU128(u,c.growthInsideLastX64),m=H.mulDivFloor(l,t.liquidity,He),d=c.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,r){let o=[];for(let s=0;s<r.length;s++){let a=new ht(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new ht(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(H.wrappingSubU128(H.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),u))}return o}static getRewardGrowthInsideV2(e,t,n,r){let o=[];for(let s=0;s<r.length;s++){let a=new ht(0);t.liquidityGross.eqn(0)?a=r[s].rewardGrowthGlobalX64:e<t.tick?a=r[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new ht(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=r[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(H.wrappingSubU128(H.wrappingSubU128(r[s].rewardGrowthGlobalX64,a),u))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:r,add:o,epochInfo:s}){var b,g,A,h;let a=Q.priceToSqrtPriceX64(new _(e.price),e.mintA.decimals,e.mintB.decimals),u=Q.getSqrtPriceX64FromTick(t.tickLower),c=Q.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+r:1-r,m=oe.getAmountsFromLiquidity(a,u,c,n,o),[d,p]=[de(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),de(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[y,f]=[de(new ht(new _(m.amountA.toString()).mul(l).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,s,!0),de(new ht(new _(m.amountB.toString()).mul(l).toFixed(0)),(h=e.mintB.extensions)==null?void 0:h.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Wt(d.expirationTime,p.expirationTime)}}};import{TOKEN_2022_PROGRAM_ID as Ys}from"@solana/spl-token";var Ee=class{static getOutputAmountAndRemainAccounts(e,t,n,r,o){let s=n.toBase58()===e.mintA.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:y}=Yt.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r,c,o);return a.push(...d),{expectedAmountOut:m.mul(It),remainingAccounts:a,executionPrice:p,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,r,o){let s=n.toBase58()===e.mintB.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=ce(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:y}=Yt.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,r.mul(It),c,o);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:r}=Ee.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?vn.checkTickArrayIsInit(ie.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):q.checkTickArrayIsInitialized(q.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ce(e.programId,e.id,r);return{isExist:!0,startIndex:r,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ie.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=ce(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ie.tickCount(e.tickSpacing)),r=t?q.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):q.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return r.length>0?{isExist:!0,nextStartIndex:r[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ie.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:r,tickIndex:o}=xt.nextInitializedTickArrayStartIndex(q.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(r)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=vn.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<_e||t>qe)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:r,rewardInfos:o}){var a,u,c;let s=[];for(let l=0;l<o.length;l++){let m=o[l],d=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(d===void 0)throw Error("get new reward mint info error");let p={...m,perSecond:H.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Vt(d)};if(p.tokenMint.equals(Vt.default))continue;if(n<=p.openTime.toNumber()||r.eq(ke)){s.push(p);continue}let y=new Ae(Math.min(p.endTime.toNumber(),n)),f=y.sub(p.lastUpdateTime),b=H.mulDivFloor(f,p.emissionsPerSecondX64,r),g=p.rewardGrowthGlobalX64.add(b),A=H.mulDivFloor(f,p.emissionsPerSecondX64,He),h=p.rewardTotalEmissioned.add(A);s.push({...p,rewardGrowthGlobalX64:g,rewardTotalEmissioned:h,lastUpdateTime:y})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:r}=this.tickRange(e);for(let o of t){let s=q.getTickArrayStartIndexByTick(o,e);if(s>=n||s<r)return!0}return!1}static tickRange(e){let t=xt.maxTickInTickarrayBitmap(e),n=-t;return t>qe&&(t=ie.getArrayStartIndex(qe,e)+ie.tickCount(e)),n<_e&&(n=ie.getArrayStartIndex(_e,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ie.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ie.tickCount(t)*zt}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let r=await mr(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of r)s.accountInfo!==null&&(o[s.pubkey.toString()]=Hs.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let r={},o=[];for(let u of t){let c=q.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=q.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:d}=ce(u.programId,u.id,m);o.push({pubkey:d}),r[d.toString()]=u.id}}let s=await mr(e,o,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=r[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=Vn.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]={...l,address:u.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:r=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of u)for(let p of s)c.push(Ze(p,d).publicKey);let l=await dt(t,c,{batchRequest:r}),m={};for(let d of l){if(d===null)continue;let p=_r.decode(d.data),y=p.poolId.toString(),f=e.find(x=>x.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=q._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),A=q._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:h,amountB:P}=oe.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,p.liquidity,!1),T=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:A.price,amountA:h,amountB:P,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(x=>({...x,pendingReward:new Ae(0)})),leverage:T,tokenFeeAmountA:new Ae(0),tokenFeeAmountB:new Ae(0)}];let I=await q.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),B=await q.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=I,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=B}if(o){let d=Object.values(m),p=await dt(t,d,{batchRequest:r}),y={};for(let f=0;f<d.length;f++){let b=p[f];if(b===null)continue;let g=d[f].toString();y[g]=Vn.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let A=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,h=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,P=y[m[A].toString()],T=y[m[h].toString()],I=P.ticks[q.getTickOffsetInArray(g.tickLower,f.tickSpacing)],B=T.ticks[q.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:K}=await Dn.GetPositionFees(f,g,I,B),O=await Dn.GetPositionRewards(f,g,I,B);g.tokenFeeAmountA=x.gte(new Ae(0))?x:new Ae(0),g.tokenFeeAmountB=K.gte(new Ae(0))?K:new Ae(0);for(let F=0;F<O.length;F++)g.rewardInfos[F].pendingReward=O[F].gte(new Ae(0))?O[F]:new Ae(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:r,amountIn:o,slippage:s,priceLimit:a=new _(0)}){var O;let u,c=n.toBase58()===e.mintA.address,[l,m]=c?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new _(0))?u=c?Et.add(new Ae(1)):Ft.sub(new Ae(1)):u=Q.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let d=de(o,l,r,!1),{expectedAmountOut:p,remainingAccounts:y,executionPrice:f,feeAmount:b}=Ee.getOutputAmountAndRemainAccounts(e,t,n,d.amount.sub((O=d.fee)!=null?O:ke),u),g=de(p,m,r,!1),A=Q.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),h=c?A:new _(1).div(A),P=p.mul(new Ae(Math.floor((1-s)*1e10))).div(new Ae(1e10)),T=de(P,m,r,!1),I=c?e.currentPrice:new _(1).div(e.currentPrice),B=new _(h).sub(I).abs(),x=I,K=new ze(new _(B).mul(10**15).toFixed(0),new _(x).mul(10**15).toFixed(0));return{realAmountIn:d,amountOut:g,minAmountOut:T,expirationTime:Wt(d.expirationTime,g.expirationTime),currentPrice:e.currentPrice,executionPrice:h,priceImpact:K,fee:b,remainingAccounts:y}}static async computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:r,slippage:o,epochInfo:s}){let a=r.address===e.mintB.address,[u,c]=a?[e.mintA,e.mintB]:[e.mintB,e.mintA],[l,m]=[new be({...u,mint:u.address,isToken2022:u.programId===Ys.toBase58()}),new be({...c,mint:c.address,isToken2022:c.programId===Ys.toBase58()})],{realAmountIn:d,amountOut:p,minAmountOut:y,expirationTime:f,currentPrice:b,executionPrice:g,priceImpact:A,fee:h,remainingAccounts:P}=await Ee.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Vt(u.address),amountIn:n,slippage:o,epochInfo:s}),T={...d,amount:new we(l,d.amount),fee:d.fee===void 0?void 0:new we(l,d.fee)},I={...p,amount:new we(m,p.amount),fee:p.fee===void 0?void 0:new we(m,p.fee)},B={...y,amount:new we(m,y.amount),fee:y.fee===void 0?void 0:new we(m,y.fee)},x=new Qe({baseToken:l,denominator:new Ae(10).pow(new Ae(20+l.decimals)),quoteToken:m,numerator:b.mul(new _(10**(20+m.decimals))).toFixed(0)}),K=new Qe({baseToken:l,denominator:new Ae(10).pow(new Ae(20+l.decimals)),quoteToken:m,numerator:g.mul(new _(10**(20+m.decimals))).toFixed(0)}),O=new we(l,h);return{realAmountIn:T,amountOut:I,minAmountOut:B,expirationTime:f,currentPrice:x,executionPrice:K,priceImpact:A,fee:O,remainingAccounts:P}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:r}){var y,f,b;let o=e[t],s=q.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=q.getTickPrice({poolInfo:e,tick:r,baseIn:!0}).price.toNumber(),u=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-u,m=a-s,d=o.priceMax-o.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:o.feeApr*p,rewardsApr:[(y=o.rewardApr[0])!=null?y:0*p,(f=o.rewardApr[1])!=null?f:0*p,(b=o.rewardApr[2])!=null?b:0*p],apr:o.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:r,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=r[en(e.mintA.address).toString()],d=r[en(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=Q.priceToSqrtPriceX64(new _(e.price),e.mintA.decimals,e.mintB.decimals),b=Q.getSqrtPriceX64FromTick(s),g=Q.getSqrtPriceX64FromTick(a),{amountSlippageA:A,amountSlippageB:h}=oe.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:P,amountSlippageB:T}=oe.getAmountsFromLiquidityWithSlippage(f,b,g,o,!1,!1,0),I=new _(A.toString()).div(new _(10).pow(p)).mul(m.value).add(new _(h.toString()).div(new _(10).pow(y)).mul(d.value)),B=new _(P.toString()).div(new _(10).pow(p)).mul(m.value).add(new _(T.toString()).div(new _(10).pow(y)).mul(d.value)),x=B.div(I.add(B)).div(B),O=new _(l.volumeFee).mul(365).div(c).mul(x).mul(100).toNumber(),F=3600*24*365,Y=e.rewardDefaultInfos.map(v=>{var te,et;let Z=v.mint.decimals,J=r[v.mint.address];return u<((te=v.startTime)!=null?te:0)||u>((et=v.endTime)!=null?et:0)||!v.perSecond||!J||Z===void 0?0:new _(J.value).mul(new _(v.perSecond).mul(F)).div(new _(10).pow(Z)).mul(x).mul(100).toNumber()});return{feeApr:O,rewardsApr:Y,apr:O+Y.reduce((v,Z)=>v+Z,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:r,amount:o,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var g,A;let l=Q.priceToSqrtPriceX64(new _(e.price),e.mintA.decimals,e.mintB.decimals),m=Q.getSqrtPriceX64FromTick(n),d=Q.getSqrtPriceX64FromTick(r),p=a?1-s:1+s,y=de(o,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!c),f=new Ae(new _(y.amount.sub((A=y.fee)!=null?A:ke).toString()).mul(p).toFixed(0)),b;if(l.lte(m))b=t?oe.getLiquidityFromTokenAmountA(m,d,f,!a):new Ae(0);else if(l.lte(d)){let h=oe.getLiquidityFromTokenAmountA(l,d,f,!a),P=oe.getLiquidityFromTokenAmountB(m,l,f);b=t?h:P}else b=t?new Ae(0):oe.getLiquidityFromTokenAmountB(m,d,f);return Ee.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:r,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:r,liquidity:o,slippage:s,add:a}){var b,g,A,h;let u=Q.getSqrtPriceX64FromTick(n),c=Q.getSqrtPriceX64FromTick(r),l=a?1+s:1-s,m=oe.getAmountsFromLiquidity(Q.priceToSqrtPriceX64(new _(t.price),t.mintA.decimals,t.mintB.decimals),u,c,o,a),[d,p]=[de(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),de(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[de(m.amountA.muln(l),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),de(m.amountB.muln(l),(h=t.mintB.extensions)==null?void 0:h.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Wt(d.expirationTime,p.expirationTime)}}static async fetchComputeClmmInfo({owner:e,connection:t,poolInfo:n}){let r=await t.getAccountInfo(new Vt(n.id));if(!r)throw new Error(`pool not found ${n.id}`);let o=Mr.decode(r.data),s=gt(e,new Vt(n.id)).publicKey,a=await Ee.fetchExBitmaps({connection:t,exBitmapAddress:[s],batchRequest:!1});return{...o,id:new Vt(n.id),programId:new Vt(n.programId),mintA:n.mintA,mintB:n.mintB,ammConfig:{...n.config,id:new Vt(n.config.id),fundOwner:""},currentPrice:new _(n.price),exBitmapInfo:a[s.toBase58()],startTime:o.startTime.toNumber()}}};var H=class{static mulDivRoundingUp(e,t,n){let r=e.mul(t),o=r.div(n);return r.mod(n).eq(ke)||(o=o.add(At)),o}static mulDivFloor(e,t,n){if(n.eq(ke))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(ke))throw new Error("division by 0");return e.mul(t).add(n.sub(At)).div(n)}static x64ToDecimal(e,t){return new _(e.toString()).div(_.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new ee(e.mul(_.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Or).sub(t).mod(Or)}};function Be(i,e){return Yi(i.mul(e),64,256)}function gl(i,e,t){let n=i.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Yi(i,e,t){let n=i.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var Q=class{static sqrtPriceX64ToPrice(e,t,n){return H.x64ToDecimal(e).pow(2).mul(_.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return H.decimalToX64(e.mul(_.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,r){if(!e.gt(ke))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ke))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,r){if(!e.gt(ke))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ke))throw new Error("liquidity must greater than 0");return r?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,r){if(n.eq(ke))return e;let o=t.shln(Fn);if(r){let s=o,a=o.add(n.mul(e));return a.gte(s)?H.mulDivCeil(s,e,a):H.mulDivRoundingUp(s,At,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return H.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,r){let o=n.shln(Fn);if(r)return e.add(o.div(t));{let s=H.mulDivRoundingUp(o,At,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<_e||e>qe)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new ee("18445821805675395072"):new ee("18446744073709551616");return(t&2)!=0&&(n=Be(n,new ee("18444899583751176192"))),(t&4)!=0&&(n=Be(n,new ee("18443055278223355904"))),(t&8)!=0&&(n=Be(n,new ee("18439367220385607680"))),(t&16)!=0&&(n=Be(n,new ee("18431993317065453568"))),(t&32)!=0&&(n=Be(n,new ee("18417254355718170624"))),(t&64)!=0&&(n=Be(n,new ee("18387811781193609216"))),(t&128)!=0&&(n=Be(n,new ee("18329067761203558400"))),(t&256)!=0&&(n=Be(n,new ee("18212142134806163456"))),(t&512)!=0&&(n=Be(n,new ee("17980523815641700352"))),(t&1024)!=0&&(n=Be(n,new ee("17526086738831433728"))),(t&2048)!=0&&(n=Be(n,new ee("16651378430235570176"))),(t&4096)!=0&&(n=Be(n,new ee("15030750278694412288"))),(t&8192)!=0&&(n=Be(n,new ee("12247334978884435968"))),(t&16384)!=0&&(n=Be(n,new ee("8131365268886854656"))),(t&32768)!=0&&(n=Be(n,new ee("3584323654725218816"))),(t&65536)!=0&&(n=Be(n,new ee("696457651848324352"))),(t&131072)!=0&&(n=Be(n,new ee("26294789957507116"))),(t&262144)!=0&&(n=Be(n,new ee("37481735321082"))),e>0&&(n=Ws.div(n)),n}static getTickFromPrice(e,t,n){return Q.getTickFromSqrtPriceX64(Q.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ft)||e.lt(Et))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new ee(t-64),r=gl(n,32,128),o=new ee("8000000000000000","hex"),s=0,a=new ee(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new ee(0))&&s<qs;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),a=a.add(o.mul(y)),o=o.shrn(1),s+=1}let c=a.shrn(32),m=r.add(c).mul(new ee(Us)),d=Yi(m.sub(new ee(Gs)),64,128).toNumber(),p=Yi(m.add(new ee(Xs)),64,128).toNumber();return d==p?d:Q.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Ht=class{static getTickWithPriceAndTickspacing(e,t,n,r){let s=Q.getTickFromSqrtPriceX64(Q.priceToSqrtPriceX64(e,n,r))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,r){let o=Ht.getTickWithPriceAndTickspacing(e,t,n,r),s=Q.getSqrtPriceX64FromTick(o);return Q.sqrtPriceX64ToPrice(s,n,r)}},oe=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ke))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(Fn),s=t.sub(e);return r?H.mulDivRoundingUp(H.mulDivCeil(o,s,t),At,e):H.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,r){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ke))throw new Error("sqrtPriceX64A must greater than 0");return r?H.mulDivCeil(n,t.sub(e),He):H.mulDivFloor(n,t.sub(e),He)}static getLiquidityFromTokenAmountA(e,t,n,r){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return r?H.mulDivRoundingUp(a,At,Xi):a.shrn(Fn)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),H.mulDivFloor(n,Xi,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,r,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return oe.getLiquidityFromTokenAmountA(t,n,r,!1);if(e.lt(n)){let s=oe.getLiquidityFromTokenAmountA(e,n,r,!1),a=oe.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return oe.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,r,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:oe.getTokenAmountAFromLiquidity(t,n,r,o),amountB:new ee(0)};if(e.lt(n)){let s=oe.getTokenAmountAFromLiquidity(e,n,r,o),a=oe.getTokenAmountBFromLiquidity(t,e,r,o);return{amountA:s,amountB:a}}else return{amountA:new ee(0),amountB:oe.getTokenAmountBFromLiquidity(t,n,r,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,r,o,s,a){let{amountA:u,amountB:c}=oe.getAmountsFromLiquidity(e,t,n,r,s),l=o?1+a:1-a,m=new ee(new _(u.toString()).mul(l).toFixed(0)),d=new ee(new _(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:r,slippage:o,add:s,epochInfo:a,amountAddFee:u}){var A,h,P,T;let c=Q.priceToSqrtPriceX64(new _(e.price),e.mintA.decimals,e.mintB.decimals),l=Q.getSqrtPriceX64FromTick(t),m=Q.getSqrtPriceX64FromTick(n),d=s?1+o:1-o,p=oe.getAmountsFromLiquidity(c,l,m,r,s),[y,f]=[de(p.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,a,u),de(p.amountB,(h=e.mintB.extensions)==null?void 0:h.feeConfig,a,u)],[b,g]=[de(new ee(new _(p.amountA.toString()).mul(d).toFixed(0)),(P=e.mintA.extensions)==null?void 0:P.feeConfig,a,u),de(new ee(new _(p.amountB.toString()).mul(d).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,a,u)];return{liquidity:r,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Wt(y.expirationTime,f.expirationTime)}}},Yt=class{static swapCompute(e,t,n,r,o,s,a,u,c,l,m,d,p,y){if(d.eq(ke))throw new Error("amountSpecified must not be 0");if(y||(y=s?Et.add(At):Ft.sub(At)),s){if(y.lt(Et))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Ft))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let f=d.gt(ke),b={amountSpecifiedRemaining:d,amountCalculated:ke,sqrtPriceX64:m,tick:c>p?Math.min(p+ie.tickCount(l)-1,c):p,accounts:[],liquidity:u,feeAmount:new ee(0)},g=p,A=n[p],h=0,P=!s&&A.startTickIndex===b.tick;for(;!b.amountSpecifiedRemaining.eq(ke)&&!b.sqrtPriceX64.eq(y);){if(h>10)throw Error("liquidity limit");let T={};T.sqrtPriceStartX64=b.sqrtPriceX64;let I=q.nextInitTick(A,b.tick,l,s,P),B=I||null,x=null;if(!(B!=null&&B.liquidityGross.gtn(0))){let O=Ee.nextInitializedTickArrayStartIndex({tickCurrent:b.tick,tickSpacing:l,tickArrayBitmap:r,exBitmapInfo:o},g,s);if(!O.isExist)throw Error("swapCompute LiquidityInsufficient");g=O.nextStartIndex;let{publicKey:F}=ce(e,t,g);x=F,A=n[g],B=q.firstInitializedTick(A,s)}T.tickNext=B.tick,T.initialized=B.liquidityGross.gtn(0),p!==g&&x&&(b.accounts.push(x),p=g),T.tickNext<_e?T.tickNext=_e:T.tickNext>qe&&(T.tickNext=qe),T.sqrtPriceNextX64=Q.getSqrtPriceX64FromTick(T.tickNext);let K;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?K=y:K=T.sqrtPriceNextX64,[b.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=Yt.swapStepCompute(b.sqrtPriceX64,K,b.liquidity,b.amountSpecifiedRemaining,a),b.feeAmount=b.feeAmount.add(T.feeAmount),f?(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),b.amountCalculated=b.amountCalculated.sub(T.amountOut)):(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.add(T.amountOut),b.amountCalculated=b.amountCalculated.add(T.amountIn.add(T.feeAmount))),b.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let O=B.liquidityNet;s&&(O=O.mul(It)),b.liquidity=oe.addDelta(b.liquidity,O)}P=T.tickNext!=b.tick&&!s&&A.startTickIndex===T.tickNext,b.tick=s?T.tickNext-1:T.tickNext}else if(b.sqrtPriceX64!=T.sqrtPriceStartX64){let O=Q.getTickFromSqrtPriceX64(b.sqrtPriceX64);P=O!=b.tick&&!s&&A.startTickIndex===O,b.tick=O}++h}try{let{nextStartIndex:T,isExist:I}=ie.nextInitializedTickArray(b.tick,l,s,r,o);I&&p!==T&&(b.accounts.push(ce(e,t,T).publicKey),p=T)}catch{}return{amountCalculated:b.amountCalculated,feeAmount:b.feeAmount,sqrtPriceX64:b.sqrtPriceX64,liquidity:b.liquidity,tickCurrent:b.tick,accounts:b.accounts}}static swapStepCompute(e,t,n,r,o){let s={sqrtPriceX64Next:new ee(0),amountIn:new ee(0),amountOut:new ee(0),feeAmount:new ee(0)},a=e.gte(t),u=r.gte(ke);if(u){let l=H.mulDivFloor(r,Nr.sub(new ee(o.toString())),Nr);s.amountIn=a?oe.getTokenAmountAFromLiquidity(t,e,n,!0):oe.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=Q.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?oe.getTokenAmountBFromLiquidity(t,e,n,!1):oe.getTokenAmountAFromLiquidity(e,t,n,!1),r.mul(It).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=Q.getNextSqrtPriceX64FromOutput(e,n,r.mul(It),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=oe.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=oe.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:oe.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:oe.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(r.mul(It))&&(s.amountOut=r.mul(It)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=r.sub(s.amountIn):s.feeAmount=H.mulDivCeil(s.amountIn,new ee(o),Nr.sub(new ee(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var xe=60,zt=512,q=class{static getTickArrayAddressByTick(e,t,n,r){let o=q.getTickArrayStartIndexByTick(n,r),{publicKey:s}=ce(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=q.getTickArrayStartIndexByTick(e,t),r=Math.floor((e-n)/t);if(r<0||r>=xe)throw new Error("tick offset in array overflow");return r}static getTickArrayBitIndex(e,t){let n=ie.tickCount(t),r=e/n;return e<0&&e%n!=0?r=Math.ceil(r)-1:r=Math.floor(r),r}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ie.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*xe,r=Math.floor(e/n)+512;return Math.abs(r)}static checkTickArrayIsInitialized(e,t,n){let r=n*xe,o=Math.floor(t/r)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*r}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*xe:e+t*xe}static mergeTickArrayBitmap(e){let t=new wl(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,r,o){let s=Math.floor(r/(n*xe));return[...q.searchLowBitFromStart(e,t,s-1,o,n),...q.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return q.searchHightBitFromStart(e,t,0,zt,n)}static getAllInitializedTickArrayInfo(e,t,n,r,o){let s=[],a=q.getAllInitializedTickArrayStartIndex(n,r,o);for(let u of a){let{publicKey:c}=ce(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,r,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>q.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===r)break}let u=ie.tickCount(o);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,r,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>q.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===r)break}let u=ie.tickCount(o);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<_e||e>qe}static nextInitTick(e,t,n,r,o){if(ie.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(r)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<xe;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=xe-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<xe;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let r=Q.getSqrtPriceX64FromTick(t),o=Q.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:r}:{tick:t,price:new _(1).div(o),tickSqrtPriceX64:r}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let r=n?t:new _(1).div(t),o=Ht.getTickWithPriceAndTickspacing(r,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=Q.getSqrtPriceX64FromTick(o),a=Q.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new _(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let r=Q.getSqrtPriceX64FromTick(t),o=Q.sqrtPriceX64ToPrice(r,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:r}:{tick:t,price:new _(1).div(o),tickSqrtPriceX64:r}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let r=n?t:new _(1).div(t),o=Ht.getTickWithPriceAndTickspacing(r,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=Q.getSqrtPriceX64FromTick(o),a=Q.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new _(1).div(a)}}};var mh=N([pe(8),E("bump"),pt("index"),S(""),We("protocolFeeRate"),We("tradeFeeRate"),pt("tickSpacing"),D(w(),8,"")]),Al=N([We("blockTimestamp"),G("sqrtPriceX64"),G("cumulativeTimePriceX64"),D(G(),1,"")]),Hi=N([pe(8),Ne("initialized"),S("poolId"),D(Al,1e3,"observations"),D(G(),5,"")]),hl=N([E("rewardState"),w("openTime"),w("endTime"),w("lastUpdateTime"),G("emissionsPerSecondX64"),w("rewardTotalEmissioned"),w("rewardClaimed"),S("tokenMint"),S("tokenVault"),S("creator"),G("rewardGrowthGlobalX64")]),Mr=N([pe(8),E("bump"),S("ammConfig"),S("creator"),S("mintA"),S("mintB"),S("vaultA"),S("vaultB"),S("observationId"),E("mintDecimalsA"),E("mintDecimalsB"),pt("tickSpacing"),G("liquidity"),G("sqrtPriceX64"),Le("tickCurrent"),pt("observationIndex"),pt("observationUpdateDuration"),G("feeGrowthGlobalX64A"),G("feeGrowthGlobalX64B"),w("protocolFeesTokenA"),w("protocolFeesTokenB"),G("swapInAmountTokenA"),G("swapOutAmountTokenB"),G("swapInAmountTokenB"),G("swapOutAmountTokenA"),E("status"),D(E(),7,""),D(hl,3,"rewardInfos"),D(w(),16,"tickArrayBitmap"),w("totalFeesTokenA"),w("totalFeesClaimedTokenA"),w("totalFeesTokenB"),w("totalFeesClaimedTokenB"),w("fundFeesTokenA"),w("fundFeesTokenB"),w("startTime"),D(w(),15*4-3,"padding")]),Pl=N([G("growthInsideLastX64"),w("rewardAmountOwed")]),_r=N([pe(8),E("bump"),S("nftMint"),S("poolId"),Le("tickLower"),Le("tickUpper"),G("liquidity"),G("feeGrowthInsideLastX64A"),G("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),D(Pl,3,"rewardInfos"),D(w(),8,"")]),dh=N([pe(8),E("bump"),S("poolId"),Le("tickLowerIndex"),Le("tickUpperIndex"),G("liquidity"),G("feeGrowthInsideLastX64A"),G("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),D(G(),3,"rewardGrowthInside"),D(w(),8,"")]),kl=N([Le("tick"),es("liquidityNet"),G("liquidityGross"),G("feeGrowthOutsideX64A"),G("feeGrowthOutsideX64B"),D(G(),3,"rewardGrowthsOutsideX64"),D(We(),13,"")]),Vn=N([pe(8),S("poolId"),Le("startTickIndex"),D(kl,xe,"ticks"),E("initializedTickCount"),D(E(),115,"")]),js=N([pe(329),D(S(),100,"whitelistMints")]),Hs=N([pe(8),S("poolId"),D(D(w(),8),zi,"positiveTickArrayBitmap"),D(D(w(),8),zi,"negativeTickArrayBitmap")]);var $s=re("Raydium_Clmm"),lt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},he=class{static createPoolInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y){let f=N([G("sqrtPriceX64"),w("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:un.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,startTime:y},g);let A=Buffer.from([...lt.createPool,...g]);return new ct({keys:b,programId:e,data:A})}static async createPoolInstructions(e){let{connection:t,programId:n,owner:r,mintA:o,mintB:s,ammConfigId:a,initialPriceX64:u,startTime:c,forerunCreate:l}=e,m=Me({fromPublicKey:r,programId:n}),[d,p]=[new V(o.address),new V(s.address)],y=[un.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:m.seed,newAccountPubkey:m.publicKey,lamports:l?0:await t.getMinimumBalanceForRentExemption(Hi.span),space:Hi.span,programId:n})],{publicKey:f}=vs(n,a,d,p),{publicKey:b}=Gi(n,f,d),{publicKey:g}=Gi(n,f,p);return y.push(this.createPoolInstruction(n,f,r,a,m.publicKey,d,b,new V(o.programId||Re),p,g,new V(s.programId||Re),gt(n,f).publicKey,u,c)),{signers:[],instructions:y,instructionTypes:[M.CreateAccount,M.ClmmCreatePool],address:{poolId:f,observationId:m.publicKey,mintAVault:b,mintBVault:g},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g,A,h,P,T,I,B,x,K,O){let F=N([Le("tickLowerIndex"),Le("tickUpperIndex"),Le("tickArrayLowerStartIndex"),Le("tickArrayUpperStartIndex"),G("liquidity"),w("amountMaxA"),w("amountMaxB"),Ne("withMetadata"),E("optionBaseFlag"),Ne("baseFlag")]),Y=[...O?[{pubkey:O,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:un.programId,isSigner:!1,isWritable:!1},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:Qs,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...Y],Z=Buffer.alloc(F.span);F.encode({tickLowerIndex:A,tickUpperIndex:h,tickArrayLowerStartIndex:P,tickArrayUpperStartIndex:T,liquidity:I,amountMaxA:B,amountMaxB:x,withMetadata:K==="create",baseFlag:!1,optionBaseFlag:0},Z);let J=Buffer.from([...lt.openPosition,...Z]);return new ct({keys:v,programId:e,data:J})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new V(e.programId),new V(e.id)],y;if(l)y=new V((await l(1))[0]);else{let x=ji.generate();m.push(x),y=x.publicKey}let f=q.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:g}=ce(d,p,f),{publicKey:A}=ce(d,p,b),{publicKey:h}=ye(n.wallet,y,Re),{publicKey:P}=Rr(y),{publicKey:T}=Ze(d,y),{publicKey:I}=Xt(d,p,r,o),B=this.openPositionFromLiquidityInstruction(d,n.feePayer,p,n.wallet,y,h,P,I,g,A,T,n.tokenAccountA,n.tokenAccountB,new V(t.vault.A),new V(t.vault.B),new V(e.mintA.address),new V(e.mintB.address),r,o,f,b,s,a,u,c);return{signers:m,instructions:[B],instructionTypes:[M.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:h,metadataAccount:P,personalPosition:T,protocolPosition:I}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new V(e.programId),new V(e.id)],y;if(l)y=new V((await l(1))[0]);else{let x=ji.generate();m.push(x),y=x.publicKey}let f=q.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:g}=ce(d,p,f),{publicKey:A}=ce(d,p,b),{publicKey:h}=ye(n.wallet,y,Re),{publicKey:P}=Rr(y),{publicKey:T}=Ze(d,y),{publicKey:I}=Xt(d,p,r,o),B=this.openPositionFromBaseInstruction(d,n.feePayer,p,n.wallet,y,h,P,I,g,A,T,n.tokenAccountA,n.tokenAccountB,new V(t.vault.A),new V(t.vault.B),new V(e.mintA.address),new V(e.mintB.address),r,o,f,b,c,s,a,u,Ee.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?gt(d,p).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:h,metadataAccount:P,personalPosition:T,protocolPosition:I},instructions:[B],signers:m,instructionTypes:[M.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g,A,h,P,T,I,B,x,K,O){let F=N([Le("tickLowerIndex"),Le("tickUpperIndex"),Le("tickArrayLowerStartIndex"),Le("tickArrayUpperStartIndex"),G("liquidity"),w("amountMaxA"),w("amountMaxB"),Ne("withMetadata"),E("optionBaseFlag"),Ne("baseFlag")]),Y=[...O?[{pubkey:O,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:un.programId,isSigner:!1,isWritable:!1},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:Qs,isSigner:!1,isWritable:!1},{pubkey:Jt,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...Y],Z=Buffer.alloc(F.span);F.encode({tickLowerIndex:A,tickUpperIndex:h,tickArrayLowerStartIndex:P,tickArrayUpperStartIndex:T,liquidity:new Zs(0),amountMaxA:B==="MintA"?x:K,amountMaxB:B==="MintA"?K:x,withMetadata:I==="create",baseFlag:B==="MintA",optionBaseFlag:1},Z);let J=Buffer.from([...lt.openPosition,...Z]);return new ct({keys:v,programId:e,data:J})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m,d=[];if(l)m=new V((await l(1))[0]);else{let x=ji.generate();d.push(x),m=x.publicKey}let[p,y]=[new V(e.programId),new V(e.id)],f=q.getTickArrayStartIndexByTick(r,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:g}=ce(p,y,f),{publicKey:A}=ce(p,y,b),{publicKey:h}=ye(n.wallet,m,Re),{publicKey:P}=Rr(m),{publicKey:T}=Ze(p,m),{publicKey:I}=Xt(p,y,r,o),B=this.openPositionFromLiquidityInstruction(p,n.wallet,y,n.wallet,m,h,P,I,g,A,T,n.tokenAccountA,n.tokenAccountB,new V(t.vault.A),new V(t.vault.B),new V(t.mintA.address),new V(t.mintB.address),r,o,f,b,s,a,u,c,Ee.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?gt(p,y).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:h,metadataAccount:P,personalPosition:T,protocolPosition:I},instructions:[B],signers:d,instructionTypes:[M.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,r,o){let s=N([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:un.programId,isSigner:!1,isWritable:!1},{pubkey:Re,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let c=Buffer.from([...lt.closePosition,...u]);return new ct({keys:a,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:r}){let o=new V(e.programId),{publicKey:s}=ye(n.wallet,r.nftMint,Re),{publicKey:a}=Ze(o,r.nftMint),u=[];return u.push(this.closePositionInstruction(o,n.wallet,r.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:u,instructionTypes:[M.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g,A){let h=N([G("liquidity"),w("amountMaxA"),w("amountMaxB"),E("optionBaseFlag"),Ne("baseFlag")]),P=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...P],I=Buffer.alloc(h.span);h.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},I);let B=Buffer.from([...lt.increaseLiquidity,...I]);return new ct({keys:T,programId:e,data:B})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:o,amountMaxA:s,amountMaxB:a}){let[u,c]=[new V(e.programId),new V(e.id)],l=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ce(u,c,l),{publicKey:p}=ce(u,c,m),{publicKey:y}=ye(r.wallet,n.nftMint,Re),{publicKey:f}=Ze(u,n.nftMint),{publicKey:b}=Xt(u,c,n.tickLower,n.tickUpper),g=this.increasePositionFromLiquidityInstruction(u,r.wallet,y,f,c,b,d,p,r.tokenAccountA,r.tokenAccountB,new V(t.vault.A),new V(t.vault.B),new V(e.mintA.address),new V(e.mintB.address),o,s,a,Ee.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?gt(u,c).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},signers:[],instructions:[g],instructionTypes:[M.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,base:o,baseAmount:s,otherAmountMax:a}){let[u,c]=[new V(e.programId),new V(e.id)],l=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ce(u,c,l),{publicKey:p}=ce(u,c,m),{publicKey:y}=ye(r.wallet,n.nftMint,Re),{publicKey:f}=Ze(u,n.nftMint),{publicKey:b}=Xt(u,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(u,r.wallet,y,f,c,b,d,p,r.tokenAccountA,r.tokenAccountB,new V(t.vault.A),new V(t.vault.B),new V(e.mintA.address),new V(e.mintB.address),o,s,a,Ee.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?gt(u,c).publicKey:void 0)],signers:[],instructionTypes:[M.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g,A){let h=N([G("liquidity"),w("amountMaxA"),w("amountMaxB"),E("optionBaseFlag"),Ne("baseFlag")]),P=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...P],I=Buffer.alloc(h.span);h.encode({liquidity:new Zs(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},I);let B=Buffer.from([...lt.increaseLiquidity,...I]);return new ct({keys:T,programId:e,data:B})}static decreaseLiquidityInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g,A,h){let P=N([G("liquidity"),w("amountMinA"),w("amountMinB")]),T=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[],...f.map(K=>[{pubkey:K.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:K.rewardMint,isSigner:!1,isWritable:!1}]).flat()],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],B=Buffer.alloc(P.span);P.encode({liquidity:b,amountMinA:g,amountMinB:A},B);let x=Buffer.from([...lt.decreaseLiquidity,...B]);return new ct({keys:I,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:r,liquidity:o,amountMinA:s,amountMinB:a,programId:u}){let[c,l]=[new V(e.programId),new V(e.id)],m=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ce(c,l,m),{publicKey:y}=ce(c,l,d),{publicKey:f}=ye(r.wallet,n.nftMint,u),{publicKey:b}=Ze(c,n.nftMint),{publicKey:g}=Xt(c,l,n.tickLower,n.tickUpper),A=[];for(let P=0;P<e.rewardDefaultInfos.length;P++)A.push({poolRewardVault:new V(t.rewardInfos[P].vault),ownerRewardVault:r.rewardAccounts[P],rewardMint:new V(e.rewardDefaultInfos[P].mint.address)});let h=[];return h.push(this.decreaseLiquidityInstruction(c,r.wallet,f,b,l,g,p,y,r.tokenAccountA,r.tokenAccountB,new V(t.vault.A),new V(t.vault.B),new V(e.mintA.address),new V(e.mintB.address),A,o,s,a,Ee.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?gt(c,l).publicKey:void 0)),{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:h,instructionTypes:[M.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g){let A=N([w("amount"),w("otherAmountThreshold"),G("sqrtPriceLimitX64"),Ne("isBaseInput")]),h=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(B=>({pubkey:B,isSigner:!1,isWritable:!0}))],P=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(A.span);A.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},T);let I=Buffer.from([...lt.swap,...T]);return new ct({keys:P,programId:e,data:I})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,inputMint:r,amountIn:o,amountOutMin:s,sqrtPriceLimitX64:a,remainingAccounts:u}){let[c,l]=[new V(e.programId),new V(e.id)],[m,d]=[new V(t.vault.A),new V(t.vault.B)],[p,y]=[new V(e.mintA.address),new V(e.mintB.address)],f=e.mintA.address===r.toString(),b=[this.swapInstruction(c,n.wallet,l,new V(e.config.id),f?n.tokenAccountA:n.tokenAccountB,f?n.tokenAccountB:n.tokenAccountA,f?m:d,f?d:m,f?p:y,f?y:p,u,m,o,s,a,!0,gt(c,l).publicKey)];return{signers:[],instructions:b,instructionTypes:[M.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,r,o,s,a,u,c,l,m,d){let p=N([w("openTime"),w("endTime"),G("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:un.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:X(l),endTime:X(m),emissionsPerSecondX64:d},f);let b=Buffer.from([...lt.initReward,...f]);return new ct({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[o,s]=[new V(e.programId),new V(e.id)],a=Ds(o,s,r.mint).publicKey,u=En(o).publicKey,c=[this.initRewardInstruction(o,n.wallet,s,u,new V(e.config.id),n.tokenAccount,r.programId,r.mint,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:u},signers:[],instructions:c,instructionTypes:[M.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,r,o,s,a,u,c,l,m,d){let p=N([E("rewardIndex"),G("emissionsPerSecondX64"),w("openTime"),w("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:c,emissionsPerSecondX64:d,openTime:X(l),endTime:X(m)},f);let b=Buffer.from([...lt.setRewardEmissions,...f]);return new ct({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:r}){let[o,s]=[new V(e.programId),new V(e.id)],a,u,c;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===r.mint.toString()&&(a=d,u=new V(t.rewardInfos[d].vault),c=new V(t.rewardInfos[d].mint.address));(a===void 0||u===void 0)&&$s.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=En(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,s,l,new V(e.config.id),n.tokenAccount,u,c,a,r.openTime,r.endTime,r.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:l},signers:[],instructions:m,instructionTypes:[M.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,r,o,s,a){let u=N([E("rewardIndex")]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Re,isSigner:!1,isWritable:!1},{pubkey:vt,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({rewardIndex:a},l);let m=Buffer.from([...lt.collectReward,...l]);return new ct({keys:c,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:r}){let[o,s]=[new V(e.programId),new V(e.id)],a,u;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===r.toString()&&(a=l,u=new V(t.rewardInfos[l].vault));(a===void 0||u===void 0)&&$s.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=[this.collectRewardInstruction(o,n.wallet,s,n.tokenAccount,u,r,a)];return{address:{rewardVault:u},signers:[],instructions:c,instructionTypes:[M.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapBaseOutInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,outputMint:r,amountOut:o,amountInMax:s,sqrtPriceLimitX64:a,remainingAccounts:u}){let[c,l]=[new V(e.programId),new V(e.id)],[m,d]=[new V(t.vault.A),new V(t.vault.B)],[p,y]=[new V(e.mintA.address),new V(e.mintB.address)],f=e.mintA.address===r.toString(),b=[this.swapInstruction(c,n.wallet,l,new V(e.config.id),f?n.tokenAccountB:n.tokenAccountA,f?n.tokenAccountA:n.tokenAccountB,f?d:m,f?m:d,f?p:y,f?y:p,u,m,o,s,a,!1)];return{signers:[],instructions:b,instructionTypes:[M.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}};import{PublicKey as xl}from"@solana/web3.js";import{PublicKey as Tl}from"@solana/web3.js";import Js from"bn.js";var ea=new Js(25),ta=new Js(1e4);var Il=re("Raydium_liquidity_serum");function na({programId:i,marketId:e}){let t=[e.toBuffer()],n=0,r;for(;n<100;){try{let o=t.concat(Buffer.from([n]),Buffer.alloc(7));r=Tl.createProgramAddressSync(o,i)}catch(o){if(o instanceof TypeError)throw o;n++;continue}return{publicKey:r,nonce:n}}throw Il.logWithError("unable to find a viable program address nonce","params",{programId:i,marketId:e}),new Error("unable to find a viable program address nonce")}import Yh from"bn.js";function Qi({programId:i}){let{publicKey:e}=se([Buffer.from("amm_config_account_seed","utf-8")],i);return e}function jt({name:i,programId:e,marketId:t}){let{publicKey:n}=se([e.toBuffer(),t.toBuffer(),Buffer.from(i,"utf-8")],e);return n}function Bl({programId:i,marketId:e}){let{publicKey:t}=se([i.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],i);return t}function Sl({programId:i}){return se([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],i)}function ra({version:i,marketVersion:e,marketId:t,baseMint:n,quoteMint:r,baseDecimals:o,quoteDecimals:s,programId:a,marketProgramId:u}){let c=jt({name:"amm_associated_seed",programId:a,marketId:t}),l=jt({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=Sl({programId:a}),p=jt({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=jt({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=jt({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Bl({programId:a,marketId:t}),g=jt({name:"target_associated_seed",programId:a,marketId:t}),A=jt({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:h}=na({programId:u,marketId:t});return{id:c,baseMint:n,quoteMint:r,lpMint:l,baseDecimals:o,quoteDecimals:s,lpDecimals:o,version:i,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:A,marketVersion:e,marketProgramId:u,marketId:t,marketAuthority:h,lookupTableAccount:xl.default,configId:Qi({programId:a})}}import je from"bn.js";var Wn=class extends ge{constructor(t){super(t);this.stableLayout=new Mn({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:r,baseIn:o}){let s=new je(new _(n).mul(10**t[o?"mintA":"mintB"].decimals).toFixed(0)),a=Is(t[o?"mintB":"mintA"]),[u,c]=[new je(new _(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new je(new _(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new je(new _(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,_.ROUND_DOWN));this.logDebug("baseReserve:",u.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",o?t.mintB.symbol:t.mintA.symbol,"slippage:",`${r.toSignificant()}%`,"baseReserve",u.toString(),"quoteReserve",c.toString());let m=o?"base":"quote";this.logDebug("input side:",m);let d=ve;s.isZero()||(d=m==="base"?ur(s.mul(c),u):ur(s.mul(u),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=ur(s.mul(l),m==="base"?u:c);this.logDebug("liquidity:",p.toString());let f=new ze(new je(1)).add(r).mul(d).quotient,b=new we(a,d),g=new we(a,f);return this.logDebug("anotherAmount:",b.toFixed(),"maxAnotherAmount:",g.toFixed()),{anotherAmount:b,maxAnotherAmount:g,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,amountInA:r,amountInB:o,fixedSide:s,config:a,txVersion:u,computeBudgetConfig:c}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",o),(r.isZero()||o.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:o.toFixed()});let{account:l}=this.scope,{bypassAssociatedCheck:m,checkCreateATAOwner:d}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},[p,y]=[r.token,o.token],f=await l.getCreatedTokenAccount({mint:p.mint,associatedOnly:!1}),b=await l.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1});!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",l.tokenAccounts);let g=await l.getCreatedTokenAccount({mint:new Xe(n.lpMint.address)}),A=[p,y],h=[f,b],P=[r.raw,o.raw],T=r.token.mint.toBase58()===n.mintA.address?"base":"quote",I="base";["quote","base"].includes(T)||this.logAndCreateError("invalid fixedSide","fixedSide",s),T==="quote"?(A.reverse(),h.reverse(),P.reverse(),I=s==="a"?"quote":"base"):T==="base"&&(I=s==="a"?"base":"quote");let[B,x]=A,[K,O]=h,[F,Y]=P,v=await this.getAmmPoolKeys(n.id),Z=this.createTxBuilder(),{tokenAccount:J,...te}=await l.handleTokenAccount({side:"in",amount:F,mint:B.mint,tokenAccount:K,bypassAssociatedCheck:m,checkCreateATAOwner:d});Z.addInstruction(te);let{tokenAccount:et,...mn}=await l.handleTokenAccount({side:"in",amount:Y,mint:x.mint,tokenAccount:O,bypassAssociatedCheck:m,checkCreateATAOwner:d});Z.addInstruction(mn);let{tokenAccount:Wr,...qr}=await l.handleTokenAccount({side:"out",amount:0,mint:new Xe(n.lpMint.address),tokenAccount:g,bypassAssociatedCheck:m,checkCreateATAOwner:d});return Z.addInstruction(qr),Z.addInstruction({instructions:[Ns({poolInfo:n,poolKeys:v,userKeys:{baseTokenAccount:J,quoteTokenAccount:et,lpTokenAccount:Wr,owner:this.scope.ownerPubKey},baseAmountIn:F,quoteAmountIn:Y,fixedSide:I})],instructionTypes:[n.pooltype.includes("StablePool")?M.AmmV5AddLiquidity:M.AmmV4AddLiquidity],lookupTableAddress:v.lookupTableAccount?[v.lookupTableAccount]:[]}),Z.addCustomComputeBudget(c),u===0&&await Z.buildV0(),Z.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,amountIn:r,config:o,txVersion:s,computeBudgetConfig:a}=t,u=await this.getAmmPoolKeys(n.id),[c,l,m]=[new Xe(n.mintA.address),new Xe(n.mintB.address),new Xe(n.lpMint.address)];this.logDebug("amountIn:",r),r.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",r.toString());let{account:d}=this.scope,p=await d.getCreatedTokenAccount({mint:m,associatedOnly:!1});p||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",d.tokenAccounts);let y=await d.getCreatedTokenAccount({mint:c}),f=await d.getCreatedTokenAccount({mint:l}),b=this.createTxBuilder(),{bypassAssociatedCheck:g,checkCreateATAOwner:A}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...o},{tokenAccount:h,...P}=await d.handleTokenAccount({side:"out",amount:0,mint:c,tokenAccount:y,bypassAssociatedCheck:g,checkCreateATAOwner:A});b.addInstruction(P);let{tokenAccount:T,...I}=await d.handleTokenAccount({side:"out",amount:0,mint:l,tokenAccount:f,bypassAssociatedCheck:g,checkCreateATAOwner:A});return b.addInstruction(I),b.addInstruction({instructions:[Wi({poolInfo:n,poolKeys:u,userKeys:{lpTokenAccount:p,baseTokenAccount:h,quoteTokenAccount:T,owner:this.scope.ownerPubKey},amountIn:r})],lookupTableAddress:u.lookupTableAccount?[u.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?M.AmmV5RemoveLiquidity:M.AmmV4RemoveLiquidity]}),b.addCustomComputeBudget(a),s===0?await b.buildV0():b.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:r,createPositionInfo:o,farmInfo:s,userFarmLpAmount:a,base:u,computeBudgetConfig:c,payer:l,tokenProgram:m=Er,checkCreateATAOwner:d=!0,getEphemeralSigners:p,txVersion:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let f=this.createTxBuilder();f.addCustomComputeBudget(c);let b={};for(let J of this.scope.account.tokenAccountRawInfos)(b[J.accountInfo.mint.toString()]===void 0||ye(this.scope.ownerPubKey,J.accountInfo.mint,Er).publicKey.equals(J.pubkey))&&(b[J.accountInfo.mint.toString()]=J.pubkey);let g=b[t.lpMint.address];if(g===void 0)throw Error("find lp account error in trade accounts");let A=r.add(a!=null?a:new je(0)),h=t.mintA.address===be.WSOL.mint.toString(),P=t.mintB.address===be.WSOL.mint.toString(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Er,mint:new Xe(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:d});if(f.addInstruction(I||{}),T===void 0)throw new Error("base token account not found");let{account:B,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Er,mint:new Xe(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:P?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:!0,checkCreateATAOwner:d});if(f.addInstruction(x||{}),B===void 0)throw new Error("quote token account not found");if(b[t.mintA.address]=T,b[t.mintB.address]=B,s!==void 0&&!(a!=null&&a.isZero())){let J=[];for(let dn of s.rewardInfos){let xa=dn.mint.address===be.WSOL.mint.toString();if(b[dn.mint.address])J.push(b[dn.mint.address]);else{let{account:io,instructionParams:oo}=await this.scope.account.getOrCreateTokenAccount({mint:new Xe(dn.mint.address),tokenProgram:m,owner:this.scope.ownerPubKey,skipCloseAccount:!xa,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:d});io||this.logAndCreateError("farm reward account not found:",dn.mint.address),oo&&f.addInstruction(oo),J.push(io)}}let te=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],et={amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:te,lpAccount:g,rewardAccounts:J},mn=at[s.programId],Wr=mn===6?Ln(et):mn===5?Rn(et):On(et),qr={3:M.FarmV3Withdraw,5:M.FarmV5Withdraw,6:M.FarmV6Withdraw};f.addInstruction({instructions:[Wr],instructionTypes:[qr[mn]]})}let K=await this.getAmmPoolKeys(t.id),O=Wi({poolInfo:t,poolKeys:K,userKeys:{lpTokenAccount:g,baseTokenAccount:T,quoteTokenAccount:B,owner:this.scope.ownerPubKey},amountIn:A});f.addInstruction({instructions:[O],instructionTypes:[t.pooltype.includes("StablePool")?M.AmmV5RemoveLiquidity:M.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[F,Y]=t.mintA.address===n.mintA.address?[T,B]:[B,T],v=await this.scope.clmm.getClmmPoolKeys(t.id),Z=await he.openPositionFromBaseInstructions({poolInfo:n,poolKeys:v,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:F,tokenAccountB:Y},withMetadata:"create",...o,base:u,getEphemeralSigners:p});return f.addInstruction({instructions:[...Z.instructions],signers:Z.signers,instructionTypes:[...Z.instructionTypes],lookupTableAddress:v.lookupTableAccount?[v.lookupTableAccount]:[]}),y===0?f.sizeCheckBuildV0():f.sizeCheckBuild()}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:r,quoteMintInfo:o,baseAmount:s,quoteAmount:a,startTime:u,ownerInfo:c,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:y,computeBudgetConfig:f}){var Y;let b=c.feePayer||((Y=this.scope.owner)==null?void 0:Y.publicKey),g=c.useSOLBalance&&r.mint.equals(ia),A=c.useSOLBalance&&o.mint.equals(ia),h=this.createTxBuilder(),{account:P,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:g?{payer:b,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:l,checkCreateATAOwner:m});h.addInstruction(T||{});let{account:I,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:A?{payer:b,amount:a}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:l,checkCreateATAOwner:m});if(h.addInstruction(B||{}),P===void 0||I===void 0)throw Error("you don't has some token account");let x=ra({version:4,marketVersion:3,marketId:n.marketId,baseMint:r.mint,quoteMint:o.mint,baseDecimals:r.decimals,quoteDecimals:o.decimals,programId:t,marketProgramId:n.programId}),K={programId:t,ammId:x.id,ammAuthority:x.authority,ammOpenOrders:x.openOrders,lpMint:x.lpMint,coinMint:x.baseMint,pcMint:x.quoteMint,coinVault:x.baseVault,pcVault:x.quoteVault,withdrawQueue:x.withdrawQueue,ammTargetOrders:x.targetOrders,poolTempLp:x.lpVault,marketProgramId:x.marketProgramId,marketId:x.marketId,ammConfigId:x.configId,feeDestinationId:y},{instruction:O,instructionType:F}=Ms({...K,userWallet:this.scope.ownerPubKey,userCoinVault:P,userPcVault:I,userLpVault:ye(this.scope.ownerPubKey,x.lpMint,d).publicKey,nonce:x.nonce,openTime:u,coinAmount:s,pcAmount:a});return h.addInstruction({instructions:[O],instructionTypes:[F]}),h.addCustomComputeBudget(f),h.versionBuild({txVersion:p,extInfo:{address:K}})}async getCreatePoolFee({programId:t}){let n=Qi({programId:t}),r=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(r===null)throw Error("get config account error");return xs.decode(r.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:r,mintOut:o,slippage:s}){if(r!==t.mintA.address&&r!==t.mintA.address)throw new Error("toke not match");if(o!==t.mintB.address&&o!==t.mintB.address)throw new Error("toke not match");let{baseReserve:a,quoteReserve:u}=t,c=[a,u],l=r==t.mintA.address?"base":"quote";l==="quote"&&c.reverse();let[m,d]=c,p=t.programId===Uo.toBase58(),y;if(p)y=new _(d.toString()).div(m.toString());else{let x=Ls(this.stableLayout.stableModelData,a.toNumber(),u.toNumber(),!1);l==="quote"?y=new _(1e6).div(x*1e6):y=new _(x*1e6).div(1e6)}let f=n,b=new je(0),g=new je(0);if(!f.isZero())if(p){g=Bn(f.mul(ea),ta);let x=f.sub(g),K=m.add(x);b=d.mul(x).div(K)}else{g=f.mul(new je(2)).div(new je(1e4));let x=f.sub(g);l==="quote"?b=new je(Ks(this.stableLayout.stableModelData,u.toNumber(),a.toNumber(),x.toNumber())):b=new je(Cs(this.stableLayout.stableModelData,u.toNumber(),a.toNumber(),x.toNumber()))}let A=new je(new _(b.toString()).mul(1-s).toFixed(0)),h=b,P=A,T=new _(b.toString()).div(new _(f.sub(g).toString()).toFixed(0));!f.isZero()&&!b.isZero()&&(T=new _(b.toString()).div(f.sub(g).toString()));let I=y.sub(T).div(y).mul(100);return{amountOut:h,minAmountOut:P,currentPrice:y,executionPrice:T,priceImpact:I,fee:g}}async swap({poolInfo:t,amountIn:n,amountOut:r,inputMint:o,fixedSide:s,txVersion:a,computeBudgetConfig:u}){let c=this.createTxBuilder(),[l,m]=o===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],d=await this.scope.account.getCreatedTokenAccount({mint:new Xe(l.address),programId:new Xe(l.programId),associatedOnly:!1}),p=await this.scope.account.getCreatedTokenAccount({mint:new Xe(m.address),programId:new Xe(m.programId),associatedOnly:!1}),{tokenAccount:y,...f}=await this.scope.account.handleTokenAccount({side:"in",amount:n,mint:new Xe(l.address),tokenAccount:d,bypassAssociatedCheck:!1,checkCreateATAOwner:!1});c.addInstruction(f);let{tokenAccount:b,...g}=await this.scope.account.handleTokenAccount({side:"out",amount:0,mint:new Xe(m.address),tokenAccount:p,bypassAssociatedCheck:!1,checkCreateATAOwner:!1});c.addInstruction(g);let A=await this.getAmmPoolKeys(t.id),h=4;return t.pooltype.includes("StablePool")&&(h=5),c.addInstruction({instructions:[_s({version:h,poolKeys:A,userKeys:{tokenAccountIn:y,tokenAccountOut:b,owner:this.scope.ownerPubKey},amountIn:n,amountOut:r,fixedSide:s})],instructionTypes:[h===4?M.AmmV4SwapBaseIn:M.AmmV5SwapBaseIn]}),c.addCustomComputeBudget(u),c.versionBuild({txVersion:a})}};import{PublicKey as ne}from"@solana/web3.js";import $e from"bn.js";var qn=class extends ge{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var A;let{programId:t,owner:n=((A=this.scope.owner)==null?void 0:A.publicKey)||ne.default,mint1:r,mint2:o,ammConfig:s,initialPrice:a,startTime:u,computeBudgetConfig:c,forerunCreate:l,txVersion:m}=e,d=this.createTxBuilder(),[p,y,f]=new $e(new ne(r.address).toBuffer()).gt(new $e(new ne(o.address).toBuffer()))?[o,r,new _(1).div(a)]:[r,o,a],b=Q.priceToSqrtPriceX64(f,p.decimals,y.decimals),g=await he.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:p,mintB:y,ammConfigId:s.id,initialPriceX64:b,startTime:u,forerunCreate:l});return d.addInstruction(g),d.addCustomComputeBudget(c),d.versionBuild({txVersion:m,extInfo:{address:{...g.address,programId:t.toString(),id:g.address.poolId.toString(),mintA:p,mintB:y,openTime:u.toString(),vault:{A:g.address.mintAVault.toString(),B:g.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:g.address.poolId.toString(),mintA:p,mintB:y,feeRate:s.tradeFeeRate,openTime:u.toString(),programId:t.toString(),price:f.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},...zs},forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:d,computeBudgetConfig:p,txVersion:y}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),b=null,g=null,A=n.useSOLBalance&&e.mintA.address===$.toString(),h=n.useSOLBalance&&e.mintB.address===$.toString(),[P,T]=s==="MintA"?[a,u]:[u,a],{account:I,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ne(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||P.isZero()?{payer:this.scope.ownerPubKey,amount:P}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});I&&(b=I),f.addInstruction(B||{});let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ne(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||T.isZero()?{payer:this.scope.ownerPubKey,amount:T}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:c,checkCreateATAOwner:l});x&&(g=x),f.addInstruction(K||{}),(!b||!g)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let O=t||await this.getClmmPoolKeys(e.id),F=await he.openPositionFromBaseInstructions({poolInfo:e,poolKeys:O,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},tickLower:r,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,withMetadata:m,getEphemeralSigners:d});return f.addInstruction(F),f.addCustomComputeBudget(p),f.versionBuild({txVersion:y,extInfo:F.address})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:r,amountMaxB:o,tickLower:s,tickUpper:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,getEphemeralSigners:p}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let y=this.createTxBuilder(),f=null,b=null,g=n.useSOLBalance&&e.mintA.address===$.toBase58(),A=n.useSOLBalance&&e.mintB.address===$.toBase58(),{account:h,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ne(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:g?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:g?!1:c,checkCreateATAOwner:l});h&&(f=h),y.addInstruction(P||{});let{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ne(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});T&&(b=T),y.addInstruction(I||{}),(f===void 0||b===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=t||await this.getClmmPoolKeys(e.id),x=await he.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:B,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},tickLower:s,tickUpper:a,liquidity:u,amountMaxA:r,amountMaxB:o,withMetadata:m,getEphemeralSigners:p});return y.addInstruction(x),y.versionBuild({txVersion:d,extInfo:{address:x.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,ownerPosition:n,amountMaxA:r,amountMaxB:o,liquidity:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,y,f=a.useSOLBalance&&t.mintA.address===$.toString(),b=a.useSOLBalance&&t.mintB.address===$.toString(),{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ne(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});g&&(p=g),d.addInstruction(A||{});let{account:h,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ne(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b?{payer:this.scope.ownerPubKey,amount:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});h&&(y=h),d.addInstruction(P||{}),!p&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=await this.getClmmPoolKeys(t.id),I=he.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:y},liquidity:s,amountMaxA:r,amountMaxB:o});return d.addInstruction(I),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:r,baseAmount:o,otherAmountMax:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,y,f=a.useSOLBalance&&t.mintA.address===$.toString(),b=a.useSOLBalance&&t.mintB.address===$.toString(),{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ne(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:r==="MintA"?o:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});g&&(p=g),d.addInstruction(A||{});let{account:h,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ne(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b?{payer:this.scope.ownerPubKey,amount:r==="MintA"?s:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});h&&(y=h),d.addInstruction(P||{}),!p&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=await this.getClmmPoolKeys(t.id),I=he.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:T,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:y},base:r,baseAmount:o,otherAmountMax:s});return d.addInstruction(I),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:I.address}})}async decreaseLiquidity(e){let{poolInfo:t,ownerPosition:n,ownerInfo:r,amountMinA:o,amountMinB:s,liquidity:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let d=this.createTxBuilder(),p=r.useSOLBalance&&t.mintA.address===$.toString(),y=r.useSOLBalance&&t.mintB.address===$.toString(),f,b,{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ne(t.mintA.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!p,associatedOnly:p?!1:u,checkCreateATAOwner:c});f=g,A&&d.addInstruction(A);let{account:h,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ne(t.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:c});b=h,P&&d.addInstruction(P);let T=[];for(let K of t.rewardDefaultInfos){let O=r.useSOLBalance&&K.mint.address===$.toString(),F;if(K.mint.address===t.mintA.address)F=f;else if(K.mint.address===t.mintB.address)F=b;else{let{account:Y,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(K.mint.programId),mint:new ne(K.mint.address),notUseTokenAccount:O,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!O,associatedOnly:O?!1:u,checkCreateATAOwner:c});F=Y,v&&d.addInstruction(v)}T.push(F)}!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=await this.getClmmPoolKeys(t.id),B=await he.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:T},liquidity:a,amountMinA:o,amountMinB:s});d.addInstruction({instructions:B.instructions,instructionTypes:[M.ClmmDecreasePosition]});let x={...B.address};if(r.closePosition){let K=await he.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});d.addInstruction({endInstructions:K.instructions,endInstructionTypes:K.instructionTypes}),x={...x,...K.address}}return d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:x}})}async closePosition({poolInfo:e,ownerPosition:t,txVersion:n}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let r=this.createTxBuilder(),o=await this.getClmmPoolKeys(e.id),s=he.closePositionInstructions({poolInfo:e,poolKeys:o,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:t});return r.addInstruction(s).versionBuild({txVersion:n,extInfo:{address:s.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.address.toString()===$.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(n.mint.address),mint:new ne(n.mint.address),notUseTokenAccount:!!c,skipCloseAccount:!c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new $e(new _(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:c?!1:r,checkCreateATAOwner:o});d&&u.addInstruction(d),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),y=he.initRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new ne(n.mint.programId),mint:new ne(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:H.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,ownerInfo:t,rewardInfos:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){for(let l of n)l.endTime<=l.openTime&&this.logAndCreateError("reward time error","rewardInfo",l);let u=this.createTxBuilder(),c={};for(let l of n){let m=t.useSOLBalance&&l.mint.address===$.toString(),d=l.perSecond.mul(l.endTime-l.openTime),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(l.mint.programId),mint:new ne(l.mint.address),notUseTokenAccount:!!m,skipCloseAccount:!m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new $e(new _(d.toFixed(0)).gte(d)?d.toFixed(0):d.add(1).toFixed(0))}:void 0,associatedOnly:m?!1:r,checkCreateATAOwner:o});y&&u.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=he.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{programId:new ne(l.mint.programId),mint:new ne(l.mint.address),openTime:l.openTime,endTime:l.endTime,emissionsPerSecondX64:H.decimalToX64(l.perSecond)}});c={...c,...b.address},u.addInstruction(b)}return u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:c}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.equals($),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new $e(new _(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:c?!1:r,checkCreateATAOwner:o});m&&u.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),p=he.setRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:H.decimalToX64(n.perSecond)}});return u.addInstruction(p),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:p.address}})}async setRewards({poolInfo:e,ownerInfo:t,rewardInfos:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){let u=this.createTxBuilder(),c={};for(let l of n){l.endTime<=l.openTime&&this.logAndCreateError("reward time error","rewardInfo",l);let m=t.useSOLBalance&&l.mint.address===$.toString(),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(l.mint.programId),mint:new ne(l.mint.address),notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new $e(new _(l.perSecond.sub(l.endTime-l.openTime).toFixed(0)).gte(l.perSecond.sub(l.endTime-l.openTime))?l.perSecond.sub(l.endTime-l.openTime).toFixed(0):l.perSecond.sub(l.endTime-l.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:r,checkCreateATAOwner:o});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=he.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:new ne(l.mint.address),openTime:l.openTime,endTime:l.endTime,emissionsPerSecondX64:H.decimalToX64(l.perSecond)}});u.addInstruction(f),c={...c,...f.address}}return u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:c}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1}){let s=e.rewardDefaultInfos.find(p=>p.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),u=t.useSOLBalance&&n.equals($),{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(s.mint.programId),mint:n,notUseTokenAccount:u,owner:this.scope.ownerPubKey,skipCloseAccount:!u,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:u?!1:r,checkCreateATAOwner:o});l&&a.addInstruction(l),c||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),d=he.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:c},rewardMint:n});return a.addInstruction(d),a.build({address:d.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1}){let s=this.createTxBuilder(),a={};for(let u of n){let c=e.rewardDefaultInfos.find(f=>f.mint.address===u.toString());if(!c){this.logAndCreateError("reward mint error","not found reward mint",u);continue}let l=t.useSOLBalance&&u.equals($),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(c.mint.programId),mint:u,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:r,checkCreateATAOwner:o});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),d&&s.addInstruction(d);let p=await this.getClmmPoolKeys(e.id),y=he.collectRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:u});s.addInstruction(y),a={...a,...y.address}}return s.build({address:a})}async swap({poolInfo:e,inputMint:t,amountIn:n,amountOutMin:r,priceLimit:o,ownerInfo:s,remainingAccounts:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,txVersion:l}){let m=this.createTxBuilder(),d=s.useSOLBalance&&e.mintA.address===$.toBase58(),p=s.useSOLBalance&&e.mintB.address===$.toBase58(),y;!o||o.equals(new _(0))?y=t.toString()===e.mintA.address?Et.add(new $e(1)):Ft.sub(new $e(1)):y=Q.priceToSqrtPriceX64(o,e.mintA.decimals,e.mintB.decimals);let f;if(!f){let{account:A,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ne(e.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:s.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:u,checkCreateATAOwner:c});f=A,h&&m.addInstruction(h)}let b;if(!b){let{account:A,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ne(e.mintB.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:s.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:u,checkCreateATAOwner:c});b=A,h&&m.addInstruction(h)}(!f||!b)&&this.logAndCreateError("user do not have token account",this.scope.account.tokenAccountRawInfos);let g=await this.getClmmPoolKeys(e.id);return m.addInstruction(he.makeSwapBaseInInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},inputMint:new ne(t),amountIn:n,amountOutMin:r,sqrtPriceLimitX64:y,remainingAccounts:a})),m.versionBuild({txVersion:l})}async harvestAllRewards({allPoolInfo:e,allPositions:t,ownerInfo:n,associatedOnly:r=!0,checkCreateATAOwner:o=!1,programId:s,txVersion:a,computeBudgetConfig:u}){let c={};for(let m of this.scope.account.tokenAccountRawInfos)r?ye(this.scope.ownerPubKey,m.accountInfo.mint,s).publicKey.equals(m.pubkey)&&(c[m.accountInfo.mint.toString()]=m.pubkey):c[m.accountInfo.mint.toString()]=m.pubkey;let l=this.createTxBuilder();for(let m of Object.values(e)){if(t[m.id]===void 0||!t[m.id].find(h=>!h.liquidity.isZero()||h.rewardInfos.find(P=>!P.rewardAmountOwed.isZero())))continue;let d=m,p=n.useSOLBalance&&d.mintA.address===$.toString(),y=n.useSOLBalance&&d.mintB.address===$.toString(),f=c[d.mintA.address];if(!f){let{account:h,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintA.programId,mint:new ne(d.mintA.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:r,checkCreateATAOwner:o});f=h,P&&l.addInstruction(P)}let b=c[d.mintB.address];if(!b){let{account:h,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintB.programId,mint:new ne(d.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:r,checkCreateATAOwner:o});b=h,P&&l.addInstruction(P)}c[d.mintA.address]=f,c[d.mintB.address]=b;let g=[];for(let h of d.rewardDefaultInfos){let P=n.useSOLBalance&&h.mint.address===$.toString(),T=c[h.mint.address];if(!T){let{account:I,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ne(h.mint.programId),mint:new ne(h.mint.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:P?!1:r});T=I,B&&l.addInstruction(B)}c[h.mint.address]=T,g.push(T)}let A=await this.getClmmPoolKeys(d.id);for(let h of t[m.id]){let P=he.decreaseLiquidityInstructions({poolInfo:d,poolKeys:A,ownerPosition:h,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:g},liquidity:new $e(0),amountMinA:new $e(0),amountMinB:new $e(0)});l.addInstruction(P)}}return a===0?l.sizeCheckBuildV0({computeBudgetConfig:u}):l.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(En(e).publicKey);return t?js.decode(t.data).whitelistMints.filter(r=>!r.equals(ne.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new $e(1))).map(s=>Ze(new ne(e),s.accountInfo.mint).publicKey),r=await this.scope.connection.getMultipleAccountsInfo(n),o=[];return r.forEach(s=>{if(!s)return;let a=_r.decode(s.data);o.push(a)}),o}async getRpcClmmPoolInfo({poolId:e}){let t=await this.scope.connection.getAccountInfo(new ne(e)),n=Mr.decode(t.data),r=Q.sqrtPriceX64ToPrice(n.sqrtPriceX64,n.mintDecimalsA,n.mintDecimalsB).toNumber();return{...n,currentPrice:r}}};import{PublicKey as W}from"@solana/web3.js";import{NATIVE_MINT as Vr,TOKEN_PROGRAM_ID as Pt,AccountLayout as ya}from"@solana/spl-token";var Kl=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Cl=Buffer.from("amm_config","utf8"),Ll=Buffer.from("pool","utf8"),Rl=Buffer.from("pool_lp_mint","utf8"),Ol=Buffer.from("pool_vault","utf8"),Nl=Buffer.from("observation","utf8");function Ml(i){return se([Kl],i)}function _l(i,e){return se([Cl,Vl(e)],i)}function El(i,e,t,n){return se([Ll,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Fl(i,e){return se([Rl,e.toBuffer()],i)}function oa(i,e,t){return se([Ol,e.toBuffer(),t.toBuffer()],i)}function Fr(i,e){return se([Nl,e.toBuffer()],i)}function Vl(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function sa({programId:i,mintA:e,mintB:t}){let n=_l(i,0).publicKey,r=Ml(i).publicKey,o=El(i,n,e,t).publicKey,s=Fl(i,o).publicKey,a=oa(i,o,e).publicKey,u=oa(i,o,t).publicKey,c=Fr(i,o).publicKey;return{poolId:o,configId:n,authority:r,lpMint:s,vaultA:a,vaultB:u,observationId:c}}import{TransactionInstruction as Un}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Zi,TOKEN_2022_PROGRAM_ID as aa,ASSOCIATED_TOKEN_PROGRAM_ID as vl}from"@solana/spl-token";var Dl=re("Raydium_cpmm"),Gn={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173]};function ua(i,e,t,n,r,o,s,a,u,c,l,m,d,p,y,f,b,g,A,h){let P=N([w("amountMaxA"),w("amountMaxB"),w("openTime")]),T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Zi,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:vl,isSigner:!1,isWritable:!1},{pubkey:So,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1}],I=Buffer.alloc(P.span);return P.encode({amountMaxA:g,amountMaxB:A,openTime:h},I),new Un({keys:T,programId:i,data:Buffer.from([...Gn.initialize,...I])})}function ca(i,e,t,n,r,o,s,a,u,c,l,m,d,p,y){let f=N([w("lpAmount"),w("amountMaxA"),w("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:Zi,isSigner:!1,isWritable:!1},{pubkey:aa,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return Dl.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:y},g),new Un({keys:b,programId:i,data:Buffer.from([...Gn.deposit,...g])})}function la(i,e,t,n,r,o,s,a,u,c,l,m,d,p,y){let f=N([w("lpAmount"),w("amountMinA"),w("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:Zi,isSigner:!1,isWritable:!1},{pubkey:aa,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:xo,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:y},g),new Un({keys:b,programId:i,data:Buffer.from([...Gn.withdraw,...g])})}function ma(i,e,t,n,r,o,s,a,u,c,l,m,d,p,y,f){let b=N([w("amountIn"),w("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},A),new Un({keys:g,programId:i,data:Buffer.from([...Gn.swapBaseInput,...A])})}function da(i,e,t,n,r,o,s,a,u,c,l,m,d,p,y,f){let b=N([w("amountInMax"),w("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},A),new Un({keys:g,programId:i,data:Buffer.from([...Gn.swapBaseOutput,...A])})}import Fe from"bn.js";var pa=N([pe(8),E("bump"),Ne("disableCreatePool"),pt("index"),w("tradeFeeRate"),w("protocolFeeRate"),w("fundFeeRate"),w("createPoolFee"),S("protocolOwner"),S("fundOwner"),D(w(),16)]),fa=N([pe(8),S("configId"),S("poolCreator"),S("vaultA"),S("vaultB"),S("mintLp"),S("mintA"),S("mintB"),S("mintProgramA"),S("mintProgramB"),S("observationId"),E("bump"),E("status"),E("lpDecimals"),E("mintDecimalA"),E("mintDecimalB"),w("lpAmount"),w("protocolFeesMintA"),w("protocolFeesMintB"),w("fundFeesMintA"),w("fundFeesMintB"),w("openTime"),D(w(),32)]);var Xn=class extends ge{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){let n=await this.scope.connection.getAccountInfo(new W(e));if(!n)throw new Error(`pool not found: ${e}`);let r=fa.decode(n.data),[o,s]=await this.scope.connection.getMultipleAccountsInfo([r.vaultA,r.vaultB]);if(!o)throw new Error(`pool vaultA info not found: ${r.vaultA.toBase58()}`);if(!s)throw new Error(`pool vaultB info not found: ${r.vaultB.toBase58()}`);let a;if(t){let u=await this.scope.connection.getAccountInfo(r.configId);u&&(a=pa.decode(u.data))}return{...r,baseReserve:new Fe(ya.decode(o.data).amount.toString()).sub(r.protocolFeesMintA).sub(r.fundFeesMintA),quoteReserve:new Fe(ya.decode(s.data).amount.toString()).sub(r.protocolFeesMintB).sub(r.fundFeesMintB),configInfo:a}}async createPool({programId:e,poolFeeAccount:t,startTime:n,ownerInfo:r,associatedOnly:o=!1,checkCreateATAOwner:s=!1,txVersion:a,computeBudgetConfig:u,...c}){var O,F,Y;let l=r.feePayer||((O=this.scope.owner)==null?void 0:O.publicKey),m=new Fe(new W(c.mintA.address).toBuffer()).lte(new Fe(new W(c.mintB.address).toBuffer())),[d,p]=m?[c.mintA,c.mintB]:[c.mintB,c.mintA],[y,f]=m?[c.mintAAmount,c.mintBAmount]:[c.mintBAmount,c.mintAAmount],b=r.useSOLBalance&&d.address===Vr.toBase58(),g=r.useSOLBalance&&p.address===Vr.toBase58(),[A,h]=[new W(d.address),new W(p.address)],P=this.createTxBuilder(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:A,tokenProgram:d.programId,owner:this.scope.ownerPubKey,createInfo:b?{payer:l,amount:y}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:o,checkCreateATAOwner:s});P.addInstruction(I||{});let{account:B,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:new W(p.address),tokenProgram:p.programId,owner:this.scope.ownerPubKey,createInfo:g?{payer:l,amount:f}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:o,checkCreateATAOwner:s});if(P.addInstruction(x||{}),T===void 0||B===void 0)throw Error("you don't has some token account");let K=sa({programId:e,mintA:A,mintB:h});return P.addInstruction({instructions:[ua(e,this.scope.ownerPubKey,K.configId,K.authority,K.poolId,A,h,K.lpMint,T,B,ye(this.scope.ownerPubKey,K.lpMint).publicKey,K.vaultA,K.vaultB,t,new W((F=d.programId)!=null?F:Pt),new W((Y=p.programId)!=null?Y:Pt),K.observationId,y,f,n)],instructionTypes:[M.CpmmCreatePool]}),P.addCustomComputeBudget(u),P.versionBuild({txVersion:a,extInfo:{address:{...K,mintA:d,mintB:p,programId:e,poolFeeAccount:t}}})}async addLiquidity(e){let{poolInfo:t,inputAmount:n,baseIn:r,slippage:o,computeResult:s,computeBudgetConfig:a,config:u,txVersion:c}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),n.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:n.toString()});let{account:l}=this.scope,{bypassAssociatedCheck:m,checkCreateATAOwner:d}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...u},p=await this.getRpcPoolInfo(t.id),{liquidity:y,inputAmountFee:f,anotherAmount:b}=s||this.computePairAmount({poolInfo:{...t,mintAmountA:new _(p.baseReserve.toString()).div(10**t.mintA.decimals).toNumber(),mintAmountB:new _(p.quoteReserve.toString()).div(10**t.mintB.decimals).toNumber(),lpAmount:new _(p.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},slippage:o,baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new _(n.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),g=b.amount,A=t.mintA.address===Vr.toString(),h=t.mintB.address===Vr.toString(),P=this.createTxBuilder(),[T,I]=[new W(t.mintA.address),new W(t.mintB.address)],{account:B,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new W(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||(r?n:g).isZero()?{payer:this.scope.ownerPubKey,amount:r?n:g}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:!1,checkCreateATAOwner:d});P.addInstruction(x||{});let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new W(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||(r?g:n).isZero()?{payer:this.scope.ownerPubKey,amount:r?g:n}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!1,checkCreateATAOwner:d});P.addInstruction(O||{}),!B&&!K&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",l.tokenAccounts);let F=await l.getCreatedTokenAccount({mint:new W(t.lpMint.address)}),{tokenAccount:Y,...v}=await l.handleTokenAccount({side:"out",amount:0,mint:new W(t.lpMint.address),tokenAccount:F,bypassAssociatedCheck:m,checkCreateATAOwner:d});P.addInstruction(v);let Z=await this.getCpmmPoolKeys(t.id);return P.addInstruction({instructions:[ca(new W(t.programId),this.scope.ownerPubKey,new W(Z.authority),new W(t.id),Y,B,K,new W(Z.vault.A),new W(Z.vault.B),T,I,new W(t.lpMint.address),y,r?f.amount:g,r?g:f.amount)],instructionTypes:[M.CpmmAddLiquidity],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),P.addCustomComputeBudget(a),P.versionBuild({txVersion:c})}async withdrawLiquidity(e){var Y,v;let{poolInfo:t,lpAmount:n,slippage:r,computeBudgetConfig:o,txVersion:s}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let a=new ze(new Fe(1)).sub(r),u=await this.getRpcPoolInfo(t.id),[c,l]=[a.mul(n.mul(u.baseReserve).div(u.lpAmount)).quotient,a.mul(n.mul(u.quoteReserve).div(u.lpAmount)).quotient],m=await this.scope.fetchEpochInfo(),[d,p]=[de(c,t.mintA.extensions.feeConfig,m,!0),de(l,t.mintB.extensions.feeConfig,m,!0)],{account:y}=this.scope,f=this.createTxBuilder(),[b,g]=[new W(t.mintA.address),new W(t.mintB.address)],A=b.equals($),h=g.equals($),P,T,{account:I,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new W(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:!A,checkCreateATAOwner:!1});P=I,B&&f.addInstruction(B);let{account:x,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new W(t.mintB.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!h,associatedOnly:!h,checkCreateATAOwner:!1});T=x,K&&f.addInstruction(K),(!P||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let O=await y.getCreatedTokenAccount({mint:new W(t.lpMint.address)});O||this.logAndCreateError("cannot found lp token account","tokenAccounts",y.tokenAccounts);let F=await this.getCpmmPoolKeys(t.id);return f.addInstruction({instructions:[la(new W(t.programId),this.scope.ownerPubKey,new W(F.authority),new W(t.id),O,P,T,new W(F.vault.A),new W(F.vault.B),b,g,new W(t.lpMint.address),n,c.sub((Y=d.fee)!=null?Y:new Fe(0)),l.sub((v=p.fee)!=null?v:new Fe(0)))],instructionTypes:[M.CpmmWithdrawLiquidity],lookupTableAddress:F.lookupTableAccount?[F.lookupTableAccount]:[]}),f.addCustomComputeBudget(o),f.versionBuild({txVersion:s})}async swap(e){let{poolInfo:t,baseIn:n,swapResult:r,config:o,computeBudgetConfig:s,txVersion:a,isSell:u=!1}=e,{bypassAssociatedCheck:c,checkCreateATAOwner:l}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...o},m=this.createTxBuilder(),[d,p]=u?[new W(t.mintB.address),new W(t.mintA.address)]:[new W(t.mintA.address),new W(t.mintB.address)],[y,f]=u?[t.mintB.programId,t.mintA.programId]:[t.mintA.programId,t.mintB.programId],b=await this.scope.account.getCreatedTokenAccount({programId:new W(y!=null?y:Pt),mint:d,associatedOnly:!1}),g=await this.scope.account.getCreatedTokenAccount({programId:new W(f!=null?f:Pt),mint:p,associatedOnly:!1}),{tokenAccount:A,...h}=await this.scope.account.handleTokenAccount({side:n?"in":"out",amount:n?r.sourceAmountSwapped:r.destinationAmountSwapped,mint:d,tokenAccount:b,bypassAssociatedCheck:c,checkCreateATAOwner:l,programId:new W(y!=null?y:Pt)});m.addInstruction(h);let{tokenAccount:P,...T}=await this.scope.account.handleTokenAccount({side:n?"out":"in",amount:n?r.destinationAmountSwapped:r.sourceAmountSwapped,mint:p,tokenAccount:g,bypassAssociatedCheck:c,checkCreateATAOwner:l,programId:new W(f!=null?f:Pt)});m.addInstruction(T),!A&&!P&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getCpmmPoolKeys(t.id),[B,x]=u?[I.vault.B,I.vault.A]:[I.vault.A,I.vault.B];return m.addInstruction({instructions:[n?ma(new W(t.programId),this.scope.ownerPubKey,new W(I.authority),new W(I.config.id),new W(t.id),A,P,new W(B),new W(x),new W(y!=null?y:Pt),new W(f!=null?f:Pt),d,p,Fr(new W(t.programId),new W(t.id)).publicKey,r.sourceAmountSwapped,r.destinationAmountSwapped):da(new W(t.programId),this.scope.ownerPubKey,new W(I.authority),new W(I.config.id),new W(t.id),P,A,new W(x),new W(B),new W(f!=null?f:Pt),new W(y!=null?y:Pt),p,d,Fr(new W(t.programId),new W(t.id)).publicKey,r.sourceAmountSwapped,r.destinationAmountSwapped)],instructionTypes:[n?M.CpmmSwapBaseIn:M.CpmmSwapBaseOut]}),m.addCustomComputeBudget(s),m.versionBuild({txVersion:a})}computePairAmount({poolInfo:e,amount:t,slippage:n,epochInfo:r,baseIn:o}){var A,h,P,T,I,B,x,K;let s=1-Number(n.toSignificant())/100,a=new Fe(new _(t).mul(10**e[o?"mintA":"mintB"].decimals).mul(s).toFixed(0)),u=de(a,e[o?"mintA":"mintB"].extensions.feeConfig,r,!1),c=a.sub((A=u.fee)!=null?A:new Fe(0)),[l,m]=[new Fe(new _(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new Fe(new _(e.mintAmountB).mul(10**e.mintB.decimals).toString())],d=new Fe(new _(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,_.ROUND_DOWN));this.logDebug("baseReserve:",l.toString(),"quoteReserve:",m.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",a.toString(),"amountInFee:",(P=(h=u.fee)==null?void 0:h.toString())!=null?P:0,"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`);let p=o?"base":"quote";this.logDebug("input side:",p);let y=c.mul(d).div(p==="base"?l:m),f={amount:ve,fee:void 0,expirationTime:void 0};c.isZero()||(f=de(Wl(y,l,m,d)[o?"amountB":"amountA"],e[o?"mintB":"mintA"].extensions.feeConfig,r,!0));let b=new ze(new Fe(1)).add(n),g=de(b.mul(f.amount.sub((T=f.fee)!=null?T:new Fe(0))).quotient,e[o?"mintB":"mintA"].extensions.feeConfig,r,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(B=(I=f.fee)==null?void 0:I.toString())!=null?B:0,"maxAnotherAmount:",g.amount.toString(),"maxAnotherAmountFee:",(K=(x=g.fee)==null?void 0:x.toString())!=null?K:0),{inputAmountFee:u,anotherAmount:f,maxAnotherAmount:g,liquidity:y}}};function Wl(i,e,t,n){let r=i.mul(e).div(n);!r.isZero()&&!i.mul(e).mod(n).isZero()&&(r=r.add(new Fe(1)));let o=i.mul(t).div(n);return!o.isZero()&&!i.mul(t).mod(n).isZero()&&(o=o.add(new Fe(1))),{amountA:r,amountB:o}}var zn=class extends ge{constructor(e){super(e)}static getAddLiquidityDefaultPool({addLiquidityPools:e,poolInfosCache:t}){if(e.length===0)return;if(e.length===1||(e.sort((r,o)=>o.version-r.version),e[0].version!==e[1].version))return e[0];let n=e.filter(r=>r.version===e[0].version);return n.sort((r,o)=>this.comparePoolSize(r,o,t)),n[0]}static comparePoolSize(e,t,n){let r=n[e.id],o=n[t.id];return r===void 0?1:o===void 0?-1:e.baseMint===t.baseMint?r.baseReserve.sub(o.baseReserve).gte(ve)?-1:1:r.baseReserve.sub(o.quoteReserve).gte(ve)?-1:1}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals($));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n}=e,r=await this.getWSolAccounts(),o=this.createTxBuilder();o.addCustomComputeBudget(e.computeBudgetConfig);let s=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});o.addInstruction(s);let a=X(t);for(let u=0;u<r.length;u++)a.gte(r[u].amount)?(o.addInstruction({instructions:[Tt({tokenAccount:r[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),a.sub(r[u].amount)):(o.addInstruction({instructions:[Tt({tokenAccount:r[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),Sn({destination:s.addresses.newAccount,source:r[u].publicKey,amount:a,owner:this.scope.ownerPubKey,tokenProgram:n}));return o.build()}async wrapWSol(e,t){let n=await this.getWSolAccounts(),r=this.createTxBuilder(),o=await ft({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(o),n.length&&r.addInstruction({instructions:[Sn({destination:n[0].publicKey,source:o.addresses.newAccount,amount:e,owner:this.scope.ownerPubKey,tokenProgram:t})],endInstructions:[Tt({tokenAccount:o.addresses.newAccount,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:t})]}),r.build()}};import{TOKEN_PROGRAM_ID as ql}from"@solana/spl-token";import{PublicKey as Ul,Transaction as $i,TransactionInstruction as Gl}from"@solana/web3.js";import ba from"bn.js";var Ve=class extends ge{static getPdaPoolId(e,t){return se([Ve.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,r){return se([Ve.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new ba(r).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:r,chainTime:o}){if(n.length===0)return[];let s=n.map(l=>Ve.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<Ve.VERSION_PROJECT.length;l++)a.push(...s.map(m=>Ve.getPdaOwnerId(t,m,r,l).publicKey));let u=await dt(e,[...s,...a]),c=[];for(let l=0;l<u.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],y=a[l],f=u[d],b=u[n.length+l];if(!(f&&b)||f.data.length!==Ve.POOL_LAYOUT.span||b.data.length!==Ve.OWNER_LAYOUT.span)continue;let g=Ve.POOL_LAYOUT.decode(f.data),A=Ve.OWNER_LAYOUT.decode(b.data),h=g.openTime.toNumber(),P=g.endTime.toNumber(),T=A.tokenInfo.map(x=>x.debtAmount.gt(new ba(0))).filter(x=>!x).length!==3,I=o>h&&o<P&&g.status===1,B=T&&I;c.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:A.lpAmount,project:Ve.VERSION_PROJECT[m],openTime:h,endTime:P,canClaim:B,canClaimErrorType:T?I?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,K)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:A.tokenInfo[K].debtAmount.add(A.tokenInfo[K].claimedAmount)}))})}return c}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),r=t.wallet||this.scope.ownerPubKey,o=[];for(let u of e.tokenInfo){let{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(be.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(be.WSOL.mint),associatedOnly:u.mintAddress.equals(be.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),o.push(c)}n.addInstruction({instructions:[Ve.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:o}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),r=t.wallet||this.scope.ownerPubKey,o={};for(let c of e){let l=[];for(let m of c.tokenInfo){let{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(be.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!m.mintAddress.equals(be.WSOL.mint),associatedOnly:m.mintAddress.equals(be.WSOL.mint)?!1:t.associatedOnly});p&&n.addInstruction(p),d&&(o[m.mintAddress.toString()]=d,l.push(d))}n.addInstruction({instructions:[Ve.makeClaimInstruction({programId:c.programId,poolInfo:c,ownerInfo:{wallet:r,ownerPda:c.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),u=n.allInstructions;return oi(u,[r,...a.map(c=>c.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new $i().add(...u.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new $i().add(...u.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new $i().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let r=N([]),o=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(u=>({pubkey:u,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:u})=>({pubkey:u,isSigner:!1,isWritable:!0})),{pubkey:ql,isSigner:!1,isWritable:!1}],s=Buffer.alloc(r.span);r.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new Gl({keys:o,programId:e,data:a})}},Je=Ve;Je.CLAIMED_NUM=3,Je.POOL_LAYOUT=N([pe(8),E("bump"),E("status"),w("openTime"),w("endTime"),S("ammId"),D(N([E("mintDecimals"),S("mintAddress"),S("mintVault"),w("perLpLoss"),w("totalClaimedAmount")]),Ve.CLAIMED_NUM,"tokenInfo"),D(w(),10,"padding")]),Je.OWNER_LAYOUT=N([pe(8),E("bump"),E("version"),S("poolId"),S("owner"),w("lpAmount"),D(N([S("mintAddress"),w("debtAmount"),w("claimedAmount")]),Ve.CLAIMED_NUM,"tokenInfo"),D(w(),4,"padding")]),Je.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Ul(e)),Je.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Je.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as eo}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Pa}from"@solana/spl-token";import Yn from"bn.js";import{TransactionInstruction as zl,SYSVAR_RENT_PUBKEY as Yl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ga}from"@solana/spl-token";import{createInitializeAccountInstruction as wa}from"@solana/spl-token";import{SystemProgram as Qt,Transaction as Aa}from"@solana/web3.js";function Xl(i="accountFlags"){let e=new hr(i);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ji=N([pe(5),Xl("accountFlags"),S("ownAddress"),w("vaultSignerNonce"),S("baseMint"),S("quoteMint"),S("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),S("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),S("requestQueue"),S("eventQueue"),S("bids"),S("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),pe(7)]);function Hl({programId:i,marketInfo:e}){let t=N([E("version"),We("instruction"),w("baseLotSize"),w("quoteLotSize"),pt("feeRateBps"),w("vaultSignerNonce"),w("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Yl,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),r=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},r),new zl({keys:n,programId:i,data:r})}async function ha({connection:i,wallet:e,marketInfo:t}){let n=new Aa,r=await i.getMinimumBalanceForRentExemption(165);n.add(Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:r,space:165,programId:ga}),Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:r,space:165,programId:ga}),wa(t.baseVault.publicKey,t.baseMint,t.vaultOwner),wa(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner));let o=new Aa;return o.add(Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await i.getMinimumBalanceForRentExemption(Ji.span),space:Ji.span,programId:t.programId}),Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:await i.getMinimumBalanceForRentExemption(5120+12),space:5120+12,programId:t.programId}),Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:await i.getMinimumBalanceForRentExemption(262144+12),space:262144+12,programId:t.programId}),Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:await i.getMinimumBalanceForRentExemption(65536+12),space:65536+12,programId:t.programId}),Qt.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:await i.getMinimumBalanceForRentExemption(65536+12),space:65536+12,programId:t.programId}),Hl({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[M.CreateAccount,M.CreateAccount,M.InitAccount,M.InitAccount]},{transaction:o,signer:[],instructionTypes:[M.CreateAccount,M.CreateAccount,M.CreateAccount,M.CreateAccount,M.CreateAccount,M.InitMarket]}]}var cn=class extends ge{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:r,dexProgramId:o,txVersion:s,computeBudgetConfig:a}){let u=this.scope.ownerPubKey,c=Me({fromPublicKey:u,programId:o}),l=Me({fromPublicKey:u,programId:o}),m=Me({fromPublicKey:u,programId:o}),d=Me({fromPublicKey:u,programId:o}),p=Me({fromPublicKey:u,programId:o}),y=Me({fromPublicKey:u,programId:Pa}),f=Me({fromPublicKey:u,programId:Pa}),b=0,g=new Yn(100);function A(){let O=new Yn(0);for(;;)try{return{vaultOwner:eo.createProgramAddressSync([c.publicKey.toBuffer(),O.toArrayLike(Buffer,"le",8)],o),vaultSignerNonce:O}}catch{if(O.iaddn(1),O.gt(new Yn(25555)))throw Error("find vault owner error")}}let{vaultOwner:h,vaultSignerNonce:P}=A(),T=new Yn(Math.round(10**e.decimals*n)),I=new Yn(Math.round(n*10**t.decimals*r));if(T.eq(ve))throw Error("lot size is too small");if(I.eq(ve))throw Error("tick size or lot size is too small");let B=await ha({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:o,id:c,baseMint:e.mint,quoteMint:t.mint,baseVault:y,quoteVault:f,vaultOwner:h,requestQueue:l,eventQueue:m,bids:d,asks:p,feeRateBps:b,quoteDustThreshold:g,vaultSignerNonce:P,baseLotSize:T,quoteLotSize:I}}),x=this.createTxBuilder();x.addCustomComputeBudget(a),x.addInstruction({instructions:B[0].transaction.instructions,signers:B[0].signer});let K=[];for await(let O of B.slice(1,B.length)){let F=this.createTxBuilder();F.addCustomComputeBudget(a),F.addInstruction({instructions:O.transaction.instructions,signers:O.signer,instructionTypes:O.instructionTypes});let Y=await F.versionBuild({txVersion:s});K.push(Y)}return x.versionMultiBuild({extraPreBuildData:K,extInfo:{address:{marketId:c.publicKey,requestQueue:l.publicKey,eventQueue:m.publicKey,bids:d.publicKey,asks:p.publicKey,baseVault:y.publicKey,quoteVault:f.publicKey,baseMint:new eo(e.mint),quoteMin:new eo(t.mint)}},txVersion:s})}};import{PublicKey as jn}from"@solana/web3.js";import{PublicKey as KT,TransactionInstruction as ka,SYSVAR_CLOCK_PUBKEY as Ql}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ta}from"@solana/spl-token";var jl=N([E("instruction"),jo("amount")]),Hn=N([E("instruction")]);function vr({programId:i},e){let t=[{pubkey:Ta,isSigner:!1,isWritable:!1},{pubkey:Bo,isSigner:!1,isWritable:!1},...Object.entries(e).map(([r,o])=>({pubkey:o,isSigner:r==="userOwner",isWritable:!["authority","userOwner"].includes(r)}))],n=Buffer.alloc(Hn.span);return Hn.encode({instruction:2},n),new ka({keys:t,programId:i,data:n})}function to(i){let{poolConfig:e,userKeys:t,side:n}=i,r=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,o=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Hn.span);Hn.encode({instruction:2},s);let a=[{pubkey:Ta,isWritable:!1,isSigner:!1},{pubkey:Ql,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new ka({programId:e.programId,keys:a,data:s})}import Ia from"bn.js";var Zl={[In.IDO_PROGRAM_ID_V1.toString()]:1,[In.IDO_PROGRAM_ID_V2.toString()]:2,[In.IDO_PROGRAM_ID_V3.toString()]:3,[In.IDO_PROGRAM_ID_V4.toString()]:4},ln=class extends ge{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:r=!1,txVersion:o}){let s=this.createTxBuilder(),a=Zl[t.programId];a||this.logAndCreateError("invalid version",a);let u=De(t),[c,l]=[!new Ia(e.coin).isZero(),!new Ia(e.pc).isZero()],m=u.projectInfo.mint.address.equals($),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:r});!d&&c&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),c&&p&&s.addInstruction(p);let y=u.buyInfo.mint.address.equals($),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:r});if(!d&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!d||!f)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...c?[vr({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:d,userIdoInfo:new jn(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[vr({programId:new jn(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:f,userIdoInfo:new jn(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:o});if(a<3)return!c&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[vr({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:f,userBaseTokenAccount:d,userIdoInfo:new jn(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:o});let g={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:d,quoteTokenAccount:f,ledgerAccount:new jn(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...c?[to({...g,side:"base"})]:[],...l?[to({...g,side:"quote"})]:[]]}).versionBuild({txVersion:o})}};import{PublicKey as $l}from"@solana/web3.js";import{MintLayout as Jl,TOKEN_2022_PROGRAM_ID as no,TOKEN_PROGRAM_ID as ro}from"@solana/spl-token";var Qn=class extends ge{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:r="strict"}=t||{},{mintList:o,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),u=await this.scope.fetchJupTokenList(r,n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(Lt.address,Lt),this._mintGroup.official.add(Lt.address),s.forEach(c=>{this._blackTokenMap.set(c.address,{...c,priority:-1})}),o.forEach(c=>{var l;this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?no.toBase58():ro.toBase58()}),this._mintGroup.official.add(c.address))}),u.forEach(c=>{var l;this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?no.toBase58():ro.toBase58()}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?no.toBase58():ro.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),r=this._tokenMap.get(n);if(r)return r;if(n.toLocaleUpperCase()==="SOL")return Lt;let o=(await this.scope.api.getTokenInfo([n]))[0];if(o)return this._mintGroup.extra.add(n),this._tokenMap.set(n,{...o,priority:2}),o;let s=await this.scope.connection.getAccountInfo(new $l(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=Jl.decode(s.data),u=n.toString().substring(0,6),c={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:u,name:u,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,c),c}};var Dr=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:r,api:o,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:u}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=r?new it(r):void 0,this._signAllTransactions=e.signAllTransactions,this.api=o,this._apiCacheTime=u||5*60*1e3,this.logger=re("Raydium"),this.farm=new Nn({scope:this,moduleName:"Raydium_Farm"}),this.account=new Kn({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Wn({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Qn({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new zn({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new qn({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Xn({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Je({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new cn({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new ln({scope:this,moduleName:"Raydium_ido"}),this.availability={};let c=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:c,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=em({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4,apiCacheTime:3e5,signAllTransactions:void 0,urlConfigs:{},logRequests:!1,logCount:10,jupTokenType:"strict",disableFeatureCheck:!1,disableLoadToken:!1,tokenAccounts:[],tokenAccountRawInfos:[],defaultChainTimeOffset:void 0,defaultChainTime:void 0},e),{cluster:n,apiRequestTimeout:r,logCount:o,logRequests:s,urlConfigs:a}=t,u=new gr({cluster:n,timeout:r,urlConfigs:a,logCount:o,logRequests:s}),c=new Dr({...t,api:u});return await c.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await c.token.load({type:e.jupTokenType}),c}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(wr);return this._owner.publicKey}setOwner(e){return this._owner=e?new it(e):void 0,this}get connection(){if(!this._connection)throw new Error(zo);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(wr),new Error(wr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}async fetchJupTokenList(e,t){var o;let n=(o=this.apiData.jupTokenList)==null?void 0:o[e];if(n&&!this.isCacheInvalidate(n.fetched)&&!t)return n.data;let r=await this.api.getJupTokenList(e);return this.apiData.jupTokenList={...this.apiData.jupTokenList,[e]:{fetched:Date.now(),data:r}},this.apiData.jupTokenList[e].data}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};export{Dr as Raydium};
/*!
 *  decimal.js v10.4.3
 *  An arbitrary-precision Decimal type for JavaScript.
 *  https://github.com/MikeMcl/decimal.js
 *  Copyright (c) 2022 Michael Mclaughlin <M8ch88l@gmail.com>
 *  MIT Licence
 */
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=raydium.mjs.map